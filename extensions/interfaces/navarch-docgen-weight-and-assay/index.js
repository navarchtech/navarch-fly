import{useApi as t,defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as a,ref as o,inject as n,resolveComponent as s,openBlock as i,createElementBlock as r,Fragment as l,createCommentVNode as d,createVNode as c,withCtx as u,createTextVNode as y,createBlock as m,toDisplayString as g}from"vue";var h=a({props:{value:{type:Object,default:null}},emits:["input"],setup(e,{emit:a}){const s=o(""),i=o(!1),r=o(!1),l=t(),d=n("values",o({})),c="foreign_key",u="lot_number",y="method",m="contract",g="counterparty",h="assay_results",f="weight_result",_="bl_date",w="vessel",p="origin",v="destination",$="assay_uom",A="name",b="name",N="name",O="logo",S="line_1",D="line_2",P="city",C="state",E="country",W="zip",J="phone_code",k="phone_number",x="signatory_name",F="signatory_title",j="signature",T="navarch_country",I="name",G="phone_code",B="navarch_world_port",R="port_name",V="country",M="commodity",q="navarch_commodity",K="name";return{isGeneraingDoc:i,failureReason:s,generatePdf:async function(){var t,e;s.value="",i.value=!0;try{const o=d.value.parcel,n=await l.get(`/items/navarch_parcel/${o}`,{params:{fields:[h,f,m,g,"actual_arrival_date",_,"estimated_shipment_date",w,p,v]}}),r=n.data.data[h],H=n.data.data[f],X=await l.get(`/items/navarch_assay_lot?filter[${c}]=${r}&sort[]=${u}`,{params:{fields:["id","commodity",y,"dry_weight","dry_weight_uom","buyer_assay","seller_assay","final_assay","lot_number",$]}});console.log(`assayLotResponse.data.data=${JSON.stringify(X.data.data)}`),function(t){if(!t||0===t.length)throw new Error("No assay lots found for the selected parcel")}(X.data.data);const Z=X.data.data.map((t=>t.commodity)).filter(((t,e,a)=>a.indexOf(t)===e));console.log(`commodities: ${Z}`);const Q=(await l.get(`/items/${q}`,{params:{fields:["name","code"],filter:{code:{_in:Z}}}})).data.data.reduce(((t,e)=>(t[e.code]=e.name,t)),{}),tt=function(t){console.log("[evaluateAnalyticalAssay]");const e={};for(const a of t)e[a.method]||(e[a.method]={}),e[a.method][a.commodity]||(e[a.method][a.commodity]=[]),null!==a.lot_number?(1===e[a.method][a.commodity].length&&null===e[a.method][a.commodity][0].lot_number&&(e[a.method][a.commodity]=[]),e[a.method][a.commodity].push(a)):null===a.lot_number&&0===e[a.method][a.commodity].length&&e[a.method][a.commodity].push(a);console.log(`[evaluateAnalyticalAssay] group: ${JSON.stringify(e)}}`);let a=e.Outturn,o="Outturn";a||(a=e["Inturn Final"],o="Inturn Final");a||(a=e.Inturn,o="Inturn");a||(a=e.Estimated,o="Estimated");a||(a=e.Planned,o="Planned");if(!a)throw new Error("No assay lot data found for all assay methods. Please ensure assay lot data has been entered in the selected parcel.");console.log(`[evaluateAnalyticalAssay] latest method=${o}`);const n={};for(const t in e[o]){console.log(`[evaluateAnalyticalAssay] commodityKey: ${t}, group[METHOD][commodityKey]: ${JSON.stringify(e[o][t])}`),n[t]={};const a=e[o][t].reduce(((t,e)=>t+e.dry_weight),0);if(console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${a} from ${JSON.stringify(e[o][t])}`),0===a||isNaN(a))throw s.value=`Please provide dry weight for ${t} commodity in ${o} method, total dry weight cannot be ${a}`,new Error("[evaluateAnalyticalAssay] totalDryWeight is 0");console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${a}`),n[t].analytical_assay=e[o][t].reduce(((e,a)=>{var n,i;const r=null!=(i=a.final_assay)?i:null!=(n=a.seller_assay)?n:a.buyer_assay;if(null==r)throw s.value=`Please provide Final, Seller or Buyer assay value for ${t} commodity in ${o} method`,new Error("[evaluateAnalyticalAssay] assay value is not defined for assay lot");const l=e+r*a.dry_weight;return console.log(`[evaluateAnalyticalAssay] evaluated analytical assay: ${l} for method=${o}, commodity=${t}; with values accumulator=${e}, assayValue=${r}, dryWeight=${a.dry_weight}`),l}),0)/a,console.log(`[evaluateAnalyticalAssay] analytical assay: ${n[t].analytical_assay}`),e[o][t].length>0&&(n[t][$]=e[o][t][0][$])}return console.log(`[evaluateAnalyticalAssay] analyticalAssay: ${JSON.stringify(n)}`),n}(X.data.data),et=Object.keys(tt).map((t=>({commodity_name:Q[t],analytical_assay:tt[t].analytical_assay,assay_uom:tt[t][$]})));console.log(`[generateProvWeightAndAssay] assay data=${JSON.stringify(et)}}`);const at=await l.get(`/items/navarch_weight_lot?filter[${c}]=${H}&sort[]=${u}`,{params:{fields:["id","dry_weight","wet_weight",y,"moisture","wet_weight_uom","dry_weight_uom"]}});console.log(`weightLotResponse.data.data=${JSON.stringify(at.data.data)}`),function(t){if(!t||0===t.length)throw new Error("No weight lots found for the selected parcel")}(at.data.data);const ot=function(t){console.log("[evaluateWeights]");const e={};for(const a of t)e[a.method]||(console.log(`adding method ${a.method} to weightData object`),e[a.method]=[]),e[a.method.toString()].push(a);const a=[];for(const t of Object.keys(e)){if(!e[t]){console.log(`method=${t} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${t}`);const o=z(e[t]);o&&a.push(o)}return a}(at.data.data);let nt=ot.find((t=>"Outturn"===t.method));if(nt||(nt=ot.find((t=>"Inturn Final"===t.method))),nt||(nt=ot.find((t=>"Inturn"===t.method))),nt||(nt=ot.find((t=>"Estimated"===t.method))),nt||(nt=ot.find((t=>"Planned"===t.method))),!nt)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");if(void 0===nt.dry_weight||null===nt.dry_weight||void 0===nt.wet_weight||null===nt.wet_weight||void 0===nt.moisture||null===nt.moisture||void 0===nt.dry_weight_uom||null===nt.dry_weight_uom||void 0===nt.wet_weight_uom||null===nt.wet_weight_uom||void 0===nt.method||null===nt.method)throw new Error("One of the fields for weight lots is undefined");const st=n.data.data[w];let it;st&&(it=await l.get(`/items/navarch_vessel/${st}`,{params:{fields:[b]}}));const rt=(await l.get("/items/navarch_company",{params:{fields:[N,O,S,D,P,C,W,E,J,k,"email",x,F,j]}})).data.data,lt=rt[N],dt=(await l.get(`/items/${T}/${rt[J]}`,{params:{fields:[G]}})).data.data[G],ct=rt[k],ut=rt[S],yt=rt[D]?`,\n${rt[D]}`:"",mt=rt[P]?`,\n${rt[P]}`:"",gt=rt[C]?`,\n${rt[C]}`:"",ht=await l.get(`/items/${T}/${rt[E]}`,{params:{fields:[I]}}),ft=ht.data.data[I]?`, ${ht.data.data[I]}`:"",_t=`${ut}${yt}${mt}${rt[W]?` ${rt[W]}`:""}${gt}${ft}`,wt={signatoryName:rt[x],signatoryTitle:rt[F],signature:rt[j],company:lt},pt=await l.get(`/items/navarch_counterparty/${n.data.data[g]}`,{params:{fields:[A]}}),vt=await l.get(`/items/${B}/${n.data.data[p]}`,{params:{fields:[R,V]}}),$t=await l.get(`/items/${B}/${n.data.data[v]}`,{params:{fields:[R,V]}}),At=n.data.data[m],bt=(await l.get(`/items/navarch_commodity_in_contract?filter[${m}]=${At}&filter[primary_commodity]=true`,{params:{fields:[M]}})).data.data[0][M],Nt=null!=(t=(await l.get(`/items/${q}/${bt}`,{params:{fields:[K]}})).data.data[K])?t:"",Ot={folder_id:await U(),invoice_type:d.value.invoice_type,company_logo:null!=(e=rt[O])?e:void 0,seller:lt,seller_address:_t,seller_phone_number:`+${dt} ${ct}`,buyer:pt.data.data[A],vessel:it?it.data.data[b]:"N/A",contract_ref:`${n.data.data[m]}`,bl_date:Y(new Date(n.data.data[_])),port_of_loading:`${vt.data.data[R]}, ${vt.data.data[V]}`,port_of_discharge:`${$t.data.data[R]}, ${$t.data.data[V]}`,commodity_name:Nt,wet_weight:nt.wet_weight,wet_weight_uom:nt.wet_weight_uom,dry_weight:nt.dry_weight,dry_weight_uom:nt.dry_weight_uom,moisture:nt.moisture,moisture_uom:"%",assays:et,signatory:wt},St=await l.post("/generate/weight-and-assay-cert",Ot);if(200!==St.status)return console.log(`[generateProvWeightAndAssay] invoice response status: ${St.status}`),s.value=St.data,void(i.value=!1);const Dt=await async function(t){if(!t)throw console.error("[uploadGeneratedDoc] fileData is empty"),new Error("A failure occured while trying to upload the generated document, no file data found. Please try again.");const e=function(t){console.log("[convertJsonToFormData] json=",JSON.stringify(t));const e=new FormData;for(let a in t)"file"!==a&&e.append(a,t[a]);const a=t.file,o=function(t,e){const a=atob(t),o=new ArrayBuffer(a.length),n=new Uint8Array(o);for(let t=0;t<a.length;t++)n[t]=a.charCodeAt(t);const s=new Blob([n],{type:e});return s}(a,"application/pdf");return e.append("file",o,t.filename_download),e}(t),a=await l.post("/files",e,{headers:{"Content-Type":"multipart/form-data"}});if(200!==a.status)throw console.error(`[uploadGeneratedDoc] uploadedFileData status: ${a.status}`),new Error("A failure occured while trying to upload the generated document. Please try again.");return a.data.data.id}(St.data);a("input",{...Ot,doc_name:Dt}),i.value=!1,L(Dt)}catch(t){console.error("[generateProvWeightAndAssay] error=",t),s.value=t,i.value=!1}},isCopying:r,copy:async function(){r.value=!0;const{id:t,user_created:e,date_created:a,user_updated:o,date_updated:n,weight_and_assay_cert:i,...c}=d.value;console.log(`[weight & assay::copy] requestBody=${JSON.stringify(c)}`);const u=await l.post("/items/navarch_weight_and_assay_cert",c);if(200!==u.status)return console.log(`[weight & assay::copy] copy response status: ${u.status}`),void(s.value=`Failed to duplicate weight & assay with status ${u.status}`);r.value=!1,window.open(`/admin/content/navarch_weight_and_assay_cert/${u.data.data.id}`)},viewPdf:L};async function U(){const t=await l.get(`/folders?filter[name][_eq]=${encodeURI("Weight & Assay Cert")}`);return 200===t.status&&t.data&&t.data.data?0===t.data.data.length?await async function(){return(await l.post("/folders",{name:"Weight & Assay Cert"})).data.data.id}():t.data.data[0].id:null}function L(t){const a=null!=t?t:e.value.doc_name;console.log(`[viewPdf] doc ID: ${a}`),window.open(`/assets/${a}?access_token=9TKZlOUjs29Svyop45nyyyN02lYPlX_x`)}function Y(t){const e=t.getDate(),a=t.getMonth(),o=t.getFullYear();return`${e} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${o}`}function z(t){if(console.log("[evaluateWeightData]"),0===t.length)throw new Error("No weight lots found");const e=H(t,"dry_weight"),a=H(t,"wet_weight");return{method:X(t,"method"),dry_weight_uom:X(t,"dry_weight_uom"),wet_weight_uom:X(t,"wet_weight_uom"),dry_weight:e,wet_weight:a,moisture:(a-e)/a*100}}function H(t,e){return console.log("[evaluateAggregateValue]"),t.reduce(((t,a)=>{var o;return t+(null!=(o=a[e.toString()])?o:0)}),0)}function X(t,e){if(console.log("[getFirstValueAsSharedValue]"),0!==t.length)return console.log(`lots[0][${e.toString()}]=${t[0][e.toString()]}`),t[0][e.toString()]}}});const f={key:0},_={key:1};var w=[],p=[];!function(t,e){if(t&&"undefined"!=typeof document){var a,o=!0===e.prepend?"prepend":"append",n=!0===e.singleTag,s="string"==typeof e.container?document.querySelector(e.container):document.getElementsByTagName("head")[0];if(n){var i=w.indexOf(s);-1===i&&(i=w.push(s)-1,p[i]={}),a=p[i]&&p[i][o]?p[i][o]:p[i][o]=r()}else a=r();65279===t.charCodeAt(0)&&(t=t.substring(1)),a.styleSheet?a.styleSheet.cssText+=t:a.appendChild(document.createTextNode(t))}function r(){var t=document.createElement("style");if(t.setAttribute("type","text/css"),e.attributes)for(var a=Object.keys(e.attributes),n=0;n<a.length;n++)t.setAttribute(a[n],e.attributes[a[n]]);var i="prepend"===o?"afterbegin":"beforeend";return s.insertAdjacentElement(i,t),t}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),h.render=function(t,e,a,o,n,h){const w=s("v-button"),p=s("v-notice");return i(),r(l,null,[d(' <input :value="value" @input="handleChange($event.target.value)" /> '),d(" create a button only interface for Directus"),t.value?(i(),r("div",_,[c(w,{onClick:e[1]||(e[1]=()=>t.viewPdf())},{default:u((()=>[y("View Weight & Assay Cert ")])),_:1})])):(i(),r("div",f,[c(w,{onClick:e[0]||(e[0]=()=>t.generatePdf()),loading:t.isGeneraingDoc},{default:u((()=>[y("Generate Weight & Assay Cert")])),_:1},8,["loading"]),t.failureReason?(i(),m(p,{key:0},{default:u((()=>[y(g(t.failureReason),1)])),_:1})):d("v-if",!0)])),c(w,{class:"margin-top-16px",onClick:e[2]||(e[2]=()=>t.copy()),loading:t.isCopying},{default:u((()=>[y("Copy")])),_:1},8,["loading"])],64)},h.__scopeId="data-v-64969d30",h.__file="src/interface.vue";var v=e({id:"navarch-weight-n-assay-generator",name:"Weight & Assay Cert Generator",icon:"receipt_long",description:"This is a custom interface for Navarch's Weight & Assay Certificate Generator Button.",component:h,options:null,types:["json"],group:"standard"});export{v as default};
