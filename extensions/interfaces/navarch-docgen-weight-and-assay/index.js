import{useApi as a,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as e,ref as i,inject as n,resolveComponent as r,openBlock as o,createElementBlock as s,Fragment as d,createCommentVNode as l,createVNode as c,withCtx as u,createTextVNode as m,createBlock as _,toDisplayString as g}from"vue";var p=e({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:e}){const r=i(""),o=a(),s=n("values",i({})),d="foreign_key",l="lot_number",c="method",u="contract",m="counterparty",_="assay_results",g="weight_result",p="bl_date",f="vessel",y="origin",h="destination",w="commodity",$="final_assay",v="assay_uom",A="name",b="name",C="name",k="line_1",P="line_2",S="city",W="state",x="country",D="zip",N="phone_code",J="phone_number",O="signatory_name",R="signatory_title",V="navarch_country",j="name",F="phone_code",G="navarch_world_port",I="port_name",M="country",T="commodity",z="navarch_commodity",B="name";return{failureReason:r,generatePdf:async function(){var a;try{const t=s.value.parcel,i=await o.get(`/items/navarch_parcel/${t}`,{params:{fields:[_,g,u,m,"actual_arrival_date",p,"invoice_date","estimated_shipment_date","actual_shipment_date",f,y,h]}}),n=i.data.data[_],q=i.data.data[g],H=await o.get(`/items/navarch_assay_lot?filter[${d}]=${n}&filter[${c}]=Inturn&filter[${l}][_null]=true`,{params:{fields:[w,$,v]}}),K=H.data.data.map((a=>a.commodity)).filter(((a,t,e)=>e.indexOf(a)===t)),L=K.map(((a,t)=>`filter[_or][${t}][code]=${a}`)).join("&"),Q=await o.get(`/items/${z}?${L}`,{params:{fields:["name","code"]}});console.log(`commodity mapping response: ${JSON.stringify(Q.data.data)}`);const X=Q.data.data.reduce(((a,t)=>(a[t.code]=t.name,a)),{}),Z=H.data.data.map((a=>({commodity_name:X[a[w]],analytical_assay:a[$],assay_uom:a[v]}))),aa=function(a){if(console.log("[evaluateWeightData]"),0===a.length)throw new Error("No weight lots found");const t=U(a,"dry_weight"),e=U(a,"wet_weight");return{dry_weight_uom:Y(a,"dry_weight_uom"),wet_weight_uom:Y(a,"wet_weight_uom"),dry_weight:t,wet_weight:e,moisture:(e-t)/e*100}}((await o.get(`/items/navarch_weight_lot?filter[${d}]=${q}&filter[${c}]=Inturn&sort[]=${l}`,{params:{fields:["dry_weight","wet_weight","wet_weight_uom","dry_weight_uom"]}})).data.data),ta=i.data.data[f],ea=await o.get(`/items/navarch_vessel/${ta}`,{params:{fields:[b]}}),ia=(await o.get("/items/navarch_company",{params:{fields:[C,k,P,S,W,D,x,N,J,"email",O,R]}})).data.data,na=ia[C],ra=(await o.get(`/items/${V}/${ia[N]}`,{params:{fields:[F]}})).data.data[F],oa=ia[J],sa=ia[k],da=ia[P]?`,\n${ia[P]}`:"",la=ia[S]?`,\n${ia[S]}`:"",ca=ia[W]?`,\n${ia[W]}`:"",ua=await o.get(`/items/${V}/${ia[x]}`,{params:{fields:[j]}}),ma=ua.data.data[j]?`, ${ua.data.data[j]}`:"",_a=`${sa}${da}${la}${ia[D]?` ${ia[D]}`:""}${ca}${ma}`,ga={signatoryName:ia[O],signatoryTitle:ia[R],company:na},pa=await o.get(`/items/navarch_counterparty/${i.data.data[m]}`,{params:{fields:[A]}}),fa=await o.get(`/items/${G}/${i.data.data[y]}`,{params:{fields:[I,M]}}),ya=await o.get(`/items/${G}/${i.data.data[h]}`,{params:{fields:[I,M]}}),ha=i.data.data[u],wa=(await o.get(`/items/navarch_commodity_in_contract?filter[${u}]=${ha}&filter[primary_commodity]=true`,{params:{fields:[T]}})).data.data[0][T],$a=null!=(a=(await o.get(`/items/${z}/${wa}`,{params:{fields:[B]}})).data.data[B])?a:"",va={invoice_type:s.value.invoice_type,seller:na,seller_address:_a,seller_phone_number:`+${ra} ${oa}`,buyer:pa.data.data[A],vessel:ea.data.data[b],contract_ref:`${i.data.data[u]}`,bl_date:E(new Date(i.data.data[p])),port_of_loading:`${fa.data.data[I]}, ${fa.data.data[M]}`,port_of_discharge:`${ya.data.data[I]}, ${ya.data.data[M]}`,commodity_name:$a,wet_weight:aa.wet_weight,wet_weight_uom:aa.wet_weight_uom,dry_weight:aa.dry_weight,dry_weight_uom:aa.dry_weight_uom,moisture:aa.moisture,moisture_uom:"%",assays:Z,signatory:ga},Aa=await o.post("/generate/weight-and-assay-cert",va);if(200!==Aa.status)return console.log(`[generateProvWeightAndAssay] invoice response status: ${Aa.status}`),void(r.value=Aa.data);const ba=Aa.data;e("input",{...va,doc_name:ba})}catch(a){console.error("[generateProvWeightAndAssay] error=",a),r.value=a}},viewPdf:function(){const a=t.value.doc_name;console.log(`[viewPdf] doc name: ${a}`);const e=`/display-doc?filepath=${encodeURIComponent(`/data/uploads/${a}.pdf`)}`;window.open(e)}};function E(a){const t=a.getDate(),e=a.getMonth(),i=a.getFullYear();return`${t} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e]} ${i}`}function U(a,t){return console.log("[evaluateAggregateValue]"),a.reduce(((a,e)=>{var i;return a+(null!=(i=e[t.toString()])?i:0)}),0)}function Y(a,t){if(console.log("[getFirstValueAsSharedValue]"),0!==a.length)return console.log(`lots[0][${t.toString()}]=${a[0][t.toString()]}`),a[0][t.toString()]}}});const f={key:0},y={key:1};p.render=function(a,t,e,i,n,p){const h=r("v-button"),w=r("v-notice");return o(),s(d,null,[l(' <input :value="value" @input="handleChange($event.target.value)" /> '),l(" create a button only interface for Directus"),a.value?(o(),s("div",y,[c(h,{class:"margin-top-16px",onClick:t[1]||(t[1]=()=>a.viewPdf())},{default:u((()=>[m("View Weight & Assay Cert ")])),_:1})])):(o(),s("div",f,[c(h,{class:"margin-top-16px",onClick:t[0]||(t[0]=()=>a.generatePdf())},{default:u((()=>[m("Generate Weight & Assay Cert")])),_:1}),a.failureReason?(o(),_(w,{key:0},{default:u((()=>[m(g(a.failureReason),1)])),_:1})):l("v-if",!0)]))],2112)},p.__file="src/interface.vue";var h=t({id:"navarch-weight-n-assay-generator",name:"Weight & Assay Cert Generator",icon:"receipt_long",description:"This is a custom interface for Navarch's Weight & Assay Certificate Generator Button.",component:p,options:null,types:["json"],group:"standard"});export{h as default};
