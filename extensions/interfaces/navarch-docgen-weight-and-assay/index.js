import{useApi as t,defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as a,ref as o,inject as n,resolveComponent as s,openBlock as i,createElementBlock as r,Fragment as l,createCommentVNode as d,createVNode as c,withCtx as u,createTextVNode as m,createBlock as y,toDisplayString as g}from"vue";var h=a({props:{value:{type:Object,default:null}},emits:["input"],setup(e,{emit:a}){const s=o(""),i=o(!1),r=o(!1),l=t(),d=n("values",o({})),c="foreign_key",u="lot_number",m="method",y="contract",g="counterparty",h="assay_results",f="weight_result",_="bl_date",p="vessel",w="origin",v="destination",$="assay_uom",A="name",b="name",N="name",O="logo",S="line_1",D="line_2",P="city",E="state",C="country",J="zip",W="phone_code",k="phone_number",x="signatory_name",F="signatory_title",j="signature",T="navarch_country",I="name",B="phone_code",G="navarch_world_port",R="port_name",V="country",M="commodity",K="navarch_commodity",q="name";return{isGeneraingDoc:i,failureReason:s,generatePdf:async function(){var t,e;s.value="",i.value=!0;try{const o=d.value.parcel,n=await l.get(`/items/navarch_parcel/${o}`,{params:{fields:[h,f,y,g,"actual_arrival_date",_,"estimated_shipment_date",p,w,v]}}),r=n.data.data[h],z=n.data.data[f],H=await l.get(`/items/navarch_assay_lot?filter[${c}]=${r}&sort[]=${u}`,{params:{fields:["id","commodity",m,"dry_weight","dry_weight_uom","buyer_assay","seller_assay","final_assay","lot_number",$]}});console.log(`assayLotResponse.data.data=${JSON.stringify(H.data.data)}`),function(t){if(!t||0===t.length)throw new Error("No assay lots found for the selected parcel")}(H.data.data);const X=H.data.data.map((t=>t.commodity)).filter(((t,e,a)=>a.indexOf(t)===e));console.log(`commodities: ${X}`);const Z=(await l.get(`/items/${K}`,{params:{fields:["name","code"],filter:{code:{_in:X}}}})).data.data.reduce(((t,e)=>(t[e.code]=e.name,t)),{}),Q=function(t){console.log("[evaluateAnalyticalAssay]");const e={};for(const a of t)e[a.method]||(e[a.method]={}),e[a.method][a.commodity]||(e[a.method][a.commodity]=[]),null!==a.lot_number?(1===e[a.method][a.commodity].length&&null===e[a.method][a.commodity][0].lot_number&&(e[a.method][a.commodity]=[]),e[a.method][a.commodity].push(a)):null===a.lot_number&&0===e[a.method][a.commodity].length&&e[a.method][a.commodity].push(a);console.log(`[evaluateAnalyticalAssay] group: ${JSON.stringify(e)}}`);let a=e.Outturn,o="Outturn";a||(a=e["Inturn Final"],o="Inturn Final");a||(a=e.Inturn,o="Inturn");a||(a=e.Estimated,o="Estimated");a||(a=e.Planned,o="Planned");if(!a)throw new Error("No assay lot data found for all assay methods. Please ensure assay lot data has been entered in the selected parcel.");console.log(`[evaluateAnalyticalAssay] latest method=${o}`);const n={};for(const t in e[o]){console.log(`[evaluateAnalyticalAssay] commodityKey: ${t}, group[METHOD][commodityKey]: ${JSON.stringify(e[o][t])}`),n[t]={};const a=e[o][t].reduce(((t,e)=>t+e.dry_weight),0);if(console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${a} from ${JSON.stringify(e[o][t])}`),0===a||isNaN(a))throw s.value=`Please provide dry weight for ${t} commodity in ${o} method, total dry weight cannot be ${a}`,new Error("[evaluateAnalyticalAssay] totalDryWeight is 0");console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${a}`),n[t].analytical_assay=e[o][t].reduce(((e,a)=>{var n,i;const r=null!=(i=a.final_assay)?i:null!=(n=a.seller_assay)?n:a.buyer_assay;if(null==r)throw s.value=`Please provide Final, Seller or Buyer assay value for ${t} commodity in ${o} method`,new Error("[evaluateAnalyticalAssay] assay value is not defined for assay lot");const l=e+r*a.dry_weight;return console.log(`[evaluateAnalyticalAssay] evaluated analytical assay: ${l} for method=${o}, commodity=${t}; with values accumulator=${e}, assayValue=${r}, dryWeight=${a.dry_weight}`),l}),0)/a,console.log(`[evaluateAnalyticalAssay] analytical assay: ${n[t].analytical_assay}`),e[o][t].length>0&&(n[t][$]=e[o][t][0][$])}return console.log(`[evaluateAnalyticalAssay] analyticalAssay: ${JSON.stringify(n)}`),n}(H.data.data),tt=Object.keys(Q).map((t=>({commodity_name:Z[t],analytical_assay:Q[t].analytical_assay,assay_uom:Q[t][$]})));console.log(`[generateProvWeightAndAssay] assay data=${JSON.stringify(tt)}}`);const et=await l.get(`/items/navarch_weight_lot?filter[${c}]=${z}&sort[]=${u}`,{params:{fields:["id","dry_weight","wet_weight",m,"moisture","wet_weight_uom","dry_weight_uom"]}});console.log(`weightLotResponse.data.data=${JSON.stringify(et.data.data)}`),function(t){if(!t||0===t.length)throw new Error("No weight lots found for the selected parcel")}(et.data.data);const at=function(t){console.log("[evaluateWeights]");const e={};for(const a of t)e[a.method]||(console.log(`adding method ${a.method} to weightData object`),e[a.method]=[]),e[a.method.toString()].push(a);const a=[];for(const t of Object.keys(e)){if(!e[t]){console.log(`method=${t} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${t}`);const o=Y(e[t]);o&&a.push(o)}return a}(et.data.data);let ot=at.find((t=>"Outturn"===t.method));if(ot||(ot=at.find((t=>"Inturn Final"===t.method))),ot||(ot=at.find((t=>"Inturn"===t.method))),ot||(ot=at.find((t=>"Estimated"===t.method))),ot||(ot=at.find((t=>"Planned"===t.method))),!ot)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");if(void 0===ot.dry_weight||null===ot.dry_weight||void 0===ot.wet_weight||null===ot.wet_weight||void 0===ot.moisture||null===ot.moisture||void 0===ot.dry_weight_uom||null===ot.dry_weight_uom||void 0===ot.wet_weight_uom||null===ot.wet_weight_uom||void 0===ot.method||null===ot.method)throw new Error("One of the fields for weight lots is undefined");const nt=n.data.data[p];let st;nt&&(st=await l.get(`/items/navarch_vessel/${nt}`,{params:{fields:[b]}}));const it=(await l.get("/items/navarch_company",{params:{fields:[N,O,S,D,P,E,J,C,W,k,"email",x,F,j]}})).data.data,rt=it[N],lt=(await l.get(`/items/${T}/${it[W]}`,{params:{fields:[B]}})).data.data[B],dt=it[k],ct=it[S],ut=it[D]?`,\n${it[D]}`:"",mt=it[P]?`,\n${it[P]}`:"",yt=it[E]?`,\n${it[E]}`:"",gt=await l.get(`/items/${T}/${it[C]}`,{params:{fields:[I]}}),ht=gt.data.data[I]?`, ${gt.data.data[I]}`:"",ft=`${ct}${ut}${mt}${it[J]?` ${it[J]}`:""}${yt}${ht}`,_t={signatoryName:it[x],signatoryTitle:it[F],signature:it[j],company:rt},pt=await l.get(`/items/navarch_counterparty/${n.data.data[g]}`,{params:{fields:[A]}}),wt=await l.get(`/items/${G}/${n.data.data[w]}`,{params:{fields:[R,V]}}),vt=await l.get(`/items/${G}/${n.data.data[v]}`,{params:{fields:[R,V]}}),$t=n.data.data[y],At=(await l.get(`/items/navarch_commodity_in_contract?filter[${y}]=${$t}&filter[primary_commodity]=true`,{params:{fields:[M]}})).data.data[0][M],bt=null!=(t=(await l.get(`/items/${K}/${At}`,{params:{fields:[q]}})).data.data[q])?t:"",Nt={invoice_type:d.value.invoice_type,company_logo:null!=(e=it[O])?e:void 0,seller:rt,seller_address:ft,seller_phone_number:`+${lt} ${dt}`,buyer:pt.data.data[A],vessel:st?st.data.data[b]:"N/A",contract_ref:`${n.data.data[y]}`,bl_date:U(new Date(n.data.data[_])),port_of_loading:`${wt.data.data[R]}, ${wt.data.data[V]}`,port_of_discharge:`${vt.data.data[R]}, ${vt.data.data[V]}`,commodity_name:bt,wet_weight:ot.wet_weight,wet_weight_uom:ot.wet_weight_uom,dry_weight:ot.dry_weight,dry_weight_uom:ot.dry_weight_uom,moisture:ot.moisture,moisture_uom:"%",assays:tt,signatory:_t},Ot=await l.post("/generate/weight-and-assay-cert",Nt);if(200!==Ot.status)return console.log(`[generateProvWeightAndAssay] invoice response status: ${Ot.status}`),s.value=Ot.data,void(i.value=!1);const St=await async function(t){const e=function(t){console.log("[convertJsonToFormData] json=",JSON.stringify(t));const e=new FormData;for(let a in t)"file"!==a&&e.append(a,t[a]);const a=t.file,o=function(t,e){const a=atob(t),o=new ArrayBuffer(a.length),n=new Uint8Array(o);for(let t=0;t<a.length;t++)n[t]=a.charCodeAt(t);const s=new Blob([n],{type:e});return s}(a,"application/pdf");return e.append("file",o,`${t.filename_download}.pdf`),e}(t),a=await l.post("/files",e,{headers:{"Content-Type":"multipart/form-data"}});if(200!==a.status)throw console.error(`[uploadGeneratedDoc] uploadedFileData status: ${a.status}`),new Error("A failure occured while trying to upload the generated document. Please try again.");return a.data.data.id}(Ot.data);a("input",{...Nt,doc_name:St}),i.value=!1,L(St)}catch(t){console.error("[generateProvWeightAndAssay] error=",t),s.value=t,i.value=!1}},isCopying:r,copy:async function(){r.value=!0;const{id:t,user_created:e,date_created:a,user_updated:o,date_updated:n,weight_and_assay_cert:i,...c}=d.value;console.log(`[weight & assay::copy] requestBody=${JSON.stringify(c)}`);const u=await l.post("/items/navarch_weight_and_assay_cert",c);if(200!==u.status)return console.log(`[weight & assay::copy] copy response status: ${u.status}`),void(s.value=`Failed to duplicate weight & assay with status ${u.status}`);r.value=!1,window.open(`/admin/content/navarch_weight_and_assay_cert/${u.data.data.id}`)},viewPdf:L};function L(t){const a=null!=t?t:e.value.doc_name;console.log(`[viewPdf] doc ID: ${a}`),window.open(`/assets/${a}?access_token=9TKZlOUjs29Svyop45nyyyN02lYPlX_x`)}function U(t){const e=t.getDate(),a=t.getMonth(),o=t.getFullYear();return`${e} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${o}`}function Y(t){if(console.log("[evaluateWeightData]"),0===t.length)throw new Error("No weight lots found");const e=z(t,"dry_weight"),a=z(t,"wet_weight");return{method:H(t,"method"),dry_weight_uom:H(t,"dry_weight_uom"),wet_weight_uom:H(t,"wet_weight_uom"),dry_weight:e,wet_weight:a,moisture:(a-e)/a*100}}function z(t,e){return console.log("[evaluateAggregateValue]"),t.reduce(((t,a)=>{var o;return t+(null!=(o=a[e.toString()])?o:0)}),0)}function H(t,e){if(console.log("[getFirstValueAsSharedValue]"),0!==t.length)return console.log(`lots[0][${e.toString()}]=${t[0][e.toString()]}`),t[0][e.toString()]}}});const f={key:0},_={key:1};var p=[],w=[];!function(t,e){if(t&&"undefined"!=typeof document){var a,o=!0===e.prepend?"prepend":"append",n=!0===e.singleTag,s="string"==typeof e.container?document.querySelector(e.container):document.getElementsByTagName("head")[0];if(n){var i=p.indexOf(s);-1===i&&(i=p.push(s)-1,w[i]={}),a=w[i]&&w[i][o]?w[i][o]:w[i][o]=r()}else a=r();65279===t.charCodeAt(0)&&(t=t.substring(1)),a.styleSheet?a.styleSheet.cssText+=t:a.appendChild(document.createTextNode(t))}function r(){var t=document.createElement("style");if(t.setAttribute("type","text/css"),e.attributes)for(var a=Object.keys(e.attributes),n=0;n<a.length;n++)t.setAttribute(a[n],e.attributes[a[n]]);var i="prepend"===o?"afterbegin":"beforeend";return s.insertAdjacentElement(i,t),t}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),h.render=function(t,e,a,o,n,h){const p=s("v-button"),w=s("v-notice");return i(),r(l,null,[d(' <input :value="value" @input="handleChange($event.target.value)" /> '),d(" create a button only interface for Directus"),t.value?(i(),r("div",_,[c(p,{onClick:e[1]||(e[1]=()=>t.viewPdf())},{default:u((()=>[m("View Weight & Assay Cert ")])),_:1})])):(i(),r("div",f,[c(p,{onClick:e[0]||(e[0]=()=>t.generatePdf()),loading:t.isGeneraingDoc},{default:u((()=>[m("Generate Weight & Assay Cert")])),_:1},8,["loading"]),t.failureReason?(i(),y(w,{key:0},{default:u((()=>[m(g(t.failureReason),1)])),_:1})):d("v-if",!0)])),c(p,{class:"margin-top-16px",onClick:e[2]||(e[2]=()=>t.copy()),loading:t.isCopying},{default:u((()=>[m("Copy")])),_:1},8,["loading"])],64)},h.__scopeId="data-v-64969d30",h.__file="src/interface.vue";var v=e({id:"navarch-weight-n-assay-generator",name:"Weight & Assay Cert Generator",icon:"receipt_long",description:"This is a custom interface for Navarch's Weight & Assay Certificate Generator Button.",component:h,options:null,types:["json"],group:"standard"});export{v as default};
