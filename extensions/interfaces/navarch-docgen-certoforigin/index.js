import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,inject as n,ref as o,resolveComponent as i,openBlock as r,createElementBlock as d,Fragment as s,createCommentVNode as l,createVNode as c,withCtx as u,createTextVNode as g,createBlock as m,toDisplayString as _}from"vue";var f=a({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:a}){let i;var r;let d;var s;(r=i||(i={})).WET_WEIGHT="wet_weight",r.MOISTURE="moisture",r.DRY_WEIGHT="dry_weight",(s=d||(d={})).METHOD="method",s.WET_WEIGHT_UOM="wet_weight_uom",s.MOISTURE_UOM="moisture_uom",s.DRY_WEIGHT_UOM="dry_weight_uom";const l=e(),c=n("values",o({})),u=o(!1),g=o(!1);console.log("[main] formValues=",c);const m=o(null),_="name",f="line_1",h="line_2",p="city",v="state",w="country",y="zip",$="phone_code",O="phone_number",b="signatory_name",C="signatory_title",T="name",E="commodity",S="name",D="navarch_country",k="name",x="phone_code",I="contract",A="counterparty",G="weight_result",M="bl_date",N="vessel",R="origin",W="destination",j="name",U="navarch_world_port",F="port_name",H="country";return{isGeneraingDoc:u,failureReason:m,generateCertOfOrigin:async function(){var e,t;m.value=null;try{u.value=!0;const n=(await l.get("/items/navarch_company",{params:{fields:[_,f,h,p,v,y,w,$,O,"email",b,C]}})).data.data,o=n[f],i=n[h]?`,\n${n[h]}`:"",r=n[p]?`,\n${n[p]}`:"",d=n[v]?`,\n${n[v]}`:"",s={signatoryName:n[b],signatoryTitle:n[C],company:n[_]},g=(await l.get(`/items/${D}/${n[$]}`,{params:{fields:[x]}})).data.data[x],P=n[O],Y=await l.get(`/items/${D}/${n[w]}`,{params:{fields:[k]}}),q=Y.data.data[k]?`, ${Y.data.data[k]}`:"",z=`${o}${i}${r}${n[y]?` ${n[y]}`:""}${d}${q}`,K=c.value.parcel,L=await l.get(`/items/navarch_parcel/${K}`,{params:{fields:[G,I,A,"actual_arrival_date",M,"estimated_shipment_date",N,R,W]}}),Q=L.data.data[G],X=L.data.data[N];let Z;X&&(Z=await l.get(`/items/navarch_vessel/${X}`,{params:{fields:[j]}}));const ee=await l.get(`/items/${U}/${L.data.data[R]}`,{params:{fields:[F,H]}}),te=await l.get(`/items/${U}/${L.data.data[W]}`,{params:{fields:[F,H]}}),ae=await l.get(`/items/navarch_counterparty/${L.data.data[A]}`,{params:{fields:[S]}}),ne=function(e){console.log("[evaluateWeights]");const t={};for(const a of e)t[a.method]||(console.log(`adding method ${a.method} to weightData object`),t[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),t[a.method.toString()].push(a);const a=[];for(const e of Object.keys(t)){if(!t[e]){console.log(`method=${e} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${e}`);const n=J(t[e]);n&&a.push(n)}return a}((await l.get(`/items/navarch_weight_lot?filter[foreign_key]=${Q}&sort[]=lot_number`,{params:{fields:["id","dry_weight","wet_weight","method","moisture","wet_weight_uom","dry_weight_uom"]}})).data.data);let oe;if(oe||(oe=ne.find((e=>"Outturn"===e.method))),oe||(oe=ne.find((e=>"Inturn Final"===e.method))),oe||(oe=ne.find((e=>"Inturn"===e.method))),oe||(oe=ne.find((e=>"Estimated"===e.method))),oe||(oe=ne.find((e=>"Planned"===e.method))),!oe)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");const ie=L.data.data[I],re=(await l.get(`/items/navarch_commodity_in_contract?filter[${I}]=${ie}&filter[primary_commodity]=true`,{params:{fields:[E]}})).data.data[0][E],de=null!=(e=(await l.get(`/items/navarch_commodity/${re}`,{params:{fields:[T]}})).data.data[T])?e:"",se={parcel_id:K,seller:n[_],seller_address:z,seller_phone_number:`+${g} ${P}`,buyer:ae.data.data[S],vessel:Z?Z.data.data[j]:"N/A",contract_ref:`${L.data.data[I]}`,bl_date:B(new Date(L.data.data[M])),port_of_loading:`${ee.data.data[F]}, ${ee.data.data[H]}`,port_of_discharge:`${te.data.data[F]}, ${te.data.data[H]}`,wet_weight:oe.wet_weight,wet_weight_uom:oe.wet_weight_uom,country_of_origin:ee.data.data[H],commodity_name:de,other_comments:null!=(t=c.value.other_comments)?t:"",signatory:s},le=await l.post("/generate/cert-of-origin",se);if(200!==le.status)return console.log(`[generateCertOfOrigin] invoice response status: ${le.status}`),m.value="Something went wrong while generating the Cert Of Origin. Please try again.",void(u.value=!1);const ce=le.data;a("input",{...se,doc_name:ce}),u.value=!1,V(ce)}catch(e){console.error("[generateCertOfOrigin] error=",e),m.value=e,u.value=!1}},copy:async function(){g.value=!0;const{id:e,user_created:t,date_created:a,user_updated:n,date_updated:o,cert_of_origin:i,...r}=c.value;console.log(`[cert of origin::copy] requestBody=${JSON.stringify(r)}`);const d=await l.post("/items/navarch_cert_of_origin",r);if(200!==d.status)return console.log(`[cert of origin::copy] copy response status: ${d.status}`),void(m.value=`Failed to duplicate cert of origin with status ${d.status}`);g.value=!1,window.open(`/admin/content/navarch_cert_of_origin/${d.data.data.id}`)},isCopying:g,viewCertOfOrigin:V};function V(e){const a=null!=e?e:t.value.doc_name;console.log(`[viewCertOfOrigin] doc name: ${a}`);const n=`/display-doc?filepath=${encodeURIComponent(`/data/uploads/${a}.pdf`)}`;window.open(n)}function B(e){const t=e.getDate(),a=e.getMonth(),n=e.getFullYear();return`${t} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${n}`}function J(e){if(console.log("[evaluateWeightData]"),0===e.length)return;const t=P(e,"dry_weight"),a=P(e,"wet_weight");return{method:Y(e,"method"),lots:e,dry_weight_uom:Y(e,"dry_weight_uom"),wet_weight_uom:Y(e,"wet_weight_uom"),dry_weight:t,wet_weight:a,moisture:(a-t)/a*100}}function P(e,t){return console.log("[evaluateAggregateValue]"),e.reduce(((e,a)=>{var n;return e+(null!=(n=a[t.toString()])?n:0)}),0)}function Y(e,t){if(console.log("[getFirstValueAsSharedValue]"),0!==e.length)return console.log(`lots[0][${t.toString()}]=${e[0][t.toString()]}`),e[0][t.toString()]}}});const h={key:0},p={key:1};var v=[],w=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,n=!0===t.prepend?"prepend":"append",o=!0===t.singleTag,i="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(o){var r=v.indexOf(i);-1===r&&(r=v.push(i)-1,w[r]={}),a=w[r]&&w[r][n]?w[r][n]:w[r][n]=d()}else a=d();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function d(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),o=0;o<a.length;o++)e.setAttribute(a[o],t.attributes[a[o]]);var r="prepend"===n?"afterbegin":"beforeend";return i.insertAdjacentElement(r,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),f.render=function(e,t,a,n,o,f){const v=i("v-button"),w=i("v-notice");return r(),d(s,null,[l(' <input :value="value" @input="handleChange($event.target.value)" /> '),e.value?(r(),d("div",p,[c(v,{onClick:t[1]||(t[1]=()=>e.viewCertOfOrigin())},{default:u((()=>[g("View Cert Of Origin ")])),_:1})])):(r(),d("div",h,[c(v,{onClick:t[0]||(t[0]=()=>e.generateCertOfOrigin()),loading:e.isGeneraingDoc},{default:u((()=>[g("Generate Cert Of Origin")])),_:1},8,["loading"]),e.failureReason?(r(),m(w,{key:0},{default:u((()=>[g(_(e.failureReason),1)])),_:1})):l("v-if",!0)])),c(v,{class:"margin-top-16px",onClick:t[2]||(t[2]=()=>e.copy()),loading:e.isCopying},{default:u((()=>[g("Copy")])),_:1},8,["loading"])],64)},f.__scopeId="data-v-64969d30",f.__file="src/interface.vue";var y=t({id:"navarch-docgen-certoforigin",name:"Navarch Cert of Origin Generator Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Cert of Origin Generator Button.",component:f,options:null,types:["json"],group:"standard"});export{y as default};
