import{useApi as t,defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as a,inject as o,ref as n,resolveComponent as i,openBlock as r,createElementBlock as d,Fragment as s,createCommentVNode as l,createVNode as c,withCtx as u,createTextVNode as g,createBlock as m,toDisplayString as _}from"vue";var h=a({props:{value:{type:Object,default:null}},emits:["input"],setup(e,{emit:a}){let i;var r;let d;var s;(r=i||(i={})).WET_WEIGHT="wet_weight",r.MOISTURE="moisture",r.DRY_WEIGHT="dry_weight",(s=d||(d={})).METHOD="method",s.WET_WEIGHT_UOM="wet_weight_uom",s.MOISTURE_UOM="moisture_uom",s.DRY_WEIGHT_UOM="dry_weight_uom";const l=t(),c=o("values",n({})),u=n(!1);console.log("[main] formValues=",c);const g=n(null),m="name",_="line_1",h="line_2",f="city",w="state",p="country",v="zip",$="phone_code",y="phone_number",O="signatory_name",C="signatory_title",b="name",D="commodity",E="name",T="navarch_country",S="name",G="phone_code",I="contract",M="counterparty",k="weight_result",R="bl_date",W="vessel",N="origin",U="destination",j="name",x="navarch_world_port",A="port_name",H="country";return{isGeneraingDoc:u,failureReason:g,generateCertOfOrigin:async function(){var t,e;g.value=null;try{u.value=!0;const o=(await l.get("/items/navarch_company",{params:{fields:[m,_,h,f,w,v,p,$,y,"email",O,C]}})).data.data,n=o[_],i=o[h]?`,\n${o[h]}`:"",r=o[f]?`,\n${o[f]}`:"",d=o[w]?`,\n${o[w]}`:"",s={signatoryName:o[O],signatoryTitle:o[C],company:o[m]},P=(await l.get(`/items/${T}/${o[$]}`,{params:{fields:[G]}})).data.data[G],Y=o[y],B=await l.get(`/items/${T}/${o[p]}`,{params:{fields:[S]}}),z=B.data.data[S]?`, ${B.data.data[S]}`:"",q=`${n}${i}${r}${o[v]?` ${o[v]}`:""}${d}${z}`,K=c.value.parcel,L=await l.get(`/items/navarch_parcel/${K}`,{params:{fields:[k,I,M,"actual_arrival_date",R,"invoice_date","estimated_shipment_date",W,N,U]}}),Q=L.data.data[k],X=L.data.data[W];let Z;X&&(Z=await l.get(`/items/navarch_vessel/${X}`,{params:{fields:[j]}}));const tt=await l.get(`/items/${x}/${L.data.data[N]}`,{params:{fields:[A,H]}}),et=await l.get(`/items/${x}/${L.data.data[U]}`,{params:{fields:[A,H]}}),at=await l.get(`/items/navarch_counterparty/${L.data.data[M]}`,{params:{fields:[E]}}),ot=function(t){console.log("[evaluateWeights]");const e={};for(const a of t)e[a.method]||(console.log(`adding method ${a.method} to weightData object`),e[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),e[a.method.toString()].push(a);const a=[];for(const t of Object.keys(e)){if(!e[t]){console.log(`method=${t} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${t}`);const o=J(e[t]);o&&a.push(o)}return a}((await l.get(`/items/navarch_weight_lot?filter[foreign_key]=${Q}&sort[]=lot_number`,{params:{fields:["id","dry_weight","wet_weight","method","moisture","wet_weight_uom","dry_weight_uom"]}})).data.data);let nt;if(nt||(nt=ot.find((t=>"Outturn"===t.method))),nt||(nt=ot.find((t=>"Inturn Final"===t.method))),nt||(nt=ot.find((t=>"Inturn"===t.method))),nt||(nt=ot.find((t=>"Estimated"===t.method))),nt||(nt=ot.find((t=>"Planned"===t.method))),!nt)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");const it=L.data.data[I],rt=(await l.get(`/items/navarch_commodity_in_contract?filter[${I}]=${it}&filter[primary_commodity]=true`,{params:{fields:[D]}})).data.data[0][D],dt=null!=(t=(await l.get(`/items/navarch_commodity/${rt}`,{params:{fields:[b]}})).data.data[b])?t:"",st={parcel_id:K,seller:o[m],seller_address:q,seller_phone_number:`+${P} ${Y}`,buyer:at.data.data[E],vessel:Z?Z.data.data[j]:"N/A",contract_ref:`${L.data.data[I]}`,bl_date:F(new Date(L.data.data[R])),port_of_loading:`${tt.data.data[A]}, ${tt.data.data[H]}`,port_of_discharge:`${et.data.data[A]}, ${et.data.data[H]}`,wet_weight:nt.wet_weight,wet_weight_uom:nt.wet_weight_uom,country_of_origin:tt.data.data[H],commodity_name:dt,other_comments:null!=(e=c.value.other_comments)?e:"",signatory:s},lt=await l.post("/generate/cert-of-origin",st);if(200!==lt.status)return console.log(`[generateCertOfOrigin] invoice response status: ${lt.status}`),g.value="Something went wrong while generating the Cert Of Origin. Please try again.",void(u.value=!1);const ct=lt.data;a("input",{...st,doc_name:ct}),u.value=!1,V(ct)}catch(t){console.error("[generateCertOfOrigin] error=",t),g.value=t,u.value=!1}},viewCertOfOrigin:V};function V(t){const a=null!=t?t:e.value.doc_name;console.log(`[viewCertOfOrigin] doc name: ${a}`);const o=`/display-doc?filepath=${encodeURIComponent(`/data/uploads/${a}.pdf`)}`;window.open(o)}function F(t){const e=t.getDate(),a=t.getMonth(),o=t.getFullYear();return`${e} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${o}`}function J(t){if(console.log("[evaluateWeightData]"),0===t.length)return;const e=P(t,"dry_weight"),a=P(t,"wet_weight");return{method:Y(t,"method"),lots:t,dry_weight_uom:Y(t,"dry_weight_uom"),wet_weight_uom:Y(t,"wet_weight_uom"),dry_weight:e,wet_weight:a,moisture:(a-e)/a*100}}function P(t,e){return console.log("[evaluateAggregateValue]"),t.reduce(((t,a)=>{var o;return t+(null!=(o=a[e.toString()])?o:0)}),0)}function Y(t,e){if(console.log("[getFirstValueAsSharedValue]"),0!==t.length)return console.log(`lots[0][${e.toString()}]=${t[0][e.toString()]}`),t[0][e.toString()]}}});const f={key:0},w={key:1};h.render=function(t,e,a,o,n,h){const p=i("v-button"),v=i("v-notice");return r(),d(s,null,[l(' <input :value="value" @input="handleChange($event.target.value)" /> '),t.value?(r(),d("div",w,[c(p,{class:"margin-top-16px",onClick:e[1]||(e[1]=()=>t.viewCertOfOrigin())},{default:u((()=>[g("View Cert Of Origin ")])),_:1})])):(r(),d("div",f,[c(p,{class:"margin-top-16px",onClick:e[0]||(e[0]=()=>t.generateCertOfOrigin()),loading:t.isGeneraingDoc},{default:u((()=>[g("Generate Cert Of Origin")])),_:1},8,["loading"]),t.failureReason?(r(),m(v,{key:0},{default:u((()=>[g(_(t.failureReason),1)])),_:1})):l("v-if",!0)]))],2112)},h.__file="src/interface.vue";var p=e({id:"navarch-docgen-certoforigin",name:"Navarch Cert of Origin Generator Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Cert of Origin Generator Button.",component:h,options:null,types:["json"],group:"standard"});export{p as default};
