import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,inject as n,ref as o,resolveComponent as i,openBlock as r,createElementBlock as s,Fragment as d,createCommentVNode as l,createVNode as c,withCtx as u,createTextVNode as g,createBlock as m,toDisplayString as _}from"vue";var f=a({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:a}){let i;var r;let s;var d;(r=i||(i={})).WET_WEIGHT="wet_weight",r.MOISTURE="moisture",r.DRY_WEIGHT="dry_weight",(d=s||(s={})).METHOD="method",d.WET_WEIGHT_UOM="wet_weight_uom",d.MOISTURE_UOM="moisture_uom",d.DRY_WEIGHT_UOM="dry_weight_uom";const l=e(),c=n("values",o({})),u=o(!1),g=o(!1);console.log("[main] formValues=",c);const m=o(null),_="name",f="line_1",h="line_2",p="city",v="state",w="country",y="zip",$="phone_code",O="phone_number",b="signatory_name",C="signatory_title",T="signature",E="name",S="commodity",D="name",k="navarch_country",x="name",I="phone_code",A="contract",G="counterparty",M="weight_result",N="bl_date",R="vessel",W="origin",j="destination",U="name",F="navarch_world_port",H="port_name",V="country";return{isGeneraingDoc:u,failureReason:m,generateCertOfOrigin:async function(){var e,t;m.value=null;try{u.value=!0;const n=(await l.get("/items/navarch_company",{params:{fields:[_,f,h,p,v,y,w,$,O,"email",b,C,T]}})).data.data,o=n[f],i=n[h]?`,\n${n[h]}`:"",r=n[p]?`,\n${n[p]}`:"",s=n[v]?`,\n${n[v]}`:"",d={signatoryName:n[b],signatoryTitle:n[C],signature:n[T],company:n[_]},g=(await l.get(`/items/${k}/${n[$]}`,{params:{fields:[I]}})).data.data[I],Y=n[O],q=await l.get(`/items/${k}/${n[w]}`,{params:{fields:[x]}}),z=q.data.data[x]?`, ${q.data.data[x]}`:"",K=`${o}${i}${r}${n[y]?` ${n[y]}`:""}${s}${z}`,L=c.value.parcel,Q=await l.get(`/items/navarch_parcel/${L}`,{params:{fields:[M,A,G,"actual_arrival_date",N,"estimated_shipment_date",R,W,j]}}),X=Q.data.data[M],Z=Q.data.data[R];let ee;Z&&(ee=await l.get(`/items/navarch_vessel/${Z}`,{params:{fields:[U]}}));const te=await l.get(`/items/${F}/${Q.data.data[W]}`,{params:{fields:[H,V]}}),ae=await l.get(`/items/${F}/${Q.data.data[j]}`,{params:{fields:[H,V]}}),ne=await l.get(`/items/navarch_counterparty/${Q.data.data[G]}`,{params:{fields:[D]}}),oe=function(e){console.log("[evaluateWeights]");const t={};for(const a of e)t[a.method]||(console.log(`adding method ${a.method} to weightData object`),t[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),t[a.method.toString()].push(a);const a=[];for(const e of Object.keys(t)){if(!t[e]){console.log(`method=${e} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${e}`);const n=P(t[e]);n&&a.push(n)}return a}((await l.get(`/items/navarch_weight_lot?filter[foreign_key]=${X}&sort[]=lot_number`,{params:{fields:["id","dry_weight","wet_weight","method","moisture","wet_weight_uom","dry_weight_uom"]}})).data.data);let ie;if(ie||(ie=oe.find((e=>"Outturn"===e.method))),ie||(ie=oe.find((e=>"Inturn Final"===e.method))),ie||(ie=oe.find((e=>"Inturn"===e.method))),ie||(ie=oe.find((e=>"Estimated"===e.method))),ie||(ie=oe.find((e=>"Planned"===e.method))),!ie)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");const re=Q.data.data[A],se=(await l.get(`/items/navarch_commodity_in_contract?filter[${A}]=${re}&filter[primary_commodity]=true`,{params:{fields:[S]}})).data.data[0][S],de=null!=(e=(await l.get(`/items/navarch_commodity/${se}`,{params:{fields:[E]}})).data.data[E])?e:"",le={parcel_id:L,seller:n[_],seller_address:K,seller_phone_number:`+${g} ${Y}`,buyer:ne.data.data[D],vessel:ee?ee.data.data[U]:"N/A",contract_ref:`${Q.data.data[A]}`,bl_date:J(new Date(Q.data.data[N])),port_of_loading:`${te.data.data[H]}, ${te.data.data[V]}`,port_of_discharge:`${ae.data.data[H]}, ${ae.data.data[V]}`,wet_weight:ie.wet_weight,wet_weight_uom:ie.wet_weight_uom,country_of_origin:te.data.data[V],commodity_name:de,other_comments:null!=(t=c.value.other_comments)?t:"",signatory:d},ce=await l.post("/generate/cert-of-origin",le);if(200!==ce.status)return console.log(`[generateCertOfOrigin] invoice response status: ${ce.status}`),m.value="Something went wrong while generating the Cert Of Origin. Please try again.",void(u.value=!1);const ue=ce.data;a("input",{...le,doc_name:ue}),u.value=!1,B(ue)}catch(e){console.error("[generateCertOfOrigin] error=",e),m.value=e,u.value=!1}},copy:async function(){g.value=!0;const{id:e,user_created:t,date_created:a,user_updated:n,date_updated:o,cert_of_origin:i,...r}=c.value;console.log(`[cert of origin::copy] requestBody=${JSON.stringify(r)}`);const s=await l.post("/items/navarch_cert_of_origin",r);if(200!==s.status)return console.log(`[cert of origin::copy] copy response status: ${s.status}`),void(m.value=`Failed to duplicate cert of origin with status ${s.status}`);g.value=!1,window.open(`/admin/content/navarch_cert_of_origin/${s.data.data.id}`)},isCopying:g,viewCertOfOrigin:B};function B(e){const a=null!=e?e:t.value.doc_name;console.log(`[viewCertOfOrigin] doc name: ${a}`);const n=`/display-doc?filepath=${encodeURIComponent(`/data/uploads/${a}.pdf`)}`;window.open(n)}function J(e){const t=e.getDate(),a=e.getMonth(),n=e.getFullYear();return`${t} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${n}`}function P(e){if(console.log("[evaluateWeightData]"),0===e.length)return;const t=Y(e,"dry_weight"),a=Y(e,"wet_weight");return{method:q(e,"method"),lots:e,dry_weight_uom:q(e,"dry_weight_uom"),wet_weight_uom:q(e,"wet_weight_uom"),dry_weight:t,wet_weight:a,moisture:(a-t)/a*100}}function Y(e,t){return console.log("[evaluateAggregateValue]"),e.reduce(((e,a)=>{var n;return e+(null!=(n=a[t.toString()])?n:0)}),0)}function q(e,t){if(console.log("[getFirstValueAsSharedValue]"),0!==e.length)return console.log(`lots[0][${t.toString()}]=${e[0][t.toString()]}`),e[0][t.toString()]}}});const h={key:0},p={key:1};var v=[],w=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,n=!0===t.prepend?"prepend":"append",o=!0===t.singleTag,i="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(o){var r=v.indexOf(i);-1===r&&(r=v.push(i)-1,w[r]={}),a=w[r]&&w[r][n]?w[r][n]:w[r][n]=s()}else a=s();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function s(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),o=0;o<a.length;o++)e.setAttribute(a[o],t.attributes[a[o]]);var r="prepend"===n?"afterbegin":"beforeend";return i.insertAdjacentElement(r,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),f.render=function(e,t,a,n,o,f){const v=i("v-button"),w=i("v-notice");return r(),s(d,null,[l(' <input :value="value" @input="handleChange($event.target.value)" /> '),e.value?(r(),s("div",p,[c(v,{onClick:t[1]||(t[1]=()=>e.viewCertOfOrigin())},{default:u((()=>[g("View Cert Of Origin ")])),_:1})])):(r(),s("div",h,[c(v,{onClick:t[0]||(t[0]=()=>e.generateCertOfOrigin()),loading:e.isGeneraingDoc},{default:u((()=>[g("Generate Cert Of Origin")])),_:1},8,["loading"]),e.failureReason?(r(),m(w,{key:0},{default:u((()=>[g(_(e.failureReason),1)])),_:1})):l("v-if",!0)])),c(v,{class:"margin-top-16px",onClick:t[2]||(t[2]=()=>e.copy()),loading:e.isCopying},{default:u((()=>[g("Copy")])),_:1},8,["loading"])],64)},f.__scopeId="data-v-64969d30",f.__file="src/interface.vue";var y=t({id:"navarch-docgen-certoforigin",name:"Navarch Cert of Origin Generator Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Cert of Origin Generator Button.",component:f,options:null,types:["json"],group:"standard"});export{y as default};
