import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,inject as n,ref as o,resolveComponent as i,openBlock as r,createElementBlock as d,Fragment as s,createCommentVNode as l,createVNode as c,withCtx as u,createTextVNode as g,createBlock as m,toDisplayString as _}from"vue";var f=a({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:a}){let i;var r;let d;var s;(r=i||(i={})).WET_WEIGHT="wet_weight",r.MOISTURE="moisture",r.DRY_WEIGHT="dry_weight",(s=d||(d={})).METHOD="method",s.WET_WEIGHT_UOM="wet_weight_uom",s.MOISTURE_UOM="moisture_uom",s.DRY_WEIGHT_UOM="dry_weight_uom";const l=e(),c=n("values",o({})),u=o(!1),g=o(!1);console.log("[main] formValues=",c);const m=o(null),_="name",f="logo",h="line_1",p="line_2",v="city",w="state",y="country",$="zip",O="phone_code",b="phone_number",C="signatory_name",T="signatory_title",E="signature",S="name",D="commodity",k="name",x="navarch_country",I="name",A="phone_code",G="contract",M="counterparty",N="weight_result",R="bl_date",W="vessel",j="origin",U="destination",F="name",H="navarch_world_port",V="port_name",B="country";return{isGeneraingDoc:u,failureReason:m,generateCertOfOrigin:async function(){var e,t,n;m.value=null;try{u.value=!0;const o=(await l.get("/items/navarch_company",{params:{fields:[_,f,h,p,v,w,$,y,O,b,"email",C,T,E]}})).data.data,i=o[h],r=o[p]?`,\n${o[p]}`:"",d=o[v]?`,\n${o[v]}`:"",s=o[w]?`,\n${o[w]}`:"",g={signatoryName:o[C],signatoryTitle:o[T],signature:o[E],company:o[_]},q=(await l.get(`/items/${x}/${o[O]}`,{params:{fields:[A]}})).data.data[A],z=o[b],K=await l.get(`/items/${x}/${o[y]}`,{params:{fields:[I]}}),L=K.data.data[I]?`, ${K.data.data[I]}`:"",Q=`${i}${r}${d}${o[$]?` ${o[$]}`:""}${s}${L}`,X=c.value.parcel,Z=await l.get(`/items/navarch_parcel/${X}`,{params:{fields:[N,G,M,"actual_arrival_date",R,"estimated_shipment_date",W,j,U]}}),ee=Z.data.data[N],te=Z.data.data[W];let ae;te&&(ae=await l.get(`/items/navarch_vessel/${te}`,{params:{fields:[F]}}));const ne=await l.get(`/items/${H}/${Z.data.data[j]}`,{params:{fields:[V,B]}}),oe=await l.get(`/items/${H}/${Z.data.data[U]}`,{params:{fields:[V,B]}}),ie=await l.get(`/items/navarch_counterparty/${Z.data.data[M]}`,{params:{fields:[k]}}),re=function(e){console.log("[evaluateWeights]");const t={};for(const a of e)t[a.method]||(console.log(`adding method ${a.method} to weightData object`),t[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),t[a.method.toString()].push(a);const a=[];for(const e of Object.keys(t)){if(!t[e]){console.log(`method=${e} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${e}`);const n=Y(t[e]);n&&a.push(n)}return a}((await l.get(`/items/navarch_weight_lot?filter[foreign_key]=${ee}&sort[]=lot_number`,{params:{fields:["id","dry_weight","wet_weight","method","moisture","wet_weight_uom","dry_weight_uom"]}})).data.data);let de;if(de||(de=re.find((e=>"Outturn"===e.method))),de||(de=re.find((e=>"Inturn Final"===e.method))),de||(de=re.find((e=>"Inturn"===e.method))),de||(de=re.find((e=>"Estimated"===e.method))),de||(de=re.find((e=>"Planned"===e.method))),!de)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");const se=Z.data.data[G],le=(await l.get(`/items/navarch_commodity_in_contract?filter[${G}]=${se}&filter[primary_commodity]=true`,{params:{fields:[D]}})).data.data[0][D],ce=null!=(e=(await l.get(`/items/navarch_commodity/${le}`,{params:{fields:[S]}})).data.data[S])?e:"",ue={parcel_id:X,company_logo:null!=(t=o[f])?t:void 0,seller:o[_],seller_address:Q,seller_phone_number:`+${q} ${z}`,buyer:ie.data.data[k],vessel:ae?ae.data.data[F]:"N/A",contract_ref:`${Z.data.data[G]}`,bl_date:P(new Date(Z.data.data[R])),port_of_loading:`${ne.data.data[V]}, ${ne.data.data[B]}`,port_of_discharge:`${oe.data.data[V]}, ${oe.data.data[B]}`,wet_weight:de.wet_weight,wet_weight_uom:de.wet_weight_uom,country_of_origin:ne.data.data[B],commodity_name:ce,other_comments:null!=(n=c.value.other_comments)?n:"",signatory:g},ge=await l.post("/generate/cert-of-origin",ue);if(200!==ge.status)return console.log(`[generateCertOfOrigin] invoice response status: ${ge.status}`),m.value="Something went wrong while generating the Cert Of Origin. Please try again.",void(u.value=!1);const me=ge.data;a("input",{...ue,doc_name:me}),u.value=!1,J(me)}catch(e){console.error("[generateCertOfOrigin] error=",e),m.value=e,u.value=!1}},copy:async function(){g.value=!0;const{id:e,user_created:t,date_created:a,user_updated:n,date_updated:o,cert_of_origin:i,...r}=c.value;console.log(`[cert of origin::copy] requestBody=${JSON.stringify(r)}`);const d=await l.post("/items/navarch_cert_of_origin",r);if(200!==d.status)return console.log(`[cert of origin::copy] copy response status: ${d.status}`),void(m.value=`Failed to duplicate cert of origin with status ${d.status}`);g.value=!1,window.open(`/admin/content/navarch_cert_of_origin/${d.data.data.id}`)},isCopying:g,viewCertOfOrigin:J};function J(e){const a=null!=e?e:t.value.doc_name;console.log(`[viewCertOfOrigin] doc name: ${a}`);const n=`/display-doc?docname=${encodeURIComponent(`${a}.pdf`)}`;window.open(n)}function P(e){const t=e.getDate(),a=e.getMonth(),n=e.getFullYear();return`${t} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${n}`}function Y(e){if(console.log("[evaluateWeightData]"),0===e.length)return;const t=q(e,"dry_weight"),a=q(e,"wet_weight");return{method:z(e,"method"),lots:e,dry_weight_uom:z(e,"dry_weight_uom"),wet_weight_uom:z(e,"wet_weight_uom"),dry_weight:t,wet_weight:a,moisture:(a-t)/a*100}}function q(e,t){return console.log("[evaluateAggregateValue]"),e.reduce(((e,a)=>{var n;return e+(null!=(n=a[t.toString()])?n:0)}),0)}function z(e,t){if(console.log("[getFirstValueAsSharedValue]"),0!==e.length)return console.log(`lots[0][${t.toString()}]=${e[0][t.toString()]}`),e[0][t.toString()]}}});const h={key:0},p={key:1};var v=[],w=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,n=!0===t.prepend?"prepend":"append",o=!0===t.singleTag,i="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(o){var r=v.indexOf(i);-1===r&&(r=v.push(i)-1,w[r]={}),a=w[r]&&w[r][n]?w[r][n]:w[r][n]=d()}else a=d();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function d(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),o=0;o<a.length;o++)e.setAttribute(a[o],t.attributes[a[o]]);var r="prepend"===n?"afterbegin":"beforeend";return i.insertAdjacentElement(r,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),f.render=function(e,t,a,n,o,f){const v=i("v-button"),w=i("v-notice");return r(),d(s,null,[l(' <input :value="value" @input="handleChange($event.target.value)" /> '),e.value?(r(),d("div",p,[c(v,{onClick:t[1]||(t[1]=()=>e.viewCertOfOrigin())},{default:u((()=>[g("View Cert Of Origin ")])),_:1})])):(r(),d("div",h,[c(v,{onClick:t[0]||(t[0]=()=>e.generateCertOfOrigin()),loading:e.isGeneraingDoc},{default:u((()=>[g("Generate Cert Of Origin")])),_:1},8,["loading"]),e.failureReason?(r(),m(w,{key:0},{default:u((()=>[g(_(e.failureReason),1)])),_:1})):l("v-if",!0)])),c(v,{class:"margin-top-16px",onClick:t[2]||(t[2]=()=>e.copy()),loading:e.isCopying},{default:u((()=>[g("Copy")])),_:1},8,["loading"])],64)},f.__scopeId="data-v-64969d30",f.__file="src/interface.vue";var y=t({id:"navarch-docgen-certoforigin",name:"Navarch Cert of Origin Generator Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Cert of Origin Generator Button.",component:f,options:null,types:["json"],group:"standard"});export{y as default};
