import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,inject as o,ref as n,resolveComponent as r,openBlock as i,createElementBlock as s,Fragment as d,createCommentVNode as l,createVNode as c,withCtx as u,createTextVNode as g,createBlock as m,toDisplayString as f}from"vue";var _=a({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:a}){let r;var i;let s;var d;(i=r||(r={})).WET_WEIGHT="wet_weight",i.MOISTURE="moisture",i.DRY_WEIGHT="dry_weight",(d=s||(s={})).METHOD="method",d.WET_WEIGHT_UOM="wet_weight_uom",d.MOISTURE_UOM="moisture_uom",d.DRY_WEIGHT_UOM="dry_weight_uom";const l=e(),c=o("values",n({})),u=n(!1),g=n(!1);console.log("[main] formValues=",c);const m=n(null),f="name",_="logo",p="line_1",h="line_2",w="city",y="state",v="country",$="zip",O="phone_code",b="phone_number",C="signatory_name",D="signatory_title",T="signature",E="name",S="commodity",A="name",k="navarch_country",x="name",G="phone_code",N="contract",I="counterparty",j="weight_result",M="bl_date",P="vessel",F="origin",W="destination",R="name",U="navarch_world_port",B="port_name",J="country";return{isGeneraingDoc:u,failureReason:m,generateCertOfOrigin:async function(){var e,t,o;m.value=null;try{u.value=!0;const n=(await l.get("/items/navarch_company",{params:{fields:[f,_,p,h,w,y,$,v,O,b,"email",C,D,T]}})).data.data,r=n[p],i=n[h]?`,\n${n[h]}`:"",s=n[w]?`,\n${n[w]}`:"",d=n[y]?`,\n${n[y]}`:"",g={signatoryName:n[C],signatoryTitle:n[D],signature:n[T],company:n[f]},q=(await l.get(`/items/${k}/${n[O]}`,{params:{fields:[G]}})).data.data[G],z=n[b],K=await l.get(`/items/${k}/${n[v]}`,{params:{fields:[x]}}),X=K.data.data[x]?`, ${K.data.data[x]}`:"",Z=`${r}${i}${s}${n[$]?` ${n[$]}`:""}${d}${X}`,L=c.value.parcel,Q=await l.get(`/items/navarch_parcel/${L}`,{params:{fields:[j,N,I,"actual_arrival_date",M,"estimated_shipment_date",P,F,W]}}),ee=Q.data.data[j],te=Q.data.data[P];let ae;te&&(ae=await l.get(`/items/navarch_vessel/${te}`,{params:{fields:[R]}}));const oe=await l.get(`/items/${U}/${Q.data.data[F]}`,{params:{fields:[B,J]}}),ne=await l.get(`/items/${U}/${Q.data.data[W]}`,{params:{fields:[B,J]}}),re=await l.get(`/items/navarch_counterparty/${Q.data.data[I]}`,{params:{fields:[A]}}),ie=function(e){console.log("[evaluateWeights]");const t={};for(const a of e)t[a.method]||(console.log(`adding method ${a.method} to weightData object`),t[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),t[a.method.toString()].push(a);const a=[];for(const e of Object.keys(t)){if(!t[e]){console.log(`method=${e} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${e}`);const o=Y(t[e]);o&&a.push(o)}return a}((await l.get(`/items/navarch_weight_lot?filter[foreign_key]=${ee}&sort[]=lot_number`,{params:{fields:["id","dry_weight","wet_weight","method","moisture","wet_weight_uom","dry_weight_uom"]}})).data.data);let se;if(se||(se=ie.find((e=>"Outturn"===e.method))),se||(se=ie.find((e=>"Inturn Final"===e.method))),se||(se=ie.find((e=>"Inturn"===e.method))),se||(se=ie.find((e=>"Estimated"===e.method))),se||(se=ie.find((e=>"Planned"===e.method))),!se)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");const de=Q.data.data[N],le=(await l.get(`/items/navarch_commodity_in_contract?filter[${N}]=${de}&filter[primary_commodity]=true`,{params:{fields:[S]}})).data.data[0][S],ce=null!=(e=(await l.get(`/items/navarch_commodity/${le}`,{params:{fields:[E]}})).data.data[E])?e:"",ue={parcel_id:L,company_logo:null!=(t=n[_])?t:void 0,seller:n[f],seller_address:Z,seller_phone_number:`+${q} ${z}`,buyer:re.data.data[A],vessel:ae?ae.data.data[R]:"N/A",contract_ref:`${Q.data.data[N]}`,bl_date:V(new Date(Q.data.data[M])),port_of_loading:`${oe.data.data[B]}, ${oe.data.data[J]}`,port_of_discharge:`${ne.data.data[B]}, ${ne.data.data[J]}`,wet_weight:se.wet_weight,wet_weight_uom:se.wet_weight_uom,country_of_origin:oe.data.data[J],commodity_name:ce,other_comments:null!=(o=c.value.other_comments)?o:"",signatory:g},ge=await l.post("/generate/cert-of-origin",ue);if(200!==ge.status)return console.log(`[generateCertOfOrigin] invoice response status: ${ge.status}`),m.value="Something went wrong while generating the Cert Of Origin. Please try again.",void(u.value=!1);const me=await async function(e){if(!e)throw console.error("[uploadGeneratedDoc] fileData is empty"),new Error("A failure occured while trying to upload the generated document, no file data found. Please try again.");const t=function(e){console.log("[convertJsonToFormData] json=",JSON.stringify(e));const t=new FormData;for(let a in e)"file"!==a&&t.append(a,e[a]);const a=e.file,o=function(e,t){const a=atob(e),o=new ArrayBuffer(a.length),n=new Uint8Array(o);for(let e=0;e<a.length;e++)n[e]=a.charCodeAt(e);const r=new Blob([n],{type:t});return r}(a,"application/pdf");return t.append("file",o,e.filename_download),t}(e),a=await l.post("/files",t,{headers:{"Content-Type":"multipart/form-data"}});if(200!==a.status)throw console.error(`[uploadGeneratedDoc] uploadedFileData status: ${a.status}`),new Error("A failure occured while trying to upload the generated document. Please try again.");return a.data.data.id}(ge.data);a("input",{...ue,doc_name:me}),u.value=!1,H(me)}catch(e){console.error("[generateCertOfOrigin] error=",e),m.value=e,u.value=!1}},copy:async function(){g.value=!0;const{id:e,user_created:t,date_created:a,user_updated:o,date_updated:n,cert_of_origin:r,...i}=c.value;console.log(`[cert of origin::copy] requestBody=${JSON.stringify(i)}`);const s=await l.post("/items/navarch_cert_of_origin",i);if(200!==s.status)return console.log(`[cert of origin::copy] copy response status: ${s.status}`),void(m.value=`Failed to duplicate cert of origin with status ${s.status}`);g.value=!1,window.open(`/admin/content/navarch_cert_of_origin/${s.data.data.id}`)},isCopying:g,viewPdf:H};function H(e){const a=null!=e?e:t.value.doc_name;console.log(`[viewPdf] doc ID: ${a}`),window.open(`/assets/${a}?access_token=9TKZlOUjs29Svyop45nyyyN02lYPlX_x`)}function V(e){const t=e.getDate(),a=e.getMonth(),o=e.getFullYear();return`${t} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${o}`}function Y(e){if(console.log("[evaluateWeightData]"),0===e.length)return;const t=q(e,"dry_weight"),a=q(e,"wet_weight");return{method:z(e,"method"),lots:e,dry_weight_uom:z(e,"dry_weight_uom"),wet_weight_uom:z(e,"wet_weight_uom"),dry_weight:t,wet_weight:a,moisture:(a-t)/a*100}}function q(e,t){return console.log("[evaluateAggregateValue]"),e.reduce(((e,a)=>{var o;return e+(null!=(o=a[t.toString()])?o:0)}),0)}function z(e,t){if(console.log("[getFirstValueAsSharedValue]"),0!==e.length)return console.log(`lots[0][${t.toString()}]=${e[0][t.toString()]}`),e[0][t.toString()]}}});const p={key:0},h={key:1};var w=[],y=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,o=!0===t.prepend?"prepend":"append",n=!0===t.singleTag,r="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(n){var i=w.indexOf(r);-1===i&&(i=w.push(r)-1,y[i]={}),a=y[i]&&y[i][o]?y[i][o]:y[i][o]=s()}else a=s();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function s(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),n=0;n<a.length;n++)e.setAttribute(a[n],t.attributes[a[n]]);var i="prepend"===o?"afterbegin":"beforeend";return r.insertAdjacentElement(i,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),_.render=function(e,t,a,o,n,_){const w=r("v-button"),y=r("v-notice");return i(),s(d,null,[l(' <input :value="value" @input="handleChange($event.target.value)" /> '),e.value?(i(),s("div",h,[c(w,{onClick:t[1]||(t[1]=()=>e.viewPdf())},{default:u((()=>[g("View Cert Of Origin ")])),_:1})])):(i(),s("div",p,[c(w,{onClick:t[0]||(t[0]=()=>e.generateCertOfOrigin()),loading:e.isGeneraingDoc},{default:u((()=>[g("Generate Cert Of Origin")])),_:1},8,["loading"]),e.failureReason?(i(),m(y,{key:0},{default:u((()=>[g(f(e.failureReason),1)])),_:1})):l("v-if",!0)])),c(w,{class:"margin-top-16px",onClick:t[2]||(t[2]=()=>e.copy()),loading:e.isCopying},{default:u((()=>[g("Copy")])),_:1},8,["loading"])],64)},_.__scopeId="data-v-64969d30",_.__file="src/interface.vue";var v=t({id:"navarch-docgen-certoforigin",name:"Navarch Cert of Origin Generator Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Cert of Origin Generator Button.",component:_,options:null,types:["json"],group:"standard"});export{v as default};
