import{useApi as t,defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as a,inject as n,ref as o,resolveComponent as r,openBlock as i,createElementBlock as d,Fragment as s,createCommentVNode as l,createVNode as c,withCtx as u,createTextVNode as g,createBlock as m,toDisplayString as f}from"vue";var _=a({props:{value:{type:Object,default:null}},emits:["input"],setup(e,{emit:a}){let r;var i;let d;var s;(i=r||(r={})).WET_WEIGHT="wet_weight",i.MOISTURE="moisture",i.DRY_WEIGHT="dry_weight",(s=d||(d={})).METHOD="method",s.WET_WEIGHT_UOM="wet_weight_uom",s.MOISTURE_UOM="moisture_uom",s.DRY_WEIGHT_UOM="dry_weight_uom";const l=t(),c=n("values",o({})),u=o(!1),g=o(!1);console.log("[main] formValues=",c);const m=o(null),f="name",_="logo",p="line_1",h="line_2",w="city",y="state",v="country",$="zip",O="phone_code",b="phone_number",C="signatory_name",D="signatory_title",T="signature",E="name",S="commodity",A="name",k="navarch_country",x="name",G="phone_code",I="contract",N="counterparty",j="weight_result",M="bl_date",P="vessel",F="origin",R="destination",U="name",W="navarch_world_port",B="port_name",J="country";return{isGeneraingDoc:u,failureReason:m,generateCertOfOrigin:async function(){var t,e,n;m.value=null;try{u.value=!0;const o=(await l.get("/items/navarch_company",{params:{fields:[f,_,p,h,w,y,$,v,O,b,"email",C,D,T]}})).data.data,r=o[p],i=o[h]?`,\n${o[h]}`:"",d=o[w]?`,\n${o[w]}`:"",s=o[y]?`,\n${o[y]}`:"",g={signatoryName:o[C],signatoryTitle:o[D],signature:o[T],company:o[f]},z=(await l.get(`/items/${k}/${o[O]}`,{params:{fields:[G]}})).data.data[G],K=o[b],X=await l.get(`/items/${k}/${o[v]}`,{params:{fields:[x]}}),Z=X.data.data[x]?`, ${X.data.data[x]}`:"",L=`${r}${i}${d}${o[$]?` ${o[$]}`:""}${s}${Z}`,Q=c.value.parcel,tt=await l.get(`/items/navarch_parcel/${Q}`,{params:{fields:[j,I,N,"actual_arrival_date",M,"estimated_shipment_date",P,F,R]}}),et=tt.data.data[j],at=tt.data.data[P];let nt;at&&(nt=await l.get(`/items/navarch_vessel/${at}`,{params:{fields:[U]}}));const ot=await l.get(`/items/${W}/${tt.data.data[F]}`,{params:{fields:[B,J]}}),rt=await l.get(`/items/${W}/${tt.data.data[R]}`,{params:{fields:[B,J]}}),it=await l.get(`/items/navarch_counterparty/${tt.data.data[N]}`,{params:{fields:[A]}}),dt=function(t){console.log("[evaluateWeights]");const e={};for(const a of t)e[a.method]||(console.log(`adding method ${a.method} to weightData object`),e[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),e[a.method.toString()].push(a);const a=[];for(const t of Object.keys(e)){if(!e[t]){console.log(`method=${t} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${t}`);const n=q(e[t]);n&&a.push(n)}return a}((await l.get(`/items/navarch_weight_lot?filter[foreign_key]=${et}&sort[]=lot_number`,{params:{fields:["id","dry_weight","wet_weight","method","moisture","wet_weight_uom","dry_weight_uom"]}})).data.data);let st;if(st||(st=dt.find((t=>"Outturn"===t.method))),st||(st=dt.find((t=>"Inturn Final"===t.method))),st||(st=dt.find((t=>"Inturn"===t.method))),st||(st=dt.find((t=>"Estimated"===t.method))),st||(st=dt.find((t=>"Planned"===t.method))),!st)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");const lt=tt.data.data[I],ct=(await l.get(`/items/navarch_commodity_in_contract?filter[${I}]=${lt}&filter[primary_commodity]=true`,{params:{fields:[S]}})).data.data[0][S],ut=null!=(t=(await l.get(`/items/navarch_commodity/${ct}`,{params:{fields:[E]}})).data.data[E])?t:"",gt={folder_id:await H(),parcel_id:Q,company_logo:null!=(e=o[_])?e:void 0,seller:o[f],seller_address:L,seller_phone_number:`+${z} ${K}`,buyer:it.data.data[A],vessel:nt?nt.data.data[U]:"N/A",contract_ref:`${tt.data.data[I]}`,bl_date:Y(new Date(tt.data.data[M])),port_of_loading:`${ot.data.data[B]}, ${ot.data.data[J]}`,port_of_discharge:`${rt.data.data[B]}, ${rt.data.data[J]}`,wet_weight:st.wet_weight,wet_weight_uom:st.wet_weight_uom,country_of_origin:ot.data.data[J],commodity_name:ut,other_comments:null!=(n=c.value.other_comments)?n:"",signatory:g},mt=await l.post("/generate/cert-of-origin",gt);if(200!==mt.status)return console.log(`[generateCertOfOrigin] invoice response status: ${mt.status}`),m.value="Something went wrong while generating the Cert Of Origin. Please try again.",void(u.value=!1);const ft=await async function(t){if(!t)throw console.error("[uploadGeneratedDoc] fileData is empty"),new Error("A failure occured while trying to upload the generated document, no file data found. Please try again.");const e=function(t){console.log("[convertJsonToFormData] json=",JSON.stringify(t));const e=new FormData;for(let a in t)"file"!==a&&e.append(a,t[a]);const a=t.file,n=function(t,e){const a=atob(t),n=new ArrayBuffer(a.length),o=new Uint8Array(n);for(let t=0;t<a.length;t++)o[t]=a.charCodeAt(t);const r=new Blob([o],{type:e});return r}(a,"application/pdf");return e.append("file",n,t.filename_download),e}(t),a=await l.post("/files",e,{headers:{"Content-Type":"multipart/form-data"}});if(200!==a.status)throw console.error(`[uploadGeneratedDoc] uploadedFileData status: ${a.status}`),new Error("A failure occured while trying to upload the generated document. Please try again.");return a.data.data.id}(mt.data);a("input",{...gt,doc_name:ft}),u.value=!1,V(ft)}catch(t){console.error("[generateCertOfOrigin] error=",t),m.value=t,u.value=!1}},copy:async function(){g.value=!0;const{id:t,user_created:e,date_created:a,user_updated:n,date_updated:o,cert_of_origin:r,...i}=c.value;console.log(`[cert of origin::copy] requestBody=${JSON.stringify(i)}`);const d=await l.post("/items/navarch_cert_of_origin",i);if(200!==d.status)return console.log(`[cert of origin::copy] copy response status: ${d.status}`),void(m.value=`Failed to duplicate cert of origin with status ${d.status}`);g.value=!1,window.open(`/admin/content/navarch_cert_of_origin/${d.data.data.id}`)},isCopying:g,viewPdf:V};async function H(){const t=await l.get(`/folders?filter[name][_eq]=${encodeURI("Cert Of Origin")}`);return 200===t.status&&t.data&&t.data.data?0===t.data.data.length?await async function(){return(await l.post("/folders",{name:"Cert Of Origin"})).data.data.id}():t.data.data[0].id:null}function V(t){const a=null!=t?t:e.value.doc_name;console.log(`[viewPdf] doc ID: ${a}`),window.open(`/assets/${a}?access_token=9TKZlOUjs29Svyop45nyyyN02lYPlX_x`)}function Y(t){const e=t.getDate(),a=t.getMonth(),n=t.getFullYear();return`${e} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${n}`}function q(t){if(console.log("[evaluateWeightData]"),0===t.length)return;const e=z(t,"dry_weight"),a=z(t,"wet_weight");return{method:K(t,"method"),lots:t,dry_weight_uom:K(t,"dry_weight_uom"),wet_weight_uom:K(t,"wet_weight_uom"),dry_weight:e,wet_weight:a,moisture:(a-e)/a*100}}function z(t,e){return console.log("[evaluateAggregateValue]"),t.reduce(((t,a)=>{var n;return t+(null!=(n=a[e.toString()])?n:0)}),0)}function K(t,e){if(console.log("[getFirstValueAsSharedValue]"),0!==t.length)return console.log(`lots[0][${e.toString()}]=${t[0][e.toString()]}`),t[0][e.toString()]}}});const p={key:0},h={key:1};var w=[],y=[];!function(t,e){if(t&&"undefined"!=typeof document){var a,n=!0===e.prepend?"prepend":"append",o=!0===e.singleTag,r="string"==typeof e.container?document.querySelector(e.container):document.getElementsByTagName("head")[0];if(o){var i=w.indexOf(r);-1===i&&(i=w.push(r)-1,y[i]={}),a=y[i]&&y[i][n]?y[i][n]:y[i][n]=d()}else a=d();65279===t.charCodeAt(0)&&(t=t.substring(1)),a.styleSheet?a.styleSheet.cssText+=t:a.appendChild(document.createTextNode(t))}function d(){var t=document.createElement("style");if(t.setAttribute("type","text/css"),e.attributes)for(var a=Object.keys(e.attributes),o=0;o<a.length;o++)t.setAttribute(a[o],e.attributes[a[o]]);var i="prepend"===n?"afterbegin":"beforeend";return r.insertAdjacentElement(i,t),t}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),_.render=function(t,e,a,n,o,_){const w=r("v-button"),y=r("v-notice");return i(),d(s,null,[l(' <input :value="value" @input="handleChange($event.target.value)" /> '),t.value?(i(),d("div",h,[c(w,{onClick:e[1]||(e[1]=()=>t.viewPdf())},{default:u((()=>[g("View Cert Of Origin ")])),_:1})])):(i(),d("div",p,[c(w,{onClick:e[0]||(e[0]=()=>t.generateCertOfOrigin()),loading:t.isGeneraingDoc},{default:u((()=>[g("Generate Cert Of Origin")])),_:1},8,["loading"]),t.failureReason?(i(),m(y,{key:0},{default:u((()=>[g(f(t.failureReason),1)])),_:1})):l("v-if",!0)])),c(w,{class:"margin-top-16px",onClick:e[2]||(e[2]=()=>t.copy()),loading:t.isCopying},{default:u((()=>[g("Copy")])),_:1},8,["loading"])],64)},_.__scopeId="data-v-64969d30",_.__file="src/interface.vue";var v=e({id:"navarch-docgen-certoforigin",name:"Navarch Cert of Origin Generator Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Cert of Origin Generator Button.",component:_,options:null,types:["json"],group:"standard"});export{v as default};
