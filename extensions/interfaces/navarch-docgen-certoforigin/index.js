import{useApi as t,defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as a,inject as n,ref as o,resolveComponent as r,openBlock as i,createElementBlock as s,Fragment as d,createCommentVNode as l,createVNode as c,withCtx as u,createTextVNode as g,createBlock as m,toDisplayString as f}from"vue";var _=a({props:{value:{type:Object,default:null}},emits:["input"],setup(e,{emit:a}){let r;var i;let s;var d;(i=r||(r={})).WET_WEIGHT="wet_weight",i.MOISTURE="moisture",i.DRY_WEIGHT="dry_weight",(d=s||(s={})).METHOD="method",d.WET_WEIGHT_UOM="wet_weight_uom",d.MOISTURE_UOM="moisture_uom",d.DRY_WEIGHT_UOM="dry_weight_uom";const l=t(),c=n("values",o({})),u=o(!1),g=o(!1);console.log("[main] formValues=",c);const m=o(null),f="name",_="logo",h="line_1",p="line_2",w="city",v="state",y="country",$="zip",O="phone_code",b="phone_number",C="signatory_name",T="signatory_title",D="signature",S="name",E="commodity",A="name",x="navarch_country",k="name",N="phone_code",G="contract",I="counterparty",j="weight_result",M="bl_date",F="vessel",P="origin",W="destination",R="name",U="navarch_world_port",B="port_name",J="country";return{isGeneraingDoc:u,failureReason:m,generateCertOfOrigin:async function(){var t,e,n;m.value=null;try{u.value=!0;const o=(await l.get("/items/navarch_company",{params:{fields:[f,_,h,p,w,v,$,y,O,b,"email",C,T,D]}})).data.data,r=o[h],i=o[p]?`,\n${o[p]}`:"",s=o[w]?`,\n${o[w]}`:"",d=o[v]?`,\n${o[v]}`:"",g={signatoryName:o[C],signatoryTitle:o[T],signature:o[D],company:o[f]},q=(await l.get(`/items/${x}/${o[O]}`,{params:{fields:[N]}})).data.data[N],z=o[b],K=await l.get(`/items/${x}/${o[y]}`,{params:{fields:[k]}}),X=K.data.data[k]?`, ${K.data.data[k]}`:"",Z=`${r}${i}${s}${o[$]?` ${o[$]}`:""}${d}${X}`,L=c.value.parcel,Q=await l.get(`/items/navarch_parcel/${L}`,{params:{fields:[j,G,I,"actual_arrival_date",M,"estimated_shipment_date",F,P,W]}}),tt=Q.data.data[j],et=Q.data.data[F];let at;et&&(at=await l.get(`/items/navarch_vessel/${et}`,{params:{fields:[R]}}));const nt=await l.get(`/items/${U}/${Q.data.data[P]}`,{params:{fields:[B,J]}}),ot=await l.get(`/items/${U}/${Q.data.data[W]}`,{params:{fields:[B,J]}}),rt=await l.get(`/items/navarch_counterparty/${Q.data.data[I]}`,{params:{fields:[A]}}),it=function(t){console.log("[evaluateWeights]");const e={};for(const a of t)e[a.method]||(console.log(`adding method ${a.method} to weightData object`),e[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),e[a.method.toString()].push(a);const a=[];for(const t of Object.keys(e)){if(!e[t]){console.log(`method=${t} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${t}`);const n=Y(e[t]);n&&a.push(n)}return a}((await l.get(`/items/navarch_weight_lot?filter[foreign_key]=${tt}&sort[]=lot_number`,{params:{fields:["id","dry_weight","wet_weight","method","moisture","wet_weight_uom","dry_weight_uom"]}})).data.data);let st;if(st||(st=it.find((t=>"Outturn"===t.method))),st||(st=it.find((t=>"Inturn Final"===t.method))),st||(st=it.find((t=>"Inturn"===t.method))),st||(st=it.find((t=>"Estimated"===t.method))),st||(st=it.find((t=>"Planned"===t.method))),!st)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");const dt=Q.data.data[G],lt=(await l.get(`/items/navarch_commodity_in_contract?filter[${G}]=${dt}&filter[primary_commodity]=true`,{params:{fields:[E]}})).data.data[0][E],ct=null!=(t=(await l.get(`/items/navarch_commodity/${lt}`,{params:{fields:[S]}})).data.data[S])?t:"",ut={parcel_id:L,company_logo:null!=(e=o[_])?e:void 0,seller:o[f],seller_address:Z,seller_phone_number:`+${q} ${z}`,buyer:rt.data.data[A],vessel:at?at.data.data[R]:"N/A",contract_ref:`${Q.data.data[G]}`,bl_date:V(new Date(Q.data.data[M])),port_of_loading:`${nt.data.data[B]}, ${nt.data.data[J]}`,port_of_discharge:`${ot.data.data[B]}, ${ot.data.data[J]}`,wet_weight:st.wet_weight,wet_weight_uom:st.wet_weight_uom,country_of_origin:nt.data.data[J],commodity_name:ct,other_comments:null!=(n=c.value.other_comments)?n:"",signatory:g},gt=await l.post("/generate/cert-of-origin",ut);if(200!==gt.status)return console.log(`[generateCertOfOrigin] invoice response status: ${gt.status}`),m.value="Something went wrong while generating the Cert Of Origin. Please try again.",void(u.value=!1);const mt=await async function(t){const e=function(t){console.log("[convertJsonToFormData] json=",JSON.stringify(t));const e=new FormData;for(let a in t)"file"!==a&&e.append(a,t[a]);const a=t.file,n=function(t,e){const a=atob(t),n=new ArrayBuffer(a.length),o=new Uint8Array(n);for(let t=0;t<a.length;t++)o[t]=a.charCodeAt(t);const r=new Blob([o],{type:e});return r}(a,"text/csv");return e.append("file",n,t.filename_download),e}(t),a=await l.post("/files",e,{headers:{"Content-Type":"multipart/form-data"}});if(200!==a.status)throw console.error(`[uploadGeneratedDoc] uploadedFileData status: ${a.status}`),new Error("A failure occured while trying to upload the generated document. Please try again.");return a.data.data.id}(gt.data);a("input",{...ut,doc_name:mt}),u.value=!1,H(mt)}catch(t){console.error("[generateCertOfOrigin] error=",t),m.value=t,u.value=!1}},copy:async function(){g.value=!0;const{id:t,user_created:e,date_created:a,user_updated:n,date_updated:o,cert_of_origin:r,...i}=c.value;console.log(`[cert of origin::copy] requestBody=${JSON.stringify(i)}`);const s=await l.post("/items/navarch_cert_of_origin",i);if(200!==s.status)return console.log(`[cert of origin::copy] copy response status: ${s.status}`),void(m.value=`Failed to duplicate cert of origin with status ${s.status}`);g.value=!1,window.open(`/admin/content/navarch_cert_of_origin/${s.data.data.id}`)},isCopying:g,viewPdf:H};function H(t){const a=null!=t?t:e.value.doc_name;console.log(`[viewPdf] doc ID: ${a}`),window.open(`/assets/${a}?access_token=9TKZlOUjs29Svyop45nyyyN02lYPlX_x`)}function V(t){const e=t.getDate(),a=t.getMonth(),n=t.getFullYear();return`${e} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${n}`}function Y(t){if(console.log("[evaluateWeightData]"),0===t.length)return;const e=q(t,"dry_weight"),a=q(t,"wet_weight");return{method:z(t,"method"),lots:t,dry_weight_uom:z(t,"dry_weight_uom"),wet_weight_uom:z(t,"wet_weight_uom"),dry_weight:e,wet_weight:a,moisture:(a-e)/a*100}}function q(t,e){return console.log("[evaluateAggregateValue]"),t.reduce(((t,a)=>{var n;return t+(null!=(n=a[e.toString()])?n:0)}),0)}function z(t,e){if(console.log("[getFirstValueAsSharedValue]"),0!==t.length)return console.log(`lots[0][${e.toString()}]=${t[0][e.toString()]}`),t[0][e.toString()]}}});const h={key:0},p={key:1};var w=[],v=[];!function(t,e){if(t&&"undefined"!=typeof document){var a,n=!0===e.prepend?"prepend":"append",o=!0===e.singleTag,r="string"==typeof e.container?document.querySelector(e.container):document.getElementsByTagName("head")[0];if(o){var i=w.indexOf(r);-1===i&&(i=w.push(r)-1,v[i]={}),a=v[i]&&v[i][n]?v[i][n]:v[i][n]=s()}else a=s();65279===t.charCodeAt(0)&&(t=t.substring(1)),a.styleSheet?a.styleSheet.cssText+=t:a.appendChild(document.createTextNode(t))}function s(){var t=document.createElement("style");if(t.setAttribute("type","text/css"),e.attributes)for(var a=Object.keys(e.attributes),o=0;o<a.length;o++)t.setAttribute(a[o],e.attributes[a[o]]);var i="prepend"===n?"afterbegin":"beforeend";return r.insertAdjacentElement(i,t),t}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),_.render=function(t,e,a,n,o,_){const w=r("v-button"),v=r("v-notice");return i(),s(d,null,[l(' <input :value="value" @input="handleChange($event.target.value)" /> '),t.value?(i(),s("div",p,[c(w,{onClick:e[1]||(e[1]=()=>t.viewPdf())},{default:u((()=>[g("View Cert Of Origin ")])),_:1})])):(i(),s("div",h,[c(w,{onClick:e[0]||(e[0]=()=>t.generateCertOfOrigin()),loading:t.isGeneraingDoc},{default:u((()=>[g("Generate Cert Of Origin")])),_:1},8,["loading"]),t.failureReason?(i(),m(v,{key:0},{default:u((()=>[g(f(t.failureReason),1)])),_:1})):l("v-if",!0)])),c(w,{class:"margin-top-16px",onClick:e[2]||(e[2]=()=>t.copy()),loading:t.isCopying},{default:u((()=>[g("Copy")])),_:1},8,["loading"])],64)},_.__scopeId="data-v-64969d30",_.__file="src/interface.vue";var y=e({id:"navarch-docgen-certoforigin",name:"Navarch Cert of Origin Generator Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Cert of Origin Generator Button.",component:_,options:null,types:["json"],group:"standard"});export{y as default};
