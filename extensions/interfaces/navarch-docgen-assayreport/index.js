import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,inject as n,ref as r,resolveComponent as o,resolveDirective as i,openBlock as s,createElementBlock as l,Fragment as d,createElementVNode as u,withDirectives as c,createBlock as p,withCtx as f,createTextVNode as v,toDisplayString as y,createCommentVNode as g}from"vue";const m="navarch_assay_report",h="avg",_={[h]:"",parcel:"Parcel",lot_number:"Lot Number",commodity:"Commodity",method:"Method",dry_weight:"Dry Weight",dry_weight_uom:"Dry Weight UOM",assay_uom:"Assay UOM",contained_metal_uom:"Contained Metal UOM",seller_assay:"Seller Assay",contained_seller_weight:"Contained Metal (Seller)",buyer_assay:"Buyer Assay",contained_buyer_weight:"Contained Metal (Buyer)",difference:"Difference",contained_difference_weight:"Contained Metal (Difference)",splitting_limit:"Splitting Limit",umpire_assay:"Umpire Assay",to_umpire:"To Umpire",umpire_name:"Umpire Name",losing_party:"Losing Party",final_assay:"Final Assay"},w="contained_metal_uom",$="contained_seller_weight",b="contained_buyer_weight",C="contained_difference_weight",A="id",M="related_parcel",D="lot_number",U="method",k="contract",x="shipment_code",N="commodity",B="dry_weight",E="dry_weight_uom",R="difference",O="splitting_limit",S="seller_assay",F="buyer_assay",W="umpire_assay",I="assay_uom",j="final_assay",T="code",V="commodity",L="contract",G="payable_metal_uom",P="unit",z="symbol",q="parcel",J={dwt:1.5551739,g:1,kg:1e3,kt:1e9,mt:1e6,mg:.001,Mt:1e12,lb:453.59238,st:907185,t:1e6,oz:31.103477},H={"kg(d)":"kg",dkt:"kt",dmt:"mt",dmg:"mg",dMt:"Mt",dt:"t"},K={Dwt:["dwt","t"],"g/t":["g","t"],"oz/t":["oz","t"],ppb:["g","t"],ppm:["kg","t"]};function Q(e){return null==e}function X(e,t=2,a=!1){if(null==e||isNaN(e))return null;const n=a&&e<0;return n&&(e*=-1),Math.round(e*Math.pow(10,t))/Math.pow(10,t)*(n?-1:1)}function Y(e,t=2,a=!0){if(isNaN(e)||null==e)return"-";const n=Math.round(e*Math.pow(10,t))/Math.pow(10,t),[r,o]=n.toString().split("."),i=r?r.replace(/\B(?=(\d{3})+(?!\d))/g,","):"0";if(!o&&!a)return i;return`${i}.${(null!=o?o:"").padEnd(t,"0")}`}function Z(e,t,a=!0){var n,r;if(e===t)return{conversionValue:1,isConvertByMultiplication:!0};const o=J[e],i=J[t];return o<i?{conversionValue:a?null!=(n=X(i/o,4))?n:1:i/o,isConvertByMultiplication:!1}:{conversionValue:a?null!=(r=X(o/i,4))?r:1:o/i,isConvertByMultiplication:!0}}function ee(e,t,a){if(void 0===e||void 0===t||null===e||null===t)return;const n=e.split("/"),r=t.split("/");if(n.length>2||r.length>2)throw new Error(`[getConversionUnit] sourceUnit=${e} and targetUnit=${t} must be in the format of 'unit1/unit2', an extra '/' was found`);if(1===n.length&&1===r.length)return a?`${r[0]}/${n[0]}`:`${n[0]}/${r[0]}`;if(1===n.length){const e=r[0]===n[0]?"":`${r[1]}(${n[1]})`,t=r[1];return""===t?a?e:`/${e}`:a?`${e}/${t}`:`${t}/${e}`}if(1===r.length){const e=n[1],t=n[0]===r[0]?"":`${n[1]}(${r[0]})`;return""===t?a?e:`/${e}`:a?`${e}/${t}`:`${t}/${e}`}{const e=n[0]===r[0],t=n[1]===r[1],o=e||""===n[0],i=e||""===r[0],s=t||""===n[1],l=t||""===r[1],d=!s&&!i,u=!o&&!l,c=`${s?"":n[1]}${d?"(":""}${i?"":`${r[0]}`}${d?")":""}`,p=`${o?"":n[0]}${u?"(":""}${l?"":`${r[1]}`}${u?")":""}`;return""===p?a?c:`/${c}`:a?`${c}/${p}`:`${p}/${c}`}}var te=a({props:{value:{type:String,default:null}},emits:["input"],setup(t,{emit:a}){const o=e(),i=n("values",r({})),s=r(!1),l=r(!1),d=r(null),u=r(t.value);return{documentData:u,generateDocument:async function(){s.value=!0,d.value=null;try{const{filter_date:e,start_date:t,end_date:a}=i.value;if(!e||!t||!a)return d.value="Please provide valid dates for all fields.",void(s.value=!1);let n;if("invoice_date"===e){const r=await o.get("/items/navarch_invoices",{params:{fields:[q],filter:{[e]:{_between:[t,a]}},limit:-1}});if(200!==r.status)return void(d.value="Failed to fetch parcel data, please try again.");if(!r.data.data||0===r.data.data.length)return d.value="No invoices found with Invoice Dates that fall within the selected date range.",void(s.value=!1);n={[A]:{_in:r.data.data.map(e=>e[q])}}}else{let r=!1,o="INVALID_FIELD_NAME";switch(e){case"bl_date":o="estimated_shipment_date",r=!0;break;case"actual_arrival_date":o="estimate_arrival_date",r=!0}n=r?{_or:[{[e]:{_between:[t,a]}},{_and:[{[e]:{_null:!0}},{[o]:{_between:[t,a]}}]}]}:{[e]:{_between:[t,a]}}}const r=await o.get("/items/navarch_parcel",{params:{fields:[A,x,k],filter:n,limit:-1}});if(200!==r.status)return void(d.value="Failed to fetch parcel data, please try again.");if(!r.data.data||0===r.data.data.length)return d.value="No parcels found that falls in the provided date range for the selected filter date.",void(s.value=!1);console.log(`[navarch-docgen-assayreport::generateDocument] ${r.data.data.length} parcels found with ${e} in the selected date range.`);const l=await o.get("/items/navarch_assay_lot",{params:{fields:[M,D,N,U,B,E,I,S,F,R,O,"to_umpire",W,"umpire_name","losing_party",j],filter:{[M]:{_in:r.data.data.map(e=>e[A])}},sort:[M,N,D],limit:-1}});if(200!==l.status)return void(d.value="Failed to fetch assay data, please try again.");if(!l.data.data||0===l.data.data.length)return d.value="No assay data found for the parcels in the provided date range for the selected filter date.",void(s.value=!1);const f=r.data.data.reduce((e,t)=>(e[t[A]]=t[x],e),{}),v={},y={},g=new Set,J=new Set;for(const e of r.data.data){const t=e[k];if(v[e[A]]=e[k],!y[t]){y[t]={};const e=await o.get("/items/navarch_commodity_in_contract",{params:{filter:{[L]:{_eq:t}},fields:[V,G]}});for(const a of e.data.data)y[t][a[V]]=a[G],J.add(a[V]),g.add(a[G])}}const K=(await o.get("/items/navarch_commodity",{params:{fields:[A,T],filter:{id:{_in:Array.from(J)}},limit:-1}})).data.data.reduce((e,t)=>(e[t[T]]=t[A],e),{}),X=(await o.get("/items/navarch_unit",{params:{filter:{[P]:{_in:Array.from(g)}},fields:[P,z]}})).data.data.reduce((e,t)=>(e[t[P]]=t[z],e),{}),Z=function(e){if(!Array.isArray(e)||0===e.length)return console.warn(`[navarch-docgen-assayreport::cleanUpAssayData] No assay data found or invalid format. Data=${JSON.stringify(e)}`),[];const t=Object.keys(_);return e.map(e=>{const a={};for(const n of t)Q(e[n])?a[n]="":a[n]=n!==B&&n!==S&&n!==$&&n!==F&&n!==b&&n!==R&&n!==C&&n!==O&&n!==W&&n!==j?e[n]:Y(e[n],4,!0);return""===a[D]&&(a[h]="Average"),a})}(function(e){const t=e.reduce((e,t)=>{const a=t[M];return e[a]?e[a].push(t):e[a]=[t],e},{});let a;for(const e in t){const n=t[e];if(n.find(e=>"Outturn"===e[U]))a="Outturn";else if(n.find(e=>"Inturn Final"===e[U]))a="Inturn Final";else if(n.find(e=>"Inturn"===e[U]))a="Inturn";else if(n.find(e=>"Planned"===e[U]))a="Planned";else{if(!n.find(e=>"Estimated"===e[U]))throw new Error(`Unknown assay method found: ${n[0][U]}`);a="Estimated"}t[e]=n.filter(e=>e[U]===a),a=void 0}return Object.values(t).flat()}(l.data.data).map(e=>{var t,a,n,r,o,i;const{related_parcel:s,...l}=e,d=null!=(t=H[l[E]])?t:l[E],u=null!=(a=v[s])?a:-1,p=null!=(n=K[l[N]])?n:-1,g=null!=(i=X[null!=(o=null==(r=y[u])?void 0:r[p])?o:""])?i:"oz";return{[h]:"",parcel:f[s],[w]:g,[$]:c(l[B],d,g,l[S],l[I]),[b]:c(l[B],d,g,l[F],l[I]),[C]:c(l[B],d,g,l[R],l[I]),...l}}));if(u.value=Z,i.value[A]){const{id:e,user_created:t,date_created:a,user_updated:n,date_updated:r,...s}=i.value,l=await o.patch(`/items/${m}/${e}`,{...s,assay_report:u.value});if(200!==l.status)return console.log(`[navarch-docgen-assayreport::generateDocument] update response status: ${l.status}`),void(d.value=`Failed to update assay report with status ${l.status}`)}else{const e=await o.post(`/items/${m}`,{...i.value,assay_report:u.value});if(200!==e.status)return console.log(`[navarch-docgen-assayreport::generateDocument] create response status: ${e.status}`),void(d.value=`Failed to create assay report with status ${e.status}`);const{id:t}=e.data.data;window.open(`/admin/content/${m}/${t}`)}p(Z)}catch(e){console.error("[navarch-docgen-assayreport::generateDocument] Error generating document:",e),d.value=`Error generating document: ${e}`}finally{s.value=!1}},downloadDoc:p,copy:async function(){l.value=!0;const{id:e,user_created:t,date_created:a,user_updated:n,date_updated:r,assay:s,...u}=i.value;console.log(`[navarch-docgen-assayreport::copy] requestBody=${JSON.stringify(u)}`);const c=await o.post("/items/navarch_assay_report",u);if(200!==c.status)return console.log(`[navarch-docgen-assayreport::copy] copy response status: ${c.status}`),void(d.value=`Failed to duplicate assay report with status ${c.status}`);l.value=!1,window.open(`/admin/content/navarch_assay_report/${c.data.data.id}`)},clearDocument:function(){u.value=null,d.value=null,a("input",null)},isGeneraingDoc:s,isCopying:l,failureReason:d};function c(e,t,a,n,r){const o=function(e,t,a,n=!0){if("%"===e){if(t===a)return{initialAssayConversion:{conversionValue:100,isConvertByMultiplication:!1}};const e=Z(t,a);return e.conversionUOM=ee(t,a,e.isConvertByMultiplication),{finalWeightConversion:e}}let r=e.split("/");if(1===r.length&&(r=K[e],!r))throw new Error(`[getConversionFactorForAssayUnitToMultiplySourceWeightUnitIntoTargetWeightUnit] assay unit composition for assayUnit=${e} is undefined`);if(2!==r.length)throw new Error(`[getConversionFactorForAssayUnitToMultiplySourceWeightUnitIntoTargetWeightUnit] assay unit composition for assayUnit=${e} must be in the format of 'weightUnit1/weightUnit2'`);const[o,i]=r,s={};return i!==t&&(s.initialAssayConversion=Z(t,i,n),s.initialAssayConversion.conversionUOM=ee(t,i,s.initialAssayConversion.isConvertByMultiplication)),o!==t&&(s.finalWeightConversion=Z(o,a,n),s.finalWeightConversion.conversionUOM=ee(o,a,s.finalWeightConversion.isConvertByMultiplication)),s}(r,t,a);if(Q(e)||Q(n))return null;let i=e*n;return o.initialAssayConversion&&(o.initialAssayConversion.isConvertByMultiplication?i*=o.initialAssayConversion.conversionValue:i/=o.initialAssayConversion.conversionValue),o.finalWeightConversion&&(o.finalWeightConversion.isConvertByMultiplication?i*=o.finalWeightConversion.conversionValue:i/=o.finalWeightConversion.conversionValue),X(i,4)}function p(e){try{const t=function(e){const t=[],a=Object.keys(e[0]);t.push(a.map(e=>_[e]).join(","));for(const n of e){const e=a.map(e=>`"${String(n[e]).replace(/"/g,'\\"')}"`);t.push(e.join(","))}return t.join("\n")}(null!=e?e:u.value),a=i.value.start_date,n=i.value.end_date;!function(e,t){const a=new Blob([e],{type:"text/csv"}),n=URL.createObjectURL(a),r=document.createElement("a");r.href=n,r.download=`${t}.csv`,document.body.appendChild(r),r.click(),document.body.removeChild(r)}(t,`Assay Report - ${i.value.filter_date} - ${a} ~ ${n}`)}catch(e){console.error("Error downloading Assay Report:",e),d.value="Error downloading Assay Report: "+e}}}});const ae={class:"margin-top-16px"};var ne=[],re=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,n=!0===t.prepend?"prepend":"append",r=!0===t.singleTag,o="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(r){var i=ne.indexOf(o);-1===i&&(i=ne.push(o)-1,re[i]={}),a=re[i]&&re[i][n]?re[i][n]:re[i][n]=s()}else a=s();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function s(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),r=0;r<a.length;r++)e.setAttribute(a[r],t.attributes[a[r]]);var i="prepend"===n?"afterbegin":"beforeend";return o.insertAdjacentElement(i,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}\n.margin-left-16px[data-v-64969d30] {\n  margin-left: 16px;\n}\n.secondary-button[data-v-64969d30] {\n  --v-button-background-color: var(--background-page);\n  --v-button-color: var(--primary);\n  border: 1px solid var(--primary);\n  border-radius: var(--border-radius);\n}\n.secondary-button[data-v-64969d30]:disabled {\n  border-radius: var(--border-radius);\n}\n.secondary-button[data-v-64969d30]:hover {\n  border-color: var(--v-button-background-color-hover);\n  --v-button-color: inherit;\n}",{}),te.render=function(e,t,a,n,r,m){const h=o("v-button"),_=o("v-notice"),w=i("tooltip");return s(),l(d,null,[u("div",ae,[e.documentData?c((s(),p(h,{key:1,onClick:t[1]||(t[1]=()=>e.downloadDoc(e.documentData))},{default:f(()=>[v(" Download Assay Report ")]),_:1})),[[w,"Download the Assay Report."]]):c((s(),p(h,{key:0,onClick:t[0]||(t[0]=()=>e.generateDocument()),loading:e.isGeneraingDoc},{default:f(()=>[v(" Generate & Save Assay Report ")]),_:1},8,["loading"])),[[w,"Generate and saves the Assay Report based on the selected date range for the selected filter date. Valid dates must be provided for start and end dates."]]),c((s(),p(h,{class:"margin-left-16px secondary-button",onClick:t[2]||(t[2]=()=>e.copy()),loading:e.isCopying},{default:f(()=>[v("Copy")]),_:1},8,["loading"])),[[w,"Create a copy of this form with all the fields except the Assay Report. To regenerate another Assay Report with minor changes to the input data."]]),c((s(),p(h,{class:"margin-left-16px secondary-button",onClick:t[3]||(t[3]=()=>e.clearDocument())},{default:f(()=>[v("Clear")]),_:1})),[[w,"Clear the generated Assay Report (if already generated) to regenerate again."]])]),e.failureReason?(s(),p(_,{key:0,class:"margin-top-16px"},{default:f(()=>[v(y(e.failureReason),1)]),_:1})):g("v-if",!0)],64)},te.__scopeId="data-v-64969d30",te.__file="src/interface.vue";var oe=t({id:"navarch-docgen-assayreport",name:"Navarch Assay Report Generator Button",icon:"receipt_long",description:"Navarch Assay Report Generator Button",component:te,options:null,types:["json"],group:"standard"});export{oe as default};
