import{useApi as e,defineInterface as o}from"@directus/extensions-sdk";import{defineComponent as t,inject as n,ref as i,resolveComponent as r,openBlock as a,createElementBlock as c,Fragment as l,createBlock as d,withCtx as s,createTextVNode as u,createCommentVNode as p}from"vue";const f="navarch_invoices",m="invoice",v="invoice_date",y="parcel",g="invoice_type",h=["Provisional","Final"],w="start_date",_="end_date",D={commodity:"Commodity",parcelReference:"Parcel",blDate:"B/L Date",invoiceDate:"Invoice Date",invoicePrior:"Invoice Prior",duringPeriod:"During Period",difference:"Difference",total:"Total"};function R(e,o=2,t=!1){if(null==e||isNaN(e))return null;const n=t&&e<0;return n&&(e*=-1),Math.round(e*Math.pow(10,o))/Math.pow(10,o)*(n?-1:1)}function P(e,o=2,t=!0){if(isNaN(e)||null==e)return"-";const n=Math.round(e*Math.pow(10,o))/Math.pow(10,o),[i,r]=n.toString().split("."),a=i?i.replace(/\B(?=(\d{3})+(?!\d))/g,","):"0";if(!r&&!t)return a;return`${a}.${(null!=r?r:"").padEnd(o,"0")}`}var b=t({props:{value:{type:String,default:null}},emits:["input"],setup(o,{emit:t}){const r=e(),a=n("values",i({})),c=i(!1);return{generateDocument:async function(){var e,o,n,i,d;c.value=!0;const s=new Date(a.value[w]),u=new Date(a.value[_]);if(!s||!u)return;const p=await async function(e,o){const t=await r.get(`/items/${f}`,{params:{filter:{[v]:{_between:[e,o]},[g]:{_in:h},[m]:{_nnull:!0}},limit:-1,fields:[m,v,y,g]}});if(0===t.data.length)return[];const n=t.data.data,i=n.reduce(((e,o)=>{if(e[o[y]]||(e[o[y]]={}),e[o[y]][o[g]]){const t=e[o[y]][o[g]][v],n=o[v];new Date(t)<new Date(n)&&(e[o[y]][o[g]]=o)}else e[o[y]][o[g]]=o;return e}),{}),a=n.filter((e=>"Final"===e[g])).map((e=>e[y])),c=(await r.get(`/items/${f}`,{params:{filter:{[g]:{_eq:"Provisional"},[y]:{_in:a},[m]:{_nnull:!0}},limit:-1,fields:[m,v,y,g]}})).data.data;for(const e of c)if(i[e[y]][e[g]]){const o=i[e[y]][e[g]][v],t=e[v];new Date(o)<new Date(t)&&(i[e[y]][e[g]]=e)}else i[e[y]][e[g]]=e;return i}(s,u),D=[],b={};for(const t of Object.keys(p)){const r=p[t];if(r.Final&&r.Provisional){const t=r.Final[m],i=r.Provisional[m];for(const r of t.commodities){const a=null!=(e=R(i.dry_weight,4))?e:0,c=null!=(o=R(t.dry_weight,4))?o:0,l=null!=(n=R(c-a,4))?n:0;D.push({commodity:r.commodity,parcelReference:t.parcel,blDate:t.bl_date,invoiceDate:t.invoice_date,invoicePrior:P(a,4),duringPeriod:P(c,4),difference:P(l,4),total:""}),b[r.commodity]?b[r.commodity]+=null!=l?l:0:b[r.commodity]=l}}else if(!r.Final&&r.Provisional){const e=r.Provisional[m];for(const o of e.commodities)D.push({commodity:o.commodity,parcelReference:e.parcel,blDate:e.bl_date,invoiceDate:e.invoice_date,invoicePrior:"",duringPeriod:e.dry_weight,difference:e.dry_weight,total:""}),b[o.commodity]?b[o.commodity]+=null!=(d=R(e.dry_weight,4))?d:0:b[o.commodity]=null!=(i=R(e.dry_weight,4))?i:0}else r.Final&&!r.Provisional&&console.error(`Final invoice found without Provisional invoice for parcel #${t}. This should not happen.`)}D.push(...Object.keys(b).map((e=>b[e]?{commodity:e,parcelReference:"",blDate:"",invoiceDate:"",invoicePrior:"",duringPeriod:"",difference:"",total:P(b[e],4)}:null)).filter((e=>!!e))),D.sort(((e,o)=>e.commodity<o.commodity?-1:e.commodity>o.commodity||""===e.parcelReference?1:""===o.parcelReference||e.parcelReference<o.parcelReference?-1:e.parcelReference>o.parcelReference?1:0)),t("input",D),c.value=!1,l(D)},downloadDoc:l,isGeneraingDoc:c};function l(e){const t=function(e){const o=[],t=Object.keys(e[0]);o.push(t.map((e=>D[e])).join(","));for(const n of e){const e=t.map((e=>`"${String(n[e]).replace(/"/g,'\\"')}"`));o.push(e.join(","))}return o.join("\n")}(null!=e?e:o.value);!function(e,o){const t=new Blob([e],{type:"text/csv"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download=`${o}.csv`,document.body.appendChild(i),i.click(),document.body.removeChild(i)}(t,`Royalty Report ${a.value[w]} - ${a.value[_]}`)}}});b.render=function(e,o,t,n,i,f){const m=r("v-button");return a(),c(l,null,[e.value?(a(),d(m,{key:1,onClick:o[1]||(o[1]=()=>e.downloadDoc(e.value))},{default:s((()=>[u(" Download Royalty Report ")])),_:1})):(a(),d(m,{key:0,onClick:o[0]||(o[0]=()=>e.generateDocument()),loading:e.isGeneraingDoc},{default:s((()=>[u(" Generate Royalty Report ")])),_:1},8,["loading"])),p(' <v-button\n\t\tclass="margin-top-16px"\n\t\t@click="() => copy()"\n\t\t:loading="isCopying"\n\t>Copy</v-button> ')],2112)},b.__file="src/interface.vue";var k=o({id:"navarch-docgen-royaltyreport",name:"Navarch Royalty Report Generator Button",icon:"receipt_long",description:"Navarch Royalty Report Generator Button",component:b,options:null,types:["json"],group:"standard"});export{k as default};
