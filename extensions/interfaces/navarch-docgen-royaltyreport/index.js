import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,inject as o,ref as n,resolveComponent as r,resolveDirective as i,openBlock as l,createElementBlock as c,Fragment as d,createElementVNode as s,withDirectives as u,createBlock as p,withCtx as y,createTextVNode as m,toDisplayString as v,createCommentVNode as f}from"vue";const g="navarch_invoices",h="invoice",b="invoice_date",_="parcel",w="invoice_type",R="navarch_royalty_report",D=["Provisional","Final"],P="start_date",$="end_date",x={commodity:"Commodity",parcelReference:"Parcel",invoiceDate:"Invoice Date",priorBlDate:"Prior B/L Date",invoicePrior:"Invoice Prior",priorPayableWeight:"Prior Payable Weight",blDate:"B/L Date",duringPeriod:"During Period",payableWeight:"Payable Weight",difference:"Difference",total:"Total"};function k(e,t=2,a=!1){if(null==e||isNaN(e))return null;const o=a&&e<0;return o&&(e*=-1),Math.round(e*Math.pow(10,t))/Math.pow(10,t)*(o?-1:1)}function C(e,t=2,a=!0){if(isNaN(e)||null==e)return"-";const o=Math.round(e*Math.pow(10,t))/Math.pow(10,t),[n,r]=o.toString().split("."),i=n?n.replace(/\B(?=(\d{3})+(?!\d))/g,","):"0";if(!r&&!a)return i;return`${i}.${(null!=r?r:"").padEnd(t,"0")}`}var B=a({props:{value:{type:String,default:null}},emits:["input"],setup(t,{emit:a}){const r=e(),i=o("values",n({})),l=n(!1),c=n(!1),d=n(null),s=n(t.value);return{documentData:s,generateDocument:async function(){var e,t,a,o,n,c,p,y,m;l.value=!0;try{const l=new Date(i.value[P]),v=new Date(i.value[$]);if(!l||!v)return void(d.value="Invalid date range provided. Please select valid start and end dates.");const f=await async function(e,t){const a=await r.get(`/items/${g}`,{params:{filter:{[b]:{_between:[e,t]},[w]:{_in:D},[h]:{_nnull:!0},[_]:{_nnull:!0}},limit:-1,fields:[h,b,_,w]}});if(0===a.data.length)return[];const o=a.data.data,n=o.reduce(((e,t)=>{if(e[t[_]]||(e[t[_]]={}),e[t[_]][t[w]]){const a=e[t[_]][t[w]][b],o=t[b];new Date(a)<new Date(o)&&(e[t[_]][t[w]]=t)}else e[t[_]][t[w]]=t;return e}),{}),i=o.filter((e=>"Final"===e[w])).map((e=>e[_])),l=(await r.get(`/items/${g}`,{params:{filter:{[w]:{_eq:"Provisional"},[_]:{_in:i},[h]:{_nnull:!0}},limit:-1,fields:[h,b,_,w]}})).data.data;for(const e of l)if(n[e[_]][e[w]]){const t=n[e[_]][e[w]][b],a=e[b];new Date(t)<new Date(a)&&(n[e[_]][e[w]]=e)}else n[e[_]][e[w]]=e;return n}(l,v),x=[],B={};for(const r of Object.keys(f)){const i=f[r];if(i.Final&&i.Provisional){const r=i.Final[h],l=i.Provisional[h];for(const i of r.commodities){const d=null!=(e=k(l.dry_weight,4))?e:0,s=l.commodities.find((e=>e.commodity===i.commodity)),u=null!=(t=k(null==s?void 0:s.payable_metal,4))?t:0,p=null!=(a=k(r.dry_weight,4))?a:0,y=null!=(o=k(i.payable_metal,4))?o:0,m=null!=(n=i.payable_metal_uom)?n:"",v=null!=(c=k(p-d,4))?c:0;x.push({commodity:i.commodity,parcelReference:r.parcel,invoiceDate:r.invoice_date,priorBlDate:l.bl_date,invoicePrior:C(d,4),priorPayableWeight:C(u,4)+m,blDate:r.bl_date,duringPeriod:C(p,4),payableWeight:C(y,4)+m,difference:C(v,4),total:""}),B[i.commodity]?B[i.commodity]+=null!=v?v:0:B[i.commodity]=v}}else if(!i.Final&&i.Provisional){const e=i.Provisional[h];for(const t of e.commodities){const a=null!=(p=t.payable_metal_uom)?p:"";x.push({commodity:t.commodity,parcelReference:e.parcel,invoiceDate:e.invoice_date,priorBlDate:"",invoicePrior:"",priorPayableWeight:"",blDate:e.bl_date,duringPeriod:C(e.dry_weight,4),payableWeight:C(t.payable_metal,4)+a,difference:C(e.dry_weight,4),total:""}),B[t.commodity]?B[t.commodity]+=null!=(m=k(e.dry_weight,4))?m:0:B[t.commodity]=null!=(y=k(e.dry_weight,4))?y:0}}else i.Final&&!i.Provisional&&console.error(`Final invoice found without Provisional invoice for parcel #${r}. This should not happen.`)}if(x.push(...Object.keys(B).map((e=>B[e]?{commodity:e,parcelReference:"",invoiceDate:"",priorBlDate:"",invoicePrior:"",priorPayableWeight:"",blDate:"",duringPeriod:"",payableWeight:"",difference:"",total:C(B[e],4)}:null)).filter((e=>!!e))),x.sort(((e,t)=>e.commodity<t.commodity?-1:e.commodity>t.commodity||""===e.parcelReference?1:""===t.parcelReference||e.parcelReference<t.parcelReference?-1:e.parcelReference>t.parcelReference?1:0)),s.value=x,i.value.id){const{id:e,user_created:t,date_created:a,user_updated:o,date_updated:n,...l}=i.value,c=await r.patch(`/items/${R}/${e}`,{...l,royalty_report:x});if(200!==c.status)return console.log(`[navarch-docgen-royaltyreport::generateDocument] update response status: ${c.status}`),void(d.value=`Failed to update royalty report with status ${c.status}`)}else{const e=await r.post(`/items/${R}`,{...i.value,royalty_report:x});if(200!==e.status)return console.log(`[navarch-docgen-royaltyreport::generateDocument] create response status: ${e.status}`),void(d.value=`Failed to create royalty report with status ${e.status}`);const{id:t}=e.data.data;window.open(`/admin/content/${R}/${t}`)}u(x)}catch(e){console.error("Error generating Royalty Report:",e)}finally{l.value=!1}},downloadDoc:u,copy:async function(){c.value=!0;const{id:e,user_created:t,date_created:a,user_updated:o,date_updated:n,royalty_report:l,...s}=i.value;console.log(`[navarch-docgen-royaltyreport::copy] requestBody=${JSON.stringify(s)}`);const u=await r.post("/items/navarch_royalty_report",s);if(200!==u.status)return console.log(`[navarch-docgen-royaltyreport::copy] copy response status: ${u.status}`),void(d.value=`Failed to duplicate royalty report with status ${u.status}`);c.value=!1,window.open(`/admin/content/navarch_royalty_report/${u.data.data.id}`)},clearDocument:function(){s.value=null,d.value=null,a("input",null)},isGeneraingDoc:l,isCopying:c,failureReason:d};function u(e){try{const t=function(e){const t=[],a=Object.keys(e[0]);t.push(a.map((e=>x[e])).join(","));for(const o of e){const e=a.map((e=>`"${String(o[e]).replace(/"/g,'\\"')}"`));t.push(e.join(","))}return t.join("\n")}(null!=e?e:s.value),a=i.value[P];!function(e,t){const a=new Blob([e],{type:"text/csv"}),o=URL.createObjectURL(a),n=document.createElement("a");n.href=o,n.download=`${t}.csv`,document.body.appendChild(n),n.click(),document.body.removeChild(n)}(t,`Royalty Report ${a} - ${i.value[$]}`)}catch(e){console.error("Error downloading Royalty Report:",e),d.value="Error downloading Royalty Report: "+e}}}});const j={class:"margin-top-16px"};var F=[],W=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,o=!0===t.prepend?"prepend":"append",n=!0===t.singleTag,r="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(n){var i=F.indexOf(r);-1===i&&(i=F.push(r)-1,W[i]={}),a=W[i]&&W[i][o]?W[i][o]:W[i][o]=l()}else a=l();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function l(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),n=0;n<a.length;n++)e.setAttribute(a[n],t.attributes[a[n]]);var i="prepend"===o?"afterbegin":"beforeend";return r.insertAdjacentElement(i,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}\n.margin-left-16px[data-v-64969d30] {\n  margin-left: 16px;\n}\n.secondary-button[data-v-64969d30] {\n  --v-button-background-color: var(--background-page);\n  --v-button-color: var(--primary);\n  border: 1px solid var(--primary);\n  border-radius: var(--border-radius);\n}\n.secondary-button[data-v-64969d30]:disabled {\n  border-radius: var(--border-radius);\n}\n.secondary-button[data-v-64969d30]:hover {\n  border-color: var(--v-button-background-color-hover);\n  --v-button-color: inherit;\n}",{}),B.render=function(e,t,a,o,n,g){const h=r("v-button"),b=r("v-notice"),_=i("tooltip");return l(),c(d,null,[s("div",j,[e.documentData?u((l(),p(h,{key:1,onClick:t[1]||(t[1]=()=>e.downloadDoc(e.documentData))},{default:y((()=>[m(" Download Royalty Report ")])),_:1})),[[_,"Download the Royalty Report as a CSV file."]]):u((l(),p(h,{key:0,onClick:t[0]||(t[0]=()=>e.generateDocument()),loading:e.isGeneraingDoc},{default:y((()=>[m(" Generate & Save Royalty Report ")])),_:1},8,["loading"])),[[_,"Generate and saves the Royalty Report based on the selected date range. Valid dates must be provided for start and end dates."]]),u((l(),p(h,{class:"margin-left-16px secondary-button",onClick:t[2]||(t[2]=()=>e.copy()),loading:e.isCopying},{default:y((()=>[m("Copy")])),_:1},8,["loading"])),[[_,"Create a copy of this form with all the fields except the Royalty Report. To regenerate another Royalty Report with minor changes to the input data."]]),u((l(),p(h,{class:"margin-left-16px secondary-button",onClick:t[3]||(t[3]=()=>e.clearDocument())},{default:y((()=>[m("Clear")])),_:1})),[[_,"Clear the generated Royalty Report (if already generated) to regenerate again."]])]),e.failureReason?(l(),p(b,{key:0,class:"margin-top-16px"},{default:y((()=>[m(v(e.failureReason),1)])),_:1})):f("v-if",!0)],64)},B.__scopeId="data-v-64969d30",B.__file="src/interface.vue";var N=t({id:"navarch-docgen-royaltyreport",name:"Navarch Royalty Report Generator Button",icon:"receipt_long",description:"Navarch Royalty Report Generator Button",component:B,options:null,types:["json"],group:"standard"});export{N as default};
