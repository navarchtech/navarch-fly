import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as o,inject as a,ref as n,resolveComponent as r,resolveDirective as i,openBlock as l,createElementBlock as c,Fragment as d,createElementVNode as s,withDirectives as u,createBlock as p,withCtx as y,createTextVNode as v,toDisplayString as f,createCommentVNode as m}from"vue";const g="navarch_invoices",h="invoice",_="invoice_date",b="parcel",w="invoice_type",R="navarch_royalty_report",D=["Provisional","Final"],$="start_date",P="end_date",x={commodity:"Commodity",parcelReference:"Parcel",blDate:"B/L Date",invoiceDate:"Invoice Date",invoicePrior:"Invoice Prior",duringPeriod:"During Period",difference:"Difference",total:"Total"};function k(e,t=2,o=!1){if(null==e||isNaN(e))return null;const a=o&&e<0;return a&&(e*=-1),Math.round(e*Math.pow(10,t))/Math.pow(10,t)*(a?-1:1)}function C(e,t=2,o=!0){if(isNaN(e)||null==e)return"-";const a=Math.round(e*Math.pow(10,t))/Math.pow(10,t),[n,r]=a.toString().split("."),i=n?n.replace(/\B(?=(\d{3})+(?!\d))/g,","):"0";if(!r&&!o)return i;return`${i}.${(null!=r?r:"").padEnd(t,"0")}`}var j=o({props:{value:{type:String,default:null}},emits:["input"],setup(t,{emit:o}){const r=e(),i=a("values",n({})),l=n(!1),c=n(!1),d=n(null),s=n(t.value);return{documentData:s,generateDocument:async function(){var e,t,o,a,n;l.value=!0;try{const l=new Date(i.value[$]),c=new Date(i.value[P]);if(!l||!c)return void(d.value="Invalid date range provided. Please select valid start and end dates.");const p=await async function(e,t){const o=await r.get(`/items/${g}`,{params:{filter:{[_]:{_between:[e,t]},[w]:{_in:D},[h]:{_nnull:!0},[b]:{_nnull:!0}},limit:-1,fields:[h,_,b,w]}});if(0===o.data.length)return[];const a=o.data.data,n=a.reduce(((e,t)=>{if(e[t[b]]||(e[t[b]]={}),e[t[b]][t[w]]){const o=e[t[b]][t[w]][_],a=t[_];new Date(o)<new Date(a)&&(e[t[b]][t[w]]=t)}else e[t[b]][t[w]]=t;return e}),{}),i=a.filter((e=>"Final"===e[w])).map((e=>e[b])),l=(await r.get(`/items/${g}`,{params:{filter:{[w]:{_eq:"Provisional"},[b]:{_in:i},[h]:{_nnull:!0}},limit:-1,fields:[h,_,b,w]}})).data.data;for(const e of l)if(n[e[b]][e[w]]){const t=n[e[b]][e[w]][_],o=e[_];new Date(t)<new Date(o)&&(n[e[b]][e[w]]=e)}else n[e[b]][e[w]]=e;return n}(l,c),y=[],v={};for(const r of Object.keys(p)){const i=p[r];if(i.Final&&i.Provisional){const a=i.Final[h],n=i.Provisional[h];for(const r of a.commodities){const i=null!=(e=k(n.dry_weight,4))?e:0,l=null!=(t=k(a.dry_weight,4))?t:0,c=null!=(o=k(l-i,4))?o:0;y.push({commodity:r.commodity,parcelReference:a.parcel,blDate:a.bl_date,invoiceDate:a.invoice_date,invoicePrior:C(i,4),duringPeriod:C(l,4),difference:C(c,4),total:""}),v[r.commodity]?v[r.commodity]+=null!=c?c:0:v[r.commodity]=c}}else if(!i.Final&&i.Provisional){const e=i.Provisional[h];for(const t of e.commodities)y.push({commodity:t.commodity,parcelReference:e.parcel,blDate:e.bl_date,invoiceDate:e.invoice_date,invoicePrior:"",duringPeriod:C(e.dry_weight,4),difference:C(e.dry_weight,4),total:""}),v[t.commodity]?v[t.commodity]+=null!=(n=k(e.dry_weight,4))?n:0:v[t.commodity]=null!=(a=k(e.dry_weight,4))?a:0}else i.Final&&!i.Provisional&&console.error(`Final invoice found without Provisional invoice for parcel #${r}. This should not happen.`)}if(y.push(...Object.keys(v).map((e=>v[e]?{commodity:e,parcelReference:"",blDate:"",invoiceDate:"",invoicePrior:"",duringPeriod:"",difference:"",total:C(v[e],4)}:null)).filter((e=>!!e))),y.sort(((e,t)=>e.commodity<t.commodity?-1:e.commodity>t.commodity||""===e.parcelReference?1:""===t.parcelReference||e.parcelReference<t.parcelReference?-1:e.parcelReference>t.parcelReference?1:0)),s.value=y,i.value.id){const{id:e,user_created:t,date_created:o,user_updated:a,date_updated:n,...l}=i.value,c=await r.patch(`/items/${R}/${e}`,{...l,royalty_report:y});if(200!==c.status)return console.log(`[navarch-docgen-royaltyreport::generateDocument] update response status: ${c.status}`),void(d.value=`Failed to update royalty report with status ${c.status}`)}else{const e=await r.post(`/items/${R}`,{...i.value,royalty_report:y});if(200!==e.status)return console.log(`[navarch-docgen-royaltyreport::generateDocument] create response status: ${e.status}`),void(d.value=`Failed to create royalty report with status ${e.status}`);const{id:t}=e.data.data;window.open(`/admin/content/${R}/${t}`)}u(y)}catch(e){console.error("Error generating Royalty Report:",e)}finally{l.value=!1}},downloadDoc:u,copy:async function(){c.value=!0;const{id:e,user_created:t,date_created:o,user_updated:a,date_updated:n,royalty_report:l,...s}=i.value;console.log(`[navarch-docgen-royaltyreport::copy] requestBody=${JSON.stringify(s)}`);const u=await r.post("/items/navarch_royalty_report",s);if(200!==u.status)return console.log(`[navarch-docgen-royaltyreport::copy] copy response status: ${u.status}`),void(d.value=`Failed to duplicate royalty report with status ${u.status}`);c.value=!1,window.open(`/admin/content/navarch_royalty_report/${u.data.data.id}`)},clearDocument:function(){o("input",null)},isGeneraingDoc:l,isCopying:c,failureReason:d};function u(e){try{const t=function(e){const t=[],o=Object.keys(e[0]);t.push(o.map((e=>x[e])).join(","));for(const a of e){const e=o.map((e=>`"${String(a[e]).replace(/"/g,'\\"')}"`));t.push(e.join(","))}return t.join("\n")}(null!=e?e:s.value),o=i.value[$];!function(e,t){const o=new Blob([e],{type:"text/csv"}),a=URL.createObjectURL(o),n=document.createElement("a");n.href=a,n.download=`${t}.csv`,document.body.appendChild(n),n.click(),document.body.removeChild(n)}(t,`Royalty Report ${o} - ${i.value[P]}`)}catch(e){console.error("Error downloading Royalty Report:",e),d.value="Error downloading Royalty Report: "+e}}}});const F={class:"margin-top-16px"};var N=[],S=[];!function(e,t){if(e&&"undefined"!=typeof document){var o,a=!0===t.prepend?"prepend":"append",n=!0===t.singleTag,r="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(n){var i=N.indexOf(r);-1===i&&(i=N.push(r)-1,S[i]={}),o=S[i]&&S[i][a]?S[i][a]:S[i][a]=l()}else o=l();65279===e.charCodeAt(0)&&(e=e.substring(1)),o.styleSheet?o.styleSheet.cssText+=e:o.appendChild(document.createTextNode(e))}function l(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var o=Object.keys(t.attributes),n=0;n<o.length;n++)e.setAttribute(o[n],t.attributes[o[n]]);var i="prepend"===a?"afterbegin":"beforeend";return r.insertAdjacentElement(i,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}\n.margin-left-16px[data-v-64969d30] {\n  margin-left: 16px;\n}\n.secondary-button[data-v-64969d30] {\n  --v-button-background-color: var(--background-page);\n  --v-button-color: var(--primary);\n  border: 1px solid var(--primary);\n  border-radius: var(--border-radius);\n}\n.secondary-button[data-v-64969d30]:disabled {\n  border-radius: var(--border-radius);\n}\n.secondary-button[data-v-64969d30]:hover {\n  border-color: var(--v-button-background-color-hover);\n  --v-button-color: inherit;\n}",{}),j.render=function(e,t,o,a,n,g){const h=r("v-button"),_=r("v-notice"),b=i("tooltip");return l(),c(d,null,[s("div",F,[e.documentData?u((l(),p(h,{key:1,onClick:t[1]||(t[1]=()=>e.downloadDoc(e.documentData))},{default:y((()=>[v(" Download Royalty Report ")])),_:1})),[[b,"Download the Royalty Report as a CSV file."]]):u((l(),p(h,{key:0,onClick:t[0]||(t[0]=()=>e.generateDocument()),loading:e.isGeneraingDoc},{default:y((()=>[v(" Generate & Save Royalty Report ")])),_:1},8,["loading"])),[[b,"Generate and saves the Royalty Report based on the selected date range. Valid dates must be provided for start and end dates."]]),u((l(),p(h,{class:"margin-left-16px secondary-button",onClick:t[2]||(t[2]=()=>e.copy()),loading:e.isCopying},{default:y((()=>[v("Copy")])),_:1},8,["loading"])),[[b,"Create a copy of this form with all the fields except the Royalty Report. To regenerate another Royalty Report with minor changes to the input data."]]),u((l(),p(h,{class:"margin-left-16px secondary-button",onClick:t[3]||(t[3]=()=>e.clearDocument())},{default:y((()=>[v("Clear")])),_:1})),[[b,"Clear the generated Royalty Report (if already generated) to regenerate again."]])]),e.failureReason?(l(),p(_,{key:0,class:"margin-top-16px"},{default:y((()=>[v(f(e.failureReason),1)])),_:1})):m("v-if",!0)],64)},j.__scopeId="data-v-64969d30",j.__file="src/interface.vue";var E=t({id:"navarch-docgen-royaltyreport",name:"Navarch Royalty Report Generator Button",icon:"receipt_long",description:"Navarch Royalty Report Generator Button",component:j,options:null,types:["json"],group:"standard"});export{E as default};
