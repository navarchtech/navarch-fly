import{useApi as t,defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as a,ref as r,inject as n,watch as o,resolveComponent as i,resolveDirective as s,openBlock as l,createElementBlock as c,Fragment as u,createCommentVNode as d,createVNode as f,withCtx as h,createTextVNode as p,createBlock as y,toDisplayString as m,withDirectives as v}from"vue";for(var g={},w={byteLength:function(t){var e=C(t),a=e[0],r=e[1];return 3*(a+r)/4-r},toByteArray:function(t){var e,a,r=C(t),n=r[0],o=r[1],i=new E(function(t,e,a){return 3*(e+a)/4-a}(0,n,o)),s=0,l=o>0?n-4:n;for(a=0;a<l;a+=4)e=$[t.charCodeAt(a)]<<18|$[t.charCodeAt(a+1)]<<12|$[t.charCodeAt(a+2)]<<6|$[t.charCodeAt(a+3)],i[s++]=e>>16&255,i[s++]=e>>8&255,i[s++]=255&e;2===o&&(e=$[t.charCodeAt(a)]<<2|$[t.charCodeAt(a+1)]>>4,i[s++]=255&e);1===o&&(e=$[t.charCodeAt(a)]<<10|$[t.charCodeAt(a+1)]<<4|$[t.charCodeAt(a+2)]>>2,i[s++]=e>>8&255,i[s++]=255&e);return i},fromByteArray:function(t){for(var e,a=t.length,r=a%3,n=[],o=16383,i=0,s=a-r;i<s;i+=o)n.push(D(t,i,i+o>s?s:i+o));1===r?(e=t[a-1],n.push(_[e>>2]+_[e<<4&63]+"==")):2===r&&(e=(t[a-2]<<8)+t[a-1],n.push(_[e>>10]+_[e>>4&63]+_[e<<2&63]+"="));return n.join("")}},_=[],$=[],E="undefined"!=typeof Uint8Array?Uint8Array:Array,b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",A=0;A<64;++A)_[A]=b[A],$[b.charCodeAt(A)]=A;function C(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var a=t.indexOf("=");return-1===a&&(a=e),[a,a===e?0:4-a%4]}function D(t,e,a){for(var r,n,o=[],i=e;i<a;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(255&t[i+2]),o.push(_[(n=r)>>18&63]+_[n>>12&63]+_[n>>6&63]+_[63&n]);return o.join("")}$["-".charCodeAt(0)]=62,$["_".charCodeAt(0)]=63;var N={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(t,e,a,r,n){var o,i,s=8*n-r-1,l=(1<<s)-1,c=l>>1,u=-7,d=a?n-1:0,f=a?-1:1,h=t[e+d];for(d+=f,o=h&(1<<-u)-1,h>>=-u,u+=s;u>0;o=256*o+t[e+d],d+=f,u-=8);for(i=o&(1<<-u)-1,o>>=-u,u+=r;u>0;i=256*i+t[e+d],d+=f,u-=8);if(0===o)o=1-c;else{if(o===l)return i?NaN:1/0*(h?-1:1);i+=Math.pow(2,r),o-=c}return(h?-1:1)*i*Math.pow(2,o-r)},write:function(t,e,a,r,n,o){var i,s,l,c=8*o-n-1,u=(1<<c)-1,d=u>>1,f=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:o-1,p=r?1:-1,y=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,i=u):(i=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-i))<1&&(i--,l*=2),(e+=i+d>=1?f/l:f*Math.pow(2,1-d))*l>=2&&(i++,l/=2),i+d>=u?(s=0,i=u):i+d>=1?(s=(e*l-1)*Math.pow(2,n),i+=d):(s=e*Math.pow(2,d-1)*Math.pow(2,n),i=0));n>=8;t[a+h]=255&s,h+=p,s/=256,n-=8);for(i=i<<n|s,c+=n;c>0;t[a+h]=255&i,h+=p,i/=256,c-=8);t[a+h-p]|=128*y}};
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
!function(t){var e=w,a=N,r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=i,t.SlowBuffer=function(t){+t!=t&&(t=0);return i.alloc(+t)},t.INSPECT_MAX_BYTES=50;var n=2147483647;function o(t){if(t>n)throw new RangeError('The value "'+t+'" is invalid for option "size"');var e=new Uint8Array(t);return Object.setPrototypeOf(e,i.prototype),e}function i(t,e,a){if("number"==typeof t){if("string"==typeof e)throw new TypeError('The "string" argument must be of type string. Received type number');return c(t)}return s(t,e,a)}function s(t,e,a){if("string"==typeof t)return function(t,e){"string"==typeof e&&""!==e||(e="utf8");if(!i.isEncoding(e))throw new TypeError("Unknown encoding: "+e);var a=0|h(t,e),r=o(a),n=r.write(t,e);n!==a&&(r=r.slice(0,n));return r}(t,e);if(ArrayBuffer.isView(t))return function(t){if(x(t,Uint8Array)){var e=new Uint8Array(t);return d(e.buffer,e.byteOffset,e.byteLength)}return u(t)}(t);if(null==t)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(x(t,ArrayBuffer)||t&&x(t.buffer,ArrayBuffer))return d(t,e,a);if("undefined"!=typeof SharedArrayBuffer&&(x(t,SharedArrayBuffer)||t&&x(t.buffer,SharedArrayBuffer)))return d(t,e,a);if("number"==typeof t)throw new TypeError('The "value" argument must not be of type number. Received type number');var r=t.valueOf&&t.valueOf();if(null!=r&&r!==t)return i.from(r,e,a);var n=function(t){if(i.isBuffer(t)){var e=0|f(t.length),a=o(e);return 0===a.length||t.copy(a,0,0,e),a}if(void 0!==t.length)return"number"!=typeof t.length||G(t.length)?o(0):u(t);if("Buffer"===t.type&&Array.isArray(t.data))return u(t.data)}(t);if(n)return n;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return i.from(t[Symbol.toPrimitive]("string"),e,a);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function l(t){if("number"!=typeof t)throw new TypeError('"size" argument must be of type number');if(t<0)throw new RangeError('The value "'+t+'" is invalid for option "size"')}function c(t){return l(t),o(t<0?0:0|f(t))}function u(t){for(var e=t.length<0?0:0|f(t.length),a=o(e),r=0;r<e;r+=1)a[r]=255&t[r];return a}function d(t,e,a){if(e<0||t.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(a||0))throw new RangeError('"length" is outside of buffer bounds');var r;return r=void 0===e&&void 0===a?new Uint8Array(t):void 0===a?new Uint8Array(t,e):new Uint8Array(t,e,a),Object.setPrototypeOf(r,i.prototype),r}function f(t){if(t>=n)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n.toString(16)+" bytes");return 0|t}function h(t,e){if(i.isBuffer(t))return t.length;if(ArrayBuffer.isView(t)||x(t,ArrayBuffer))return t.byteLength;if("string"!=typeof t)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);var a=t.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===a)return 0;for(var n=!1;;)switch(e){case"ascii":case"latin1":case"binary":return a;case"utf8":case"utf-8":return j(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*a;case"hex":return a>>>1;case"base64":return L(t).length;default:if(n)return r?-1:j(t).length;e=(""+e).toLowerCase(),n=!0}}function p(t,e,a){var r=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===a||a>this.length)&&(a=this.length),a<=0)return"";if((a>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return S(this,e,a);case"utf8":case"utf-8":return C(this,e,a);case"ascii":return P(this,e,a);case"latin1":case"binary":return O(this,e,a);case"base64":return A(this,e,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return I(this,e,a);default:if(r)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),r=!0}}function y(t,e,a){var r=t[e];t[e]=t[a],t[a]=r}function m(t,e,a,r,n){if(0===t.length)return-1;if("string"==typeof a?(r=a,a=0):a>2147483647?a=2147483647:a<-2147483648&&(a=-2147483648),G(a=+a)&&(a=n?0:t.length-1),a<0&&(a=t.length+a),a>=t.length){if(n)return-1;a=t.length-1}else if(a<0){if(!n)return-1;a=0}if("string"==typeof e&&(e=i.from(e,r)),i.isBuffer(e))return 0===e.length?-1:v(t,e,a,r,n);if("number"==typeof e)return e&=255,"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(t,e,a):Uint8Array.prototype.lastIndexOf.call(t,e,a):v(t,[e],a,r,n);throw new TypeError("val must be string, number or Buffer")}function v(t,e,a,r,n){var o,i=1,s=t.length,l=e.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(t.length<2||e.length<2)return-1;i=2,s/=2,l/=2,a/=2}function c(t,e){return 1===i?t[e]:t.readUInt16BE(e*i)}if(n){var u=-1;for(o=a;o<s;o++)if(c(t,o)===c(e,-1===u?0:o-u)){if(-1===u&&(u=o),o-u+1===l)return u*i}else-1!==u&&(o-=o-u),u=-1}else for(a+l>s&&(a=s-l),o=a;o>=0;o--){for(var d=!0,f=0;f<l;f++)if(c(t,o+f)!==c(e,f)){d=!1;break}if(d)return o}return-1}function g(t,e,a,r){a=Number(a)||0;var n=t.length-a;r?(r=Number(r))>n&&(r=n):r=n;var o=e.length;r>o/2&&(r=o/2);for(var i=0;i<r;++i){var s=parseInt(e.substr(2*i,2),16);if(G(s))return i;t[a+i]=s}return i}function _(t,e,a,r){return F(j(e,t.length-a),t,a,r)}function $(t,e,a,r){return F(function(t){for(var e=[],a=0;a<t.length;++a)e.push(255&t.charCodeAt(a));return e}(e),t,a,r)}function E(t,e,a,r){return F(L(e),t,a,r)}function b(t,e,a,r){return F(function(t,e){for(var a,r,n,o=[],i=0;i<t.length&&!((e-=2)<0);++i)r=(a=t.charCodeAt(i))>>8,n=a%256,o.push(n),o.push(r);return o}(e,t.length-a),t,a,r)}function A(t,a,r){return 0===a&&r===t.length?e.fromByteArray(t):e.fromByteArray(t.slice(a,r))}function C(t,e,a){a=Math.min(t.length,a);for(var r=[],n=e;n<a;){var o,i,s,l,c=t[n],u=null,d=c>239?4:c>223?3:c>191?2:1;if(n+d<=a)switch(d){case 1:c<128&&(u=c);break;case 2:128==(192&(o=t[n+1]))&&(l=(31&c)<<6|63&o)>127&&(u=l);break;case 3:o=t[n+1],i=t[n+2],128==(192&o)&&128==(192&i)&&(l=(15&c)<<12|(63&o)<<6|63&i)>2047&&(l<55296||l>57343)&&(u=l);break;case 4:o=t[n+1],i=t[n+2],s=t[n+3],128==(192&o)&&128==(192&i)&&128==(192&s)&&(l=(15&c)<<18|(63&o)<<12|(63&i)<<6|63&s)>65535&&l<1114112&&(u=l)}null===u?(u=65533,d=1):u>65535&&(u-=65536,r.push(u>>>10&1023|55296),u=56320|1023&u),r.push(u),n+=d}return function(t){var e=t.length;if(e<=D)return String.fromCharCode.apply(String,t);var a="",r=0;for(;r<e;)a+=String.fromCharCode.apply(String,t.slice(r,r+=D));return a}(r)}t.kMaxLength=n,i.TYPED_ARRAY_SUPPORT=function(){try{var t=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(t,e),42===t.foo()}catch(t){return!1}}(),i.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(i.prototype,"parent",{enumerable:!0,get:function(){if(i.isBuffer(this))return this.buffer}}),Object.defineProperty(i.prototype,"offset",{enumerable:!0,get:function(){if(i.isBuffer(this))return this.byteOffset}}),i.poolSize=8192,i.from=function(t,e,a){return s(t,e,a)},Object.setPrototypeOf(i.prototype,Uint8Array.prototype),Object.setPrototypeOf(i,Uint8Array),i.alloc=function(t,e,a){return function(t,e,a){return l(t),t<=0?o(t):void 0!==e?"string"==typeof a?o(t).fill(e,a):o(t).fill(e):o(t)}(t,e,a)},i.allocUnsafe=function(t){return c(t)},i.allocUnsafeSlow=function(t){return c(t)},i.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==i.prototype},i.compare=function(t,e){if(x(t,Uint8Array)&&(t=i.from(t,t.offset,t.byteLength)),x(e,Uint8Array)&&(e=i.from(e,e.offset,e.byteLength)),!i.isBuffer(t)||!i.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;for(var a=t.length,r=e.length,n=0,o=Math.min(a,r);n<o;++n)if(t[n]!==e[n]){a=t[n],r=e[n];break}return a<r?-1:r<a?1:0},i.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},i.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return i.alloc(0);var a;if(void 0===e)for(e=0,a=0;a<t.length;++a)e+=t[a].length;var r=i.allocUnsafe(e),n=0;for(a=0;a<t.length;++a){var o=t[a];if(x(o,Uint8Array))n+o.length>r.length?i.from(o).copy(r,n):Uint8Array.prototype.set.call(r,o,n);else{if(!i.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(r,n)}n+=o.length}return r},i.byteLength=h,i.prototype._isBuffer=!0,i.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)y(this,e,e+1);return this},i.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)y(this,e,e+3),y(this,e+1,e+2);return this},i.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)y(this,e,e+7),y(this,e+1,e+6),y(this,e+2,e+5),y(this,e+3,e+4);return this},i.prototype.toString=function(){var t=this.length;return 0===t?"":0===arguments.length?C(this,0,t):p.apply(this,arguments)},i.prototype.toLocaleString=i.prototype.toString,i.prototype.equals=function(t){if(!i.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===i.compare(this,t)},i.prototype.inspect=function(){var e="",a=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,a).replace(/(.{2})/g,"$1 ").trim(),this.length>a&&(e+=" ... "),"<Buffer "+e+">"},r&&(i.prototype[r]=i.prototype.inspect),i.prototype.compare=function(t,e,a,r,n){if(x(t,Uint8Array)&&(t=i.from(t,t.offset,t.byteLength)),!i.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(void 0===e&&(e=0),void 0===a&&(a=t?t.length:0),void 0===r&&(r=0),void 0===n&&(n=this.length),e<0||a>t.length||r<0||n>this.length)throw new RangeError("out of range index");if(r>=n&&e>=a)return 0;if(r>=n)return-1;if(e>=a)return 1;if(this===t)return 0;for(var o=(n>>>=0)-(r>>>=0),s=(a>>>=0)-(e>>>=0),l=Math.min(o,s),c=this.slice(r,n),u=t.slice(e,a),d=0;d<l;++d)if(c[d]!==u[d]){o=c[d],s=u[d];break}return o<s?-1:s<o?1:0},i.prototype.includes=function(t,e,a){return-1!==this.indexOf(t,e,a)},i.prototype.indexOf=function(t,e,a){return m(this,t,e,a,!0)},i.prototype.lastIndexOf=function(t,e,a){return m(this,t,e,a,!1)},i.prototype.write=function(t,e,a,r){if(void 0===e)r="utf8",a=this.length,e=0;else if(void 0===a&&"string"==typeof e)r=e,a=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e>>>=0,isFinite(a)?(a>>>=0,void 0===r&&(r="utf8")):(r=a,a=void 0)}var n=this.length-e;if((void 0===a||a>n)&&(a=n),t.length>0&&(a<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return g(this,t,e,a);case"utf8":case"utf-8":return _(this,t,e,a);case"ascii":case"latin1":case"binary":return $(this,t,e,a);case"base64":return E(this,t,e,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return b(this,t,e,a);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},i.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var D=4096;function P(t,e,a){var r="";a=Math.min(t.length,a);for(var n=e;n<a;++n)r+=String.fromCharCode(127&t[n]);return r}function O(t,e,a){var r="";a=Math.min(t.length,a);for(var n=e;n<a;++n)r+=String.fromCharCode(t[n]);return r}function S(t,e,a){var r=t.length;(!e||e<0)&&(e=0),(!a||a<0||a>r)&&(a=r);for(var n="",o=e;o<a;++o)n+=q[t[o]];return n}function I(t,e,a){for(var r=t.slice(e,a),n="",o=0;o<r.length-1;o+=2)n+=String.fromCharCode(r[o]+256*r[o+1]);return n}function T(t,e,a){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>a)throw new RangeError("Trying to access beyond buffer length")}function B(t,e,a,r,n,o){if(!i.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>n||e<o)throw new RangeError('"value" argument is out of bounds');if(a+r>t.length)throw new RangeError("Index out of range")}function M(t,e,a,r,n,o){if(a+r>t.length)throw new RangeError("Index out of range");if(a<0)throw new RangeError("Index out of range")}function U(t,e,r,n,o){return e=+e,r>>>=0,o||M(t,0,r,4),a.write(t,e,r,n,23,4),r+4}function k(t,e,r,n,o){return e=+e,r>>>=0,o||M(t,0,r,8),a.write(t,e,r,n,52,8),r+8}i.prototype.slice=function(t,e){var a=this.length;(t=~~t)<0?(t+=a)<0&&(t=0):t>a&&(t=a),(e=void 0===e?a:~~e)<0?(e+=a)<0&&(e=0):e>a&&(e=a),e<t&&(e=t);var r=this.subarray(t,e);return Object.setPrototypeOf(r,i.prototype),r},i.prototype.readUintLE=i.prototype.readUIntLE=function(t,e,a){t>>>=0,e>>>=0,a||T(t,e,this.length);for(var r=this[t],n=1,o=0;++o<e&&(n*=256);)r+=this[t+o]*n;return r},i.prototype.readUintBE=i.prototype.readUIntBE=function(t,e,a){t>>>=0,e>>>=0,a||T(t,e,this.length);for(var r=this[t+--e],n=1;e>0&&(n*=256);)r+=this[t+--e]*n;return r},i.prototype.readUint8=i.prototype.readUInt8=function(t,e){return t>>>=0,e||T(t,1,this.length),this[t]},i.prototype.readUint16LE=i.prototype.readUInt16LE=function(t,e){return t>>>=0,e||T(t,2,this.length),this[t]|this[t+1]<<8},i.prototype.readUint16BE=i.prototype.readUInt16BE=function(t,e){return t>>>=0,e||T(t,2,this.length),this[t]<<8|this[t+1]},i.prototype.readUint32LE=i.prototype.readUInt32LE=function(t,e){return t>>>=0,e||T(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},i.prototype.readUint32BE=i.prototype.readUInt32BE=function(t,e){return t>>>=0,e||T(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},i.prototype.readIntLE=function(t,e,a){t>>>=0,e>>>=0,a||T(t,e,this.length);for(var r=this[t],n=1,o=0;++o<e&&(n*=256);)r+=this[t+o]*n;return r>=(n*=128)&&(r-=Math.pow(2,8*e)),r},i.prototype.readIntBE=function(t,e,a){t>>>=0,e>>>=0,a||T(t,e,this.length);for(var r=e,n=1,o=this[t+--r];r>0&&(n*=256);)o+=this[t+--r]*n;return o>=(n*=128)&&(o-=Math.pow(2,8*e)),o},i.prototype.readInt8=function(t,e){return t>>>=0,e||T(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},i.prototype.readInt16LE=function(t,e){t>>>=0,e||T(t,2,this.length);var a=this[t]|this[t+1]<<8;return 32768&a?4294901760|a:a},i.prototype.readInt16BE=function(t,e){t>>>=0,e||T(t,2,this.length);var a=this[t+1]|this[t]<<8;return 32768&a?4294901760|a:a},i.prototype.readInt32LE=function(t,e){return t>>>=0,e||T(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},i.prototype.readInt32BE=function(t,e){return t>>>=0,e||T(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},i.prototype.readFloatLE=function(t,e){return t>>>=0,e||T(t,4,this.length),a.read(this,t,!0,23,4)},i.prototype.readFloatBE=function(t,e){return t>>>=0,e||T(t,4,this.length),a.read(this,t,!1,23,4)},i.prototype.readDoubleLE=function(t,e){return t>>>=0,e||T(t,8,this.length),a.read(this,t,!0,52,8)},i.prototype.readDoubleBE=function(t,e){return t>>>=0,e||T(t,8,this.length),a.read(this,t,!1,52,8)},i.prototype.writeUintLE=i.prototype.writeUIntLE=function(t,e,a,r){(t=+t,e>>>=0,a>>>=0,r)||B(this,t,e,a,Math.pow(2,8*a)-1,0);var n=1,o=0;for(this[e]=255&t;++o<a&&(n*=256);)this[e+o]=t/n&255;return e+a},i.prototype.writeUintBE=i.prototype.writeUIntBE=function(t,e,a,r){(t=+t,e>>>=0,a>>>=0,r)||B(this,t,e,a,Math.pow(2,8*a)-1,0);var n=a-1,o=1;for(this[e+n]=255&t;--n>=0&&(o*=256);)this[e+n]=t/o&255;return e+a},i.prototype.writeUint8=i.prototype.writeUInt8=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,1,255,0),this[e]=255&t,e+1},i.prototype.writeUint16LE=i.prototype.writeUInt16LE=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,2,65535,0),this[e]=255&t,this[e+1]=t>>>8,e+2},i.prototype.writeUint16BE=i.prototype.writeUInt16BE=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=255&t,e+2},i.prototype.writeUint32LE=i.prototype.writeUInt32LE=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t,e+4},i.prototype.writeUint32BE=i.prototype.writeUInt32BE=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},i.prototype.writeIntLE=function(t,e,a,r){if(t=+t,e>>>=0,!r){var n=Math.pow(2,8*a-1);B(this,t,e,a,n-1,-n)}var o=0,i=1,s=0;for(this[e]=255&t;++o<a&&(i*=256);)t<0&&0===s&&0!==this[e+o-1]&&(s=1),this[e+o]=(t/i>>0)-s&255;return e+a},i.prototype.writeIntBE=function(t,e,a,r){if(t=+t,e>>>=0,!r){var n=Math.pow(2,8*a-1);B(this,t,e,a,n-1,-n)}var o=a-1,i=1,s=0;for(this[e+o]=255&t;--o>=0&&(i*=256);)t<0&&0===s&&0!==this[e+o+1]&&(s=1),this[e+o]=(t/i>>0)-s&255;return e+a},i.prototype.writeInt8=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=255&t,e+1},i.prototype.writeInt16LE=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,2,32767,-32768),this[e]=255&t,this[e+1]=t>>>8,e+2},i.prototype.writeInt16BE=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=255&t,e+2},i.prototype.writeInt32LE=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,4,2147483647,-2147483648),this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},i.prototype.writeInt32BE=function(t,e,a){return t=+t,e>>>=0,a||B(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},i.prototype.writeFloatLE=function(t,e,a){return U(this,t,e,!0,a)},i.prototype.writeFloatBE=function(t,e,a){return U(this,t,e,!1,a)},i.prototype.writeDoubleLE=function(t,e,a){return k(this,t,e,!0,a)},i.prototype.writeDoubleBE=function(t,e,a){return k(this,t,e,!1,a)},i.prototype.copy=function(t,e,a,r){if(!i.isBuffer(t))throw new TypeError("argument should be a Buffer");if(a||(a=0),r||0===r||(r=this.length),e>=t.length&&(e=t.length),e||(e=0),r>0&&r<a&&(r=a),r===a)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(a<0||a>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),t.length-e<r-a&&(r=t.length-e+a);var n=r-a;return this===t&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(e,a,r):Uint8Array.prototype.set.call(t,this.subarray(a,r),e),n},i.prototype.fill=function(t,e,a,r){if("string"==typeof t){if("string"==typeof e?(r=e,e=0,a=this.length):"string"==typeof a&&(r=a,a=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!i.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===t.length){var n=t.charCodeAt(0);("utf8"===r&&n<128||"latin1"===r)&&(t=n)}}else"number"==typeof t?t&=255:"boolean"==typeof t&&(t=Number(t));if(e<0||this.length<e||this.length<a)throw new RangeError("Out of range index");if(a<=e)return this;var o;if(e>>>=0,a=void 0===a?this.length:a>>>0,t||(t=0),"number"==typeof t)for(o=e;o<a;++o)this[o]=t;else{var s=i.isBuffer(t)?t:i.from(t,r),l=s.length;if(0===l)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(o=0;o<a-e;++o)this[o+e]=s[o%l]}return this};var R=/[^+/0-9A-Za-z-_]/g;function j(t,e){var a;e=e||1/0;for(var r=t.length,n=null,o=[],i=0;i<r;++i){if((a=t.charCodeAt(i))>55295&&a<57344){if(!n){if(a>56319){(e-=3)>-1&&o.push(239,191,189);continue}if(i+1===r){(e-=3)>-1&&o.push(239,191,189);continue}n=a;continue}if(a<56320){(e-=3)>-1&&o.push(239,191,189),n=a;continue}a=65536+(n-55296<<10|a-56320)}else n&&(e-=3)>-1&&o.push(239,191,189);if(n=null,a<128){if((e-=1)<0)break;o.push(a)}else if(a<2048){if((e-=2)<0)break;o.push(a>>6|192,63&a|128)}else if(a<65536){if((e-=3)<0)break;o.push(a>>12|224,a>>6&63|128,63&a|128)}else{if(!(a<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;o.push(a>>18|240,a>>12&63|128,a>>6&63|128,63&a|128)}}return o}function L(t){return e.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace(R,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function F(t,e,a,r){for(var n=0;n<r&&!(n+a>=e.length||n>=t.length);++n)e[n+a]=t[n];return n}function x(t,e){return t instanceof e||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===e.name}function G(t){return t!=t}var q=function(){for(var t="0123456789abcdef",e=new Array(256),a=0;a<16;++a)for(var r=16*a,n=0;n<16;++n)e[r+n]=t[a]+t[n];return e}()}(g);var P=(t=>(t.BRACKET="Bracket",t.MIN_DEDUCTION="Minimum Deduction",t.MAX_CAP="Maximum Cap",t))(P||{}),O=(t=>(t.PERCENTAGE="Percentage",t.FRACTIONAL="Fractional",t))(O||{}),S=(t=>(t.WET_WEIGHT="wet_weight",t.MOISTURE="moisture",t.DRY_WEIGHT="dry_weight",t))(S||{}),I=(t=>(t.METHOD="method",t.WET_WEIGHT_UOM="wet_weight_uom",t.MOISTURE_UOM="moisture_uom",t.DRY_WEIGHT_UOM="dry_weight_uom",t))(I||{});const T={Advance:0,"Second Advance":1,"Third Advance":2,"Fourth Advance":3,Provisional:4,"Second Provisional":5,"Third Provisional":6,"Fourth Provisional":7,Final:8},B={Original:0,"First Revision":1,"Second Revision":2};var M=(t=>(t.PNG="image/png",t.JPEG="image/jpeg",t.JPG="image/jpg",t))(M||{}),U=a({props:{value:{type:Object,default:null}},emits:["input"],setup(e,{emit:a}){const i=r(""),s=r(!1),l=r(!1),c=t(),u=n("values",r({}));function d(t){if(console.log("[evaluateWeightData]"),0===t.length)return;const e=h(t,S.DRY_WEIGHT),a=h(t,S.WET_WEIGHT);return{method:f(t,I.METHOD),lots:t,dry_weight_uom:f(t,I.DRY_WEIGHT_UOM),wet_weight_uom:f(t,I.WET_WEIGHT_UOM),dry_weight:e,wet_weight:a,moisture:(a-e)/a*100}}function f(t,e){if(console.log("[getFirstValueAsSharedValue]"),0!==t.length)return console.log(`lots[0][${e.toString()}]=${t[0][e.toString()]}`),t[0][e.toString()]}function h(t,e){return console.log("[evaluateAggregateValue]"),t.reduce(((t,a)=>{var r;return t+parseFloat(null!=(r=a[e.toString()])?r:"0")}),0)}function p(t){return null==t}function y(t,e=2,a=!0){if(console.log("[formatNumber]"),isNaN(t)||null===t)return"-";const r=Math.round(t*Math.pow(10,e))/Math.pow(10,e),[n,o]=r.toString().split("."),i=n.replace(/\B(?=(\d{3})+(?!\d))/g,",");if(!o&&!a)return i;return`${i}.${(null!=o?o:"").padEnd(e,"0")}`}function m(t,e=2,a=!1){if(p(t)||isNaN(t))return null;const r=a&&t<0;return r&&(t*=-1),Math.round(t*Math.pow(10,e))/Math.pow(10,e)*(r?-1:1)}function v(t,e){return console.log("[findBracket]"),t.find((t=>{var a,r;const n=e>(null!=(a=t.lower_threshold)?a:0)&&(p(t.upper_threshold)||e<t.upper_threshold)||t.lower_threshold_inclusive&&e===(null!=(r=t.lower_threshold)?r:0)||t.upper_threshold_inclusive&&e===t.upper_threshold;return console.log(`[findBracket] value=${e} for bracket: ${JSON.stringify(t)}? match=${!!n}`),n}))}function w(t,e){var a,r,n,o,i,s,l,c,u,d,f;console.log("[evaluateFinalValueFromBrackets]");const h=(t-(null!=(a=e.initial_adjustment)?a:0)*(e.initial_adjustment_conversion_by_multiplication?null!=(r=e.initial_adjustment_conversion_factor)?r:1:1/(null!=(n=e.initial_adjustment_conversion_factor)?n:1)))*(null!=(o=e.rate)?o:0)*(e.rate_type===O.PERCENTAGE?.01:1)+(null!=(i=e.final_adjustment)?i:0)*(e.final_adjustment_conversion_factor?null!=(s=e.final_adjustment_conversion_factor)?s:1:1/(null!=(l=e.final_adjustment_conversion_factor)?l:1));switch(e.bracket_type){case P.MIN_DEDUCTION:if(null===e.comparator||void 0===e.comparator)throw new Error("Minimum deduction not found");const a=e.comparator*(e.comparator_conversion_by_multiplication?null!=(c=e.comparator_conversion_factor)?c:1:1/(null!=(u=e.comparator_conversion_factor)?u:1));return m(t-h<a?t-a:h,4);case P.MAX_CAP:if(null===e.comparator||void 0===e.comparator)throw new Error("Maximum cap not found");const r=e.comparator*(e.comparator_conversion_by_multiplication?null!=(d=e.comparator_conversion_factor)?d:1:1/(null!=(f=e.comparator_conversion_factor)?f:1));return m(h>r?r:h,4);case P.BRACKET:return m(h,4);default:throw new Error(`bracket type ${e.bracket_type} is not supported`)}}async function _(t,e,a,r){var n,o,i,s,l,c,u,d;if(console.log("[evaluatePayableAssay]"),!a||0===a.length)return{};const f=v(a,t);if(!f)throw new Error(`Unable to find the range for analytical assay value of ${t}, please ensure the payable assay rates for the commodity ${r} are defined in the contract cover all range of possible values`);let h,p,g=1,_=!0;if(f.initial_adjustment_uom&&void 0!==f.initial_adjustment_uom&&null!==f.initial_adjustment_uom&&f.initial_adjustment_uom!==e){const t=await F(f.initial_adjustment_uom,e);g=t.value,h=x(f.initial_adjustment_uom,e,t.isConvertByMultiplication),_=t.isConvertByMultiplication}let $,E=1,b=!0;if(f.bracket_type===P.MAX_CAP){if(p=null!=(n=f.maximum_cap)?n:0,void 0!==f.maximum_cap_uom&&null!==f.maximum_cap_uom&&f.maximum_cap_uom!==e){const t=await F(f.maximum_cap_uom,e);E=t.value,$=x(f.maximum_cap_uom,e,t.isConvertByMultiplication),b=t.isConvertByMultiplication}}else if(f.bracket_type===P.MIN_DEDUCTION&&(p=null!=(o=f.minimum_deduction)?o:0,void 0!==f.minimum_deduction_uom&&null!==f.minimum_deduction_uom&&f.minimum_deduction_uom!==e)){const t=await F(f.minimum_deduction_uom,e);E=t.value,$=x(f.minimum_deduction_uom,e,t.isConvertByMultiplication),b=t.isConvertByMultiplication}const A={bracket_type:f.bracket_type,rate:null!=(i=f.rate)?i:1,rate_type:null!=(s=f.rate_type)?s:O.FRACTIONAL,initial_adjustment:null!=(l=f.initial_adjustment)?l:0,initial_adjustment_conversion_factor:g,initial_adjustment_conversion_by_multiplication:_,comparator:p,comparator_conversion_factor:E,comparator_conversion_by_multiplication:b};console.log(`[evaluatePayableAssay] bracketForEvaluation: ${JSON.stringify(A)}`);const C=w(t,A);let D="";const N=void 0!==f.initial_adjustment&&null!==f.initial_adjustment;if(f.bracket_type===P.BRACKET)D=`${N?"(":""}${y(t,4)}${null!=e?e:""}${N?` - ${y(f.initial_adjustment,4)}${null!=(c=f.initial_adjustment_uom)?c:`${null!=e?e:""}`}`:""}${N&&1!==g?` ${_?"*":"/"} ${y(g,4)}${h}`:""}${N?")":""} * ${y(f.rate,4)}${f.rate_type===O.PERCENTAGE?"/100":`/${y(1,4)}`}`;else if(f.bracket_type===P.MIN_DEDUCTION){D=C===m(t-(null!=p?p:0)*(b?null!=E?E:1:1/(null!=E?E:1)),4)?`${y(t,4)}${null!=e?e:""} - ${y(p,4)}${null!=e?e:""}${1!==E?` ${b?"*":"/"} ${y(E,4)}${$}`:""}`:`${N?"(":""}${y(t,4)}${null!=e?e:""}${N?` - ${y(f.initial_adjustment,4)}${null!=(u=f.initial_adjustment_uom)?u:`${null!=e?e:""}`}`:""}${N&&1!==g?` ${_?"*":"/"} ${y(g,4)}${h}`:""}${N?")":""} * ${y(f.rate,4)}${f.rate_type===O.PERCENTAGE?"/100":`/${y(1,4)}`}`}else{if(f.bracket_type!==P.MAX_CAP)throw new Error(`[buildPayableAssayExpression] unknown bracket method: ${f.bracket_type}`);D=C===m((null!=p?p:0)*(b?null!=E?E:1:1/(null!=E?E:1)),4)?`${y(p,4)}${null!=e?e:""}${1!==E?` ${b?"*":"/"} ${y(E,4)}${$}`:""}`:`${N?"(":""}${y(t,4)}${null!=e?e:""}${N?` - ${y(f.initial_adjustment,4)}${null!=(d=f.initial_adjustment_uom)?d:`${null!=e?e:""}`}`:""}${N&&1!==g?` ${_?"*":"/"} ${y(g,4)}${h}`:""}${N?")":""} * ${y(f.rate,4)}${f.rate_type===O.PERCENTAGE?"/100":`/${y(1,4)}`}`}return{payableAssay:C,expression:D}}console.log("[main] formValues=",u);const $="above the lower threshold, plus",E="below the upper threshold, minus";function b(t,e,a,r,n,o){var i,s,l,c,u,d,f;if(console.log("[evaluateCharge]"),!a||!a.length)return;const h=v(a,t);if(!h)throw new Error(`Unable to find the bracket range for the ${o} value of ${t}, please ensure the ${n} rates for commodity ${r} are defined in the contract cover all range of possible values`);let p=0,y=1;const m=null!=(i=h.escalator_reference)?i:1;if(h.use_btc)y=0,p=0;else if(y=(null!=(s=h.rate)?s:1)/m,h.for_every_unit===$)p=null!=(l=h.lower_threshold)?l:0;else{if(h.for_every_unit!==E)throw new Error(`[evaluateCharge] unknown for_every_unit: ${h.for_every_unit}`);p=null!=(c=h.upper_threshold)?c:0}const g={bracket_type:P.BRACKET,rate:y,rate_type:O.FRACTIONAL,initial_adjustment:p,final_adjustment:(null!=(u=h.base_treatment_charge)?u:0)+(null!=(d=h.base_charge_adjustment)?d:0)};return console.log(`[evaluateCharge] bracketForEvaluation: ${JSON.stringify(g)}`),{finalValue:w(t,g),baseTreatmentCharge:h.base_treatment_charge+(null!=(f=h.base_charge_adjustment)?f:0)}}function A(t,e,a,r,n){var o,i,s,l;if(console.log("[evaluatePenalty]"),!e||!e.length)return{};const c=v(e,t);if(!c)throw new Error(`Unable to find the range for the analytical assay value of ${t}, please ensure the penalty rates for commodity ${n} are defined in the contract cover all range of possible values`);let u=0,d=1;const f=null!=(o=c.escalator_reference)?o:1;if(c.no_penalty)d=0,u=0;else if(d=(null!=(i=c.rate)?i:1)/f,c.for_every_unit===$)u=null!=(s=c.lower_threshold)?s:0;else{if(c.for_every_unit!==E)throw new Error(`[evaluatePenalty] unknown for_every_unit: ${c.for_every_unit}`);u=null!=(l=c.upper_threshold)?l:0}const h={bracket_type:P.BRACKET,rate:d,rate_type:O.FRACTIONAL,initial_adjustment:u,final_adjustment:0};console.log(`[evaluatePenalty] bracketForEvaluation: ${JSON.stringify(h)}`);const p=w(t,h),m=null!=h.initial_adjustment;let g="";return g=c.rate&&0!==c.rate?`${m?"(":""}${y(t,4)}${m?` - ${y(u,4)})`:""} / ${y(f,4)} * ${null!=a?a:""} ${y(d,4)}/${null!=r?r:""}`:"No penalty",{penalty:p,expression:g,bracket:c}}function C(t){return t.toLowerCase().split(" ").map((t=>t.charAt(0).toUpperCase()+t.slice(1))).join(" ")}function D(t){const e=t.getDate(),a=t.getMonth(),r=t.getFullYear();return`${e} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${r}`}function N(t,e=!0){const a=t.getMonth()+1,r=t.getDate();return`${t.getFullYear()}${e?"-":" "}${a<10?"0":""}${a}${e?"-":" "}${r<10?"0":""}${r}`}function U(t,e,a=!1){const r=new Date(t.valueOf());let n=e-(a?1:0),o=!0;for(;k(r);)r.setDate(r.getDate()-1),o&&(n-=1,o=!1);for(;n>0;)r.setDate(r.getDate()-1),k(r)||(n-=1);for(r.getHours()>=12&&r.setDate(r.getDate()+1);k(r);)r.setDate(r.getDate()-1);return r}function k(t){return 0===t.getDay()||6===t.getDay()}function R(t,e){const a=new Date(t.valueOf());return a.setMonth(a.getMonth()+e,1),a}function j(t,e){const a=new Date(t.valueOf());return a.setMonth(a.getMonth()+e+1,0),a}async function L(t,e){var a,r;if(t===e)return{value:1,isConvertByMultiplication:!0};const n=await c.get(`/items/${Lt}?filter[${Ft}]=${t}`,{params:{fields:[Vt]}});if(0===n.data.data.length||null===n.data.data[0][Vt]||void 0===n.data.data[0][Vt])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for source weight unit ${t}. Ensure that the symbol is correct and is a weight unit symbol`);const o=await c.get(`/items/${Lt}?filter[${Ft}]=${e}`,{params:{fields:[Vt]}});if(0===o.data.data.length||null===o.data.data[0][Vt]||void 0===o.data.data[0][Vt])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for the target weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const i=parseFloat(n.data.data[0][Vt]);if(isNaN(i))throw new Error(`[getWeightUnitConversionValue] source weight unit ${t} conversion value=${i} is not a number`);const s=parseFloat(o.data.data[0][Vt]);if(isNaN(s))throw new Error(`[getWeightUnitConversionValue] target weight unit ${e} conversion value=${s} is not a number`);return i<s?{value:null!=(a=m(s/i,4))?a:1,isConvertByMultiplication:!1}:{value:null!=(r=m(i/s,4))?r:1,isConvertByMultiplication:!0}}async function F(t,e){var a,r;if(null==t||null==e)return{value:1,isConvertByMultiplication:!0};if(t===e)return{value:1,isConvertByMultiplication:!0};const n=await c.get(`/items/${Jt}?filter[${Wt}]=${t}`,{params:{fields:[Ht]}});if(0===n.data.data.length||void 0===n.data.data[0][Ht]||null===n.data.data[0][Ht])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for source weight unit ${t}. Ensure that the symbol is correct and is a weight unit symbol`);const o=await c.get(`/items/${Jt}?filter[${Wt}]=${e}`,{params:{fields:[Ht]}});if(0===o.data.data.length||void 0===o.data.data[0][Ht]||null===o.data.data[0][Ht])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for the target weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const i=parseFloat(n.data.data[0][Ht]);if(isNaN(i))throw new Error(`[getAssayUnitConversionValue] source weight unit ${t} conversion value=${i} is not a number`);console.log(`[getAssayUnitConversionValue] source unit conversion value=${i}`);const s=parseFloat(o.data.data[0][Ht]);if(isNaN(s))throw new Error(`[getAssayUnitConversionValue] target weight unit ${t} conversion value=${s} is not a number`);return console.log(`[getAssayUnitConversionValue] target unit conversion value=${s}`),console.log("[getAssayUnitConversionValue] returning "+i/s),i<s?{value:null!=(a=m(s/i,4))?a:1,isConvertByMultiplication:!1}:{value:null!=(r=m(i/s,4))?r:1,isConvertByMultiplication:!0}}function x(t,e,a){if(void 0===t||void 0===e||null===t||null===e)return;const r=t.split("/"),n=e.split("/");if(r.length>2||n.length>2)throw new Error(`[getConversionUnit] sourceUnit=${t} and targetUnit=${e} must be in the format of 'unit1/unit2', an extra '/' was found`);if(1===r.length&&1===n.length)return a?`${n[0]}/${r[0]}`:`${r[0]}/${n[0]}`;if(1===r.length){const t=n[0]===r[0]?"":`${n[1]}(${r[1]})`,e=n[1];return""===e?a?t:`/${t}`:a?`${t}/${e}`:`${e}/${t}`}if(1===n.length){const t=r[1],e=r[0]===n[0]?"":`${r[1]}(${n[0]})`;return""===e?a?t:`/${t}`:a?`${t}/${e}`:`${e}/${t}`}{const t=r[0]===n[0],e=r[1]===n[1],o=t||""===r[0],i=t||""===n[0],s=e||""===r[1],l=e||""===n[1],c=!s&&!i,u=!o&&!l,d=`${s?"":r[1]}${c?"(":""}${i?"":`${n[0]}`}${c?")":""}`,f=`${o?"":r[0]}${u?"(":""}${l?"":`${n[1]}`}${u?")":""}`;return""===f?a?d:`/${d}`:a?`${d}/${f}`:`${f}/${d}`}}async function G(t,e,a){const r=await c.get(`/items/${Lt}?filter[${xt}]=${e}`,{params:{fields:[Ft]}});if(!r.data.data||!r.data.data[0]||!r.data.data[0][Ft])throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] Dry weight uom not found for symbol ${e}`);const n=r.data.data[0][Ft];if("%"===a){if(n===t)return{};const e=await L(n,t),a=x(n,t,e.isConvertByMultiplication);if(!a)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for dry weight unit ${n} and target weight unit ${t}`);return{finalConversion:{conversionFactor:e.value,conversionUom:a,isConvertByMultiplication:e.isConvertByMultiplication}}}let o=a.split("/");if(1==o.length){const t=await async function(t){const e=await c.get(`/items/${Jt}`,{params:{fields:[Wt,Yt],filter:{[Yt]:{_nnull:!0},[Wt]:{_eq:t}}}});if(200!==e.status||!e.data||0===e.data.data.length)throw new Error("[getAssayUnitComposition] no assay units found with composition");return e.data.data[0][Yt]}(a);if(!t)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${a} does not have a composition`);o=t.split("/")}if(o.length>2||0===o.length)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${a} is not in the format of 'unit1/unit2'`);const i=o[0],s=o[1],l={};if(s!==n){const t=await L(n,s),e=x(n,s,t.isConvertByMultiplication);if(!e)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for dry weight unit ${n} and assay unit denominator unit ${s}`);l.initialConversion={conversionFactor:t.value,conversionUom:e,isConvertByMultiplication:t.isConvertByMultiplication}}if(i!==t){const e=await L(i,t),a=x(i,t,e.isConvertByMultiplication);if(!a)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for target weight unit ${t} and assay unit numerator unit ${i}`);l.finalConversion={conversionFactor:e.value,conversionUom:a,isConvertByMultiplication:e.isConvertByMultiplication}}return l}const q="lot_number",V="method",J="contract",W="counterparty",H="assay_results",Y="weight_result",Q="estimate_arrival_date",z="actual_arrival_date",K="bl_date",X="estimated_shipment_date",Z="qp_selection",tt="vessel",et="origin",at="destination",rt="shipment_code",nt="invoice_due_date",ot="adjustments",it="parcel_finalisation_date",st="assay_uom",lt="contract_currency",ct="gst_applicable",ut="gst_rate",dt="local_currency",ft="invoice_type",ht="pay_percent",pt="pa_days",yt="pa_day_type",mt="pa_ref_day",vt="pp_days",gt="pp_day_type",wt="pp_ref_day",_t="commodity",$t="payable_commodity",Et="price_per_uom",bt="related_commodity_in_contract",At="lower_threshold",Ct="lower_threshold_inclusive",Dt="upper_threshold",Nt="upper_threshold_inclusive",Pt="rate",Ot="navarch_treatment_charge_bracket",St="base_treatment_charge",It="base_charge_adjustment",Tt="use_btc",Bt="escalator_reference",Mt="for_every_unit",Ut="name",kt="code",Rt="navarch_currency",jt="code",Lt="navarch_unit",Ft="symbol",xt="dry_symbol",Gt="dry_unit",qt="wet_unit",Vt="conversionToGram",Jt="navarch_assay_unit",Wt="unit",Ht="conversion_to_ppb",Yt="composition",Qt="name",zt="navarch_address_id",Kt="business_number",Xt="name",Zt="logo",te="line_1",ee="line_2",ae="city",re="state",ne="country",oe="zip",ie="phone_code",se="phone_number",le="signatory_name",ce="signatory_title",ue="remittance_details",de="business_number",fe="signature",he="navarch_country",pe="name",ye="phone_code",me="line_1",ve="line_2",ge="city",we="state",_e="country",$e="zip",Ee="name",be="navarch_world_port",Ae="port_name",Ce="country",De="price_am",Ne="price_pm",Pe="average_price",Oe="date",Se="name",Ie="navarch_invoices",Te="parcel",Be="invoice",Me="document_type",Ue="revision_invoice",ke="invoice_type",Re="invoice_date",je="amount_paid",Le="gst_paid_in_local_currency",Fe="currency_conversion_to_usd",xe=Object.keys(B)[Object.keys(B).length-1],Ge=r(u.value[Me]==xe);o((()=>u.value[Me]),(t=>{console.log(`[watch] new document type=${t} equals the last document type=${xe}?`),Ge.value=t==xe}));let qe=null;function Ve(t){return!!t&&"object"==typeof t&&!!t[ct]}async function Je(){const t=await c.get(`/folders?filter[name][_eq]=${encodeURI("Invoices")}`);return 200===t.status&&t.data&&t.data.data?0===t.data.data.length?await async function(){return(await c.post("/folders",{name:"Invoices"})).data.data.id}():t.data.data[0].id:null}async function We(t){const a=null!=t?t:e.value.doc_name;if(console.log(`[downloadPdf] doc ID: ${a}`),!a)throw new Error("No document ID found, please ensure the document has been generated");try{const t=(await c.get(`/files/${a}`)).data.data.filename_download,e=await c.get(`/assets/${a}`,{responseType:"arraybuffer"}),r=new Blob([e.data],{type:"application/pdf"}),n=URL.createObjectURL(r),o=document.createElement("a");o.href=n,o.download=null!=t?t:"invoice.pdf",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}catch(t){throw console.error(`[downloadPdf] error: ${t}`),new Error("Failed to fetch the document, please try again")}}return{isGeneraingDoc:s,invoiceUrl:u.value,isLastDocType:Ge,generateInvoice:async function(){var t,e,r,n,o,l,f,h,v,w,$,E,P,O,S,I,U,R,j,L,F,x,Vt,Jt,Wt,Ht,Yt,De,Ne,Pe,Oe,xe,Ge,Ye,na,oa,ia,sa,la,ca,ua,da,fa;i.value="";try{if(s.value=!0,console.log("[generateInvoice] formValues=",u),p(u.value[Me]))return i.value="Document type not selected for invoice document generation",void(s.value=!1);if(p(u.value[ke]))return i.value="Invoice type not selected for invoice document generation",void(s.value=!1);const ha=u.value[Te];if(!ha)return i.value="Parcel not selected for invoice document generation",void(s.value=!1);const pa=u.value[Re]?new Date(u.value[Re]):new Date,ya=u.value[ke],ma=await c.get(`/items/navarch_parcel/${ha}`,{params:{fields:[H,Y,J,W,Q,z,K,X,Z,tt,et,at,rt,nt,ot]}});console.log(`parcelResponce.data.data=${JSON.stringify(ma.data.data)}`),function(t){if(!t)throw new Error("Parcel data not found, please ensure the selected parcel still exists");if(!t[J])throw new Error("The selected parcel does not have a contract, please ensure that the contract field for the parcel is not empty");if(!t[W])throw new Error("The selected parcel does not have a counterparty, please ensure that the counterparty field for the parcel is not empty");if(!t[H])throw new Error("The selected parcel does not have assay results");if(!t[Y])throw new Error("The selected parcel does not have weight results");if(!t[et])throw new Error("The selected parcel does not have an origin port");if(!t[at])throw new Error("The selected parcel does not have a destination port");if(!t[rt])throw new Error("The selected parcel does not have a shipment code")}(ma.data.data);const va=ma.data.data[H],ga=(ma.data.data[Y],ma.data.data[J]),wa=ma.data.data[Z],_a=await c.get(`/items/navarch_contract_payment_information?filter[related_contract]=${ga}`,{params:{fields:[ft,ht,pt,yt,mt,vt,gt,wt]}});if(_a.data.data&&0===_a.data.data.length)return i.value="No invoice type found for the contract",void(s.value=!1);const $a=_a.data.data.find((t=>t[ft]===ya));if(!$a)return i.value=`Cannot find payment information for ${ya} in the contract, please ensure that data for it has been entered and saved`,void(s.value=!1);const Ea=await c.get(`/items/navarch_weight_lot?filter[related_parcel]=${ha}&filter[${q}][_nnull]=true&sort[]=${q}`,{params:{fields:["id","dry_weight","wet_weight",V,"moisture","wet_weight_uom","dry_weight_uom"]}});console.log(`weightLotResponse.data.data=${JSON.stringify(Ea.data.data)}`),function(t){if(!t||0===t.length)throw new Error("No weight lots found for the selected parcel")}(Ea.data.data);const ba=function(t){console.log("[evaluateWeights]");const e={};for(const a of t)e[a.method]||(console.log(`adding method ${a.method} to weightData object`),e[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),e[a.method.toString()].push(a);const a=[];for(const t of Object.keys(e)){if(!e[t]){console.log(`method=${t} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${t}`);const r=d(e[t]);r&&a.push(r)}return a}(Ea.data.data),Aa=u.value.weight_method;let Ca=ba.find((t=>t.method===Aa));if(Ca||(Ca=ba.find((t=>"Outturn"===t.method))),Ca||(Ca=ba.find((t=>"Inturn Final"===t.method))),Ca||(Ca=ba.find((t=>"Inturn"===t.method))),Ca||(Ca=ba.find((t=>"Estimated"===t.method))),Ca||(Ca=ba.find((t=>"Planned"===t.method))),!Ca)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");if(void 0===Ca.dry_weight||null===Ca.dry_weight||void 0===Ca.wet_weight||null===Ca.wet_weight||void 0===Ca.moisture||null===Ca.moisture||void 0===Ca.dry_weight_uom||null===Ca.dry_weight_uom||void 0===Ca.wet_weight_uom||null===Ca.wet_weight_uom||void 0===Ca.method||null===Ca.method)throw new Error("One of the fields for weight lots is undefined");const Da=await c.get(`/items/${Lt}?filter[${xt}]=${Ca.dry_weight_uom}`,{params:{fields:[Gt]}}),Na=await c.get(`/items/${Lt}?filter[wet_symbol]=${Ca.wet_weight_uom}`,{params:{fields:[qt]}});if(!Da.data.data||!Da.data.data[0]||!Da.data.data[0][Gt])throw new Error(`Dry weight uom not found for symbol ${Ca.dry_weight_uom}`);if(!Na.data.data||!Na.data.data[0]||!Na.data.data[0][qt])throw new Error(`Wet weight uom not found for symbol ${Ca.wet_weight_uom}`);const Pa=Da.data.data[0][Gt],Oa=0===Pa.indexOf("dry")?Pa:`dry ${Pa}`,Sa=Na.data.data[0][qt],Ia=0===Sa.indexOf("wet")?Sa:`wet ${Sa}`,Ta=await c.get(`/items/navarch_assay_lot?filter[foreign_key]=${va}&sort[]=${q}`,{params:{fields:["id","commodity",V,"dry_weight","dry_weight_uom","buyer_assay","seller_assay","final_assay","lot_number",st]}});console.log(`assayLotResponse.data.data=${JSON.stringify(Ta.data.data)}`),function(t){if(!t||0===t.length)throw new Error("No assay lots found for the selected parcel")}(Ta.data.data);const Ba=function(t){var e;console.log("[evaluateAnalyticalAssay]");const a={};for(const e of t)a[e.method]||(a[e.method]={}),a[e.method][e.commodity]||(a[e.method][e.commodity]=[]),null!==e.lot_number?(1===a[e.method][e.commodity].length&&null===a[e.method][e.commodity][0].lot_number&&(a[e.method][e.commodity]=[]),a[e.method][e.commodity].push(e)):null===e.lot_number&&0===a[e.method][e.commodity].length&&a[e.method][e.commodity].push(e);console.log(`[evaluateAnalyticalAssay] group: ${JSON.stringify(a)}}`);const r={};for(const t in a){console.log(`[evaluateAnalyticalAssay] methodKey: ${t}, group[methodKey]: ${JSON.stringify(a[t])}`);for(const n in a[t]){console.log(`[evaluateAnalyticalAssay] commodityKey: ${n}, group[methodKey][commodityKey]: ${JSON.stringify(a[t][n])}`),r[t]=null!=(e=r[t])?e:{},r[t][n]={};const o=a[t][n].reduce(((t,e)=>t+parseFloat(e.dry_weight)),0);if(console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${o} from ${JSON.stringify(a[t][n])}`),0===o||isNaN(o))throw i.value=`Please provide dry weight for ${n} commodity in ${t} method, total dry weight cannot be ${o}`,new Error("[evaluateAnalyticalAssay] totalDryWeight is 0");console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${o}`),r[t][n].analytical_assay=a[t][n].reduce(((e,a)=>{var r,o,s;const l=parseFloat(null!=(o=a.final_assay)?o:null!=(r=a.seller_assay)?r:a.buyer_assay);if(null==l)throw i.value=`Please provide Final, Seller or Buyer assay value for ${n} commodity in ${t} method`,new Error("[evaluateAnalyticalAssay] assay value is not defined for assay lot");const c=e+l*parseFloat(null!=(s=a.dry_weight)?s:"0");return console.log(`[evaluateAnalyticalAssay] evaluated analytical assay: ${c} for method=${t}, commodity=${n}; with values accumulator=${e}, assayValue=${l}, dryWeight=${a.dry_weight}`),c}),0)/o,console.log(`[evaluateAnalyticalAssay] analytical assay: ${r[t][n].analytical_assay}`),a[t][n].length>0&&(r[t][n][st]=a[t][n][0][st])}}return console.log(`[evaluateAnalyticalAssay] analyticalAssay: ${JSON.stringify(r)}`),r}(Ta.data.data),Ma=u.value.assay_method;let Ua;if(Ma&&(Ua=Ba[Ma.toString()]),Ua||(Ua=Ba.Outturn),Ua||(Ua=Ba["Inturn Final"]),Ua||(Ua=Ba.Inturn),Ua||(Ua=Ba.Estimated),Ua||(Ua=Ba.Planned),!Ua)throw new Error("No assay lot data found for all assay methods. Please ensure assay lot data has been entered in the selected parcel.");console.log(`WEIGHT: ${JSON.stringify(Ca)}`),console.log(`ASSAYS: ${JSON.stringify(Ua)}`);const ka=await c.get(`/items/navarch_contract/${ga}`,{params:{fields:[lt,ct,ut,dt]}});!function(t){if(!t)throw new Error("Contract data not found, please ensure the selected contract still exists");if(!t[lt])throw new Error("The selected contract does not have a set currency, please ensure that the currency field for the contract is not empty");if(t[ct]){if(isNaN(t[ut]))throw new Error("GST Rate from the contract is not a valid number");if(t[ut]<0||t[ut]>100)throw new Error("GST Rate from the contract is not a valid percentage");if(p(t[dt]))throw new Error("Currency for the country of the GST rate in the contract is not selected");if(isNaN(t[dt]))throw new Error("Currency for the country of the GST rate in the contract is invalid")}}(ka.data.data);const Ra=await c.get(`/items/${Rt}/${ka.data.data.contract_currency}`,{params:{fields:[jt]}});Xe(Ra.data.data,"selected currency for the contract");const ja=Ra.data.data.code,La=await c.get(`/items/navarch_commodity_in_contract?filter[contract]=${ga}`,{params:{fields:["id",_t,"primary_commodity",$t,"price_method","price_fix_to_use","quotational_periods","payable_assay_rates","penalty_rates","penalty_per_uom",Et,"treatment_charge_per_uom","tc_reference","refining_charge_rate_uom"]}});!function(t){if(!t||0===t.length)throw new Error("No commodity data found in selected contract for parcel");if(!t.every((t=>t[_t])))throw new Error("The selected contract has an undefined commodity, please ensure that the 'Commodity' field for all commodites in the contract is not empty");if(!t.every((t=>!t[$t]||t[Et])))throw new Error("The selected contract has an undefined base price Uom for commodity, please ensure that the 'Base Price Uom' field for all commodites in the contract is not empty")}(La.data.data),console.log(`\tcommodityInContractResponse: ${JSON.stringify(La.data.data)}`);const Fa=[],xa=[];let Ga="",qa=[];for(const{id:a,commodity:i,primary_commodity:s,payable_commodity:u,price_method:d,price_fix_to_use:p,quotational_periods:g,price_per_uom:C,penalty_per_uom:N,treatment_charge_per_uom:T,tc_reference:B,refining_charge_rate_uom:M}of La.data.data){const k=await c.get(`/items/navarch_commodity/${i}`,{params:{fields:[Ut,kt]}});if(Ze(k.data.data,i),!Ua[k.data.data.code]){console.log(`[generateInvoice] no analytical assay for commodity ${k.data.data.code} found, skipping...`);continue}if(s&&(Ga=k.data.data[Ut]),null!==g){const i=g;console.log(`\tquotationalPeriods: ${JSON.stringify(i)}`);const s=Array.isArray(i)?i.find((t=>t.default)):null;if(!s)throw new Error(`No default quotational period found for commodity ${k.data.data.code}`);let u,A=!1;const N=wa?wa[k.data.data[kt]]:void 0;if(void 0!==N&&(null==N?void 0:N.declared))A=N.declared,u=N.qp_selected;else{const t=i.filter((t=>!t.default)).map((t=>`${t.qp_period} ${t.qp_code}`));u=[`${s.qp_period} ${s.qp_code}`,...t].join(", ")}console.log(`[generateInvoice] evaluate payable assay for ${k.data.data.code} with an analytical assay=${null==(t=Ua[k.data.data.code])?void 0:t.analytical_assay}`);const q=await c.get(`/items/navarch_payable_assay_bracket?filter[${bt}]=${a}`,{params:{fields:["bracket_type",At,Ct,Dt,Nt,Pt,"rate_type","initial_adjustment","initial_adjustment_uom","minimum_deduction","minimum_deduction_uom","maximum_cap","maximum_cap_uom"]}}),{payableAssay:V,expression:J}=await _(null==(e=Ua[k.data.data.code])?void 0:e.analytical_assay,null==(r=Ua[k.data.data.code])?void 0:r.assay_uom,q.data.data,k.data.data[Ut]);let W=null,H=null,Y=null;if("Final"!==ya){const t=await He(k.data.data.code,ma.data.data,pa,d,(async()=>Qe($a,ma.data.data,pa,ya)));if(null===t)throw new Error(`[generateInvoice] Provisional pricing dates not found for commodity ${k.data.data.code}`);if(null===t.provisionalPricingStartDate||!(t.provisionalPricingStartDate instanceof Date))throw new Error(`[generateInvoice] Invalid provisional pricing start date for commodity ${k.data.data.code} of invoice type ${ya}`);if(W=t.provisionalPricingStartDate,null===t.provisionalPricingEndDate||!(t.provisionalPricingEndDate instanceof Date))throw new Error(`[generateInvoice] Invalid provisional pricing end date for commodity ${k.data.data.code} of invoice type ${ya}`);H=t.provisionalPricingEndDate,Y=t.expectedNoOfBusinessDays}else{const t=await He(k.data.data.code,ma.data.data,pa,d,(async()=>ze(s,ma.data.data,pa)),!0);if(null===t)throw new Error(`[generateInvoice] Provisional pricing dates not found for commodity ${k.data.data.code}`);if(null===t.provisionalPricingStartDate||!(t.provisionalPricingStartDate instanceof Date))throw new Error(`[generateInvoice] Invalid provisional pricing start date for commodity ${k.data.data.code} of invoice type ${ya}`);if(W=t.provisionalPricingStartDate,null===t.provisionalPricingEndDate||!(t.provisionalPricingEndDate instanceof Date))throw new Error(`[generateInvoice] Invalid provisional pricing end date for commodity ${k.data.data.code} of invoice type ${ya}`);H=t.provisionalPricingEndDate,qa.push(H),console.log(`[generateInvoice] Provisional pricing start date=${W.toString()} and end date=${H.toString()}`)}console.log(`[generateInvoice] provisional pricing date range: ${W.toString()} - ${H.toString()}`);const Q=await Ke(k.data.data.code,d,W,H,Y,p),z=Q.averagePrice;let K;W=Q.startDate,H=Q.endDate,console.log(`[generateInvoice] average price within period: ${z} with start date=${W} and end date=${H}`);const X=await c.get(`/items/${Ot}?filter[related_contract_commodity_tc]=${a}`,{params:{fields:[At,Ct,Dt,Nt,St,It,Tt,Bt,Mt,Pt]}});if(void 0!==X.data.data&&null!==X.data.data&&X.data.data.length>0){let t;if("Assay Grade"===B){if(t=m(null==(n=Ua[k.data.data.code])?void 0:n.analytical_assay,4),null===t)throw new Error(`Assay Grade is not defined for commodity ${k.data.data[Ut]} when evaluating treatment charge`)}else t=z;K=await b(t,null==(o=Ua[k.data.data.code])||o.assay_uom,X.data.data,k.data.data[Ut],"treatment charge",B.toLowerCase())}let Z,tt;if(K){if(!T)throw new Error(`Treatment Charge Rate UOM is not defined for commodity ${k.data.data[Ut]}`);const t=await c.get(`/items/${Lt}/${T}`,{params:{fields:[Ft]}});ea(t.data.data,k.data.data[Ut]),Z=t.data.data[Ft]}const et=await c.get(`/items/${Ot}?filter[related_contract_commodity_rc]=${a}`,{params:{fields:[At,Ct,Dt,Nt,St,It,Tt,Bt,Mt,Pt]}});let at;if(void 0!==et.data.data&&null!==et.data.data&&et.data.data.length>0&&(tt=await b(z,null==(l=Ua[k.data.data.code])||l.assay_uom,et.data.data,k.data.data[Ut],"refining charge","price rate")),tt){if(!M)throw new Error(`Refining Charge Rate UOM is not defined for commodity ${k.data.data[Ut]}`);const t=await c.get(`/items/${Lt}/${M}`,{params:{fields:[Ft]}});ea(t.data.data,k.data.data[Ut]),at=t.data.data[Ft]}const rt=await c.get(`/items/${Lt}/${C}`,{params:{fields:[Ft]}});ta(rt.data.data,k.data.data[Ut]);const nt=rt.data.data[Ft],ot=await G(nt,Ca.dry_weight_uom,null==(f=Ua[k.data.data.code])?void 0:f.assay_uom);console.log(`[generateInvoice] payableMetalConversion for commodity ${k.data.data.name}: ${JSON.stringify(ot)}`),ot.initialConversion=1===(null==(h=ot.initialConversion)?void 0:h.conversionFactor)?void 0:ot.initialConversion,ot.finalConversion=1===(null==(v=ot.finalConversion)?void 0:v.conversionFactor)?void 0:ot.finalConversion;const it=await c.get(`/items/navarch_price_method/${d}`,{params:{fields:[Se]}});ra(it.data.data,d,k.data.data[Ut]);const st=(null==(w=ot.initialConversion)?void 0:w.isConvertByMultiplication)?null!=(E=null==($=ot.initialConversion)?void 0:$.conversionFactor)?E:1:1/(null!=(O=null==(P=ot.initialConversion)?void 0:P.conversionFactor)?O:1),lt=(null==(S=ot.finalConversion)?void 0:S.isConvertByMultiplication)?null!=(U=null==(I=ot.finalConversion)?void 0:I.conversionFactor)?U:1:1/(null!=(j=null==(R=ot.finalConversion)?void 0:R.conversionFactor)?j:1),ct=null!=(F=m(Ca.dry_weight*st*(null!=V?V:1)*lt*("%"!==(null==(L=Ua[k.data.data.code])?void 0:L.assay_uom)?1:.01),4))?F:1;console.log(`[generateInvoice] PAYABLE_METAL for commodity ${k.data.data.name}: ${ct}`);const ut=m(z,4),dt=m(ct*(null!=ut?ut:z));Fa.push({commodity:k.data.data.name,analytical_assay:m(null==(x=Ua[k.data.data.code])?void 0:x.analytical_assay,4),deduction_expression:J,payable_assay:m(V,4),assay_uom:null==(Vt=Ua[k.data.data.code])?void 0:Vt.assay_uom,payable_metal:ct,payable_metal_expression:`${y(Ca.dry_weight,4)}${Ca.dry_weight_uom}${ot.initialConversion?` ${ot.initialConversion.isConvertByMultiplication?"*":"/"} ${y(ot.initialConversion.conversionFactor,4)}${ot.initialConversion.conversionUom}`:""} * ${y(null!=V?V:1,4)}${"%"!==(null==(Jt=Ua[k.data.data.code])?void 0:Jt.assay_uom)?`${null==(Wt=Ua[k.data.data.code])?void 0:Wt.assay_uom}`:" / 100"}${ot.finalConversion?` ${ot.finalConversion.isConvertByMultiplication?"*":"/"} ${y(ot.finalConversion.conversionFactor,4)}${ot.finalConversion.conversionUom}`:""}`,payable_metal_uom:nt,qp:u,qp_declared:A,qp_month:qe,qp_start_date:D(W),qp_end_date:D(H),price_method:it.data.data[Se],price_rate:ut,price_per_uom:nt,price:dt,treatment_charge:K?{rate:m(K.baseTreatmentCharge,4),discount:m((null!=(Ht=K.baseTreatmentCharge)?Ht:0)-(null!=(Yt=K.finalValue)?Yt:0),4),final_rate:m(K.finalValue,4),per_uom:Z,final_amount:m(Ca.dry_weight*(null!=(De=K.finalValue)?De:1)*-1,2,!0)}:void 0,refining_charge:tt?{rate:m(tt.baseTreatmentCharge,4),discount:m((null!=(Ne=tt.baseTreatmentCharge)?Ne:0)-(null!=(Pe=tt.finalValue)?Pe:0),4),final_rate:m(tt.finalValue,4),per_uom:at,final_amount:m(ct*(null!=(Oe=tt.finalValue)?Oe:1)*-1,2,!0)}:void 0,final_total:m((null!=dt?dt:0)+(K&&null!=(Ge=m(Ca.dry_weight*(null!=(xe=K.finalValue)?xe:1)*-1,2,!0))?Ge:0)+(tt&&null!=(na=m(ct*(null!=(Ye=tt.finalValue)?Ye:1)*-1,2,!0))?na:0))})}else{if(s)throw new Error(`No QP set in the contract for the primary commodity ${k.data.data[Ut]}`);if(u)throw new Error(`No QP set in the contract for the payable commodity ${k.data.data[Ut]}`)}const q=await c.get(`/items/navarch_penalty_bracket?filter[${bt}]=${a}`,{params:{fields:[At,Ct,Dt,Nt,"no_penalty","escalator_reference","for_every_unit",Pt]}});if(q.data.data.length>0){if(null===N)throw new Error(`Please fill in the field for Penalty Per UOM in the contract for commodity ${k.data.data[Ut]}`);const t=await c.get(`/items/${Lt}/${N}`,{params:{fields:[Ft]}});aa(t.data.data,k.data.data[Ut]);const e=t.data.data[Ft],{penalty:a,expression:r,bracket:n}=await A(null==(oa=Ua[k.data.data.code])?void 0:oa.analytical_assay,q.data.data,ja,e,k.data.data[Ut]);console.log(`[generateInvoice] evaluate penalty for ${k.data.data.code} with an analytical assay=${null==(ia=Ua[k.data.data.code])?void 0:ia.analytical_assay}, penaltyRate=${null==n?void 0:n.rate}, finalPenaltyRate=${a}, expression='${r}'`),xa.push({commodity:k.data.data.name,analytical_assay:m(null==(sa=Ua[k.data.data.code])?void 0:sa.analytical_assay,4),deduction_expression:r,assay_uom:null==(la=Ua[k.data.data.code])?void 0:la.assay_uom,penalty_rate:m(null==n?void 0:n.rate,4),penalty_per_uom:e,final_penalty_rate:m(a,4),final_penalty:m((null!=a?a:1)*Ca.dry_weight*-1,2,!0)})}}console.log(`[generateInvoice] COMMODITIES: ${JSON.stringify(Fa)}`),console.log(`[generateInvoice] PENALTIES: ${JSON.stringify(xa)}`);const Va=Fa.reduce(((t,e)=>{var a;return t+(null!=(a=null==e?void 0:e.price)?a:0)}),0),Ja=Fa.reduce(((t,e)=>{var a,r;return t+(null!=(r=null==(a=e.treatment_charge)?void 0:a.final_amount)?r:0)}),0),Wa=Fa.reduce(((t,e)=>{var a,r;return t+(null!=(r=null==(a=e.refining_charge)?void 0:a.final_amount)?r:0)}),0),Ha=xa.reduce(((t,e)=>{var a;return t+(null!=(a=null==e?void 0:e.final_penalty)?a:0)}),0);console.log(`[generateInvoice] TOTAL_REVENUE=${Va}, TOTAL_TREATMENT_CHARGE=${Ja}, TOTAL_REFINING_CHARGE=${Wa}, TOTAL_PENALTIES=${Ha}`);let Ya,Qa=0;const za=!!ma.data.data[ot];za&&(Qa=ma.data.data[ot].reduce(((t,e)=>t+e.amount),0),Ya={adjustments:ma.data.data[ot].map((t=>({description:t.description,amount:m(t.amount)}))),total_adjustments:m(Qa)});const Ka=$a[ht],Xa=Va+Ja+Wa+Ha,Za=null!=Ka?Xa*Ka/100:void 0,tr=await c.get(`/items/navarch_counterparty/${ma.data.data[W]}`,{params:{fields:[Qt,Kt]}});!function(t){if(console.log("[validateCounterparty]"),!t)throw new Error("Counterparty for parcel not found");if(!t[Qt])throw new Error("No name defined for counterparty of the selected parcel")}(tr.data.data);const er=await c.get(`/items/navarch_counterparty_navarch_address?filter[navarch_counterparty_id]=${ma.data.data[W]}`,{params:{fields:[zt]}});!function(t){if(console.log("[validateCounterpartyAddress]"),!t||0===t.length)throw new Error("Counterparty address for parcel not found");if(!t[0][zt])throw new Error("No address defined for counterparty of the selected parcel")}(er.data.data);const ar=er.data.data[0][zt],rr=await c.get(`/items/navarch_address/${ar}`,{params:{fields:[me,ve,ge,we,_e,$e]}});!function(t){if(!t)throw new Error("Buyer address for parcel not found");if(!t[me])throw new Error("No address line 1 defined for buyer address of the selected parcel");if(!t[_e])throw new Error("No country defined for buyer address of the selected parcel")}(rr.data.data);const nr=rr.data.data[me],or=rr.data.data[ve]?`,\n${rr.data.data[ve]}`:"",ir=rr.data.data[ge]?`,\n${rr.data.data[ge]}`:"",sr=rr.data.data[we]?`,\n${rr.data.data[we]}`:"",lr=await c.get(`/items/${he}/${rr.data.data[_e]}`,{params:{fields:[pe]}});!function(t){if(!t)throw new Error("Something went wrong when getting the buyer's based country")}(lr.data.data);const cr=lr.data.data[pe]?`, ${lr.data.data[pe]}`:"",ur=`${nr}${or}${ir}${rr.data.data[$e]?` ${rr.data.data[$e]}`:""}${sr}${cr}`,dr=ma.data.data[tt];let fr;dr&&(fr=await c.get(`/items/navarch_vessel/${dr}`,{params:{fields:[Ee]}}),function(t){if(console.log("[validateVessel]"),!t)throw new Error("Vessel for parcel not found");if(!t[Ee])throw new Error("No name defined for vessel of the selected parcel")}(fr.data.data));const hr=(await c.get("/items/navarch_company",{params:{fields:[Xt,Zt,te,ee,ae,re,oe,ne,ie,se,le,ce,ue,fe,de]}})).data.data;let pr=null;if(hr[Zt]){const t=hr[Zt],e=await c.get(`/assets/${t}`,{responseType:"arraybuffer"}),a=g.Buffer.from(e.data,"binary"),r=e.headers["content-type"];Object.values(M).includes(r)&&(pr={imageData:a.toString("base64"),imageType:r})}const yr=hr[fe];let mr=null;if(yr){const t=await c.get(`/assets/${yr}`,{responseType:"arraybuffer"}),e=g.Buffer.from(t.data,"binary"),a=t.headers["content-type"];Object.values(M).includes(a)&&(mr={imageData:e.toString("base64"),imageType:a})}!function(t){if(console.log("[validateCompanyData]"),!t)throw new Error("Company data not found");if(!t[Xt])throw new Error("Please set company name in Directories > Company");if(!t[te])throw new Error("Please set company address line 1 in Directories > Company");if(!t[ne])throw new Error("Please set the country the company is based in Directories > Company");if(!t[le])throw new Error("Please set the company signatory name in Directories > Company");if(!t[ce])throw new Error("Please set the company signatory title in Directories > Company");if(!t[ue])throw new Error("Please set the company remittance details in Directories > Company");if(!t[fe])throw new Error("Please set the company signature in Directories > Company")}(hr);const vr=hr[Xt];let gr,wr;if(hr[ie]){const t=await c.get(`/items/${he}/${hr[ie]}`,{params:{fields:[ye]}});!function(t){if(!t)throw new Error("Company phone code not found, please ensure phone code selected for Directories > Company is valid");if(!t[ye])throw new Error("Company country phone code not found, please contact Navarch support for assistance")}(t.data.data),gr=t.data.data[ye],wr=hr[se]}const _r=hr[te],$r=hr[ee]?`,\n${hr[ee]}`:"",Er=hr[ae]?`,\n${hr[ae]}`:"",br=hr[re]?`,\n${hr[re]}`:"",Ar=await c.get(`/items/${he}/${hr[ne]}`,{params:{fields:[pe]}});!function(t){if(!t)throw new Error("Country not found, please ensure country selected for Directories > Company is valid");if(!t[pe])throw new Error("Country name not found, please contact Navarch support for assistance")}(Ar.data.data);const Cr=Ar.data.data[pe]?`, ${Ar.data.data[pe]}`:"",Dr=`${_r}${$r}${Er}${hr[oe]?` ${hr[oe]}`:""}${br}${Cr}`,Nr=await c.get(`/items/${be}/${ma.data.data[et]}`,{params:{fields:[Ae,Ce]}});!function(t){if(!t)throw new Error("Origin port for parcel not found");if(!t[Ae])throw new Error("No name defined for origin port of the selected parcel");if(!t[Ce])throw new Error("No country defined for origin port of the selected parcel")}(Nr.data.data);const Pr=await c.get(`/items/${be}/${ma.data.data[at]}`,{params:{fields:[Ae,Ce]}});!function(t){if(!t)throw new Error("Destination port for parcel not found");if(!t[Ae])throw new Error("No name defined for destination port of the selected parcel");if(!t[Ce])throw new Error("No country defined for destination port of the selected parcel")}(Pr.data.data);const Or=((await c.get(`/items/${Ie}?filter[${Te}]=${ha}`,{params:{fields:["id",Be]}})).data.data.reduce(((t,e)=>t+(e[Be]?1:0)),0)+1).toString().padStart(2,"0"),Sr=`${ma.data.data[rt]} (#${Or})`,Ir=ma.data.data[nt];let Tr=null;if(Ir){const t=null==(ca=Ir[ya])?void 0:ca.due_date;p(t)||(Tr=new Date(t))}if(p(Tr)){const t={invoice_type:ya,days:$a[pt],day_type:$a[yt],ref_day:"Final"===ya?void 0:$a[mt]};if(!t)throw new Error(`Contract does not have a payment advice for invoice type ${ya}`);let e,a="";if("Final"!==ya)switch(t.ref_day){case"Arrival Date":a="Actual/Estimated Arrival Date from the Parcel form",e=null!=(ua=ma.data.data[z])?ua:ma.data.data[Q];break;case"B/L Date":a="B/L Date (or Estimated Shipment Date) from the Parcel form",e=null!=(da=ma.data.data[K])?da:ma.data.data[X];break;case"End of Month of Delivery":a="B/L Date (or Estimated Shipment Date) from the Parcel form",e=null!=(fa=ma.data.data[K])?fa:ma.data.data[X];const r=new Date(e);r.setMonth(r.getMonth()+1,0),e=N(r);break;case"Invoice Date":a="Invoice Date from the Invoice form",e=u.value[Re];break;case"Estimated Shipment Date":a="Estimated Shipment Date from the Parcel form",e=ma.data.data[X];break;case"Parcel Finalisation":if(void 0===ma.data.data[it]||null===ma.data.data[it])throw new Error("[generateInvoice] Parcel has not been finalised, please fill in the the parcel finalisation date in the parcel form.");a="Parcel Finalisation Date from the Parcel form",e=ma.data.data[it];break;default:throw new Error(`Invalid reference day for payment advice: ${t.ref_day}; please contact Navarch for support`)}else a="Last day of the last QP Month";if("Final"!==ya&&p(e))throw new Error(`Reference day for payment advice ${a} is empty in parcel`);const r="Final"===ya?function(t,e){if(0===t.length)throw new Error(e);return t.reduce(((t,e)=>p(e)&&e.valueOf()>t.valueOf()?e:t),t[0])}(qa,"No QP Month end dates found when evaluating due date for Final invoice"):new Date(e),n=parseInt(t.days),o=t.day_type;switch(o){case"Business Day(s)":Tr=function(t,e,a=!1){const r=new Date(t.valueOf());let n=e-(a?1:0),o=!0;for(;k(r);)r.setDate(r.getDate()+1),o&&(n-=1,o=!1);for(;n>0;)r.setDate(r.getDate()+1),k(r)||(n-=1);for(r.getHours()>=12&&r.setDate(r.getDate()+1);k(r);)r.setDate(r.getDate()+1);return r}(r,n);break;case"Calendar Day(s)":Tr=new Date(r.valueOf()),Tr.getHours()>=12?Tr.setDate(Tr.getDate()+n+1):Tr.setDate(Tr.getDate()+n);break;default:throw new Error(`[generateInvoice] Invalid day_type for payment advice ${o}`)}}if(!Tr)throw new Error(`Due date could not be calculated for invoice type ${ya}`);console.log(`[generateInvoice] payment advice due date: ${Tr.toString()}`);const Br=D(Tr),Mr=[],Ur={};let kr=0,Rr=0;const jr="current";let Lr,Fr,xr,Gr,qr,Vr;if(Ve(ka.data.data)){if(isNaN(ka.data.data[ut]))throw new Error("GST Rate from the contract is not a valid number");kr=ka.data.data[ut]/100;const t=await c.get(`/items/${Rt}/${ka.data.data[dt]}`,{params:{fields:[jt]}});if(Xe(t.data.data,"local currency for GST in the contract"),Lr=t.data.data[jt],p(u.value[Fe]))throw new Error("Local currency for GST to USD exchange rate is not provided in the current invoice form, field mandatory when GST is applicable");if(isNaN(u.value[Fe]))throw new Error("Local currency for GST to USD exchange rate provided in the current invoice form is not a number");const e=Xa*kr;if(Fr=m(u.value[Fe],4),0===Fr||null===Fr)throw new Error(`Invalid conversion rate to USD of ${Fr} provided in the Invoice form for GST calculation`);const a=e/Fr;Ur[jr]={gst_in_usd:m(e),gst_in_local_currency:m(a),conversion_rate_to_usd:Fr,local_currency:Lr},Rr=a}if(u.value[Ue]){const t=await c.get(`/items/${Ie}/${u.value[Ue]}`,{params:{fields:[Te,Be,ke,Me]}});if(console.log(`[generateInvoice] revisionParcelResponse: ${JSON.stringify(t.data)}`),200!==t.status||!t.data.data)throw new Error(`[generateInvoice] Failed to get invoice ${u.value[Ue]}`);if(t.data.data[Te]!==ha)throw new Error(`[generateInvoice] Parcel ID mismatch between this invoice with parcel ${ha}, and the revision invoice ${u.value[Ue]} with parcel id ${t.data.data[Te]}`);if(!t.data.data[Be])throw new Error(`[generateInvoice] No invoice pdf has been generated yet for invoice ${u.value[Ue]}`);if(!t.data.data[ke])throw new Error(`[generateInvoice] No invoice type found for the revision invoice ${u.value[Ue]}`);qr=t.data.data[ke],Vr=t.data.data[Me];const e=t.data.data[Be];if(function(t){if(!t)throw new Error("Revision invoice data not found");if(!t.invoice_number)throw new Error("Revision invoice data does not have an invoice number in generated document");if(!t.balance_in_sellers_favor)throw new Error("Revision invoice data does not have a valid 'Balance in Sellers Favor' in generated document")}(e),console.log(`[generateInvoice] revisionInvoiceData: ${JSON.stringify(e)}`),xr=e.invoice_number,!xr||""===xr)throw new Error(`[generateInvoice] Could not find invoice number in revision invoice ${u.value[Ue]}`);const a=e.balance_in_sellers_favor.replace(/,/g,"");if(Gr=parseFloat(a),!Gr||isNaN(Gr))throw new Error(`[generateInvoice] Total payment=${e.balance_in_sellers_favor} found is not convertible to monetary amount for revision invoice ${u.value[Ue]}`)}const Jr=_a.data.data.map((t=>t[ft])),Wr=T[ya];if(void 0===Wr)throw new Error(`'${ya}' is not a valid Invoice Type`);const Hr=Jr.filter((t=>T[t]<Wr)),Yr=await c.get(`/items/${Ie}`,{params:{filter:{[Te]:{_eq:ha},[ke]:{_in:Hr},[Be]:{_nnull:!0}},fields:[Be,je,ke,Me,Le]}});let Qr,zr=0;Yr.data.data.forEach((t=>{const e=t[Me],a=t[ke],r=parseFloat(t[je]),n=parseFloat(t[Le]);if(p(a))throw new Error("One of the previous invoices has no invoice type");if(p(e))throw new Error(`Previous ${a} invoice has no document type`);if(a===ya&&B[e]>=B[u.value[Me]])return void console.warn(`[generateInvoice] Skipping invoice of type ${a} and document type ${e} as it is of the same or higher order Document Type than the current invoice`);if(p(t[Be]))throw new Error(`No generated invoice data found for invoice of type ${a} with document type ${e}`);const o=t[Be].invoice_number;if(p(o))throw new Error(`No invoice number found for the generated invoice of type ${a} and document type ${e}`);if(p(r)||isNaN(r))throw new Error(`Invalid amount paid for the generated invoice of type ${a} and document type ${e}`);if(o&&r&&e){zr+=r;const t=`${a}.${e}.${o}`;if(Mr.push({invoice_type:a,document_type:e,payment_received_source:t,payment_received:m(-1*r)}),Ve(ka.data.data)){if(p(n)||isNaN(n))throw new Error(`Invalid GST paid in local currency for the generated invoice of type ${a} and document type ${e}`);const r=n,o=m(r*Fr);Ur[t]={gst_in_usd:o?-1*o:null,gst_in_local_currency:r,local_currency:Lr},Rr-=r}}})),Ve(ka.data.data)&&(Qr={gst_in_usd:m(Rr*Fr),gst_in_local_currency:m(Rr),local_currency:Lr}),Mr.sort(((t,e)=>{const a=T[t.invoice_type]-T[e.invoice_type];return 0!==a?a:B[t.document_type]-B[e.document_type]}));const Kr=null!=Za?Za+(null!=Qa?Qa:0)-zr:void 0,Xr={signatoryName:hr[le],signatoryTitle:hr[ce],signature:null!=mr?mr:null,company:vr},Zr={doc_name:null,folder_id:await Je(),company_logo:null!=pr?pr:null,seller:vr,seller_address:Dr,seller_phone_number:gr&&wr?`+${gr} ${wr}`:null,seller_business_number:hr[de],signatory:Xr,remittance:hr[ue],buyer:tr.data.data[Qt],buyer_id:ma.data.data[W],buyer_address:ur,buyer_business_number:tr.data.data[Kt],shipment_code:ma.data.data[rt],vessel:fr?fr.data.data[Ee]:"N/A",bl_date:ma.data.data[K]?D(new Date(ma.data.data[K])):"N/A",invoice_type:ya,invoice_date:D(pa),revision:xr&&Gr?Vr:void 0,invoice_number:Sr,parcel:`${ma.data.data[rt]}`,port_of_loading:`${Nr.data.data[Ae]}, ${Nr.data.data[Ce]}`,port_of_discharge:`${Pr.data.data[Ae]}, ${Pr.data.data[Ce]}`,primary_commodity:`${Ga} Concentrates`,due_date:Br,wet_weight:m(Ca.wet_weight,4),wet_weight_uom:Ca.wet_weight_uom,wet_weight_uom_name:C(Ia),moisture:m(Ca.moisture,4),moisture_uom:"%",dry_weight:m(Ca.dry_weight,4),dry_weight_uom:Ca.dry_weight_uom,dry_weight_uom_name:C(Oa),total_revenue:m(Va),total_deductions:m(Ha+Ja+Wa,2,!0),currency:ja,commodities:Fa,penalties:{penalties:xa,total_penalties:m(Ha)},adjustments:za?Ya:void 0,invoice_value:m(Xa),payable_percentage:m(Ka),payable_amount:m(Za),payments_received:Mr,gst:Object.keys(Ur).length>0?Ur:void 0,balance_of_gst_payable:Qr,balance_in_sellers_favor:m(Kr)};let tn;try{tn=await c.post("/generate/invoice",Zr)}catch(t){throw console.error(`[generateInvoice] error: ${t}`),new Error(JSON.stringify(t.response.data))}if(200!==tn.status)return console.log(`[generateInvoice] invoice response status: ${tn.status}`),i.value=tn.data,void(s.value=!1);const en=await async function(t){if(!t)throw console.error("[uploadGeneratedDoc] fileData is empty"),new Error("A failure occured while trying to upload the generated document, no file data found. Please try again.");const e=function(t){console.log("[convertJsonToFormData] json=",JSON.stringify(t));const e=new FormData;for(let a in t)"file"!==a&&e.append(a,t[a]);const a=t.file,r=function(t,e){const a=atob(t),r=new ArrayBuffer(a.length),n=new Uint8Array(r);for(let t=0;t<a.length;t++)n[t]=a.charCodeAt(t);const o=new Blob([n],{type:e});return o}(a,"application/pdf");return e.append("file",r,t.filename_download),e}(t),a=await c.post("/files",e,{headers:{"Content-Type":"multipart/form-data"}});if(200!==a.status)throw console.error(`[uploadGeneratedDoc] uploadedFileData status: ${a.status}`),new Error("A failure occured while trying to upload the generated document. Please try again.");return a.data.data.id}(tn.data);Zr.doc_name=en,Zr.company_logo=void 0,Zr.signatory&&(Zr.signatory.signature=void 0),a("input",Zr),console.log(`[generateInvoice] invoice response: ${JSON.stringify(u.value)}`),s.value=!1,We(en)}catch(t){return s.value=!1,console.log(`generating invoice went wrong due to: ${t}`),void(i.value=t)}},viewPdf:function(t){const a=null!=t?t:e.value.doc_name;console.log(`[viewPdf] doc ID: ${a}`),window.open(`/assets/${a}?access_token=9TKZlOUjs29Svyop45nyyyN02lYPlX_x`)},downloadPdf:We,isCopying:l,copy:async function(){l.value=!0;const{id:t,user_created:e,date_created:a,user_updated:r,date_updated:n,invoice:o,document_type:s,...d}=u.value;console.log(`[invoice::copy] requestBody=${JSON.stringify(d)}`);const f=function(t){const e=B[t];if(void 0===e)throw new Error(`'${t}' is not a valid Document Type`);let a=e+1;const r=Object.keys(B).length;if(a>=r)return null;const n=Object.keys(B)[a];if(void 0===n)throw new Error(`Could not find the next Document Type after '${t}'`);return n}(s);if(null===f)return console.log("[invoice::copy] no more document types to copy to"),i.value=`Duplication failed, cannot create a new revision invoice after ${s}`,Ge.value=!0,void(l.value=!1);const h=await c.post("/items/navarch_invoices",{...d,document_type:f});if(200!==h.status)return console.log(`[invoice::copy] copy response status: ${h.status}`),void(i.value=`Failed to duplicate invoice with status ${h.status}`);l.value=!1,window.open(`/admin/content/navarch_invoices/${h.data.data.id}`)},failureReason:i};async function He(t,e,a,r,n,o=!1){if(p(e[Z])||p(e[Z][t]))return await n();const i=await async function(t,e,a,r,n){var o,i;if(n&&!t.declared)return null;const s=null==t?void 0:t.qp_selected;if(!s)return null;const l=s.split(" "),c={qp_period:parseInt(l[0]),qp_code:l[1]};let u,d,f,h;switch(c.qp_code){case"MAMA":u=null!=(o=e[z])?o:e[Q],d="Actual/Estimated Arrival Date";break;case"MOSS":u=e[X],d="Estimated Shipment Date";break;case"MOS":case"MOAS":u=null!=(i=e[K])?i:e[X],d="B/L Date (or Estimated Shipment Date)";break;default:throw new Error(`Unsupported QP code ${c.qp_code} in the contract commodities, please ensure all commodity QP codes are MAMA, MOS, MOSS, or MOAS`)}if(p(u))throw new Error(`Please fill in a date for the field '${d}' for the Parcel form, for QP: ${s}`);const y=new Date(u);if(f=R(y,c.qp_period),qe=Ye(f),f.valueOf()>a.valueOf())return null;if(h=j(y,c.qp_period),h.valueOf()>a.valueOf())return null;return qe=null,{provisionalPricingStartDate:f,provisionalPricingEndDate:h,expectedNoOfBusinessDays:null}}(e[Z][t],e,a,0,o);return i||await n()}function Ye(t){return t.toLocaleString("default",{month:"short"})+" "+t.getFullYear()}async function Qe(t,e,a,r){var n,o;let i,s,l;const c={invoice_type:r,days:t[vt],day_type:t[gt],ref_day:t[wt]};if(!c)throw new Error(`[generateInvoice] No provisional pricing found for invoice type ${r}`);let d;switch(c.ref_day){case"Arrival Date":d=null!=(n=e[z])?n:e[Q],i="Actual/Estimated Arrival Date from the Parcel form";break;case"B/L Date":d=null!=(o=e[K])?o:e[X],i="B/L Date (or Estimated Shipment Date) from the Parcel form";break;case"Invoice Date":d=u.value[Re],i="Invoice Date from the Invoice form";break;case"Estimated Shipment Date":d=e[X],i="Estimated Shipment Date from the Parcel form";break;default:throw new Error(`Invalid reference day for invoice pricing: ${c.ref_day}; please contact Navarch for support`)}if(null==d)throw new Error(`Reference day for invoice pricing ${i} is empty`);l=new Date(d),l.setDate(l.getDate()-1);const f=parseInt(c.days),h=c.day_type;let p=null;switch(h){case"Business Day(s)":p=f,s=U(l,f),(0===l.getDay()||6===l.getDay())&&(l=U(l,1,!0));break;case"Calendar Day(s)":s=new Date(l.valueOf()),s.setDate(s.getDate()-f);break;default:throw new Error(`Invalid day type ${h} for ${r} Invoice in the contract, please ensure it is either Calendar Day(s) or Business Day(s)`)}if(s.valueOf()>a.valueOf())throw new Error(`Start date for provisional pricing ${s} (${i}) for ${r} Invoice has not occurred yet`);if(l.valueOf()>a.valueOf())throw new Error(`End date for provisional pricing ${l} (${i}) for ${r} Invoice has not occurred yet`);return{provisionalPricingStartDate:s,provisionalPricingEndDate:l,expectedNoOfBusinessDays:p}}async function ze(t,e,a){var r,n;let o,i,s,l;switch(t.qp_code){case"MAMA":l=null!=(r=e[z])?r:e[Q],o="Actual/Estimated Arrival Date";break;case"MOSS":l=e[X],o="Estimated Shipment Date";break;case"MOS":case"MOAS":l=null!=(n=e[K])?n:e[X],o="B/L Date (or Estimated Shipment Date)";break;default:throw new Error(`Unsupported QP code ${t.qp_code} in the contract commodities, please ensure all commodity QP codes are MAMA, MOS, MOSS, or MOAS`)}if(p(l))throw new Error(`Please fill in a date for the field '${o}' for the Parcel form, for QP:${t.qp_period} ${t.qp_code}`);const c=new Date(l);if(i=R(c,t.qp_period),qe=Ye(i),i.valueOf()>a.valueOf())throw new Error(`Start date for provisional pricing ${i} (${o}) based on default QP has not occurred yet`);if(s=j(c,t.qp_period),s.valueOf()>a.valueOf())throw new Error(`End date for provisional pricing ${s} (${o}) based on default QP has not occurred yet`);return qe=null,{provisionalPricingStartDate:i,provisionalPricingEndDate:s,expectedNoOfBusinessDays:null}}async function Ke(t,e,a,r,n,o=null,i=1){if(p(t))throw new Error("Commodity is not defined for price calcualtion");if(p(e))throw new Error(`Price method for commodity ${t} is not defined for price calcualtion`);if(p(a))throw new Error(`Start date is not defined for price calcualtion with ${e} has not been properly defined, please ensure that contract QP is properly defined`);if(p(r))throw new Error(`End date is not defined for price calcualtion with ${e} has not been properly defined, please ensure that contract QP is properly defined`);const s=new Date(a.valueOf());null===n||isNaN(n)||s.setDate(s.getDate()-10);const l=await c.get(`/items/navarch_commodity_price?filter[_and][0][price_method][_eq]=${e}&filter[_and][0][currency][_eq]=${i}&filter[_and][1][date][_between][0]=${N(s)}&filter[_and][1][date][_between][1]=${N(r)}&sort[]=-${Oe}`,{params:{fields:[De,Ne,Pe,Oe,"price_method"]}});if(!l||!l.data||!l.data.data)throw new Error(`Failed to get commodity prices for commodity ${t} between ${N(a)} and ${N(r)}`);if(0===l.data.data.length)throw new Error(`No commodity prices found for commodity ${t} between ${N(a)} and ${N(r)}`);if(null!=n&&l.data.data.length<n)throw new Error(`Not enough commodity prices found for commodity ${t} between ${N(a)} and ${N(r)}, please contact Navarch for support`);const u=null===n||isNaN(n)?l.data.data:l.data.data.slice(0,n);return{averagePrice:u.reduce(((a,r)=>{if(!r[Pe]&&!r[Ne]&&!r[De])throw new Error(`Commodity for ${e} on the date of ${r[Oe]} does not have a price, please contact Navarch for assistance`);let n;if("PM"===o){if(null===r[Ne])throw new Error(`The price data for the commodity ${t} does not have a Closing Price (PM) for the date of ${r[Oe]}, please choose another price fix or provide a Price PM for this date`);n=Number(r[Ne])}else if("AM"===o){if(null===r[De])throw new Error(`The price data for the commodity ${t} does not have an Opening Price (AM) for the date of ${r[Oe]}, please choose another price fix or provide a Price AM for this date`);n=Number(r[De])}else if("Average"===o){if(null===r[Pe])throw new Error(`The price data for the commodity ${t} does not have an Average Price for the date of ${r[Oe]}, please choose another price fix or provide an Average Price for this date`);n=Number(r[Pe])}else if(null!==r[Pe])n=Number(r[Pe]);else if(null!==r[Ne])n=Number(r[Ne]);else{if(null===r[De])throw new Error(`The commodity price for the commodity ${t} for the date of ${r[Oe]} is not a valid number, please contact Navarch for assistance`);n=Number(r[De])}return a+n}),0)/u.length,startDate:new Date(u[u.length-1][Oe]),endDate:new Date(u[0][Oe])}}function Xe(t,e){if(!t)throw new Error(`Currency data not found, please ensure the ${e} still exists`);if(!t[jt])throw new Error(`The ${e} is not valid`)}function Ze(t,e){var a,r;if(console.log("[validateCommodityData]"),!t)throw new Error("commodity data response is null");if(!t[Ut])throw new Error(`Commodity name for commodity ${null!=(a=t[kt])?a:e} is undefined, please contact Navarch for assistance`);if(!t[kt])throw new Error(`Commodity code for commodity ${null!=(r=t[Ut])?r:e} is not defined, please contact Navarch for assistance`)}function ta(t,e){if(!t)throw new Error(`Price per UOM for commodity ${e} is not a valid`);if(!t[Ft])throw new Error(`Price per UOM for commodity ${e} does not have a valid unit symbol, please contact Navarch for assistance`)}function ea(t,e){if(!t)throw new Error(`Charge per UOM for commodity ${e} is not a valid`);if(!t[Ft])throw new Error(`Charge per UOM for commodity ${e} does not have a valid unit symbol, please contact Navarch for assistance`)}function aa(t,e){if(!t)throw new Error(`Penalty per UOM for commodity ${e} is not a valid`);if(!t[Ft])throw new Error(`Penalty per UOM for commodity ${e} does not have a valid unit symbol, please contact Navarch for assistance`)}function ra(t,e,a){if(!t)throw new Error(`Price method ${e} for commodity ${a} is not defined, please contact Navarch for assistance`);if(!t[Se])throw new Error(`Price method ${e} for commodity ${a} has no name, please contact Navarch for assistance`)}}});const k={key:0},R={key:1};var j=[],L=[];!function(t,e){if(t&&"undefined"!=typeof document){var a,r=!0===e.prepend?"prepend":"append",n=!0===e.singleTag,o="string"==typeof e.container?document.querySelector(e.container):document.getElementsByTagName("head")[0];if(n){var i=j.indexOf(o);-1===i&&(i=j.push(o)-1,L[i]={}),a=L[i]&&L[i][r]?L[i][r]:L[i][r]=s()}else a=s();65279===t.charCodeAt(0)&&(t=t.substring(1)),a.styleSheet?a.styleSheet.cssText+=t:a.appendChild(document.createTextNode(t))}function s(){var t=document.createElement("style");if(t.setAttribute("type","text/css"),e.attributes)for(var a=Object.keys(e.attributes),n=0;n<a.length;n++)t.setAttribute(a[n],e.attributes[a[n]]);var i="prepend"===r?"afterbegin":"beforeend";return o.insertAdjacentElement(i,t),t}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),U.render=function(t,e,a,r,n,o){const g=i("v-button"),w=i("v-notice"),_=s("tooltip");return l(),c(u,null,[d(' <input :value="value" @input="handleChange($event.target.value)" /> '),d(" create a button only interface for Directus"),t.value?(l(),c("div",R,[f(g,{onClick:e[1]||(e[1]=()=>t.downloadPdf())},{default:h((()=>[p("Download Invoice ")])),_:1})])):(l(),c("div",k,[f(g,{onClick:e[0]||(e[0]=()=>t.generateInvoice()),loading:t.isGeneraingDoc},{default:h((()=>[p("Generate Invoice")])),_:1},8,["loading"]),t.failureReason?(l(),y(w,{key:0},{default:h((()=>[p(m(t.failureReason),1)])),_:1})):d("v-if",!0)])),v((l(),y(g,{class:"margin-top-16px",onClick:e[2]||(e[2]=()=>t.copy()),loading:t.isCopying,disabled:t.isLastDocType},{default:h((()=>[p("Copy")])),_:1},8,["loading","disabled"])),[[_,t.isLastDocType?"Invoice cannot be revised beyond the current document type":"Duplicating an invoice will create a new revision",void 0,{bottom:!0}]])],64)},U.__scopeId="data-v-64969d30",U.__file="src/interface.vue";var F=e({id:"invoice_generator_button",name:"Generate Invoice Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Invoice Generator Button.",component:U,options:null,types:["json"],group:"standard"});export{F as default};
