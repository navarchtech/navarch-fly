import{useApi as t,defineInterface as e}from"@directus/extensions-sdk";import{defineComponent as a,ref as r,inject as n,resolveComponent as o,openBlock as i,createElementBlock as s,Fragment as l,createCommentVNode as c,createVNode as d,withCtx as u,createTextVNode as f,createBlock as h,toDisplayString as p}from"vue";for(var y={},m={byteLength:function(t){var e=E(t),a=e[0],r=e[1];return 3*(a+r)/4-r},toByteArray:function(t){var e,a,r=E(t),n=r[0],o=r[1],i=new w(function(t,e,a){return 3*(e+a)/4-a}(0,n,o)),s=0,l=o>0?n-4:n;for(a=0;a<l;a+=4)e=v[t.charCodeAt(a)]<<18|v[t.charCodeAt(a+1)]<<12|v[t.charCodeAt(a+2)]<<6|v[t.charCodeAt(a+3)],i[s++]=e>>16&255,i[s++]=e>>8&255,i[s++]=255&e;2===o&&(e=v[t.charCodeAt(a)]<<2|v[t.charCodeAt(a+1)]>>4,i[s++]=255&e);1===o&&(e=v[t.charCodeAt(a)]<<10|v[t.charCodeAt(a+1)]<<4|v[t.charCodeAt(a+2)]>>2,i[s++]=e>>8&255,i[s++]=255&e);return i},fromByteArray:function(t){for(var e,a=t.length,r=a%3,n=[],o=16383,i=0,s=a-r;i<s;i+=o)n.push(b(t,i,i+o>s?s:i+o));1===r?(e=t[a-1],n.push(g[e>>2]+g[e<<4&63]+"==")):2===r&&(e=(t[a-2]<<8)+t[a-1],n.push(g[e>>10]+g[e>>4&63]+g[e<<2&63]+"="));return n.join("")}},g=[],v=[],w="undefined"!=typeof Uint8Array?Uint8Array:Array,_="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",$=0;$<64;++$)g[$]=_[$],v[_.charCodeAt($)]=$;function E(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var a=t.indexOf("=");return-1===a&&(a=e),[a,a===e?0:4-a%4]}function b(t,e,a){for(var r,n,o=[],i=e;i<a;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(255&t[i+2]),o.push(g[(n=r)>>18&63]+g[n>>12&63]+g[n>>6&63]+g[63&n]);return o.join("")}v["-".charCodeAt(0)]=62,v["_".charCodeAt(0)]=63;var A={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(t,e,a,r,n){var o,i,s=8*n-r-1,l=(1<<s)-1,c=l>>1,d=-7,u=a?n-1:0,f=a?-1:1,h=t[e+u];for(u+=f,o=h&(1<<-d)-1,h>>=-d,d+=s;d>0;o=256*o+t[e+u],u+=f,d-=8);for(i=o&(1<<-d)-1,o>>=-d,d+=r;d>0;i=256*i+t[e+u],u+=f,d-=8);if(0===o)o=1-c;else{if(o===l)return i?NaN:1/0*(h?-1:1);i+=Math.pow(2,r),o-=c}return(h?-1:1)*i*Math.pow(2,o-r)},write:function(t,e,a,r,n,o){var i,s,l,c=8*o-n-1,d=(1<<c)-1,u=d>>1,f=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,h=r?0:o-1,p=r?1:-1,y=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,i=d):(i=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-i))<1&&(i--,l*=2),(e+=i+u>=1?f/l:f*Math.pow(2,1-u))*l>=2&&(i++,l/=2),i+u>=d?(s=0,i=d):i+u>=1?(s=(e*l-1)*Math.pow(2,n),i+=u):(s=e*Math.pow(2,u-1)*Math.pow(2,n),i=0));n>=8;t[a+h]=255&s,h+=p,s/=256,n-=8);for(i=i<<n|s,c+=n;c>0;t[a+h]=255&i,h+=p,i/=256,c-=8);t[a+h-p]|=128*y}};
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
!function(t){var e=m,a=A,r="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=i,t.SlowBuffer=function(t){+t!=t&&(t=0);return i.alloc(+t)},t.INSPECT_MAX_BYTES=50;var n=2147483647;function o(t){if(t>n)throw new RangeError('The value "'+t+'" is invalid for option "size"');var e=new Uint8Array(t);return Object.setPrototypeOf(e,i.prototype),e}function i(t,e,a){if("number"==typeof t){if("string"==typeof e)throw new TypeError('The "string" argument must be of type string. Received type number');return c(t)}return s(t,e,a)}function s(t,e,a){if("string"==typeof t)return function(t,e){"string"==typeof e&&""!==e||(e="utf8");if(!i.isEncoding(e))throw new TypeError("Unknown encoding: "+e);var a=0|h(t,e),r=o(a),n=r.write(t,e);n!==a&&(r=r.slice(0,n));return r}(t,e);if(ArrayBuffer.isView(t))return function(t){if(L(t,Uint8Array)){var e=new Uint8Array(t);return u(e.buffer,e.byteOffset,e.byteLength)}return d(t)}(t);if(null==t)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(L(t,ArrayBuffer)||t&&L(t.buffer,ArrayBuffer))return u(t,e,a);if("undefined"!=typeof SharedArrayBuffer&&(L(t,SharedArrayBuffer)||t&&L(t.buffer,SharedArrayBuffer)))return u(t,e,a);if("number"==typeof t)throw new TypeError('The "value" argument must not be of type number. Received type number');var r=t.valueOf&&t.valueOf();if(null!=r&&r!==t)return i.from(r,e,a);var n=function(t){if(i.isBuffer(t)){var e=0|f(t.length),a=o(e);return 0===a.length||t.copy(a,0,0,e),a}if(void 0!==t.length)return"number"!=typeof t.length||V(t.length)?o(0):d(t);if("Buffer"===t.type&&Array.isArray(t.data))return d(t.data)}(t);if(n)return n;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return i.from(t[Symbol.toPrimitive]("string"),e,a);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function l(t){if("number"!=typeof t)throw new TypeError('"size" argument must be of type number');if(t<0)throw new RangeError('The value "'+t+'" is invalid for option "size"')}function c(t){return l(t),o(t<0?0:0|f(t))}function d(t){for(var e=t.length<0?0:0|f(t.length),a=o(e),r=0;r<e;r+=1)a[r]=255&t[r];return a}function u(t,e,a){if(e<0||t.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(a||0))throw new RangeError('"length" is outside of buffer bounds');var r;return r=void 0===e&&void 0===a?new Uint8Array(t):void 0===a?new Uint8Array(t,e):new Uint8Array(t,e,a),Object.setPrototypeOf(r,i.prototype),r}function f(t){if(t>=n)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+n.toString(16)+" bytes");return 0|t}function h(t,e){if(i.isBuffer(t))return t.length;if(ArrayBuffer.isView(t)||L(t,ArrayBuffer))return t.byteLength;if("string"!=typeof t)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);var a=t.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===a)return 0;for(var n=!1;;)switch(e){case"ascii":case"latin1":case"binary":return a;case"utf8":case"utf-8":return x(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*a;case"hex":return a>>>1;case"base64":return F(t).length;default:if(n)return r?-1:x(t).length;e=(""+e).toLowerCase(),n=!0}}function p(t,e,a){var r=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===a||a>this.length)&&(a=this.length),a<=0)return"";if((a>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return P(this,e,a);case"utf8":case"utf-8":return D(this,e,a);case"ascii":return S(this,e,a);case"latin1":case"binary":return O(this,e,a);case"base64":return C(this,e,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,e,a);default:if(r)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),r=!0}}function y(t,e,a){var r=t[e];t[e]=t[a],t[a]=r}function g(t,e,a,r,n){if(0===t.length)return-1;if("string"==typeof a?(r=a,a=0):a>2147483647?a=2147483647:a<-2147483648&&(a=-2147483648),V(a=+a)&&(a=n?0:t.length-1),a<0&&(a=t.length+a),a>=t.length){if(n)return-1;a=t.length-1}else if(a<0){if(!n)return-1;a=0}if("string"==typeof e&&(e=i.from(e,r)),i.isBuffer(e))return 0===e.length?-1:v(t,e,a,r,n);if("number"==typeof e)return e&=255,"function"==typeof Uint8Array.prototype.indexOf?n?Uint8Array.prototype.indexOf.call(t,e,a):Uint8Array.prototype.lastIndexOf.call(t,e,a):v(t,[e],a,r,n);throw new TypeError("val must be string, number or Buffer")}function v(t,e,a,r,n){var o,i=1,s=t.length,l=e.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(t.length<2||e.length<2)return-1;i=2,s/=2,l/=2,a/=2}function c(t,e){return 1===i?t[e]:t.readUInt16BE(e*i)}if(n){var d=-1;for(o=a;o<s;o++)if(c(t,o)===c(e,-1===d?0:o-d)){if(-1===d&&(d=o),o-d+1===l)return d*i}else-1!==d&&(o-=o-d),d=-1}else for(a+l>s&&(a=s-l),o=a;o>=0;o--){for(var u=!0,f=0;f<l;f++)if(c(t,o+f)!==c(e,f)){u=!1;break}if(u)return o}return-1}function w(t,e,a,r){a=Number(a)||0;var n=t.length-a;r?(r=Number(r))>n&&(r=n):r=n;var o=e.length;r>o/2&&(r=o/2);for(var i=0;i<r;++i){var s=parseInt(e.substr(2*i,2),16);if(V(s))return i;t[a+i]=s}return i}function _(t,e,a,r){return j(x(e,t.length-a),t,a,r)}function $(t,e,a,r){return j(function(t){for(var e=[],a=0;a<t.length;++a)e.push(255&t.charCodeAt(a));return e}(e),t,a,r)}function E(t,e,a,r){return j(F(e),t,a,r)}function b(t,e,a,r){return j(function(t,e){for(var a,r,n,o=[],i=0;i<t.length&&!((e-=2)<0);++i)r=(a=t.charCodeAt(i))>>8,n=a%256,o.push(n),o.push(r);return o}(e,t.length-a),t,a,r)}function C(t,a,r){return 0===a&&r===t.length?e.fromByteArray(t):e.fromByteArray(t.slice(a,r))}function D(t,e,a){a=Math.min(t.length,a);for(var r=[],n=e;n<a;){var o,i,s,l,c=t[n],d=null,u=c>239?4:c>223?3:c>191?2:1;if(n+u<=a)switch(u){case 1:c<128&&(d=c);break;case 2:128==(192&(o=t[n+1]))&&(l=(31&c)<<6|63&o)>127&&(d=l);break;case 3:o=t[n+1],i=t[n+2],128==(192&o)&&128==(192&i)&&(l=(15&c)<<12|(63&o)<<6|63&i)>2047&&(l<55296||l>57343)&&(d=l);break;case 4:o=t[n+1],i=t[n+2],s=t[n+3],128==(192&o)&&128==(192&i)&&128==(192&s)&&(l=(15&c)<<18|(63&o)<<12|(63&i)<<6|63&s)>65535&&l<1114112&&(d=l)}null===d?(d=65533,u=1):d>65535&&(d-=65536,r.push(d>>>10&1023|55296),d=56320|1023&d),r.push(d),n+=u}return function(t){var e=t.length;if(e<=I)return String.fromCharCode.apply(String,t);var a="",r=0;for(;r<e;)a+=String.fromCharCode.apply(String,t.slice(r,r+=I));return a}(r)}t.kMaxLength=n,i.TYPED_ARRAY_SUPPORT=function(){try{var t=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(t,e),42===t.foo()}catch(t){return!1}}(),i.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(i.prototype,"parent",{enumerable:!0,get:function(){if(i.isBuffer(this))return this.buffer}}),Object.defineProperty(i.prototype,"offset",{enumerable:!0,get:function(){if(i.isBuffer(this))return this.byteOffset}}),i.poolSize=8192,i.from=function(t,e,a){return s(t,e,a)},Object.setPrototypeOf(i.prototype,Uint8Array.prototype),Object.setPrototypeOf(i,Uint8Array),i.alloc=function(t,e,a){return function(t,e,a){return l(t),t<=0?o(t):void 0!==e?"string"==typeof a?o(t).fill(e,a):o(t).fill(e):o(t)}(t,e,a)},i.allocUnsafe=function(t){return c(t)},i.allocUnsafeSlow=function(t){return c(t)},i.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==i.prototype},i.compare=function(t,e){if(L(t,Uint8Array)&&(t=i.from(t,t.offset,t.byteLength)),L(e,Uint8Array)&&(e=i.from(e,e.offset,e.byteLength)),!i.isBuffer(t)||!i.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;for(var a=t.length,r=e.length,n=0,o=Math.min(a,r);n<o;++n)if(t[n]!==e[n]){a=t[n],r=e[n];break}return a<r?-1:r<a?1:0},i.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},i.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return i.alloc(0);var a;if(void 0===e)for(e=0,a=0;a<t.length;++a)e+=t[a].length;var r=i.allocUnsafe(e),n=0;for(a=0;a<t.length;++a){var o=t[a];if(L(o,Uint8Array))n+o.length>r.length?i.from(o).copy(r,n):Uint8Array.prototype.set.call(r,o,n);else{if(!i.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(r,n)}n+=o.length}return r},i.byteLength=h,i.prototype._isBuffer=!0,i.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)y(this,e,e+1);return this},i.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)y(this,e,e+3),y(this,e+1,e+2);return this},i.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)y(this,e,e+7),y(this,e+1,e+6),y(this,e+2,e+5),y(this,e+3,e+4);return this},i.prototype.toString=function(){var t=this.length;return 0===t?"":0===arguments.length?D(this,0,t):p.apply(this,arguments)},i.prototype.toLocaleString=i.prototype.toString,i.prototype.equals=function(t){if(!i.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===i.compare(this,t)},i.prototype.inspect=function(){var e="",a=t.INSPECT_MAX_BYTES;return e=this.toString("hex",0,a).replace(/(.{2})/g,"$1 ").trim(),this.length>a&&(e+=" ... "),"<Buffer "+e+">"},r&&(i.prototype[r]=i.prototype.inspect),i.prototype.compare=function(t,e,a,r,n){if(L(t,Uint8Array)&&(t=i.from(t,t.offset,t.byteLength)),!i.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(void 0===e&&(e=0),void 0===a&&(a=t?t.length:0),void 0===r&&(r=0),void 0===n&&(n=this.length),e<0||a>t.length||r<0||n>this.length)throw new RangeError("out of range index");if(r>=n&&e>=a)return 0;if(r>=n)return-1;if(e>=a)return 1;if(this===t)return 0;for(var o=(n>>>=0)-(r>>>=0),s=(a>>>=0)-(e>>>=0),l=Math.min(o,s),c=this.slice(r,n),d=t.slice(e,a),u=0;u<l;++u)if(c[u]!==d[u]){o=c[u],s=d[u];break}return o<s?-1:s<o?1:0},i.prototype.includes=function(t,e,a){return-1!==this.indexOf(t,e,a)},i.prototype.indexOf=function(t,e,a){return g(this,t,e,a,!0)},i.prototype.lastIndexOf=function(t,e,a){return g(this,t,e,a,!1)},i.prototype.write=function(t,e,a,r){if(void 0===e)r="utf8",a=this.length,e=0;else if(void 0===a&&"string"==typeof e)r=e,a=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e>>>=0,isFinite(a)?(a>>>=0,void 0===r&&(r="utf8")):(r=a,a=void 0)}var n=this.length-e;if((void 0===a||a>n)&&(a=n),t.length>0&&(a<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return w(this,t,e,a);case"utf8":case"utf-8":return _(this,t,e,a);case"ascii":case"latin1":case"binary":return $(this,t,e,a);case"base64":return E(this,t,e,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return b(this,t,e,a);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},i.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var I=4096;function S(t,e,a){var r="";a=Math.min(t.length,a);for(var n=e;n<a;++n)r+=String.fromCharCode(127&t[n]);return r}function O(t,e,a){var r="";a=Math.min(t.length,a);for(var n=e;n<a;++n)r+=String.fromCharCode(t[n]);return r}function P(t,e,a){var r=t.length;(!e||e<0)&&(e=0),(!a||a<0||a>r)&&(a=r);for(var n="",o=e;o<a;++o)n+=q[t[o]];return n}function N(t,e,a){for(var r=t.slice(e,a),n="",o=0;o<r.length-1;o+=2)n+=String.fromCharCode(r[o]+256*r[o+1]);return n}function T(t,e,a){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>a)throw new RangeError("Trying to access beyond buffer length")}function U(t,e,a,r,n,o){if(!i.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>n||e<o)throw new RangeError('"value" argument is out of bounds');if(a+r>t.length)throw new RangeError("Index out of range")}function B(t,e,a,r,n,o){if(a+r>t.length)throw new RangeError("Index out of range");if(a<0)throw new RangeError("Index out of range")}function M(t,e,r,n,o){return e=+e,r>>>=0,o||B(t,0,r,4),a.write(t,e,r,n,23,4),r+4}function k(t,e,r,n,o){return e=+e,r>>>=0,o||B(t,0,r,8),a.write(t,e,r,n,52,8),r+8}i.prototype.slice=function(t,e){var a=this.length;(t=~~t)<0?(t+=a)<0&&(t=0):t>a&&(t=a),(e=void 0===e?a:~~e)<0?(e+=a)<0&&(e=0):e>a&&(e=a),e<t&&(e=t);var r=this.subarray(t,e);return Object.setPrototypeOf(r,i.prototype),r},i.prototype.readUintLE=i.prototype.readUIntLE=function(t,e,a){t>>>=0,e>>>=0,a||T(t,e,this.length);for(var r=this[t],n=1,o=0;++o<e&&(n*=256);)r+=this[t+o]*n;return r},i.prototype.readUintBE=i.prototype.readUIntBE=function(t,e,a){t>>>=0,e>>>=0,a||T(t,e,this.length);for(var r=this[t+--e],n=1;e>0&&(n*=256);)r+=this[t+--e]*n;return r},i.prototype.readUint8=i.prototype.readUInt8=function(t,e){return t>>>=0,e||T(t,1,this.length),this[t]},i.prototype.readUint16LE=i.prototype.readUInt16LE=function(t,e){return t>>>=0,e||T(t,2,this.length),this[t]|this[t+1]<<8},i.prototype.readUint16BE=i.prototype.readUInt16BE=function(t,e){return t>>>=0,e||T(t,2,this.length),this[t]<<8|this[t+1]},i.prototype.readUint32LE=i.prototype.readUInt32LE=function(t,e){return t>>>=0,e||T(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},i.prototype.readUint32BE=i.prototype.readUInt32BE=function(t,e){return t>>>=0,e||T(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},i.prototype.readIntLE=function(t,e,a){t>>>=0,e>>>=0,a||T(t,e,this.length);for(var r=this[t],n=1,o=0;++o<e&&(n*=256);)r+=this[t+o]*n;return r>=(n*=128)&&(r-=Math.pow(2,8*e)),r},i.prototype.readIntBE=function(t,e,a){t>>>=0,e>>>=0,a||T(t,e,this.length);for(var r=e,n=1,o=this[t+--r];r>0&&(n*=256);)o+=this[t+--r]*n;return o>=(n*=128)&&(o-=Math.pow(2,8*e)),o},i.prototype.readInt8=function(t,e){return t>>>=0,e||T(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},i.prototype.readInt16LE=function(t,e){t>>>=0,e||T(t,2,this.length);var a=this[t]|this[t+1]<<8;return 32768&a?4294901760|a:a},i.prototype.readInt16BE=function(t,e){t>>>=0,e||T(t,2,this.length);var a=this[t+1]|this[t]<<8;return 32768&a?4294901760|a:a},i.prototype.readInt32LE=function(t,e){return t>>>=0,e||T(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},i.prototype.readInt32BE=function(t,e){return t>>>=0,e||T(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},i.prototype.readFloatLE=function(t,e){return t>>>=0,e||T(t,4,this.length),a.read(this,t,!0,23,4)},i.prototype.readFloatBE=function(t,e){return t>>>=0,e||T(t,4,this.length),a.read(this,t,!1,23,4)},i.prototype.readDoubleLE=function(t,e){return t>>>=0,e||T(t,8,this.length),a.read(this,t,!0,52,8)},i.prototype.readDoubleBE=function(t,e){return t>>>=0,e||T(t,8,this.length),a.read(this,t,!1,52,8)},i.prototype.writeUintLE=i.prototype.writeUIntLE=function(t,e,a,r){(t=+t,e>>>=0,a>>>=0,r)||U(this,t,e,a,Math.pow(2,8*a)-1,0);var n=1,o=0;for(this[e]=255&t;++o<a&&(n*=256);)this[e+o]=t/n&255;return e+a},i.prototype.writeUintBE=i.prototype.writeUIntBE=function(t,e,a,r){(t=+t,e>>>=0,a>>>=0,r)||U(this,t,e,a,Math.pow(2,8*a)-1,0);var n=a-1,o=1;for(this[e+n]=255&t;--n>=0&&(o*=256);)this[e+n]=t/o&255;return e+a},i.prototype.writeUint8=i.prototype.writeUInt8=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,1,255,0),this[e]=255&t,e+1},i.prototype.writeUint16LE=i.prototype.writeUInt16LE=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,2,65535,0),this[e]=255&t,this[e+1]=t>>>8,e+2},i.prototype.writeUint16BE=i.prototype.writeUInt16BE=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=255&t,e+2},i.prototype.writeUint32LE=i.prototype.writeUInt32LE=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t,e+4},i.prototype.writeUint32BE=i.prototype.writeUInt32BE=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},i.prototype.writeIntLE=function(t,e,a,r){if(t=+t,e>>>=0,!r){var n=Math.pow(2,8*a-1);U(this,t,e,a,n-1,-n)}var o=0,i=1,s=0;for(this[e]=255&t;++o<a&&(i*=256);)t<0&&0===s&&0!==this[e+o-1]&&(s=1),this[e+o]=(t/i>>0)-s&255;return e+a},i.prototype.writeIntBE=function(t,e,a,r){if(t=+t,e>>>=0,!r){var n=Math.pow(2,8*a-1);U(this,t,e,a,n-1,-n)}var o=a-1,i=1,s=0;for(this[e+o]=255&t;--o>=0&&(i*=256);)t<0&&0===s&&0!==this[e+o+1]&&(s=1),this[e+o]=(t/i>>0)-s&255;return e+a},i.prototype.writeInt8=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=255&t,e+1},i.prototype.writeInt16LE=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,2,32767,-32768),this[e]=255&t,this[e+1]=t>>>8,e+2},i.prototype.writeInt16BE=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=255&t,e+2},i.prototype.writeInt32LE=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,4,2147483647,-2147483648),this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},i.prototype.writeInt32BE=function(t,e,a){return t=+t,e>>>=0,a||U(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},i.prototype.writeFloatLE=function(t,e,a){return M(this,t,e,!0,a)},i.prototype.writeFloatBE=function(t,e,a){return M(this,t,e,!1,a)},i.prototype.writeDoubleLE=function(t,e,a){return k(this,t,e,!0,a)},i.prototype.writeDoubleBE=function(t,e,a){return k(this,t,e,!1,a)},i.prototype.copy=function(t,e,a,r){if(!i.isBuffer(t))throw new TypeError("argument should be a Buffer");if(a||(a=0),r||0===r||(r=this.length),e>=t.length&&(e=t.length),e||(e=0),r>0&&r<a&&(r=a),r===a)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(a<0||a>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),t.length-e<r-a&&(r=t.length-e+a);var n=r-a;return this===t&&"function"==typeof Uint8Array.prototype.copyWithin?this.copyWithin(e,a,r):Uint8Array.prototype.set.call(t,this.subarray(a,r),e),n},i.prototype.fill=function(t,e,a,r){if("string"==typeof t){if("string"==typeof e?(r=e,e=0,a=this.length):"string"==typeof a&&(r=a,a=this.length),void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!i.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(1===t.length){var n=t.charCodeAt(0);("utf8"===r&&n<128||"latin1"===r)&&(t=n)}}else"number"==typeof t?t&=255:"boolean"==typeof t&&(t=Number(t));if(e<0||this.length<e||this.length<a)throw new RangeError("Out of range index");if(a<=e)return this;var o;if(e>>>=0,a=void 0===a?this.length:a>>>0,t||(t=0),"number"==typeof t)for(o=e;o<a;++o)this[o]=t;else{var s=i.isBuffer(t)?t:i.from(t,r),l=s.length;if(0===l)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(o=0;o<a-e;++o)this[o+e]=s[o%l]}return this};var R=/[^+/0-9A-Za-z-_]/g;function x(t,e){var a;e=e||1/0;for(var r=t.length,n=null,o=[],i=0;i<r;++i){if((a=t.charCodeAt(i))>55295&&a<57344){if(!n){if(a>56319){(e-=3)>-1&&o.push(239,191,189);continue}if(i+1===r){(e-=3)>-1&&o.push(239,191,189);continue}n=a;continue}if(a<56320){(e-=3)>-1&&o.push(239,191,189),n=a;continue}a=65536+(n-55296<<10|a-56320)}else n&&(e-=3)>-1&&o.push(239,191,189);if(n=null,a<128){if((e-=1)<0)break;o.push(a)}else if(a<2048){if((e-=2)<0)break;o.push(a>>6|192,63&a|128)}else if(a<65536){if((e-=3)<0)break;o.push(a>>12|224,a>>6&63|128,63&a|128)}else{if(!(a<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;o.push(a>>18|240,a>>12&63|128,a>>6&63|128,63&a|128)}}return o}function F(t){return e.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace(R,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function j(t,e,a,r){for(var n=0;n<r&&!(n+a>=e.length||n>=t.length);++n)e[n+a]=t[n];return n}function L(t,e){return t instanceof e||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===e.name}function V(t){return t!=t}var q=function(){for(var t="0123456789abcdef",e=new Array(256),a=0;a<16;++a)for(var r=16*a,n=0;n<16;++n)e[r+n]=t[a]+t[n];return e}()}(y);var C=(t=>(t.BRACKET="Bracket",t.MIN_DEDUCTION="Minimum Deduction",t.MAX_CAP="Maximum Cap",t))(C||{}),D=(t=>(t.PERCENTAGE="Percentage",t.FRACTIONAL="Fractional",t))(D||{}),I=(t=>(t.WET_WEIGHT="wet_weight",t.MOISTURE="moisture",t.DRY_WEIGHT="dry_weight",t))(I||{}),S=(t=>(t.METHOD="method",t.WET_WEIGHT_UOM="wet_weight_uom",t.MOISTURE_UOM="moisture_uom",t.DRY_WEIGHT_UOM="dry_weight_uom",t))(S||{}),O=a({props:{value:{type:Object,default:null}},emits:["input"],setup(e,{emit:a}){const o=r(""),i=r(!1),s=r(!1),l=t(),c=n("values",r({}));function d(t){if(console.log("[evaluateWeightData]"),0===t.length)return;const e=f(t,I.DRY_WEIGHT),a=f(t,I.WET_WEIGHT);return{method:u(t,S.METHOD),lots:t,dry_weight_uom:u(t,S.DRY_WEIGHT_UOM),wet_weight_uom:u(t,S.WET_WEIGHT_UOM),dry_weight:e,wet_weight:a,moisture:(a-e)/a*100}}function u(t,e){if(console.log("[getFirstValueAsSharedValue]"),0!==t.length)return console.log(`lots[0][${e.toString()}]=${t[0][e.toString()]}`),t[0][e.toString()]}function f(t,e){return console.log("[evaluateAggregateValue]"),t.reduce(((t,a)=>{var r;return t+(null!=(r=a[e.toString()])?r:0)}),0)}function h(t){return null==t}function p(t,e=2,a=!0){if(console.log("[formatNumber]"),isNaN(t)||null===t)return"-";const r=Math.round(t*Math.pow(10,e))/Math.pow(10,e),[n,o]=r.toString().split("."),i=n.replace(/\B(?=(\d{3})+(?!\d))/g,",");if(!o&&!a)return i;return`${i}.${(null!=o?o:"").padEnd(e,"0")}`}function m(t){if(console.log("[parseNumber]"),!t)return 0;const e=parseFloat(t.replace(/,/g,""));return console.log(`[parseNumber] number: ${t} to ${e}`),e}function g(t,e,a){var r,n,o;if(console.log("[findBracket]"),1===t.length){if(e>=(null!=(r=t[0].lower_threshold)?r:0)&&(null===t[0].upper_threshold||void 0===t[0].upper_threshold||e<t[0].upper_threshold))return t[0];throw new Error(`Evaluated monetary value $${e} does not fall within the only ${a.type} bracket with range ${null!=(n=t[0].lower_threshold)?n:0} - ${null!=(o=t[0].upper_threshold)?o:"∞"}`)}return t.find((t=>{var a,r;const n=e>(null!=(a=t.lower_threshold)?a:0)&&(null===t.upper_threshold||void 0===t.upper_threshold||e<t.upper_threshold)||t.lower_threshold_inclusive&&e===(null!=(r=t.lower_threshold)?r:0)||t.upper_threshold_inclusive&&e===t.upper_threshold;return console.log(`[findBracket] value=${e} for bracket: ${JSON.stringify(t)}? match=${!!n}`),n}))}function v(t,e){var a,r,n,o,i,s,l;console.log("[evaluateFinalValueFromBrackets]");const c=(t-(null!=(a=e.initial_adjustment)?a:0)*(null!=(r=e.initial_adjustment_conversion_factor)?r:1))*(null!=(n=e.rate)?n:0)*(e.rate_type===D.PERCENTAGE?.01:1)+(null!=(o=e.final_adjustment)?o:0)*(null!=(i=e.final_adjustment_conversion_factor)?i:1);switch(e.bracket_type){case C.MIN_DEDUCTION:if(null===e.comparator||void 0===e.comparator)throw new Error("Minimum deduction not found");const a=e.comparator*(null!=(s=e.comparator_conversion_factor)?s:1);return t-c<a?t-a:c;case C.MAX_CAP:if(null===e.comparator||void 0===e.comparator)throw new Error("Maximum cap not found");const r=e.comparator*(null!=(l=e.comparator_conversion_factor)?l:1);return c>r?r:c;case C.BRACKET:return c;default:throw new Error(`bracket type ${e.bracket_type} is not supported`)}}async function w(t,e,a,r){var n,o,i,s,l,c,d,u;if(console.log("[evaluatePayableAssay]"),!a||0===a.length)return{};const f=g(a,t,{commodityCode:r,type:"Payable Assay"});if(!f)throw new Error(`Bracket not found for value ${t}, please ensure the brackets for all commodities defined in the contract cover all range of possible values for payable assays`);let h,y,m=1;f.initial_adjustment_uom&&void 0!==f.initial_adjustment_uom&&null!==f.initial_adjustment_uom&&f.initial_adjustment_uom!==e&&(m=await M(f.initial_adjustment_uom,e),h=k(f.initial_adjustment_uom,e));let w,_=1;f.bracket_type===C.MAX_CAP?(y=null!=(n=f.maximum_cap)?n:0,void 0!==f.maximum_cap_uom&&null!==f.maximum_cap_uom&&f.maximum_cap_uom!==e&&(_=await M(f.maximum_cap_uom,e),w=k(f.maximum_cap_uom,e))):f.bracket_type===C.MIN_DEDUCTION&&(y=null!=(o=f.minimum_deduction)?o:0,void 0!==f.minimum_deduction_uom&&null!==f.minimum_deduction_uom&&f.minimum_deduction_uom!==e&&(_=await M(f.minimum_deduction_uom,e),w=k(f.minimum_deduction_uom,e)));const $=v(t,{bracket_type:f.bracket_type,rate:null!=(i=f.rate)?i:1,rate_type:null!=(s=f.rate_type)?s:D.FRACTIONAL,initial_adjustment:null!=(l=f.initial_adjustment)?l:0,initial_adjustment_conversion_factor:m,comparator:y,comparator_conversion_factor:_});let E="";const b=void 0!==f.initial_adjustment&&null!==f.initial_adjustment;if(f.bracket_type===C.BRACKET)E=`${b?"(":""}${p(t,4)}${null!=e?e:""}${b?` - ${p(f.initial_adjustment,4)}${null!=(c=f.initial_adjustment_uom)?c:`${null!=e?e:""}`}`:""}${b&&1!==m?` * ${p(m,4)}${h}`:""}${b?")":""} * ${p(f.rate,4)}${f.rate_type===D.PERCENTAGE?"/100":`/${p(1,4)}`}`;else if(f.bracket_type===C.MIN_DEDUCTION){E=$===t-y*_?`${p(t,4)}${null!=e?e:""} - ${p(y,4)}${null!=e?e:""}${1!==_?` * ${p(_,4)}${w}`:""}`:`${b?"(":""}${p(t,4)}${null!=e?e:""}${b?` - ${p(f.initial_adjustment,4)}${null!=(d=f.initial_adjustment_uom)?d:`${null!=e?e:""}`}`:""}${b&&1!==m?` * ${p(m,4)}${h}`:""}${b?")":""} * ${p(f.rate,4)}${f.rate_type===D.PERCENTAGE?"/100":`/${p(1,4)}`}`}else{if(f.bracket_type!==C.MAX_CAP)throw new Error(`[buildPayableAssayExpression] unknown bracket method: ${f.bracket_type}`);E=$===y*_?`${p(y,4)}${null!=e?e:""}${1!==_?` * ${p(_,4)}${w}`:""}`:`${b?"(":""}${p(t,4)}${null!=e?e:""}${b?` - ${p(f.initial_adjustment,4)}${null!=(u=f.initial_adjustment_uom)?u:`${null!=e?e:""}`}`:""}${b&&1!==m?` * ${p(m,4)}${h}`:""}${b?")":""} * ${p(f.rate,4)}${f.rate_type===D.PERCENTAGE?"/100":`/${p(1,4)}`}`}return{payableAssay:$,expression:E}}console.log("[main] formValues=",c);const _="above the lower threshold, plus",$="below the upper threshold, minus";function E(t,e,a,r,n){var o,i,s,l,c;if(console.log("[evaluateCharge]"),!a||!a.length)return;const d=g(a,t,{commodityCode:r,type:n});if(!d)throw new Error(`Bracket not found for value ${t}, please ensure the brackets for all commodities defined in the contract cover all range of possible values for ${n}`);let u=0,f=1;if(d.use_btc)f=0,u=0;else{const t=null!=(o=d.escalator_reference)?o:1;if(f=(null!=(i=d.rate)?i:1)/t,d.for_every_unit===_)u=null!=(s=d.lower_threshold)?s:0;else{if(d.for_every_unit!==$)throw new Error(`[evaluateCharge] unknown for_every_unit: ${d.for_every_unit}`);u=null!=(l=d.upper_threshold)?l:0}}const h={bracket_type:C.BRACKET,rate:f,rate_type:D.FRACTIONAL,initial_adjustment:u,final_adjustment:null!=(c=d.base_treatment_charge)?c:0};return console.log(`[evaluateCharge] bracketForEvaluation: ${JSON.stringify(h)}`),{finalValue:v(t,h),baseTreatmentCharge:d.base_treatment_charge}}function b(t,e,a,r,n){var o,i,s,l;if(console.log("[evaluatePenalty]"),!e||!e.length)return{};const c=g(e,t,{commodityCode:n,type:"Penalty"});if(!c)throw new Error(`[evaluatePenalty] Bracket not found for value ${t}, please ensure the brackets for all commodities defined in the contract cover all range of possible values for penalty`);let d=0,u=1;if(c.no_penalty)u=0,d=0;else{const t=null!=(o=c.escalator_reference)?o:1;if(u=(null!=(i=c.rate)?i:1)/t,c.for_every_unit===_)d=null!=(s=c.lower_threshold)?s:0;else{if(c.for_every_unit!==$)throw new Error(`[evaluatePenalty] unknown for_every_unit: ${c.for_every_unit}`);d=null!=(l=c.upper_threshold)?l:0}}const f={bracket_type:C.BRACKET,rate:u,rate_type:D.FRACTIONAL,initial_adjustment:d,final_adjustment:0};console.log(`[evaluatePenalty] bracketForEvaluation: ${JSON.stringify(f)}`);const h=v(t,f),y=null!=f.initial_adjustment;let m="";return m=c.rate&&0!==c.rate?`${y?"(":""}${p(t,4)}${y?` - ${p(d,4)})`:""} / ${p(1,4)} * ${null!=a?a:""} ${p(u,4)}/${null!=r?r:""}`:"No penalty",{penalty:h,expression:m,bracket:c}}function A(t){return t.toLowerCase().split(" ").map((t=>t.charAt(0).toUpperCase()+t.slice(1))).join(" ")}function O(t){const e=t.getDate(),a=t.getMonth(),r=t.getFullYear();return`${e} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${r}`}function P(t,e=!0){const a=t.getMonth()+1,r=t.getDate();return`${t.getFullYear()}${e?"-":" "}${a<10?"0":""}${a}${e?"-":" "}${r<10?"0":""}${r}`}function N(t,e,a=!1){const r=new Date(t.valueOf());let n=e-(a?1:0);for(;n>0;)r.setDate(r.getDate()-1),0!==r.getDay()&&6!==r.getDay()&&(n-=1);return r.getHours()>=12&&r.setDate(r.getDate()+1),r}function T(t,e){const a=new Date(t.valueOf());return a.setMonth(a.getMonth()+e,1),a}function U(t,e){const a=new Date(t.valueOf());return a.setMonth(a.getMonth()+e+1,0),a}async function B(t,e){if(t===e)return 1;const a=await l.get(`/items/${St}?filter[${Ot}]=${t}`,{params:{fields:[Ut]}});if(0===a.data.data.length||null===a.data.data[0][Ut]||void 0===a.data.data[0][Ut])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for source weight unit ${t}. Ensure that the symbol is correct and is a weight unit symbol`);const r=await l.get(`/items/${St}?filter[${Ot}]=${e}`,{params:{fields:[Ut]}});if(0===r.data.data.length||null===r.data.data[0][Ut]||void 0===r.data.data[0][Ut])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for the target weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const n=parseFloat(a.data.data[0][Ut]);if(isNaN(n))throw new Error(`[getWeightUnitConversionValue] source weight unit ${t} conversion value=${n} is not a number`);const o=parseFloat(r.data.data[0][Ut]);if(isNaN(o))throw new Error(`[getWeightUnitConversionValue] target weight unit ${e} conversion value=${o} is not a number`);return n/o}async function M(t,e){if(null==t||null==e)return 1;if(t===e)return 1;const a=await l.get(`/items/${Bt}?filter[${Mt}]=${t}`,{params:{fields:[kt]}});if(0===a.data.data.length||void 0===a.data.data[0][kt]||null===a.data.data[0][kt])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for source weight unit ${t}. Ensure that the symbol is correct and is a weight unit symbol`);const r=await l.get(`/items/${Bt}?filter[${Mt}]=${e}`,{params:{fields:[kt]}});if(0===r.data.data.length||void 0===r.data.data[0][kt]||null===r.data.data[0][kt])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for the target weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const n=parseFloat(a.data.data[0][kt]);if(isNaN(n))throw new Error(`[getAssayUnitConversionValue] source weight unit ${t} conversion value=${n} is not a number`);console.log(`[getAssayUnitConversionValue] source unit conversion value=${n}`);const o=parseFloat(r.data.data[0][kt]);if(isNaN(o))throw new Error(`[getAssayUnitConversionValue] target weight unit ${t} conversion value=${o} is not a number`);return console.log(`[getAssayUnitConversionValue] target unit conversion value=${o}`),console.log("[getAssayUnitConversionValue] returning "+n/o),n/o}function k(t,e){if(void 0===t||void 0===e||null===t||null===e)return;const a=t.split("/"),r=e.split("/");if(a.length>2||r.length>2)throw new Error(`[getConversionUnit] sourceUnit=${t} and targetUnit=${e} must be in the format of 'unit1/unit2', an extra '/' was found`);if(1===a.length&&1===r.length)return`${r[0]}/${a[0]}`;if(1===a.length){const t=r[0]===a[0]?"":`${r[1]}(${a[1]})`,e=r[1];return""===e?t:`${t}/${e}`}if(1===r.length){const t=a[1],e=a[0]===r[0]?"":`${a[1]}(${r[0]})`;return""===e?t:`${t}/${e}`}{const t=a[0]===r[0],e=a[1]===r[1],n=t||""===a[0],o=t||""===r[0],i=e||""===a[1],s=e||""===r[1],l=!i&&!o,c=!n&&!s,d=`${i?"":a[1]}${l?"(":""}${o?"":`${r[0]}`}${l?")":""}`,u=`${n?"":a[0]}${c?"(":""}${s?"":`${r[1]}`}${c?")":""}`;return""===u?d:`${d}/${u}`}}async function R(t,e,a){const r=await l.get(`/items/${St}?filter[${Pt}]=${e}`,{params:{fields:[Ot]}});if(!r.data.data||!r.data.data[0]||!r.data.data[0][Ot])throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] Dry weight uom not found for symbol ${e}`);const n=r.data.data[0][Ot];if("%"===a){if(n===t)return{};const e=k(n,t);if(!e)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for dry weight unit ${n} and target weight unit ${t}`);return{finalConversion:{conversionFactor:await B(n,t),conversionUom:e}}}let o=a.split("/");if(1==o.length){const t=await async function(t){const e=await l.get(`/items/${Bt}`,{params:{fields:[Mt,Rt],filter:{[Rt]:{_nnull:!0},[Mt]:{_eq:t}}}});if(200!==e.status||!e.data||0===e.data.data.length)throw new Error("[getAssayUnitComposition] no assay units found with composition");return e.data.data[0][Rt]}(a);if(!t)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${a} does not have a composition`);o=t.split("/")}if(o.length>2||0===o.length)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${a} is not in the format of 'unit1/unit2'`);const i=o[0],s=o[1],c={};if(s!==n){const t=k(n,s);if(!t)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for dry weight unit ${n} and assay unit denominator unit ${s}`);c.initialConversion={conversionFactor:await B(n,s),conversionUom:t}}if(i!==t){const e=k(i,t);if(!e)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for target weight unit ${t} and assay unit numerator unit ${i}`);c.finalConversion={conversionFactor:await B(i,t),conversionUom:e}}return c}const x="foreign_key",F="lot_number",j="method",L="contract",V="counterparty",q="assay_results",J="weight_result",W="actual_arrival_date",G="bl_date",H="estimated_shipment_date",Y="qp_selection",K="vessel",z="origin",X="destination",Q="shipment_code",Z="adjustments",tt="parcel_finalisation_date",et="assay_uom",at="contract_currency",rt="invoice_type",nt="pay_percent",ot="pa_days",it="pa_day_type",st="pa_ref_day",lt="pp_days",ct="pp_day_type",dt="pp_ref_day",ut="commodity",ft="payable_commodity",ht="price_per_uom",pt="related_commodity_in_contract",yt="lower_threshold",mt="lower_threshold_inclusive",gt="upper_threshold",vt="upper_threshold_inclusive",wt="rate",_t="navarch_treatment_charge_bracket",$t="base_treatment_charge",Et="use_btc",bt="escalator_reference",At="for_every_unit",Ct="name",Dt="code",It="code",St="navarch_unit",Ot="symbol",Pt="dry_symbol",Nt="dry_unit",Tt="wet_unit",Ut="conversionToGram",Bt="navarch_assay_unit",Mt="unit",kt="conversion_to_ppb",Rt="composition",xt="name",Ft="navarch_address_id",jt="name",Lt="logo",Vt="line_1",qt="line_2",Jt="city",Wt="state",Gt="country",Ht="zip",Yt="phone_code",Kt="phone_number",zt="signatory_name",Xt="signatory_title",Qt="remittance_details",Zt="signature",te="navarch_country",ee="name",ae="phone_code",re="line_1",ne="line_2",oe="city",ie="state",se="country",le="zip",ce="name",de="navarch_world_port",ue="port_name",fe="country",he="navarch_commodity_price",pe="price_pm",ye="average_price",me="date",ge="name",ve="navarch_invoices",we="parcel",_e="invoice",$e="document_type",Ee="revision_invoice",be="invoice_type",Ae="invoice_date";async function Ce(){const t=await l.get(`/folders?filter[name][_eq]=${encodeURI("Invoices")}`);return 200===t.status&&t.data&&t.data.data?0===t.data.data.length?await async function(){return(await l.post("/folders",{name:"Invoices"})).data.data.id}():t.data.data[0].id:null}function De(t){const a=null!=t?t:e.value.doc_name;console.log(`[viewPdf] doc ID: ${a}`),window.open(`/assets/${a}?access_token=9TKZlOUjs29Svyop45nyyyN02lYPlX_x`)}return{isGeneraingDoc:i,invoiceUrl:c.value,generateInvoice:async function(){var t,e,r,n,s,u,f,h,g,v,_,$,C,D,I,S,P,N,T,U,B,M,k,Ut,Bt,Mt,kt,Rt,he,pe,ye,me,ke,Re,xe,Fe,je,Le,Ve;o.value="";try{i.value=!0,console.log("[generateInvoice] formValues=",c);const qe=c.value[we];if(!qe)return o.value="Parcel not selected for invoice document generation",void(i.value=!1);const Je=c.value[Ae]?new Date(c.value[Ae]):new Date,We=c.value[be],Ge=await l.get(`/items/navarch_parcel/${qe}`,{params:{fields:[q,J,L,V,W,G,H,Y,K,z,X,Q,Z]}});console.log(`parcelResponce.data.data=${JSON.stringify(Ge.data.data)}`),function(t){if(!t)throw new Error("Parcel data not found, please ensure the selected parcel still exists");if(!t[L])throw new Error("The selected parcel does not have a contract, please ensure that the contract field for the parcel is not empty");if(!t[V])throw new Error("The selected parcel does not have a counterparty, please ensure that the counterparty field for the parcel is not empty");if(!t[q])throw new Error("The selected parcel does not have assay results");if(!t[J])throw new Error("The selected parcel does not have weight results");if(!t[z])throw new Error("The selected parcel does not have an origin port");if(!t[X])throw new Error("The selected parcel does not have a destination port");if(!t[Q])throw new Error("The selected parcel does not have a shipment code")}(Ge.data.data);const He=Ge.data.data[q],Ye=Ge.data.data[J],Ke=Ge.data.data[L],ze=await l.get(`/items/navarch_contract_payment_information?filter[related_contract]=${Ke}`,{params:{fields:[rt,nt,ot,it,st,lt,ct,dt]}});if(ze.data.data&&0===ze.data.data.length)return o.value="No invoice type found for the contract",void(i.value=!1);const Xe=ze.data.data.find((t=>t[rt]===We));if(!Xe)return o.value=`Cannot find payment information for ${We} in the contract, please ensure that data for it has been entered and saved`,void(i.value=!1);const Qe=await l.get(`/items/navarch_weight_lot?filter[${x}]=${Ye}&sort[]=${F}`,{params:{fields:["id","dry_weight","wet_weight",j,"moisture","wet_weight_uom","dry_weight_uom"]}});console.log(`weightLotResponse.data.data=${JSON.stringify(Qe.data.data)}`),function(t){if(!t||0===t.length)throw new Error("No weight lots found for the selected parcel")}(Qe.data.data);const Ze=function(t){console.log("[evaluateWeights]");const e={};for(const a of t)e[a.method]||(console.log(`adding method ${a.method} to weightData object`),e[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),e[a.method.toString()].push(a);const a=[];for(const t of Object.keys(e)){if(!e[t]){console.log(`method=${t} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${t}`);const r=d(e[t]);r&&a.push(r)}return a}(Qe.data.data),ta=c.value.weight_method;let ea=Ze.find((t=>t.method===ta));if(ea||(ea=Ze.find((t=>"Outturn"===t.method))),ea||(ea=Ze.find((t=>"Inturn Final"===t.method))),ea||(ea=Ze.find((t=>"Inturn"===t.method))),ea||(ea=Ze.find((t=>"Estimated"===t.method))),ea||(ea=Ze.find((t=>"Planned"===t.method))),!ea)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");if(void 0===ea.dry_weight||null===ea.dry_weight||void 0===ea.wet_weight||null===ea.wet_weight||void 0===ea.moisture||null===ea.moisture||void 0===ea.dry_weight_uom||null===ea.dry_weight_uom||void 0===ea.wet_weight_uom||null===ea.wet_weight_uom||void 0===ea.method||null===ea.method)throw new Error("One of the fields for weight lots is undefined");const aa=await l.get(`/items/${St}?filter[${Pt}]=${ea.dry_weight_uom}`,{params:{fields:[Nt]}}),ra=await l.get(`/items/${St}?filter[wet_symbol]=${ea.wet_weight_uom}`,{params:{fields:[Tt]}});if(!aa.data.data||!aa.data.data[0]||!aa.data.data[0][Nt])throw new Error(`Dry weight uom not found for symbol ${ea.dry_weight_uom}`);if(!ra.data.data||!ra.data.data[0]||!ra.data.data[0][Tt])throw new Error(`Wet weight uom not found for symbol ${ea.wet_weight_uom}`);const na=aa.data.data[0][Nt],oa=0===na.indexOf("dry")?na:`dry ${na}`,ia=ra.data.data[0][Tt],sa=0===ia.indexOf("wet")?ia:`wet ${ia}`,la=await l.get(`/items/navarch_assay_lot?filter[${x}]=${He}&sort[]=${F}`,{params:{fields:["id","commodity",j,"dry_weight","dry_weight_uom","buyer_assay","seller_assay","final_assay","lot_number",et]}});console.log(`assayLotResponse.data.data=${JSON.stringify(la.data.data)}`),function(t){if(!t||0===t.length)throw new Error("No assay lots found for the selected parcel")}(la.data.data);const ca=function(t){var e;console.log("[evaluateAnalyticalAssay]");const a={};for(const e of t)a[e.method]||(a[e.method]={}),a[e.method][e.commodity]||(a[e.method][e.commodity]=[]),null!==e.lot_number?(1===a[e.method][e.commodity].length&&null===a[e.method][e.commodity][0].lot_number&&(a[e.method][e.commodity]=[]),a[e.method][e.commodity].push(e)):null===e.lot_number&&0===a[e.method][e.commodity].length&&a[e.method][e.commodity].push(e);console.log(`[evaluateAnalyticalAssay] group: ${JSON.stringify(a)}}`);const r={};for(const t in a){console.log(`[evaluateAnalyticalAssay] methodKey: ${t}, group[methodKey]: ${JSON.stringify(a[t])}`);for(const n in a[t]){console.log(`[evaluateAnalyticalAssay] commodityKey: ${n}, group[methodKey][commodityKey]: ${JSON.stringify(a[t][n])}`),r[t]=null!=(e=r[t])?e:{},r[t][n]={};const i=a[t][n].reduce(((t,e)=>t+e.dry_weight),0);if(console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${i} from ${JSON.stringify(a[t][n])}`),0===i||isNaN(i))throw o.value=`Please provide dry weight for ${n} commodity in ${t} method, total dry weight cannot be ${i}`,new Error("[evaluateAnalyticalAssay] totalDryWeight is 0");console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${i}`),r[t][n].analytical_assay=a[t][n].reduce(((e,a)=>{var r,i;const s=null!=(i=a.final_assay)?i:null!=(r=a.seller_assay)?r:a.buyer_assay;if(null==s)throw o.value=`Please provide Final, Seller or Buyer assay value for ${n} commodity in ${t} method`,new Error("[evaluateAnalyticalAssay] assay value is not defined for assay lot");const l=e+s*a.dry_weight;return console.log(`[evaluateAnalyticalAssay] evaluated analytical assay: ${l} for method=${t}, commodity=${n}; with values accumulator=${e}, assayValue=${s}, dryWeight=${a.dry_weight}`),l}),0)/i,console.log(`[evaluateAnalyticalAssay] analytical assay: ${r[t][n].analytical_assay}`),a[t][n].length>0&&(r[t][n][et]=a[t][n][0][et])}}return console.log(`[evaluateAnalyticalAssay] analyticalAssay: ${JSON.stringify(r)}`),r}(la.data.data),da=c.value.assay_method;let ua;if(da&&(ua=ca[da.toString()]),ua||(ua=ca.Outturn),ua||(ua=ca["Inturn Final"]),ua||(ua=ca.Inturn),ua||(ua=ca.Estimated),ua||(ua=ca.Planned),!ua)throw new Error("No assay lot data found for all assay methods. Please ensure assay lot data has been entered in the selected parcel.");console.log(`WEIGHT: ${JSON.stringify(ea)}`),console.log(`ASSAYS: ${JSON.stringify(ua)}`);const fa=await l.get(`/items/navarch_contract/${Ke}`,{params:{fields:[at]}});!function(t){if(!t)throw new Error("Contract data not found, please ensure the selected contract still exists");if(!t[at])throw new Error("The selected contract does not have a set currency, please ensure that the currency field for the contract is not empty")}(fa.data.data);const ha=await l.get(`/items/navarch_currency/${fa.data.data.contract_currency}`,{params:{fields:[It]}});!function(t){if(!t)throw new Error("Currency data not found, please ensure the selected currency still exists");if(!t[It])throw new Error("The selected currency in the contract is not valid")}(ha.data.data);const pa=ha.data.data.code,ya=await l.get(`/items/navarch_commodity_in_contract?filter[contract]=${Ke}`,{params:{fields:["id",ut,"primary_commodity",ft,"price_method","quotational_periods","payable_assay_rates","penalty_rates","penalty_per_uom",ht,"treatment_charge_per_uom"]}});!function(t){if(!t||0===t.length)throw new Error("No commodity data found in selected contract for parcel");if(!t.every((t=>t[ut])))throw new Error("The selected contract has an undefined commodity, please ensure that the 'Commodity' field for all commodites in the contract is not empty");if(!t.every((t=>!t[ft]||t[ht])))throw new Error("The selected contract has an undefined base price Uom for commodity, please ensure that the 'Base Price Uom' field for all commodites in the contract is not empty")}(ya.data.data),console.log(`\tcommodityInContractResponse: ${JSON.stringify(ya.data.data)}`);const ma=[],ga=[];let va="";for(const{id:a,commodity:o,primary_commodity:i,price_method:c,quotational_periods:d,price_per_uom:y,penalty_per_uom:m,treatment_charge_per_uom:A}of ya.data.data){const x=await l.get(`/items/navarch_commodity/${o}`,{params:{fields:[Ct,Dt]}});if(Ne(x.data.data,o),!ua[x.data.data.code]){console.log(`[generateInvoice] no analytical assay for commodity ${x.data.data.code} found, skipping...`);continue}if(i&&(va=x.data.data[Ct]),null!==d){const o=d;console.log(`\tquotationalPeriods: ${JSON.stringify(o)}`);const i=Array.isArray(o)?o.find((t=>t.default)):null;if(!i)throw new Error(`No default quotational period found for commodity ${x.data.data.code}`);const m=o.filter((t=>!t.default)).map((t=>`${t.qp_period} ${t.qp_code}`)),b=[`${i.qp_period} ${i.qp_code}`,...m].join(", ");console.log(`[generateInvoice] evaluate payable assay for ${x.data.data.code} with an analytical assay=${null==(t=ua[x.data.data.code])?void 0:t.analytical_assay}`);const F=await l.get(`/items/navarch_payable_assay_bracket?filter[${pt}]=${a}`,{params:{fields:["bracket_type",yt,mt,gt,vt,wt,"rate_type","initial_adjustment","initial_adjustment_uom","minimum_deduction","minimum_deduction_uom","maximum_cap","maximum_cap_uom"]}}),{payableAssay:j,expression:L}=await w(null==(e=ua[x.data.data.code])?void 0:e.analytical_assay,null==(r=ua[x.data.data.code])?void 0:r.assay_uom,F.data.data,x.data.data[Ct]);let V=null,q=null;if("Final"!==We){const t=await Ie(x.data.data.code,Ge.data.data,c,(async()=>Se(Xe,Ge.data.data,We)));if(null===t)throw new Error(`[generateInvoice] Provisional pricing dates not found for commodity ${x.data.data.code}`);if(null===t.provisionalPricingStartDate||!(t.provisionalPricingStartDate instanceof Date))throw new Error(`[generateInvoice] Invalid provisional pricing start date for commodity ${x.data.data.code} of invoice type ${We}`);if(V=t.provisionalPricingStartDate,null===t.provisionalPricingEndDate||!(t.provisionalPricingEndDate instanceof Date))throw new Error(`[generateInvoice] Invalid provisional pricing end date for commodity ${x.data.data.code} of invoice type ${We}`);q=t.provisionalPricingEndDate}else{const t=await Ie(x.data.data.code,Ge.data.data,c,(async()=>Oe(i,Ge.data.data)),!0);if(null===t)throw new Error(`[generateInvoice] Provisional pricing dates not found for commodity ${x.data.data.code}`);if(null===t.provisionalPricingStartDate||!(t.provisionalPricingStartDate instanceof Date))throw new Error(`[generateInvoice] Invalid provisional pricing start date for commodity ${x.data.data.code} of invoice type ${We}`);if(V=t.provisionalPricingStartDate,null===t.provisionalPricingEndDate||!(t.provisionalPricingEndDate instanceof Date))throw new Error(`[generateInvoice] Invalid provisional pricing end date for commodity ${x.data.data.code} of invoice type ${We}`);q=t.provisionalPricingEndDate}console.log(`[generateInvoice] provisional pricing date range: ${V.toString()} - ${q.toString()}`);const J=await Pe(x.data.data.code,c,V,q);let W;const G=await l.get(`/items/${_t}?filter[related_contract_commodity_tc]=${a}`,{params:{fields:[yt,mt,gt,vt,$t,Et,bt,At,wt]}});let H,Y;if(void 0!==G.data.data&&null!==G.data.data&&G.data.data.length>0&&(W=await E(J,null==(n=ua[x.data.data.code])||n.assay_uom,G.data.data,x.data.data[Ct],"Treatment Charge")),W){if(!A)throw new Error(`Charge Rate UOM is not defined for commodity ${x.data.data[Ct]}`);const t=await l.get(`/items/${St}/${A}`,{params:{fields:[Ot]}});Ue(t.data.data,x.data.data[Ct]),H=t.data.data[Ot]}const K=await l.get(`/items/${_t}?filter[related_contract_commodity_rc]=${a}`,{params:{fields:[yt,mt,gt,vt,$t,Et,bt,At,wt]}});if(void 0!==K.data.data&&null!==K.data.data&&K.data.data.length>0&&(Y=await E(J,null==(s=ua[x.data.data.code])||s.assay_uom,K.data.data,x.data.data[Ct],"Refining Charge")),Y){if(!A)throw new Error(`Charge Rate UOM is not defined for commodity ${x.data.data[Ct]}`);const t=await l.get(`/items/${St}/${A}`,{params:{fields:[Ot]}});Ue(t.data.data,x.data.data[Ct]),H=t.data.data[Ot]}const z=await l.get(`/items/${St}/${y}`,{params:{fields:[Ot]}});Te(z.data.data,x.data.data[Ct]);const X=z.data.data[Ot],Q=await R(X,ea.dry_weight_uom,null==(u=ua[x.data.data.code])?void 0:u.assay_uom);console.log(`[generateInvoice] payableMetalConversion for commodity ${x.data.data.name}: ${JSON.stringify(Q)}`),Q.initialConversion=1===(null==(f=Q.initialConversion)?void 0:f.conversionFactor)?void 0:Q.initialConversion,Q.finalConversion=1===(null==(h=Q.finalConversion)?void 0:h.conversionFactor)?void 0:Q.finalConversion;const Z=await l.get(`/items/navarch_price_method/${c}`,{params:{fields:[ge]}});Me(Z.data.data,c,x.data.data[Ct]),ma.push({commodity:x.data.data.name,analytical_assay:p(null==(g=ua[x.data.data.code])?void 0:g.analytical_assay,4),deduction_expression:L,payable_assay:p(j,4),assay_uom:null==(v=ua[x.data.data.code])?void 0:v.assay_uom,payable_metal:p(ea.dry_weight*(null!=($=null==(_=Q.initialConversion)?void 0:_.conversionFactor)?$:1)*(null!=j?j:1)*(null!=(D=null==(C=Q.finalConversion)?void 0:C.conversionFactor)?D:1)*("%"!==(null==(I=ua[x.data.data.code])?void 0:I.assay_uom)?1:.01),4),payable_metal_expression:`${p(ea.dry_weight,4)}${ea.dry_weight_uom}${Q.initialConversion?` * ${p(Q.initialConversion.conversionFactor,4)}${Q.initialConversion.conversionUom}`:""} * ${p(null!=j?j:1,4)}${"%"!==(null==(S=ua[x.data.data.code])?void 0:S.assay_uom)?`${null==(P=ua[x.data.data.code])?void 0:P.assay_uom}`:" / 100"}${Q.finalConversion?` * ${p(Q.finalConversion.conversionFactor,4)}${Q.finalConversion.conversionUom}`:""}`,payable_metal_uom:X,qp:b,qp_start_date:O(V),qp_end_date:O(q),price_method:Z.data.data[ge],price_rate:p(J,4),price_per_uom:X,price:p(ea.dry_weight*(null!=(T=null==(N=Q.initialConversion)?void 0:N.conversionFactor)?T:1)*(null!=j?j:1)*(null!=(B=null==(U=Q.finalConversion)?void 0:U.conversionFactor)?B:1)*("%"!==(null==(M=ua[x.data.data.code])?void 0:M.assay_uom)?1:.01)*J),treatment_charge:W?{rate:p(W.baseTreatmentCharge,4),discount:p((null!=(k=W.baseTreatmentCharge)?k:0)-(null!=(Ut=W.finalValue)?Ut:0),4),final_rate:p(W.finalValue,4),per_uom:H,final_amount:p(ea.dry_weight*(null!=(Bt=W.finalValue)?Bt:1))}:void 0,refining_charge:Y?{rate:p(Y.baseTreatmentCharge,4),discount:p((null!=(Mt=Y.baseTreatmentCharge)?Mt:0)-(null!=(kt=Y.finalValue)?kt:0),4),final_rate:p(Y.finalValue,4),per_uom:H,final_amount:p(ea.dry_weight*(null!=(Rt=Y.finalValue)?Rt:1))}:void 0,final_total:p(ea.dry_weight*(null!=(pe=null==(he=Q.initialConversion)?void 0:he.conversionFactor)?pe:1)*(null!=j?j:1)*(null!=(me=null==(ye=Q.finalConversion)?void 0:ye.conversionFactor)?me:1)*("%"!==(null==(ke=ua[x.data.data.code])?void 0:ke.assay_uom)?1:.01)*J-(W?1:0)*(ea.dry_weight*(null!=(Re=null==W?void 0:W.finalValue)?Re:1))-(Y?1:0)*(ea.dry_weight*(null!=(xe=null==Y?void 0:Y.finalValue)?xe:1)))})}const F=await l.get(`/items/navarch_penalty_bracket?filter[${pt}]=${a}`,{params:{fields:[yt,mt,gt,vt,"no_penalty","escalator_reference","for_every_unit",wt]}});if(F.data.data.length>0){if(null===m)throw new Error(`[generateInvoice] penalty_per_uom is null for ${x.data.data.code}`);const t=await l.get(`/items/${St}/${m}`,{params:{fields:[Ot]}});Be(t.data.data,x.data.data[Ct]);const e=t.data.data[Ot],{penalty:a,expression:r,bracket:n}=await b(null==(Fe=ua[x.data.data.code])?void 0:Fe.analytical_assay,F.data.data,pa,e,x.data.data[Ct]);console.log(`[generateInvoice] evaluate penalty for ${x.data.data.code} with an analytical assay=${null==(je=ua[x.data.data.code])?void 0:je.analytical_assay}, penaltyRate=${null==n?void 0:n.rate}, finalPenaltyRate=${a}, expression='${r}'`),ga.push({commodity:x.data.data.name,analytical_assay:p(null==(Le=ua[x.data.data.code])?void 0:Le.analytical_assay,4),deduction_expression:r,assay_uom:null==(Ve=ua[x.data.data.code])?void 0:Ve.assay_uom,penalty_rate:p(null==n?void 0:n.rate,4),penalty_per_uom:e,final_penalty_rate:p(a,4),final_penalty:p((null!=a?a:1)*ea.dry_weight)})}}console.log(`[generateInvoice] COMMODITIES: ${JSON.stringify(ma)}`),console.log(`[generateInvoice] PENALTIES: ${JSON.stringify(ga)}`);const wa=ma.reduce(((t,e)=>t+m(e.price)),0),_a=ma.reduce(((t,e)=>{var a;return t+m(null==(a=e.treatment_charge)?void 0:a.final_amount)}),0),$a=ma.reduce(((t,e)=>{var a;return t+m(null==(a=e.refining_charge)?void 0:a.final_amount)}),0),Ea=ga.reduce(((t,e)=>t+m(e.final_penalty)),0);console.log(`[generateInvoice] TOTAL_REVENUE=${wa}, TOTAL_TREATMENT_CHARGE=${_a}, TOTAL_REFINING_CHARGE=${$a}, TOTAL_PENALTIES=${Ea}`);let ba,Aa=0;const Ca=!!Ge.data.data[Z];Ca&&(Aa=Ge.data.data[Z].reduce(((t,e)=>t+e.amount),0),ba={adjustments:Ge.data.data[Z].map((t=>({description:t.description,amount:p(t.amount)}))),total_adjustments:p(Aa)});const Da=Xe[nt],Ia=wa-_a-$a-Ea+Aa,Sa=null!=Da?Ia*Da/100:void 0,Oa=await l.get(`/items/navarch_counterparty/${Ge.data.data[V]}`,{params:{fields:[xt]}});!function(t){if(console.log("[validateCounterparty]"),!t)throw new Error("Counterparty for parcel not found");if(!t[xt])throw new Error("No name defined for counterparty of the selected parcel")}(Oa.data.data);const Pa=await l.get(`/items/navarch_counterparty_navarch_address?filter[navarch_counterparty_id]=${Ge.data.data[V]}`,{params:{fields:[Ft]}});!function(t){if(console.log("[validateCounterpartyAddress]"),!t||0===t.length)throw new Error("Counterparty address for parcel not found");if(!t[0][Ft])throw new Error("No address defined for counterparty of the selected parcel")}(Pa.data.data);const Na=Pa.data.data[0][Ft],Ta=await l.get(`/items/navarch_address/${Na}`,{params:{fields:[re,ne,oe,ie,se,le]}});!function(t){if(!t)throw new Error("Buyer address for parcel not found");if(!t[re])throw new Error("No address line 1 defined for buyer address of the selected parcel");if(!t[se])throw new Error("No country defined for buyer address of the selected parcel")}(Ta.data.data);const Ua=Ta.data.data[re],Ba=Ta.data.data[ne]?`,\n${Ta.data.data[ne]}`:"",Ma=Ta.data.data[oe]?`,\n${Ta.data.data[oe]}`:"",ka=Ta.data.data[ie]?`,\n${Ta.data.data[ie]}`:"",Ra=await l.get(`/items/${te}/${Ta.data.data[se]}`,{params:{fields:[ee]}});!function(t){if(!t)throw new Error("Something went wrong when getting the buyer's based country")}(Ra.data.data);const xa=Ra.data.data[ee]?`, ${Ra.data.data[ee]}`:"",Fa=`${Ua}${Ba}${Ma}${Ta.data.data[le]?` ${Ta.data.data[le]}`:""}${ka}${xa}`,ja=Ge.data.data[K];let La;ja&&(La=await l.get(`/items/navarch_vessel/${ja}`,{params:{fields:[ce]}}),function(t){if(console.log("[validateVessel]"),!t)throw new Error("Vessel for parcel not found");if(!t[ce])throw new Error("No name defined for vessel of the selected parcel")}(La.data.data));const Va=(await l.get("/items/navarch_company",{params:{fields:[jt,Lt,Vt,qt,Jt,Wt,Ht,Gt,Yt,Kt,zt,Xt,Qt,Zt]}})).data.data;let qa=null;if(Va[Lt]){const t=Va[Lt],e=await l.get(`/assets/${t}?access_token=9TKZlOUjs29Svyop45nyyyN02lYPlX_x`,{responseType:"arraybuffer"});qa=y.Buffer.from(e.data,"binary").toString("base64")}const Ja=Va[Zt];let Wa=null;if(Ja){const t=await l.get(`/assets/${Ja}?access_token=9TKZlOUjs29Svyop45nyyyN02lYPlX_x`,{responseType:"arraybuffer"});Wa=y.Buffer.from(t.data,"binary").toString("base64")}!function(t){if(console.log("[validateCompanyData]"),!t)throw new Error("Company data not found");if(!t[jt])throw new Error("Please set company name in Directories > Company");if(!t[Yt])throw new Error("Please set company phone code in Directories > Company");if(!t[Vt])throw new Error("Please set company address line 1 in Directories > Company");if(!t[Gt])throw new Error("Please set the country the company is based in Directories > Company");if(!t[Kt])throw new Error("Please set the company phone number in Directories > Company");if(!t[zt])throw new Error("Please set the company signatory name in Directories > Company");if(!t[Xt])throw new Error("Please set the company signatory title in Directories > Company");if(!t[Qt])throw new Error("Please set the company remittance details in Directories > Company");if(!t[Zt])throw new Error("Please set the company signature in Directories > Company")}(Va);const Ga=Va[jt],Ha=await l.get(`/items/${te}/${Va[Yt]}`,{params:{fields:[ae]}});!function(t){if(!t)throw new Error("Company phone code not found, please ensure phone code selected for Directories > Company is valid");if(!t[ae])throw new Error("Company country phone code not found, please contact Navarch support for assistance")}(Ha.data.data);const Ya=Ha.data.data[ae],Ka=Va[Kt],za=Va[Vt],Xa=Va[qt]?`,\n${Va[qt]}`:"",Qa=Va[Jt]?`,\n${Va[Jt]}`:"",Za=Va[Wt]?`,\n${Va[Wt]}`:"",tr=await l.get(`/items/${te}/${Va[Gt]}`,{params:{fields:[ee]}});!function(t){if(!t)throw new Error("Country not found, please ensure country selected for Directories > Company is valid");if(!t[ee])throw new Error("Country name not found, please contact Navarch support for assistance")}(tr.data.data);const er=tr.data.data[ee]?`, ${tr.data.data[ee]}`:"",ar=`${za}${Xa}${Qa}${Va[Ht]?` ${Va[Ht]}`:""}${Za}${er}`,rr=await l.get(`/items/${de}/${Ge.data.data[z]}`,{params:{fields:[ue,fe]}});!function(t){if(!t)throw new Error("Origin port for parcel not found");if(!t[ue])throw new Error("No name defined for origin port of the selected parcel");if(!t[fe])throw new Error("No country defined for origin port of the selected parcel")}(rr.data.data);const nr=await l.get(`/items/${de}/${Ge.data.data[X]}`,{params:{fields:[ue,fe]}});!function(t){if(!t)throw new Error("Destination port for parcel not found");if(!t[ue])throw new Error("No name defined for destination port of the selected parcel");if(!t[fe])throw new Error("No country defined for destination port of the selected parcel")}(nr.data.data);let or=(await l.get(`/items/${ve}?filter[${we}]=${qe}`,{params:{fields:["id",_e]}})).data.data.reduce(((t,e)=>t+(e[_e]?1:0)),0)+1,ir=qe;const sr=or.toString().padStart(2,"0"),lr=`${Ge.data.data[Q]} (#${sr})`,cr=ir.toString().padStart(2,"0"),dr={invoice_type:We,days:Xe[ot],day_type:Xe[it],ref_day:"Final"===We?"Parcel Finalisation":Xe[st]};if(!dr)throw new Error(`Contract does not have a payment advice for invoice type ${We}`);let ur,fr="";switch(dr.ref_day){case"Arrival Date":fr="Actual Arrival Date from the Parcel form",ur=Ge.data.data[W];break;case"B/L Date":fr="B/L Date from the Parcel form",ur=Ge.data.data[G];break;case"Invoice Date":fr="Invoice Date from the Invoice form",ur=c.value[Ae];break;case"Estimated Shipment Date":fr="Estimated Shipment Date from the Parcel form",ur=Ge.data.data[H];break;case"Parcel Finalisation":if(void 0===Ge.data.data[tt]||null===Ge.data.data[tt])throw new Error("[generateInvoice] Parcel has not been finalised, please fill in the the parcel finalisation date in the parcel form.");fr="Parcel Finalisation Date from the Parcel form",ur=Ge.data.data[tt];break;default:throw new Error(`Invalid reference day for payment advice: ${dr.ref_day}; please contact Navarch for support`)}if(null==ur)throw new Error(`Reference day for payment advice ${fr} is empty in parcel`);const hr=new Date(ur),pr=parseInt(dr.days),yr=dr.day_type;let mr;switch(yr){case"Business Day(s)":mr=function(t,e,a=!1){const r=new Date(t.valueOf());let n=e-(a?1:0);for(;n>0;)r.setDate(r.getDate()+1),0!==r.getDay()&&6!==r.getDay()&&(n-=1);return r.getHours()>=12&&r.setDate(r.getDate()+1),r}(hr,pr,!0);break;case"Calendar Day(s)":mr=new Date(hr.valueOf()),mr.getHours()>=12?mr.setDate(mr.getDate()+pr+1):mr.setDate(mr.getDate()+pr);break;default:throw new Error(`[generateInvoice] Invalid day_type for payment advice ${yr}`)}console.log(`[generateInvoice] payment advice due date: ${mr.toString()}`);const gr=O(mr);let vr,wr,_r,$r;if(c.value[Ee]){const t=await l.get(`/items/${ve}/${c.value[Ee]}`,{params:{fields:[we,_e,be,$e]}});if(console.log(`[generateInvoice] revisionParcelResponse: ${JSON.stringify(t.data)}`),200!==t.status||!t.data.data)throw new Error(`[generateInvoice] Failed to get invoice ${c.value[Ee]}`);if(t.data.data[we]!==qe)throw new Error(`[generateInvoice] Parcel ID mismatch between this invoice with parcel ${qe}, and the revision invoice ${c.value[Ee]} with parcel id ${t.data.data[we]}`);if(!t.data.data[_e])throw new Error(`[generateInvoice] No invoice pdf has been generated yet for invoice ${c.value[Ee]}`);if(!t.data.data[be])throw new Error(`[generateInvoice] No invoice type found for the revision invoice ${c.value[Ee]}`);_r=t.data.data[be],$r=t.data.data[$e];const e=t.data.data[_e];if(function(t){if(!t)throw new Error("Revision invoice data not found");if(!t.invoice_number)throw new Error("Revision invoice data does not have an invoice number in generated document");if(!t.balance_in_sellers_favor)throw new Error("Revision invoice data does not have a valid 'Balance in Sellers Favor' in generated document")}(e),console.log(`[generateInvoice] revisionInvoiceData: ${JSON.stringify(e)}`),vr=e.invoice_number,!vr||""===vr)throw new Error(`[generateInvoice] Could not find invoice number in revision invoice ${c.value[Ee]}`);const a=e.balance_in_sellers_favor.replace(/,/g,"");if(wr=parseFloat(a),!wr||isNaN(wr))throw new Error(`[generateInvoice] Total payment=${e.balance_in_sellers_favor} found is not convertible to monetary amount for revision invoice ${c.value[Ee]}`)}const Er=null!=Sa?Sa-(null!=wr?wr:0):void 0,br={signatoryName:Va[zt],signatoryTitle:Va[Xt],signature:null!=Wa?Wa:null,company:Ga},Ar={folder_id:await Ce(),company_logo:null!=qa?qa:null,seller:Ga,seller_address:ar,seller_phone_number:`+${Ya} ${Ka}`,signatory:br,remittance:Va[Qt],buyer:Oa.data.data[xt],buyer_address:Fa,shipment_code:Ge.data.data[Q],vessel:La?La.data.data[ce]:"N/A",bl_date:Ge.data.data[G]?O(new Date(Ge.data.data[G])):"N/A",invoice_type:We,invoice_date:O(Je),revision:vr&&wr?$r:void 0,invoice_number:lr,parcel:`${Ge.data.data[Q]} (#${cr})`,port_of_loading:`${rr.data.data[ue]}, ${rr.data.data[fe]}`,port_of_discharge:`${nr.data.data[ue]}, ${nr.data.data[fe]}`,primary_commodity:`${va} Concentrates`,due_date:gr,wet_weight:p(ea.wet_weight,4),wet_weight_uom:ea.wet_weight_uom,wet_weight_uom_name:A(sa),moisture:p(ea.moisture,4),moisture_uom:"%",dry_weight:p(ea.dry_weight,4),dry_weight_uom:ea.dry_weight_uom,dry_weight_uom_name:A(oa),total_revenue:p(wa),total_deductions:p(Ea+_a+$a),currency:pa,commodities:ma,penalties:{penalties:ga,total_penalties:p(Ea)},adjustments:Ca?ba:void 0,invoice_value:p(Ia),payable_percentage:p(Da),payable_amount:p(Sa),payment_received_source:vr&&wr&&$r?`${_r}.${$r}.${vr}`:void 0,payment_received:vr&&wr?p(wr):void 0,balance_in_sellers_favor:p(Er)};let Cr;try{Cr=await l.post("/generate/invoice",Ar)}catch(t){throw console.error(`[generateInvoice] error: ${t}`),new Error(JSON.stringify(t.response.data))}if(200!==Cr.status)return console.log(`[generateInvoice] invoice response status: ${Cr.status}`),o.value=Cr.data,void(i.value=!1);const Dr=await async function(t){if(!t)throw console.error("[uploadGeneratedDoc] fileData is empty"),new Error("A failure occured while trying to upload the generated document, no file data found. Please try again.");const e=function(t){console.log("[convertJsonToFormData] json=",JSON.stringify(t));const e=new FormData;for(let a in t)"file"!==a&&e.append(a,t[a]);const a=t.file,r=function(t,e){const a=atob(t),r=new ArrayBuffer(a.length),n=new Uint8Array(r);for(let t=0;t<a.length;t++)n[t]=a.charCodeAt(t);const o=new Blob([n],{type:e});return o}(a,"application/pdf");return e.append("file",r,t.filename_download),e}(t),a=await l.post("/files",e,{headers:{"Content-Type":"multipart/form-data"}});if(200!==a.status)throw console.error(`[uploadGeneratedDoc] uploadedFileData status: ${a.status}`),new Error("A failure occured while trying to upload the generated document. Please try again.");return a.data.data.id}(Cr.data);a("input",{...Ar,doc_name:Dr}),console.log(`[generateInvoice] invoice response: ${JSON.stringify(c.value)}`),i.value=!1,De(Dr)}catch(t){return i.value=!1,console.log(`generating invoice went wrong due to: ${t}`),void(o.value=t)}},viewPdf:De,isCopying:s,copy:async function(){s.value=!0;const{id:t,user_created:e,date_created:a,user_updated:r,date_updated:n,invoice:i,...d}=c.value;console.log(`[invoice::copy] requestBody=${JSON.stringify(d)}`);const u=await l.post("/items/navarch_invoices",d);if(200!==u.status)return console.log(`[invoice::copy] copy response status: ${u.status}`),void(o.value=`Failed to duplicate invoice with status ${u.status}`);s.value=!1,window.open(`/admin/content/navarch_invoices/${u.data.data.id}`)},failureReason:o};async function Ie(t,e,a,r,n=!1){if(h(e[Y])||h(e[Y][t]))return await r();const o=await async function(t,e,a,r){if(r&&!t.declared)return null;const n=null==t?void 0:t.qp_selected;if(!n)return null;const o=n.split(" "),i={qp_period:parseInt(o[0]),qp_code:o[1]};let s,c,d,u;switch(i.qp_code){case"MAMA":s=W,c="Actual Arrival Date";break;case"MOSS":s=H,c="Estimated Shipment Date";break;case"MOS":case"MOAS":s=G,c="B/L Date";break;default:throw new Error(`Unsupported QP code ${i.qp_code} in the contract commodities, please ensure all commodity QP codes are MAMA, MOS, MOSS, or MOAS`)}const f=new Date(e[s]);if(null==f)throw new Error(`[generateInvoice] Invalid reference day for ${c} from ${i.qp_code}`);if(d=T(f,i.qp_period),d.valueOf()>Date.now())return null;if(u=U(f,i.qp_period),u.valueOf()>Date.now())return null;if(u.valueOf()<=Date.now()){0===u.getDay()?u=N(u,2,!0):6===u.getDay()&&(u=N(u,1,!0));const t=await l.get(`/items/${he}`,{params:{filter:{_and:[{date:{_eq:P(u)}},{price_method:{_eq:a}}]},fields:[pe,ye]}});if(!t.data.data||0===t.data.data.length)return null}return{provisionalPricingStartDate:d,provisionalPricingEndDate:u}}(e[Y][t],e,a,n);return o||await r()}async function Se(t,e,a){let r,n,o;const i={invoice_type:a,days:t[lt],day_type:t[ct],ref_day:t[dt]};if(!i)throw new Error(`[generateInvoice] No provisional pricing found for invoice type ${a}`);let s;switch(i.ref_day){case"Arrival Date":s=e[W],r="Actual Arrival Date from the Parcel form";break;case"B/L Date":s=e[G],r="B/L Date from the Parcel form";break;case"Invoice Date":s=c.value[Ae],r="Invoice Date from the Invoice form";break;case"Estimated Shipment Date":s=e[H],r="Estimated Shipment Date from the Parcel form";break;default:throw new Error(`Invalid reference day for invoice pricing: ${i.ref_day}; please contact Navarch for support`)}if(null==s)throw new Error(`Reference day for invoice pricing ${r} is empty`);o=new Date(s);const l=parseInt(i.days),d=i.day_type;switch(d){case"Business Day(s)":n=N(o,l,!0);break;case"Calendar Day(s)":n=new Date(o.valueOf()),n.setDate(n.getDate()-l);break;default:throw new Error(`Invalid day type ${d} for ${a} Invoice in the contract, please ensure it is either Calendar Day(s) or Business Day(s)`)}if(n.valueOf()>Date.now())throw new Error(`Start date for provisional pricing ${n} (${r}) for ${a} Invoice has not occurred yet`);if(o.valueOf()>Date.now())throw new Error(`End date for provisional pricing ${o} (${r}) for ${a} Invoice has not occurred yet`);return{provisionalPricingStartDate:n,provisionalPricingEndDate:o}}async function Oe(t,e){let a,r,n,o;switch(t.qp_code){case"MAMA":o=W,a="Actual Arrival Date";break;case"MOSS":o=H,a="Estimated Shipment Date";break;case"MOS":case"MOAS":o=G,a="B/L Date";break;default:throw new Error(`Unsupported QP code ${t.qp_code} in the contract commodities, please ensure all commodity QP codes are MAMA, MOS, MOSS, or MOAS`)}const i=new Date(e[o]);if(null==i)throw new Error(`[generateInvoice] Invalid reference day for ${a} from ${t.qp_code}`);if(r=T(i,t.qp_period),r.valueOf()>Date.now())throw new Error(`[generateInvoice] Start date for provisional pricing ${r} (${a}) based on default QP has not occurred yet`);if(n=U(i,t.qp_period),n.valueOf()>Date.now())throw new Error(`[generateInvoice] End date for provisional pricing ${n} (${a}) based on default QP has not occurred yet`);return{provisionalPricingStartDate:r,provisionalPricingEndDate:n}}async function Pe(t,e,a,r,n=1){if(h(t))throw new Error("Commodity is not defined for price calcualtion");if(h(e))throw new Error(`Price method for commodity ${t} is not defined for price calcualtion`);if(h(a))throw new Error(`Start date is not defined for price calcualtion with ${e} has not been properly defined, please ensure that contract QP is properly defined`);if(h(r))throw new Error(`End date is not defined for price calcualtion with ${e} has not been properly defined, please ensure that contract QP is properly defined`);const o=await l.get(`/items/${he}?filter[_and][0][price_method][_eq]=${e}&filter[_and][0][currency][_eq]=${n}&filter[_and][1][date][_between][0]=${P(a)}&filter[_and][1][date][_between][1]=${P(r)}`,{params:{fields:[pe,ye,me,"price_method"]}});if(!o||!o.data||!o.data.data)throw new Error(`[getCommodityAvgPrice] Failed to get commodity prices for commodity ${t} between ${P(a)} and ${P(r)}`);if(0===o.data.data.length)throw new Error(`No commodity prices found for commodity ${t} between ${P(a)} and ${P(r)}`);return o.data.data.reduce(((t,a)=>{if(!a[ye]&&!a[pe])throw new Error(`Commodity for ${e} on the date of ${a[me]} does not have a price, please contact Navarch for assistance`);let r;if(null!==a[ye]&&(r=Number(a[ye])),null===a[pe])throw new Error(`The commodity price for Price Method #${e} for the date of ${a[me]} is not a valid number, please contact Navarch for assistance`);return r=Number(a[pe]),t+r}),0)/o.data.data.length}function Ne(t,e){var a,r;if(console.log("[validateCommodityData]"),!t)throw new Error("commodity data response is null");if(!t[Ct])throw new Error(`Commodity name for commodity ${null!=(a=t[Dt])?a:e} is undefined, please contact Navarch for assistance`);if(!t[Dt])throw new Error(`Commodity code for commodity ${null!=(r=t[Ct])?r:e} is not defined, please contact Navarch for assistance`)}function Te(t,e){if(!t)throw new Error(`Price per UOM for commodity ${e} is not a valid`);if(!t[Ot])throw new Error(`Price per UOM for commodity ${e} does not have a valid unit symbol, please contact Navarch for assistance`)}function Ue(t,e){if(!t)throw new Error(`Charge per UOM for commodity ${e} is not a valid`);if(!t[Ot])throw new Error(`Charge per UOM for commodity ${e} does not have a valid unit symbol, please contact Navarch for assistance`)}function Be(t,e){if(!t)throw new Error(`Penalty per UOM for commodity ${e} is not a valid`);if(!t[Ot])throw new Error(`Penalty per UOM for commodity ${e} does not have a valid unit symbol, please contact Navarch for assistance`)}function Me(t,e,a){if(!t)throw new Error(`Price method ${e} for commodity ${a} is not defined, please contact Navarch for assistance`);if(!t[ge])throw new Error(`Price method ${e} for commodity ${a} has no name, please contact Navarch for assistance`)}}});const P={key:0},N={key:1};var T=[],U=[];!function(t,e){if(t&&"undefined"!=typeof document){var a,r=!0===e.prepend?"prepend":"append",n=!0===e.singleTag,o="string"==typeof e.container?document.querySelector(e.container):document.getElementsByTagName("head")[0];if(n){var i=T.indexOf(o);-1===i&&(i=T.push(o)-1,U[i]={}),a=U[i]&&U[i][r]?U[i][r]:U[i][r]=s()}else a=s();65279===t.charCodeAt(0)&&(t=t.substring(1)),a.styleSheet?a.styleSheet.cssText+=t:a.appendChild(document.createTextNode(t))}function s(){var t=document.createElement("style");if(t.setAttribute("type","text/css"),e.attributes)for(var a=Object.keys(e.attributes),n=0;n<a.length;n++)t.setAttribute(a[n],e.attributes[a[n]]);var i="prepend"===r?"afterbegin":"beforeend";return o.insertAdjacentElement(i,t),t}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),O.render=function(t,e,a,r,n,y){const m=o("v-button"),g=o("v-notice");return i(),s(l,null,[c(' <input :value="value" @input="handleChange($event.target.value)" /> '),c(" create a button only interface for Directus"),t.value?(i(),s("div",N,[d(m,{onClick:e[1]||(e[1]=()=>t.viewPdf())},{default:u((()=>[f("View Invoice ")])),_:1})])):(i(),s("div",P,[d(m,{onClick:e[0]||(e[0]=()=>t.generateInvoice()),loading:t.isGeneraingDoc},{default:u((()=>[f("Generate Invoice")])),_:1},8,["loading"]),t.failureReason?(i(),h(g,{key:0},{default:u((()=>[f(p(t.failureReason),1)])),_:1})):c("v-if",!0)])),d(m,{class:"margin-top-16px",onClick:e[2]||(e[2]=()=>t.copy()),loading:t.isCopying},{default:u((()=>[f("Copy")])),_:1},8,["loading"])],64)},O.__scopeId="data-v-64969d30",O.__file="src/interface.vue";var B=e({id:"invoice_generator_button",name:"Generate Invoice Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Invoice Generator Button.",component:O,options:null,types:["json"],group:"standard"});export{B as default};
