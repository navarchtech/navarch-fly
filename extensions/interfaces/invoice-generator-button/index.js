import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,ref as o,inject as n,resolveComponent as r,openBlock as i,createElementBlock as s,Fragment as l,createCommentVNode as d,createVNode as c,withCtx as u,createTextVNode as f,createBlock as m,toDisplayString as h}from"vue";var _=(e=>(e.BRACKET="Brackets",e.MIN_DEDUCTION="Minimum Deduction",e.MAX_CAP="Maximum Cap",e))(_||{}),p=(e=>(e.PERCENTAGE="Percentage",e.FRACTIONAL="Fractional",e))(p||{}),y=(e=>(e.WET_WEIGHT="wet_weight",e.MOISTURE="moisture",e.DRY_WEIGHT="dry_weight",e))(y||{}),v=(e=>(e.METHOD="method",e.WET_WEIGHT_UOM="wet_weight_uom",e.MOISTURE_UOM="moisture_uom",e.DRY_WEIGHT_UOM="dry_weight_uom",e))(v||{}),w=a({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:a}){const r=o(""),i=o(!1),s=e(),l=n("values",o({}));function d(e){if(console.log("[evaluateWeightData]"),0===e.length)return;const t=u(e,y.DRY_WEIGHT),a=u(e,y.WET_WEIGHT);return{method:c(e,v.METHOD),lots:e,dry_weight_uom:c(e,v.DRY_WEIGHT_UOM),wet_weight_uom:c(e,v.WET_WEIGHT_UOM),dry_weight:t,wet_weight:a,moisture:(a-t)/a*100}}function c(e,t){if(console.log("[getFirstValueAsSharedValue]"),0!==e.length)return console.log(`lots[0][${t.toString()}]=${e[0][t.toString()]}`),e[0][t.toString()]}function u(e,t){return console.log("[evaluateAggregateValue]"),e.reduce(((e,a)=>{var o;return e+(null!=(o=a[t.toString()])?o:0)}),0)}function f(e){return null==e}function m(e,t=2,a=!0){if(console.log("[formatNumber]"),isNaN(e)||null===e)return"-";const o=Math.round(e*Math.pow(10,t))/Math.pow(10,t),[n,r]=o.toString().split("."),i=n.replace(/\B(?=(\d{3})+(?!\d))/g,",");if(!r&&!a)return i;return`${i}.${(null!=r?r:"").padEnd(t,"0")}`}function h(e){if(console.log("[parseNumber]"),!e)return 0;const t=parseFloat(e.replace(/,/g,""));return console.log(`[parseNumber] number: ${e} to ${t}`),t}function w(e,t){var a;if(console.log("[findBracket]"),1===e.length){if(t>=(null!=(a=e[0].lower_threshold)?a:0)&&(null===e[0].upper_threshold||void 0===e[0].upper_threshold||t<e[0].upper_threshold))return e[0];throw new Error(`[findBracket] value=${t} does not fall within the only bracket: ${JSON.stringify(e[0])}`)}return e.find((e=>{var a,o;const n=t>(null!=(a=e.lower_threshold)?a:0)&&(null===e.upper_threshold||void 0===e.upper_threshold||t<e.upper_threshold)||e.lower_threshold_inclusive&&t===(null!=(o=e.lower_threshold)?o:0)||e.upper_threshold_inclusive&&t===e.upper_threshold;return console.log(`[findBracket] value=${t} for bracket: ${JSON.stringify(e)}? match=${!!n}`),n}))}function g(e,t){var a,o,n,r,i,s,l;console.log("[evaluateFinalValueFromBrackets]");const d=(e-(null!=(a=t.initial_adjustment)?a:0)*(null!=(o=t.initial_adjustment_conversion_factor)?o:1))*(null!=(n=t.rate)?n:0)*(t.rate_type===p.PERCENTAGE?.01:1)+(null!=(r=t.final_adjustment)?r:0)*(null!=(i=t.final_adjustment_conversion_factor)?i:1);switch(t.bracket_type){case _.MIN_DEDUCTION:if(null===t.comparator||void 0===t.comparator)throw new Error("Minimum deduction not found");const a=t.comparator*(null!=(s=t.comparator_conversion_factor)?s:1);return e-d<a?e-a:d;case _.MAX_CAP:if(null===t.comparator||void 0===t.comparator)throw new Error("Maximum cap not found");const o=t.comparator*(null!=(l=t.comparator_conversion_factor)?l:1);return d>o?o:d;case _.BRACKET:return d;default:throw new Error(`bracket type ${t.bracket_type} is not supported`)}}async function $(e,t,a){var o,n,r,i,s,l,d,c;if(console.log("[evaluatePayableAssay]"),!a||0===a.length)return{};const u=w(a,e);if(!u)throw new Error(`Bracket not found for value ${e}, please ensure the brackets for all commodities defined in the contract cover all range of possible values for payable assays`);let f,h,y=1;u.initial_adjustment_uom&&void 0!==u.initial_adjustment_uom&&null!==u.initial_adjustment_uom&&u.initial_adjustment_uom!==t&&(y=await M(u.initial_adjustment_uom,t),f=P(u.initial_adjustment_uom,t));let v,$=1;u.bracket_type===_.MAX_CAP?(h=null!=(o=u.maximum_cap)?o:0,void 0!==u.maximum_cap_uom&&null!==u.maximum_cap_uom&&u.maximum_cap_uom!==t&&($=await M(u.maximum_cap_uom,t),v=P(u.maximum_cap_uom,t))):u.bracket_type===_.MIN_DEDUCTION&&(h=null!=(n=u.minimum_deduction)?n:0,void 0!==u.minimum_deduction_uom&&null!==u.minimum_deduction_uom&&u.minimum_deduction_uom!==t&&($=await M(u.minimum_deduction_uom,t),v=P(u.minimum_deduction_uom,t)));const E=g(e,{bracket_type:u.bracket_type,rate:null!=(r=u.rate)?r:1,rate_type:null!=(i=u.rate_type)?i:p.FRACTIONAL,initial_adjustment:null!=(s=u.initial_adjustment)?s:0,initial_adjustment_conversion_factor:y,comparator:h,comparator_conversion_factor:$});let b="";const C=void 0!==u.initial_adjustment&&null!==u.initial_adjustment;if(u.bracket_type===_.BRACKET)b=`${C?"(":""}${m(e,4)}${null!=t?t:""}${C?` - ${m(u.initial_adjustment,4)}${null!=(l=u.initial_adjustment_uom)?l:`${null!=t?t:""}`}`:""}${C&&1!==y?` * ${m(y,4)}${f}`:""}${C?")":""} * ${m(u.rate,4)}${u.rate_type===p.PERCENTAGE?"/100":`/${m(1,4)}`}`;else if(u.bracket_type===_.MIN_DEDUCTION){b=E===e-h*$?`${m(e,4)}${null!=t?t:""} - ${m(h,4)}${null!=t?t:""}${1!==$?` * ${m($,4)}${v}`:""}`:`${C?"(":""}${m(e,4)}${null!=t?t:""}${C?` - ${m(u.initial_adjustment,4)}${null!=(d=u.initial_adjustment_uom)?d:`${null!=t?t:""}`}`:""}${C&&1!==y?` * ${m(y,4)}${f}`:""}${C?")":""} * ${m(u.rate,4)}${u.rate_type===p.PERCENTAGE?"/100":`/${m(1,4)}`}`}else{if(u.bracket_type!==_.MAX_CAP)throw new Error(`[buildPayableAssayExpression] unknown bracket method: ${u.bracket_type}`);b=E===h*$?`${m(h,4)}${null!=t?t:""}${1!==$?` * ${m($,4)}${v}`:""}`:`${C?"(":""}${m(e,4)}${null!=t?t:""}${C?` - ${m(u.initial_adjustment,4)}${null!=(c=u.initial_adjustment_uom)?c:`${null!=t?t:""}`}`:""}${C&&1!==y?` * ${m(y,4)}${f}`:""}${C?")":""} * ${m(u.rate,4)}${u.rate_type===p.PERCENTAGE?"/100":`/${m(1,4)}`}`}return{payableAssay:E,expression:b}}console.log("[main] formValues=",l);const E="above the lower threshold, plus",b="below the upper threshold, minus";function C(e,t,a){var o,n,r,i;if(console.log("[evaluateTreatmentCharge]"),!a||!a.length)return;const s=w(a,e);if(!s)throw new Error(`Bracket not found for value ${e}, please ensure the brackets for all commodities defined in the contract cover all range of possible values for treatment charge`);let l=0,d=1;if(s.use_btc)d=0,l=0;else if(d=null!=(o=s.rate)?o:1,s.for_every_unit===E)l=null!=(n=s.lower_threshold)?n:0;else{if(s.for_every_unit!==b)throw new Error(`[evaluateTreatmentCharge] unknown for_every_unit: ${s.for_every_unit}`);l=null!=(r=s.upper_threshold)?r:0}const c={bracket_type:_.BRACKET,rate:d,rate_type:p.FRACTIONAL,initial_adjustment:l,final_adjustment:null!=(i=s.base_treatment_charge)?i:0};return console.log(`[evaluateTreatmentCharge] bracketForEvaluation: ${JSON.stringify(c)}`),{finalValue:g(e,c),baseTreatmentCharge:s.base_treatment_charge}}function N(e,t,a,o){var n,r,i;if(console.log("[evaluatePenalty]"),!t||!t.length)return{};const s=w(t,e);if(!s)throw new Error(`[evaluatePenalty] Bracket not found for value ${e}, please ensure the brackets for all commodities defined in the contract cover all range of possible values for penalty`);let l=0,d=1;if(s.no_penalty)d=0,l=0;else if(d=null!=(n=s.rate)?n:1,s.for_every_unit===E)l=null!=(r=s.lower_threshold)?r:0;else{if(s.for_every_unit!==b)throw new Error(`[evaluatePenalty] unknown for_every_unit: ${s.for_every_unit}`);l=null!=(i=s.upper_threshold)?i:0}const c={bracket_type:_.BRACKET,rate:d,rate_type:p.FRACTIONAL,initial_adjustment:l,final_adjustment:0};console.log(`[evaluatePenalty] bracketForEvaluation: ${JSON.stringify(c)}`);const u=g(e,c),f=null!=c.initial_adjustment;let h="";return h=s.rate&&0!==s.rate?`${f?"(":""}${m(e,4)}${f?` - ${m(l,4)})`:""} / ${m(1,4)} * ${null!=a?a:""} ${m(d,4)}/${null!=o?o:""}`:"No penalty",{penalty:u,expression:h,bracket:s}}function A(e){return e.toLowerCase().split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" ")}function D(e){const t=e.getDate(),a=e.getMonth(),o=e.getFullYear();return`${t} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][a]} ${o}`}function I(e,t=!0){const a=e.getMonth()+1,o=e.getDate();return`${e.getFullYear()}${t?"-":" "}${a<10?"0":""}${a}${t?"-":" "}${o<10?"0":""}${o}`}function O(e,t,a=!1){const o=new Date(e.valueOf());let n=t-(a?1:0);for(;n>0;)o.setDate(o.getDate()-1),0!==o.getDay()&&6!==o.getDay()&&(n-=1);return o}function T(e,t){const a=new Date(e.valueOf());return a.setMonth(a.getMonth()+t,1),a}function S(e,t){const a=new Date(e.valueOf());return a.setMonth(a.getMonth()+t+1,0),a}async function k(e,t){if(e===t)return 1;const a=await s.get(`/items/${be}?filter[${Ce}]=${e}`,{params:{fields:[Ie]}});if(0===a.data.data.length||null===a.data.data[0][Ie]||void 0===a.data.data[0][Ie])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for source weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const o=await s.get(`/items/${be}?filter[${Ce}]=${t}`,{params:{fields:[Ie]}});if(0===o.data.data.length||null===o.data.data[0][Ie]||void 0===o.data.data[0][Ie])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for the target weight unit ${t}. Ensure that the symbol is correct and is a weight unit symbol`);const n=parseFloat(a.data.data[0][Ie]);if(isNaN(n))throw new Error(`[getWeightUnitConversionValue] source weight unit ${e} conversion value=${n} is not a number`);const r=parseFloat(o.data.data[0][Ie]);if(isNaN(r))throw new Error(`[getWeightUnitConversionValue] target weight unit ${t} conversion value=${r} is not a number`);return n/r}async function M(e,t){if(null==e||null==t)return 1;if(e===t)return 1;const a=await s.get(`/items/${Oe}?filter[${Te}]=${e}`,{params:{fields:[Se]}});if(0===a.data.data.length||void 0===a.data.data[0][Se]||null===a.data.data[0][Se])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for source weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const o=await s.get(`/items/${Oe}?filter[${Te}]=${t}`,{params:{fields:[Se]}});if(0===o.data.data.length||void 0===o.data.data[0][Se]||null===o.data.data[0][Se])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for the target weight unit ${t}. Ensure that the symbol is correct and is a weight unit symbol`);const n=parseFloat(a.data.data[0][Se]);if(isNaN(n))throw new Error(`[getAssayUnitConversionValue] source weight unit ${e} conversion value=${n} is not a number`);console.log(`[getAssayUnitConversionValue] source unit conversion value=${n}`);const r=parseFloat(o.data.data[0][Se]);if(isNaN(r))throw new Error(`[getAssayUnitConversionValue] target weight unit ${e} conversion value=${r} is not a number`);return console.log(`[getAssayUnitConversionValue] target unit conversion value=${r}`),console.log("[getAssayUnitConversionValue] returning "+n/r),n/r}function P(e,t){if(void 0===e||void 0===t||null===e||null===t)return;const a=e.split("/"),o=t.split("/");if(a.length>2||o.length>2)throw new Error(`[getConversionUnit] sourceUnit=${e} and targetUnit=${t} must be in the format of 'unit1/unit2', an extra '/' was found`);if(1===a.length&&1===o.length)return`${o[0]}/${a[0]}`;if(1===a.length){const e=o[0]===a[0]?"":`${o[1]}(${a[1]})`,t=o[1];return""===t?e:`${e}/${t}`}if(1===o.length){const e=a[1],t=a[0]===o[0]?"":`${a[1]}(${o[0]})`;return""===t?e:`${e}/${t}`}{const e=a[0]===o[0],t=a[1]===o[1],n=e||""===a[0],r=e||""===o[0],i=t||""===a[1],s=t||""===o[1],l=!i&&!r,d=!n&&!s,c=`${i?"":a[1]}${l?"(":""}${r?"":`${o[0]}`}${l?")":""}`,u=`${n?"":a[0]}${d?"(":""}${s?"":`${o[1]}`}${d?")":""}`;return""===u?c:`${c}/${u}`}}async function U(e,t,a){const o=await s.get(`/items/${be}?filter[${Ne}]=${t}`,{params:{fields:[Ce]}});if(!o.data.data||!o.data.data[0]||!o.data.data[0][Ce])throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] Dry weight uom not found for symbol ${t}`);const n=o.data.data[0][Ce];if("%"===a){if(n===e)return{};const t=P(n,e);if(!t)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for dry weight unit ${n} and target weight unit ${e}`);return{finalConversion:{conversionFactor:await k(n,e),conversionUom:t}}}let r=a.split("/");if(1==r.length){const e=await async function(e){const t=await s.get(`/items/${Oe}`,{params:{fields:[Te,ke],filter:{[ke]:{_nnull:!0},[Te]:{_eq:e}}}});if(200!==t.status||!t.data||0===t.data.data.length)throw new Error("[getAssayUnitComposition] no assay units found with composition");return t.data.data[0][ke]}(a);if(!e)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${a} does not have a composition`);r=e.split("/")}if(r.length>2||0===r.length)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${a} is not in the format of 'unit1/unit2'`);const i=r[0],l=r[1],d={};if(l!==n){const e=P(n,l);if(!e)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for dry weight unit ${n} and assay unit denominator unit ${l}`);d.initialConversion={conversionFactor:await k(n,l),conversionUom:e}}if(i!==e){const t=P(i,e);if(!t)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for target weight unit ${e} and assay unit numerator unit ${i}`);d.finalConversion={conversionFactor:await k(i,e),conversionUom:t}}return d}const F="foreign_key",R="lot_number",j="method",V="contract",x="counterparty",B="assay_results",J="weight_result",G="actual_arrival_date",W="bl_date",q="invoice_date",L="estimated_shipment_date",H="vessel",K="origin",Y="destination",Q="shipment_code",X="adjustments",z="parcel_finalisation_date",Z="dry_weight",ee="final_assay",te="assay_uom",ae="contract_currency",oe="invoice_type",ne="pay_percent",re="pa_days",ie="pa_day_type",se="pa_ref_day",le="pa_final_inv_ref_day",de="pp_days",ce="pp_day_type",ue="pp_ref_day",fe="commodity",me="price_per_uom",he="related_commodity_in_contract",_e="lower_threshold",pe="lower_threshold_inclusive",ye="upper_threshold",ve="upper_threshold_inclusive",we="rate",ge="name",$e="code",Ee="code",be="navarch_unit",Ce="symbol",Ne="dry_symbol",Ae="dry_unit",De="wet_unit",Ie="conversionToGram",Oe="navarch_assay_unit",Te="unit",Se="conversion_to_ppb",ke="composition",Me="name",Pe="navarch_address_id",Ue="name",Fe="line_1",Re="line_2",je="city",Ve="state",xe="country",Be="zip",Je="phone_code",Ge="phone_number",We="signatory_name",qe="signatory_title",Le="remittance_details",He="navarch_country",Ke="name",Ye="phone_code",Qe="line_1",Xe="line_2",ze="city",Ze="state",et="country",tt="zip",at="name",ot="navarch_world_port",nt="port_name",rt="country",it="price_pm",st="average_price",lt="date",dt="navarch_invoices",ct="parcel",ut="invoice",ft="document_type",mt="revision_invoice",ht="invoice_type";return{isGeneraingDoc:i,invoiceUrl:l.value,generateInvoice:async function(){var e,t,o,n,c,u,f,_,p,y,v,w,g,E,b,I,k,M,P,Ie,Oe,Te,Se,ke,it,st,lt,$t,Et,bt,Ct,Nt,At,Dt;r.value="";try{i.value=!0,console.log("[generateInvoice] formValues=",l);const It=l.value[ct];if(!It)return r.value="Parcel not selected for invoice document generation",void(i.value=!1);const Ot=l.value[ht],Tt=await s.get(`/items/navarch_parcel/${It}`,{params:{fields:[B,J,V,x,G,W,q,L,H,K,Y,Q,X]}});console.log(`parcelResponce.data.data=${JSON.stringify(Tt.data.data)}`),function(e){if(!e)throw new Error("Parcel data not found, please ensure the selected parcel still exists");if(!e[V])throw new Error("The selected parcel does not have a contract, please ensure that the contract field for the parcel is not empty");if(!e[x])throw new Error("The selected parcel does not have a counterparty, please ensure that the counterparty field for the parcel is not empty");if(!e[B])throw new Error("The selected parcel does not have assay results");if(!e[J])throw new Error("The selected parcel does not have weight results");if(!e[K])throw new Error("The selected parcel does not have an origin port");if(!e[Y])throw new Error("The selected parcel does not have a destination port");if(!e[Q])throw new Error("The selected parcel does not have a shipment code")}(Tt.data.data);const St=Tt.data.data[B],kt=Tt.data.data[J],Mt=Tt.data.data[V],Pt=await s.get(`/items/navarch_contract_payment_information?filter[related_contract]=${Mt}`,{params:{fields:[oe,ne,re,ie,se,le,de,ce,ue]}});if(Pt.data.data&&0===Pt.data.data.length)return r.value="No invoice type found for the contract",void(i.value=!1);const Ut=Pt.data.data.find((e=>e[oe]===Ot));if(!Ut)return r.value=`Cannot find payment information for ${Ot} in the contract, please ensure that data for it has been entered and saved`,void(i.value=!1);const Ft=await s.get(`/items/navarch_weight_lot?filter[${F}]=${kt}&sort[]=${R}`,{params:{fields:["id","dry_weight","wet_weight",j,"moisture","wet_weight_uom","dry_weight_uom"]}});console.log(`weightLotResponse.data.data=${JSON.stringify(Ft.data.data)}`),function(e){if(!e||0===e.length)throw new Error("No weight lots found for the selected parcel")}(Ft.data.data);const Rt=function(e){console.log("[evaluateWeights]");const t={};for(const a of e)t[a.method]||(console.log(`adding method ${a.method} to weightData object`),t[a.method]=[]),console.log(`adding lot ${a.id} to weightData.${a.method} array`),t[a.method.toString()].push(a);const a=[];for(const e of Object.keys(t)){if(!t[e]){console.log(`method=${e} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${e}`);const o=d(t[e]);o&&a.push(o)}return a}(Ft.data.data),jt=l.value.weight_method;let Vt=Rt.find((e=>e.method===jt));if(Vt||(Vt=Rt.find((e=>"Outturn"===e.method))),Vt||(Vt=Rt.find((e=>"Inturn Final"===e.method))),Vt||(Vt=Rt.find((e=>"Inturn"===e.method))),Vt||(Vt=Rt.find((e=>"Estimated"===e.method))),Vt||(Vt=Rt.find((e=>"Planned"===e.method))),!Vt)throw new Error("No weight lot data found for all weight methods. Please ensure weight lot data has been entered in the selected parcel.");if(void 0===Vt.dry_weight||null===Vt.dry_weight||void 0===Vt.wet_weight||null===Vt.wet_weight||void 0===Vt.moisture||null===Vt.moisture||void 0===Vt.dry_weight_uom||null===Vt.dry_weight_uom||void 0===Vt.wet_weight_uom||null===Vt.wet_weight_uom||void 0===Vt.method||null===Vt.method)throw new Error("One of the fields for weight lots is undefined");const xt=await s.get(`/items/${be}?filter[${Ne}]=${Vt.dry_weight_uom}`,{params:{fields:[Ae]}}),Bt=await s.get(`/items/${be}?filter[wet_symbol]=${Vt.wet_weight_uom}`,{params:{fields:[De]}});if(!xt.data.data||!xt.data.data[0]||!xt.data.data[0][Ae])throw new Error(`Dry weight uom not found for symbol ${Vt.dry_weight_uom}`);if(!Bt.data.data||!Bt.data.data[0]||!Bt.data.data[0][De])throw new Error(`Wet weight uom not found for symbol ${Vt.wet_weight_uom}`);const Jt=xt.data.data[0][Ae],Gt=0===Jt.indexOf("dry")?Jt:`dry ${Jt}`,Wt=Bt.data.data[0][De],qt=0===Wt.indexOf("wet")?Wt:`wet ${Wt}`,Lt=await s.get(`/items/navarch_assay_lot?filter[${F}]=${St}&sort[]=${R}`,{params:{fields:["id","commodity",j,Z,ee,"lot_number",te]}});console.log(`assayLotResponse.data.data=${JSON.stringify(Lt.data.data)}`),function(e){if(!e||0===e.length)throw new Error("No assay lots found for the selected parcel")}(Lt.data.data);const Ht=function(e){var t;console.log("[evaluateAnalyticalAssay]");const a={};for(const t of e)a[t.method]||(a[t.method]={}),a[t.method][t.commodity]||(a[t.method][t.commodity]=[]),null!==t.lot_number?(1===a[t.method][t.commodity].length&&null===a[t.method][t.commodity][0].lot_number&&(a[t.method][t.commodity]=[]),a[t.method][t.commodity].push(t)):null===t.lot_number&&0===a[t.method][t.commodity].length&&a[t.method][t.commodity].push(t);console.log(`[evaluateAnalyticalAssay] group: ${JSON.stringify(a)}}`);const o={};for(const e in a){console.log(`[evaluateAnalyticalAssay] methodKey: ${e}, group[methodKey]: ${JSON.stringify(a[e])}`);for(const n in a[e]){console.log(`[evaluateAnalyticalAssay] commodityKey: ${n}, group[methodKey][commodityKey]: ${JSON.stringify(a[e][n])}`),o[e]=null!=(t=o[e])?t:{},o[e][n]={};const r=a[e][n].reduce(((e,t)=>e+t[Z]),0);console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${r} from ${JSON.stringify(a[e][n])}`),o[e][n].analytical_assay=a[e][n].reduce(((e,t)=>e+t[ee]*t[Z]),0)/(0!==r?r:1),console.log(`[evaluateAnalyticalAssay] analytical assay: ${o[e][n].analytical_assay}`),a[e][n].length>0&&(o[e][n][te]=a[e][n][0][te])}}return console.log(`[evaluateAnalyticalAssay] analyticalAssay: ${JSON.stringify(o)}`),o}(Lt.data.data),Kt=l.value.assay_method;let Yt;if(Kt&&(Yt=Ht[Kt.toString()]),Yt||(Yt=Ht.Outturn),Yt||(Yt=Ht["Inturn Final"]),Yt||(Yt=Ht.Inturn),Yt||(Yt=Ht.Estimated),Yt||(Yt=Ht.Planned),!Yt)throw new Error("No assay lot data found for all assay methods. Please ensure assay lot data has been entered in the selected parcel.");console.log(`WEIGHT: ${JSON.stringify(Vt)}`),console.log(`ASSAYS: ${JSON.stringify(Yt)}`);const Qt=await s.get(`/items/navarch_contract/${Mt}`,{params:{fields:[ae]}});!function(e){if(!e)throw new Error("Contract data not found, please ensure the selected contract still exists");if(!e[ae])throw new Error("The selected contract does not have a set currency, please ensure that the currency field for the contract is not empty")}(Qt.data.data);const Xt=await s.get(`/items/navarch_currency/${Qt.data.data.contract_currency}`,{params:{fields:[Ee]}});!function(e){if(!e)throw new Error("Currency data not found, please ensure the selected currency still exists");if(!e[Ee])throw new Error("The selected currency in the contract is not valid")}(Xt.data.data);const zt=Xt.data.data.code,Zt=await s.get(`/items/navarch_commodity_in_contract?filter[contract]=${Mt}`,{params:{fields:["id",fe,"primary_commodity","price_method","quotational_periods","payable_assay_rates","treatment_charge_rates","penalty_rates","penalty_per_uom",me,"treatment_charge_per_uom"]}});!function(e){if(!e||0===e.length)throw new Error("No commodity data found in selected contract for parcel");if(!e.every((e=>e[fe])))throw new Error("The selected contract has an undefined commodity, please ensure that the 'Commodity' field for all commodites in the contract is not empty");if(!e.every((e=>e[me])))throw new Error("The selected contract has an undefined base price Uom for commodity, please ensure that the 'Base Price Uom' field for all commodites in the contract is not empty")}(Zt.data.data),console.log(`\tcommodityInContractResponse: ${JSON.stringify(Zt.data.data)}`);const ea=[],ta=[];let aa="";for(const{id:a,commodity:r,primary_commodity:i,price_method:l,quotational_periods:d,price_per_uom:h,penalty_per_uom:A,treatment_charge_per_uom:F}of Zt.data.data){const R=await s.get(`/items/navarch_commodity/${r}`,{params:{fields:[ge,$e]}});if(yt(R.data.data,r),!Yt[R.data.data.code]){console.log(`[generateInvoice] no analytical assay for commodity ${R.data.data.code} found, skipping...`);continue}if(i&&(aa=R.data.data[ge]),null!==d){const r=d;console.log(`\tquotationalPeriods: ${JSON.stringify(r)}`);const i=Array.isArray(r)?r.find((e=>e.default)):null;if(!i)throw new Error(`No default quotational period found for commodity ${R.data.data.code}`);const N=r.filter((e=>!e.default)).map((e=>`${e.qp_period} ${e.qp_code}`)),A=[`${i.qp_period} ${i.qp_code}`,...N].join(", ");console.log(`[generateInvoice] evaluate payable assay for ${R.data.data.code} with an analytical assay=${null==(e=Yt[R.data.data.code])?void 0:e.analytical_assay}`);const j=await s.get(`/items/navarch_payable_assay_bracket?filter[${he}]=${a}`,{params:{fields:["bracket_type",_e,pe,ye,ve,we,"rate_type","initial_adjustment","initial_adjustment_uom","minimum_deduction","minimum_deduction_uom","maximum_cap","maximum_cap_uom"]}}),{payableAssay:V,expression:x}=await $(null==(t=Yt[R.data.data.code])?void 0:t.analytical_assay,null==(o=Yt[R.data.data.code])?void 0:o.assay_uom,j.data.data);let B,J,H="";if("Final"!==Ot){const e={invoice_type:Ot,days:Ut[de],day_type:Ut[ce],ref_day:Ut[ue]};if(!e)throw new Error(`[generateInvoice] No provisional pricing found for invoice type ${Ot}`);let t;switch(e.ref_day){case"Arrival Date":t=G,H="Actual Arrival Date";break;case"B/L Date":t=W,H="B/L Date";break;case"Invoice Date":t=q,H="Invoice Date";break;case"Estimated Shipment Date":t=L,H="Estimated Shipment Date";break;default:throw new Error(`Invalid reference day for invoice pricing: ${e.ref_day}; please contact Navarch for support`)}if(null==Tt.data.data[t]||null==Tt.data.data[t])throw new Error(`Reference day for invoice pricing ${H} is empty`);J=new Date(Tt.data.data[t]);const a=parseInt(e.days),o=e.day_type;switch(o){case"Business Day(s)":B=O(J,a,!0);break;case"Calendar Day(s)":B=new Date(J.valueOf()),B.setDate(B.getDate()-a);break;default:throw new Error(`[generateInvoice] Invalid day_type ${o}`)}}else{let e;switch(i.qp_code){case"MAMA":e=G,H="Actual Arrival Date";break;case"MOSS":e=L,H="Estimated Shipment Date";break;case"MOS":case"MOAS":e=W,H="B/L Date";break;default:throw new Error(`[generateInvoice] Unsupported QP code ${i.qp_code}, currently only supports MAMA, MOS, MOSS, and MOAS`)}const t=new Date(Tt.data.data[e]);if(null==t)throw new Error(`[generateInvoice] Invalid reference day for ${H} from ${i.qp_code}`);if(B=T(t,i.qp_period),B.valueOf()>Date.now())throw new Error(`[generateInvoice] Start date for provisional pricing ${B} (${H}) based on default QP has not occurred yet`);if(J=S(t,i.qp_period),J.valueOf()>Date.now())throw new Error(`[generateInvoice] End date for provisional pricing ${J} (${H}) based on default QP has not occurred yet`)}console.log(`[generateInvoice] provisional pricing date range: ${B.toString()} - ${J.toString()}`);const K=await pt(R.data.data.code,l,B,J);let Y;const Q=await s.get(`/items/navarch_treatment_charge_bracket?filter[${he}]=${a}`,{params:{fields:[_e,pe,ye,ve,"base_treatment_charge","use_btc","for_every_unit",we]}});void 0!==Q.data.data&&null!==Q.data.data&&Q.data.data.length>0&&(Y=await C(K,null==(n=Yt[R.data.data.code])||n.assay_uom,Q.data.data));const X=await s.get(`/items/${be}/${h}`,{params:{fields:[Ce]}});vt(X.data.data,R.data.data[ge]);const z=X.data.data[Ce];let Z;if(Y){if(!F)throw new Error(`Treatment Charge Rate UOM is not defined for commodity ${R.data.data[ge]}`);const e=await s.get(`/items/${be}/${F}`,{params:{fields:[Ce]}});wt(e.data.data,R.data.data[ge]),Z=e.data.data[Ce]}const ee=await U(z,Vt.dry_weight_uom,null==(c=Yt[R.data.data.code])?void 0:c.assay_uom);console.log(`[generateInvoice] payableMetalConversion for commodity ${R.data.data.name}: ${JSON.stringify(ee)}`),ee.initialConversion=1===(null==(u=ee.initialConversion)?void 0:u.conversionFactor)?void 0:ee.initialConversion,ee.finalConversion=1===(null==(f=ee.finalConversion)?void 0:f.conversionFactor)?void 0:ee.finalConversion,ea.push({commodity:R.data.data.name,analytical_assay:m(null==(_=Yt[R.data.data.code])?void 0:_.analytical_assay,4),deduction_expression:x,payable_assay:m(V,4),assay_uom:null==(p=Yt[R.data.data.code])?void 0:p.assay_uom,payable_metal:m(Vt.dry_weight*(null!=(v=null==(y=ee.initialConversion)?void 0:y.conversionFactor)?v:1)*(null!=V?V:1)*(null!=(g=null==(w=ee.finalConversion)?void 0:w.conversionFactor)?g:1)*("%"!==(null==(E=Yt[R.data.data.code])?void 0:E.assay_uom)?1:.01),4),payable_metal_expression:`${m(Vt.dry_weight,4)}${Vt.dry_weight_uom}${ee.initialConversion?` * ${m(ee.initialConversion.conversionFactor,4)}${ee.initialConversion.conversionUom}`:""} * ${m(null!=V?V:1,4)}${"%"!==(null==(b=Yt[R.data.data.code])?void 0:b.assay_uom)?`${null==(I=Yt[R.data.data.code])?void 0:I.assay_uom}`:" / 100"}${ee.finalConversion?` * ${m(ee.finalConversion.conversionFactor,4)}${ee.finalConversion.conversionUom}`:""}`,payable_metal_uom:z,qp:A,qp_date_range:`${D(B)} - ${D(J)}`,price_method:l,price_rate:m(K,4),price_per_uom:z,price:m(Vt.dry_weight*(null!=(M=null==(k=ee.initialConversion)?void 0:k.conversionFactor)?M:1)*(null!=V?V:1)*(null!=(Ie=null==(P=ee.finalConversion)?void 0:P.conversionFactor)?Ie:1)*("%"!==(null==(Oe=Yt[R.data.data.code])?void 0:Oe.assay_uom)?1:.01)*K),treatment_charge:Y?{rate:m(Y.baseTreatmentCharge,4),discount:m((null!=(Te=Y.baseTreatmentCharge)?Te:0)-(null!=(Se=Y.finalValue)?Se:0),4),final_rate:m(Y.finalValue,4),per_uom:Z,final_amount:m(Vt.dry_weight*(null!=(ke=Y.finalValue)?ke:1))}:void 0,final_total:m(Vt.dry_weight*(null!=(st=null==(it=ee.initialConversion)?void 0:it.conversionFactor)?st:1)*(null!=V?V:1)*(null!=($t=null==(lt=ee.finalConversion)?void 0:lt.conversionFactor)?$t:1)*("%"!==(null==(Et=Yt[R.data.data.code])?void 0:Et.assay_uom)?1:.01)*K-(Y?1:0)*(Vt.dry_weight*(null!=(bt=null==Y?void 0:Y.finalValue)?bt:1)))})}const j=await s.get(`/items/navarch_penalty_bracket?filter[${he}]=${a}`,{params:{fields:[_e,pe,ye,ve,"no_penalty","for_every_unit",we]}});if(j.data.data.length>0){if(null===A)throw new Error(`[generateInvoice] penalty_per_uom is null for ${R.data.data.code}`);const e=await s.get(`/items/${be}/${A}`,{params:{fields:[Ce]}});gt(e.data.data,R.data.data[ge]);const t=e.data.data[Ce],{penalty:a,expression:o,bracket:n}=await N(null==(Ct=Yt[R.data.data.code])?void 0:Ct.analytical_assay,j.data.data,zt,t);console.log(`[generateInvoice] evaluate penalty for ${R.data.data.code} with an analytical assay=${null==(Nt=Yt[R.data.data.code])?void 0:Nt.analytical_assay}, penaltyRate=${null==n?void 0:n.rate}, finalPenaltyRate=${a}, expression='${o}'`),ta.push({commodity:R.data.data.name,analytical_assay:m(null==(At=Yt[R.data.data.code])?void 0:At.analytical_assay,4),deduction_expression:o,assay_uom:null==(Dt=Yt[R.data.data.code])?void 0:Dt.assay_uom,penalty_rate:m(null==n?void 0:n.rate,4),penalty_per_uom:t,final_penalty_rate:m(a,4),final_penalty:m((null!=a?a:1)*Vt.dry_weight)})}}console.log(`[generateInvoice] COMMODITIES: ${JSON.stringify(ea)}`),console.log(`[generateInvoice] PENALTIES: ${JSON.stringify(ta)}`);const oa=ea.reduce(((e,t)=>e+h(t.price)),0),na=ea.reduce(((e,t)=>{var a;return e+h(null==(a=t.treatment_charge)?void 0:a.final_amount)}),0),ra=ta.reduce(((e,t)=>e+h(t.final_penalty)),0);console.log(`[generateInvoice] TOTAL_REVENUE=${oa}, TOTAL_TREATMENT_CHARGE=${na}, TOTAL_PENALTIES=${ra}`);let ia,sa=0;const la=!!Tt.data.data[X];la&&(sa=Tt.data.data[X].reduce(((e,t)=>e+t.amount),0),ia={adjustments:Tt.data.data[X].map((e=>({description:e.description,amount:m(e.amount)}))),total_adjustments:m(sa)});const da=Ut[ne],ca=oa-na-ra+sa,ua=null!=da?ca*da/100:void 0,fa=await s.get(`/items/navarch_counterparty/${Tt.data.data[x]}`,{params:{fields:[Me]}});!function(e){if(console.log("[validateCounterparty]"),!e)throw new Error("Counterparty for parcel not found");if(!e[Me])throw new Error("No name defined for counterparty of the selected parcel")}(fa.data.data);const ma=await s.get(`/items/navarch_counterparty_navarch_address?filter[navarch_counterparty_id]=${Tt.data.data[x]}`,{params:{fields:[Pe]}});!function(e){if(console.log("[validateCounterpartyAddress]"),!e||0===e.length)throw new Error("Counterparty address for parcel not found");if(!e[0][Pe])throw new Error("No address defined for counterparty of the selected parcel")}(ma.data.data);const ha=Tt.data.data[H];let _a;ha&&(_a=await s.get(`/items/navarch_vessel/${ha}`,{params:{fields:[at]}}),function(e){if(console.log("[validateVessel]"),!e)throw new Error("Vessel for parcel not found");if(!e[at])throw new Error("No name defined for vessel of the selected parcel")}(_a.data.data));const pa=(await s.get("/items/navarch_company",{params:{fields:[Ue,Fe,Re,je,Ve,Be,xe,Je,Ge,We,qe,Le]}})).data.data;!function(e){if(console.log("[validateCompanyData]"),!e)throw new Error("Company data not found");if(!e[Ue])throw new Error("Please set company name in Directories > Company");if(!e[Je])throw new Error("Please set company phone code in Directories > Company");if(!e[Fe])throw new Error("Please set company address line 1 in Directories > Company");if(!e[xe])throw new Error("Please set the country the company is based in Directories > Company");if(!e[Ge])throw new Error("Please set the company phone number in Directories > Company");if(!e[We])throw new Error("Please set the company signatory name in Directories > Company");if(!e[qe])throw new Error("Please set the company signatory title in Directories > Company");if(!e[Le])throw new Error("Please set the company remittance details in Directories > Company")}(pa);const ya=pa[Ue],va=await s.get(`/items/${He}/${pa[Je]}`,{params:{fields:[Ye]}});!function(e){if(!e)throw new Error("Company phone code not found, please ensure phone code selected for Directories > Company is valid");if(!e[Ye])throw new Error("Company country phone code not found, please contact Navarch support for assistance")}(va.data.data);const wa=va.data.data[Ye],ga=pa[Ge],$a=pa[Fe],Ea=pa[Re]?`,\n${pa[Re]}`:"",ba=pa[je]?`,\n${pa[je]}`:"",Ca=pa[Ve]?`,\n${pa[Ve]}`:"",Na=await s.get(`/items/${He}/${pa[xe]}`,{params:{fields:[Ke]}});!function(e){if(!e)throw new Error("Country not found, please ensure country selected for Directories > Company is valid");if(!e[Ke])throw new Error("Country name not found, please contact Navarch support for assistance")}(Na.data.data);const Aa=Na.data.data[Ke]?`, ${Na.data.data[Ke]}`:"",Da=`${$a}${Ea}${ba}${pa[Be]?` ${pa[Be]}`:""}${Ca}${Aa}`,Ia=ma.data.data[0][Pe],Oa=await s.get(`/items/navarch_address/${Ia}`,{params:{fields:[Qe,Xe,ze,Ze,et,tt]}});!function(e){if(!e)throw new Error("Buyer address for parcel not found");if(!e[Qe])throw new Error("No address line 1 defined for buyer address of the selected parcel");if(!e[et])throw new Error("No country defined for buyer address of the selected parcel")}(Oa.data.data);const Ta=Oa.data.data[Qe],Sa=Oa.data.data[Xe]?`,\n${Oa.data.data[Xe]}`:"",ka=Oa.data.data[ze]?`,\n${Oa.data.data[ze]}`:"",Ma=Oa.data.data[Ze]?`,\n${Oa.data.data[Ze]}`:"",Pa=await s.get(`/items/${He}/${Oa.data.data[et]}`,{params:{fields:[Ke]}});!function(e){if(!e)throw new Error("Something went wrong when getting the buyer's based country")}(Pa.data.data);const Ua=Pa.data.data[Ke]?`, ${Pa.data.data[Ke]}`:"",Fa=`${Ta}${Sa}${ka}${Oa.data.data[tt]?` ${Oa.data.data[tt]}`:""}${Ma}${Ua}`,Ra=await s.get(`/items/${ot}/${Tt.data.data[K]}`,{params:{fields:[nt,rt]}});!function(e){if(!e)throw new Error("Origin port for parcel not found");if(!e[nt])throw new Error("No name defined for origin port of the selected parcel");if(!e[rt])throw new Error("No country defined for origin port of the selected parcel")}(Ra.data.data);const ja=await s.get(`/items/${ot}/${Tt.data.data[Y]}`,{params:{fields:[nt,rt]}});!function(e){if(!e)throw new Error("Destination port for parcel not found");if(!e[nt])throw new Error("No name defined for destination port of the selected parcel");if(!e[rt])throw new Error("No country defined for destination port of the selected parcel")}(ja.data.data);let Va=(await s.get(`/items/${dt}?filter[${ct}]=${It}`,{params:{fields:["id",ut]}})).data.data.reduce(((e,t)=>e+(t[ut]?1:0)),0)+1,xa=It;const Ba=Va.toString().padStart(2,"0"),Ja=`${Tt.data.data[Q]} (#${Ba})`,Ga=xa.toString().padStart(2,"0"),Wa={invoice_type:Ot,days:Ut[re],day_type:Ut[ie],ref_day:"Final"===Ot?Ut[le]:Ut[se]};if(!Wa)throw new Error(`Contract does not have a payment advice for invoice type ${Ot}`);let qa,La="";switch(Wa.ref_day){case"Arrival Date":qa=G,La="Actual Arrival Date";break;case"B/L Date":qa=W,La="B/L Date";break;case"Invoice Date":qa=q,La="Invoice Date";break;case"Estimated Shipment Date":qa=L,La="Estimated Shipment Date";break;case"Parcel Finalisation":if(void 0===Tt.data.data[z]||null===Tt.data.data[z])throw new Error("[generateInvoice] Parcel has not been finalised, please fill in the the parcel finalisation date in the parcel form.");qa=z,La="Parcel Finalisation Date";break;default:throw new Error(`Invalid reference day for payment advice: ${Wa.ref_day}; please contact Navarch for support`)}if(void 0===Tt.data.data[qa]||null===Tt.data.data[qa])throw new Error(`Reference day for payment advice ${La} is empty in parcel`);const Ha=new Date,Ka=parseInt(Wa.days),Ya=Wa.day_type;let Qa;switch(Ya){case"Business Day(s)":Qa=function(e,t,a=!1){const o=new Date(e.valueOf());let n=t-(a?1:0);for(;n>0;)o.setDate(o.getDate()+1),0!==o.getDay()&&6!==o.getDay()&&(n-=1);return o}(Ha,Ka,!0);break;case"Calendar Day(s)":Qa=new Date(Ha.valueOf()),Qa.setDate(Qa.getDate()+Ka);break;default:throw new Error(`[generateInvoice] Invalid day_type for payment advice ${Ya}`)}console.log(`[generateInvoice] payment advice due date: ${Qa.toString()}`);const Xa=D(Qa);let za,Za,eo,to;if(l.value[mt]){const e=await s.get(`/items/${dt}/${l.value[mt]}`,{params:{fields:[ct,ut,ht,ft]}});if(console.log(`[generateInvoice] revisionParcelResponse: ${JSON.stringify(e.data)}`),200!==e.status||!e.data.data)throw new Error(`[generateInvoice] Failed to get invoice ${l.value[mt]}`);if(e.data.data[ct]!==It)throw new Error(`[generateInvoice] Parcel ID mismatch between this invoice with parcel ${It}, and the revision invoice ${l.value[mt]} with parcel id ${e.data.data[ct]}`);if(!e.data.data[ut])throw new Error(`[generateInvoice] No invoice pdf has been generated yet for invoice ${l.value[mt]}`);if(!e.data.data[ht])throw new Error(`[generateInvoice] No invoice type found for the revision invoice ${l.value[mt]}`);eo=e.data.data[ht],to=e.data.data[ft];const t=e.data.data[ut];if(function(e){if(!e)throw new Error("Revision invoice data not found");if(!e.invoice_number)throw new Error("Revision invoice data does not have an invoice number in generated document");if(!e.balance_in_sellers_favor)throw new Error("Revision invoice data does not have a valid 'Balance in Sellers Favor' in generated document")}(t),console.log(`[generateInvoice] revisionInvoiceData: ${JSON.stringify(t)}`),za=t.invoice_number,!za||""===za)throw new Error(`[generateInvoice] Could not find invoice number in revision invoice ${l.value[mt]}`);const a=t.balance_in_sellers_favor.replace(/,/g,"");if(Za=parseFloat(a),!Za||isNaN(Za))throw new Error(`[generateInvoice] Total payment=${t.balance_in_sellers_favor} found is not convertible to monetary amount for revision invoice ${l.value[mt]}`)}const ao=null!=ua?ua-(null!=Za?Za:0):void 0,oo={seller:ya,seller_address:Da,seller_phone_number:`+${wa} ${ga}`,signatory:{signatoryName:pa[We],signatoryTitle:pa[qe],company:ya},remittance:pa[Le],buyer:fa.data.data[Me],buyer_address:Fa,shipment_code:Tt.data.data[Q],vessel:_a?_a.data.data[at]:"N/A",bl_date:Tt.data.data[W]?D(new Date(Tt.data.data[W])):"N/A",invoice_type:Ot,invoice_date:Tt.data.data[q]?D(new Date(Tt.data.data[q])):"N/A",revision:za&&Za?to:void 0,invoice_number:Ja,parcel:`${Tt.data.data[Q]} (#${Ga})`,port_of_loading:`${Ra.data.data[nt]}, ${Ra.data.data[rt]}`,port_of_discharge:`${ja.data.data[nt]}, ${ja.data.data[rt]}`,primary_commodity:`${aa} Concentrates`,due_date:Xa,wet_weight:m(Vt.wet_weight,4),wet_weight_uom:Vt.wet_weight_uom,wet_weight_uom_name:A(qt),moisture:m(Vt.moisture,4),moisture_uom:"%",dry_weight:m(Vt.dry_weight,4),dry_weight_uom:Vt.dry_weight_uom,dry_weight_uom_name:A(Gt),total_revenue:m(oa),total_deductions:m(ra+na),currency:zt,commodities:ea,penalties:{penalties:ta,total_penalties:m(ra)},adjustments:la?ia:void 0,invoice_value:m(ca),payable_percentage:m(da),payable_amount:m(ua),payment_received_source:za&&Za&&to?`${eo}.${to}.${za}`:void 0,payment_received:za&&Za?m(Za):void 0,balance_in_sellers_favor:m(ao)};console.log(`[generateInvoice] invoice request body: ${JSON.stringify(oo)}`);const no=await s.post("/generate/invoice",oo);if(200!==no.status)return console.log(`[generateInvoice] invoice response status: ${no.status}`),r.value=no.data,void(i.value=!1);const ro={...oo,doc_name:no.data};a("input",ro),console.log(`[generateInvoice] invoice response: ${JSON.stringify(l.value)}`),i.value=!1,_t(no.data)}catch(e){return i.value=!1,console.log(`generating invoice went wrong due to: ${e}`),void(r.value=e)}},viewInvoice:_t,failureReason:r};function _t(e){const a=null!=e?e:t.value.doc_name;console.log(`[viewInvoice] doc name: ${a}`);const o=`/display-doc?filepath=${encodeURIComponent(`/data/uploads/${a}.pdf`)}`;window.open(o)}async function pt(e,t,a,o,n=1){if(f(e))throw new Error("Commodity is not defined for price calcualtion");if(f(t))throw new Error(`Price method for commodity ${e} is not defined for price calcualtion`);if(f(a))throw new Error(`Start date is not defined for price calcualtion with ${t} has not been properly defined, please ensure that contract QP is properly defined`);if(f(o))throw new Error(`End date is not defined for price calcualtion with ${t} has not been properly defined, please ensure that contract QP is properly defined`);const r=await s.get(`/items/navarch_commodity_price?filter[_and][0][price_method][_eq]=${t}&filter[_and][0][currency][_eq]=${n}&filter[_and][1][date][_between][0]=${I(a)}&filter[_and][1][date][_between][1]=${I(o)}`,{params:{fields:[it,st,lt,"price_method"]}});if(!r||!r.data||!r.data.data)throw new Error(`[getCommodityAvgPrice] Failed to get commodity prices for commodity ${e} between ${I(a)} and ${I(o)}`);if(0===r.data.data.length)throw new Error(`No commodity prices found for commodity ${e} between ${I(a)} and ${I(o)}`);return r.data.data.reduce(((e,a)=>{if(!a[st]&&!a[it])throw new Error(`Commodity for ${t} on the date of ${a[lt]} does not have a price, please contact Navarch for assistance`);let o=Number(a[st]);if(isNaN(o)&&(o=Number(a[it])),isNaN(o))throw new Error(`The commodity price for Price Method #${t} for the date of ${a[lt]} is not a valid number, please contact Navarch for assistance`);return e+o}),0)/r.data.data.length}function yt(e,t){var a,o;if(console.log("[validateCommodityData]"),!e)throw new Error("commodity data response is null");if(!e[ge])throw new Error(`Commodity name for commodity ${null!=(a=e[$e])?a:t} is undefined, please contact Navarch for assistance`);if(!e[$e])throw new Error(`Commodity code for commodity ${null!=(o=e[ge])?o:t} is not defined, please contact Navarch for assistance`)}function vt(e,t){if(!e)throw new Error(`Price per UOM for commodity ${t} is not a valid`);if(!e[Ce])throw new Error(`Price per UOM for commodity ${t} does not have a valid unit symbol, please contact Navarch for assistance`)}function wt(e,t){if(!e)throw new Error(`Treatment charge per UOM for commodity ${t} is not a valid`);if(!e[Ce])throw new Error(`Treatment charge per UOM for commodity ${t} does not have a valid unit symbol, please contact Navarch for assistance`)}function gt(e,t){if(!e)throw new Error(`Penalty per UOM for commodity ${t} is not a valid`);if(!e[Ce])throw new Error(`Penalty per UOM for commodity ${t} does not have a valid unit symbol, please contact Navarch for assistance`)}}});const g={key:0},$={key:1};w.render=function(e,t,a,o,n,_){const p=r("v-button"),y=r("v-notice");return i(),s(l,null,[d(' <input :value="value" @input="handleChange($event.target.value)" /> '),d(" create a button only interface for Directus"),e.value?(i(),s("div",$,[c(p,{class:"margin-top-16px",onClick:t[1]||(t[1]=()=>e.viewInvoice())},{default:u((()=>[f("View Invoice ")])),_:1})])):(i(),s("div",g,[c(p,{class:"margin-top-16px",onClick:t[0]||(t[0]=()=>e.generateInvoice()),loading:e.isGeneraingDoc},{default:u((()=>[f("Generate Invoice")])),_:1},8,["loading"]),e.failureReason?(i(),m(y,{key:0},{default:u((()=>[f(h(e.failureReason),1)])),_:1})):d("v-if",!0)]))],2112)},w.__file="src/interface.vue";var E=t({id:"invoice_generator_button",name:"Generate Invoice Button",icon:"receipt_long",description:"This is a custom interface for Navarch's Invoice Generator Button.",component:w,options:null,types:["json"],group:"standard"});export{E as default};
