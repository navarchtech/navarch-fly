import{useApi as e,defineInterface as a}from"@directus/extensions-sdk";import{defineComponent as t,ref as n,inject as o,resolveComponent as i,openBlock as r,createElementBlock as s,Fragment as l,createCommentVNode as c,createVNode as d,withCtx as u,createTextVNode as v,createBlock as p,toDisplayString as f}from"vue";var m=(e=>(e[e.Advance=0]="Advance",e[e["Second Advance"]=1]="Second Advance",e[e["Third Advance"]=2]="Third Advance",e[e["Fourth Advance"]=3]="Fourth Advance",e[e.Provisional=4]="Provisional",e[e["Second Provisional"]=5]="Second Provisional",e[e["Third Provisional"]=6]="Third Provisional",e[e["Fourth Provisional"]=7]="Fourth Provisional",e[e.Final=8]="Final",e))(m||{}),g=t({props:{value:{type:Object,default:null}},emits:["input"],setup(a,{emit:t}){const i=n(""),r=n(!1),s=n(""),l=n(""),c=e(),d=o("values",n({})),u="id",v="navarch_invoices",p="id",f="parcel",g="invoice_type",y="invoice",h="navarch_parcel",_="invoice_date",$="contract",w="mine",D="name",b="code",P="codename",F="navarch_unit",E="symbol",C="conversionToGram";return{isGeneraingDoc:r,failureReason:i,generatePdf:async function(){var e;i.value="",r.value=!0;try{const a=d.value.start_date,n=d.value.end_date,o=d.value.filter_date,$=d.value.invoice_type;if(!a)return i.value="Start date not selected",void(r.value=!1);if(!n)return i.value="End date not selected",void(r.value=!1);if(!o)return i.value="Filter date not selected",void(r.value=!1);if(!$)return i.value="Invoice type not selected",void(r.value=!1);let w="";switch(o){case"Arrival Date":w="actual_arrival_date";break;case"Shipment Date":w="actual_shipment_date";break;case"Invoice Date":w=_;break;case"B/L Date":w="bl_date";break;case"Parcel Finalisation Date":w="parcel_finalisation_date";break;default:return i.value="Invalid filter date",void(r.value=!1)}const F=await c.get(`/items/${h}?filter[_and][0][_and][0][${w}][_between][0]=${a}&filter[_and][0][_and][0][${w}][_between][1]=${n}&filter[_and][0][_and][1][${_}][_nnull]=true&sort=${"First Issued Invoice"===$?"":"-"}${_}`,{params:{fields:[u,_]}});if(200!==F.status)return console.error(`[generateLoadportDisportComparisonDoc] parcelResponce status: ${F.status}`),i.value="Failed to fetch parcels",void(r.value=!1);if(0===F.data.data.length)return i.value=`No parcels found within the selected date range of ${a} to ${n} with a non-null Invoice Date`,void(r.value=!1);const E=F.data.data[0][u],C=(await c.get(`/items/${v}?filter[${f}]=${E}&filter[_and][0][${y}][_nnull]=true`,{params:{fields:[p,g,y]}})).data.data.map((e=>e[g]));let S=null;if("First Issued Invoice"===$)S=C.reduce(((e,a)=>(console.debug(`[generateLoadportDisportComparisonDoc] prev=${e}, curr=${m[a]}`),m[a]<e?m[a]:e)),0);else{if("Latest Issued Invoice"!==$)return i.value="Invalid invoice type",void(r.value=!1);S=C.reduce(((e,a)=>(console.debug(`[generateLoadportDisportComparisonDoc] prev=${e}, curr=${m[a]}`),m[a]>e?m[a]:e)),0)}if(null===S)return i.value=`No invoices found for parcel with id ${E} with an issued invoice type of ${$}`,void(r.value=!1);const T=F.data.data.map((e=>e[u])),U=`/items/${v}?filter[_and][0][${f}][_in]=${T.join(",")}&filter[_and][1][${g}]=${m[S]}&filter[_and][1][${y}][_nnull]=true&sort=-date_updated`.replace(/ /g,"%20"),L=await c.get(U,{params:{fields:[p,f,g,y]}});if(console.log(`[generatePenaltyElementsDoc] invoice ids fetched=${L.data.data.map((e=>e[p])).join(", ")}`),200!==L.status)return console.error(`[generateLoadportDisportComparisonDoc] invoicesResponse status: ${L.status}`),i.value="Failed to fetch invoices",void(r.value=!1);if(0===L.data.data.length)return i.value=`No invoices found for parcels with invoice type ${m[S]}`,void(r.value=!1);const V=L.data.data.filter(((e,a,t)=>{const n=`${e[f]}_${e[g]}`;return a===t.findIndex((e=>`${e[f]}_${e[g]}`===n))})),W=V.reduce(((e,a)=>{const t=a[y];""===s.value&&(s.value=t.dry_weight_uom);const n=t.penalties;if(!n||!n.penalties||0===n.penalties.length)return e;""===l.value&&(console.debug(`[generatePenaltyElementsDoc] penalties=${JSON.stringify(n)}`),l.value=`${t.currency}/${n.penalties[0].penalty_per_uom}`);const o=n.penalties.map((e=>e.commodity));return[...e,...o]}),[]).filter(((e,a,t)=>t.indexOf(e)===a));console.log(`[generatePenaltyElementsDoc] penalty commodities=${W.join(", ")}`);const j=W.map(((e,a)=>`filter[_or][${a}][${D}]=${e}`)).join("&").replace(/ /g,"%20"),x=await c.get(`/items/navarch_commodity?${j}`,{params:{fields:[D,b,"id"]}});console.log(`commodity mapping response: ${JSON.stringify(x.data.data)}`);const G=x.data.data.reduce(((e,a)=>(e[a[D]]={code:a[b],id:a.id},e)),{}),R=[];for(const e of V){const a=e[y].penalties;if(!a||!a.penalties)continue;const t=a.penalties,n=(await c.get(`/items/navarch_counterparty?filter[name]=${e[y].buyer}`,{params:{fields:[P]}})).data.data[0][P],o=e[y].dry_weight.replace(/,/g,""),i=await A(e[y].dry_weight_uom,s.value);console.log(`[generatePenaltyElementsDoc] dry weight conversion factor=${i}`),R.push({id:e[f],name:e[y].shipment_code,vessel:e[y].vessel,invoice_type:e.invoice_type,dry_weight:parseFloat(o)*i,penalties:await Promise.all(t.map((async a=>await N(a,n,e[f],G))))})}const J=V[0][y].currency,O={start_date:k(new Date(a)),end_date:k(new Date(n)),filter_date:o,invoice_type:$,parcels:R,dry_weight_uom:null==(e=s.value)?void 0:e.toUpperCase(),penalty_rate_uom:l.value,currency:J},M=await c.post("/generate/penalty-elements",O);if(200!==M.status)return console.log(`[generateLoadportDisportComparisonDoc] response status: ${M.status}`),i.value=M.data,void(r.value=!1);const B=M.data;t("input",{...O,doc_name:B}),r.value=!1,I(B)}catch(e){console.error("[generatePenaltyElements] error=",e),i.value=e,r.value=!1}},viewPdf:I};function I(e){const t=null!=e?e:a.value.doc_name;console.log(`[viewPdf] doc name: ${t}`);const n=`/display-doc?filepath=${encodeURIComponent(`/data/uploads/${t}.pdf`)}`;window.open(n)}async function N(e,a,t,n){const o=(await c.get(`/items/${h}/${t}`,{params:{fields:[$]}})).data.data[$];if(!o)throw new Error(`[generatePenalty] no contract found for parcel with id ${t}`);const i=await c.get(`/items/navarch_contract/${o}`,{params:{fields:[w]}});if(!i.data.data[w])throw new Error(`No mine found for contract with id ${o}`);const r=l.value.split("/")[1],s=await A(e.penalty_per_uom,r);return{mine:i.data.data[w],commodity_code:n[e.commodity].code,counterparty:a,assay:parseFloat(e.analytical_assay.replace(/,/g,"")),assay_uom:e.assay_uom,penalty_rate:parseFloat(e.final_penalty_rate.replace(/,/g,""))/s,penalty_amount:parseFloat(e.final_penalty.replace(/,/g,""))}}function k(e){const a=e.getDay(),t=e.getDate(),n=e.getMonth(),o=e.getFullYear();return`${["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][a]}, ${["January","February","March","April","May","June","July","August","September","October","November","December"][n]} ${t}, ${o}`}async function A(e,a){if(e===a)return 1;const t=await c.get(`/items/${F}?filter[${E}]=${e}`,{params:{fields:[C]}});if(0===t.data.data.length||null===t.data.data[0][C]||void 0===t.data.data[0][C])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for source weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const n=await c.get(`/items/${F}?filter[${E}]=${a}`,{params:{fields:[C]}});if(0===n.data.data.length||null===n.data.data[0][C]||void 0===n.data.data[0][C])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for the target weight unit ${a}. Ensure that the symbol is correct and is a weight unit symbol`);const o=parseFloat(t.data.data[0][C]);if(isNaN(o))throw new Error(`[getWeightUnitConversionValue] source weight unit ${e} conversion value=${o} is not a number`);const i=parseFloat(n.data.data[0][C]);if(isNaN(i))throw new Error(`[getWeightUnitConversionValue] target weight unit ${a} conversion value=${i} is not a number`);return console.log(`[getWeightUnitConversionValue] source weight unit=${e}, target weight unit=${a}, source weight unit conversion=${o}, target weight unit conversion=${i}`),console.log("[getWeightUnitConversionValue] conversion factor="+o/i),o/i}}});const y={key:0},h={key:1};g.render=function(e,a,t,n,o,m){const g=i("v-button"),_=i("v-notice");return r(),s(l,null,[c(' <input :value="value" @input="handleChange($event.target.value)" /> '),c(" create a button only interface for Directus"),e.value?(r(),s("div",h,[d(g,{class:"margin-top-16px",onClick:a[1]||(a[1]=()=>e.viewPdf())},{default:u((()=>[v("View Penalty Elements Doc ")])),_:1})])):(r(),s("div",y,[d(g,{class:"margin-top-16px",onClick:a[0]||(a[0]=()=>e.generatePdf()),loading:e.isGeneraingDoc},{default:u((()=>[v("Generate Penalty Elements Doc")])),_:1},8,["loading"]),e.failureReason?(r(),p(_,{key:0},{default:u((()=>[v(f(e.failureReason),1)])),_:1})):c("v-if",!0)]))],2112)},g.__file="src/interface.vue";var _=a({id:"navarch-penalty-elements-generator",name:"Penalty Elements Doc Generator",icon:"receipt_long",description:"This is a custom interface for Navarch's Penalty Elements Document Generator Button.",component:g,options:null,types:["json"],group:"standard"});export{_ as default};
