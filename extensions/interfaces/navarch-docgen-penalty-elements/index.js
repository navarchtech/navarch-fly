import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,ref as n,inject as o,resolveComponent as i,openBlock as r,createElementBlock as s,Fragment as l,createCommentVNode as c,createVNode as d,withCtx as u,createTextVNode as p,createBlock as v,toDisplayString as m}from"vue";var g=(e=>(e[e.Advance=0]="Advance",e[e["Second Advance"]=1]="Second Advance",e[e["Third Advance"]=2]="Third Advance",e[e["Fourth Advance"]=3]="Fourth Advance",e[e.Provisional=4]="Provisional",e[e["Second Provisional"]=5]="Second Provisional",e[e["Third Provisional"]=6]="Third Provisional",e[e["Fourth Provisional"]=7]="Fourth Provisional",e[e.Final=8]="Final",e))(g||{}),y=a({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:a}){const i=n(""),r=n(!1),s=n(!1),l=n(""),c=n(""),d=e(),u=o("values",n({})),p="logo",v="navarch_invoices",m="parcel",y="invoice_type",f="invoice_date",h="invoice",_="navarch_parcel",w="contract",$="mine",b="name",D="code",P="codename",E="navarch_unit",F="symbol",C="conversionToGram";return{isGeneraingDoc:r,failureReason:i,generatePdf:async function(){var e,t;i.value="",r.value=!0;try{const n=u.value.start_date,o=u.value.end_date,s=u.value.filter_date,w=u.value.invoice_type;if(!n)return i.value="Start date not selected",void(r.value=!1);if(!o)return i.value="End date not selected",void(r.value=!1);if(!s)return i.value="Filter date not selected",void(r.value=!1);if(!w)return i.value="Invoice type not selected",void(r.value=!1);let $="";switch(s){case"Arrival Date":$="actual_arrival_date";break;case"Invoice Date":$=f;break;case"B/L Date":$="bl_date";break;case"Parcel Finalisation Date":$="parcel_finalisation_date";break;default:return i.value="Invalid filter date",void(r.value=!1)}console.log(`[generatePenaltyElementsDoc] filter date=${$}`);const E={[h]:{_nnull:!0}};if($===f)E[f]={_between:[n,o]};else{const e=await d.get(`/items/${_}`,{params:{filter:{_and:[{[$]:{_between:[n,o]}}]},fields:["id"]}});if(200!==e.status)return console.error(`[generateLoadportDisportComparisonDoc] parcelResponce status: ${e.status}`),i.value="Failed to fetch parcels",void(r.value=!1);if(0===e.data.data.length)return i.value=`No parcels found within the selected date range of ${n} to ${o} with a non-null Invoice Date`,void(r.value=!1);const t=e.data.data[0].id;E[m]={_in:t}}const F=(await d.get(`/items/${v}`,{params:{filter:E,fields:[m,y]}})).data.data.map((e=>({parcel:e[m],invoiceType:e[y]}))).reduce(((e,t)=>(e[t.parcel]||(e[t.parcel]=[]),e[t.parcel].push(t.invoiceType),e)),{});let C={};if("First Issued Invoice"===w)C=Object.keys(F).reduce(((e,t)=>{const a=F[t].reduce(((e,t)=>g[t]<e?g[t]:e),8);return e[t]=g[a],e}),{});else{if("Latest Issued Invoice"!==w)return i.value="Invalid invoice type",void(r.value=!1);C=Object.keys(F).reduce(((e,t)=>{const a=F[t].reduce(((e,t)=>g[t]>e?g[t]:e),0);return e[t]=g[a],e}),{})}console.log(`[generatePenaltyElementsDoc] invoice type parcel combo=${JSON.stringify(C)}`);const T={_or:Object.keys(C).map((e=>({_and:[{[m]:{_eq:e}},{[y]:{_eq:C[e]}},{[h]:{_nnull:!0}}]})))};console.log(`[generatePenaltyElementsDoc] invoice data filter=${JSON.stringify(T)}`);const O=await d.get(`/items/${v}`,{params:{filter:T,fields:["id",m,y,h]}});if(console.log(`[generatePenaltyElementsDoc] invoice ids fetched=${O.data.data.map((e=>e.id)).join(", ")}`),200!==O.status)return console.error(`[generateLoadportDisportComparisonDoc] invoicesResponse status: ${O.status}`),i.value="Failed to fetch invoices",void(r.value=!1);if(0===O.data.data.length)return i.value="No invoices found for parcels within the selected date range",void(r.value=!1);const I=O.data.data.reduce(((e,t)=>{const a=t[h];""===l.value&&(l.value=a.dry_weight_uom);const n=a.penalties;if(!n||!n.penalties||0===n.penalties.length)return e;""===c.value&&(console.debug(`[generatePenaltyElementsDoc] penalties=${JSON.stringify(n)}`),c.value=`${a.currency}/${n.penalties[0].penalty_per_uom}`);const o=n.penalties.map((e=>e.commodity));return[...e,...o]}),[]).filter(((e,t,a)=>a.indexOf(e)===t));console.log(`[generatePenaltyElementsDoc] penalty commodities=${I.join(", ")}`);const j=I.map(((e,t)=>`filter[_or][${t}][${b}]=${e}`)).join("&").replace(/ /g,"%20"),x=await d.get(`/items/navarch_commodity?${j}`,{params:{fields:[b,D,"id"]}});console.log(`commodity mapping response: ${JSON.stringify(x.data.data)}`);const J=x.data.data.reduce(((e,t)=>(e[t[b]]={code:t[D],id:t.id},e)),{}),U=[];for(const e of O.data.data){const t=e[h].penalties;if(!t||!t.penalties)continue;const a=t.penalties,n=(await d.get(`/items/navarch_counterparty?filter[name]=${e[h].buyer}`,{params:{fields:[P]}})).data.data[0][P],o=e[h].dry_weight.replace(/,/g,""),i=await A(e[h].dry_weight_uom,l.value);console.log(`[generatePenaltyElementsDoc] dry weight conversion factor=${i}`),U.push({id:e[m],name:e[h].shipment_code,vessel:e[h].vessel,invoice_type:e.invoice_type,dry_weight:parseFloat(o)*i,penalties:await Promise.all(a.map((async t=>await S(t,n,e[m],J))))})}const V=O.data.data[0][h].currency,W={company_logo:null!=(e=(await d.get("/items/navarch_company",{params:{fields:[p]}})).data.data[p])?e:void 0,start_date:k(new Date(n)),end_date:k(new Date(o)),filter_date:s,invoice_type:w,parcels:U,dry_weight_uom:null==(t=l.value)?void 0:t.toUpperCase(),penalty_rate_uom:c.value,currency:V},G=await d.post("/generate/penalty-elements",W);if(200!==G.status)return console.log(`[generateLoadportDisportComparisonDoc] response status: ${G.status}`),i.value=G.data,void(r.value=!1);const R=G.data;a("input",{...W,doc_name:R}),r.value=!1,N(R)}catch(e){console.error("[generatePenaltyElements] error=",e),i.value=e,r.value=!1}},copy:async function(){s.value=!0;const{id:e,user_created:t,date_created:a,user_updated:n,date_updated:o,penalty_elements:r,...l}=u.value;console.log(`[penalty elements::copy] requestBody=${JSON.stringify(l)}`);const c=await d.post("/items/navarch_penalty_elements",l);if(200!==c.status)return console.log(`[penalty elements::copy] copy response status: ${c.status}`),void(i.value=`Failed to duplicate penalty elements with status ${c.status}`);s.value=!1,window.open(`/admin/content/navarch_penalty_elements/${c.data.data.id}`)},isCopying:s,viewPdf:N};function N(e){const a=null!=e?e:t.value.doc_name;console.log(`[viewPdf] doc name: ${a}`);const n=`/display-doc?docname=${encodeURIComponent(`${a}.pdf`)}`;window.open(n)}async function S(e,t,a,n){const o=(await d.get(`/items/${_}/${a}`,{params:{fields:[w]}})).data.data[w];if(!o)throw new Error(`[generatePenalty] no contract found for parcel with id ${a}`);const i=await d.get(`/items/navarch_contract/${o}`,{params:{fields:[$]}});if(!i.data.data[$])throw new Error(`No mine found for contract with id ${o}`);const r=c.value.split("/")[1],s=await A(e.penalty_per_uom,r);return{mine:i.data.data[$],commodity_code:n[e.commodity].code,counterparty:t,assay:parseFloat(e.analytical_assay.replace(/,/g,"")),assay_uom:e.assay_uom,penalty_rate:parseFloat(e.final_penalty_rate.replace(/,/g,""))/s,penalty_amount:parseFloat(e.final_penalty.replace(/,/g,""))}}function k(e){const t=e.getDay(),a=e.getDate(),n=e.getMonth(),o=e.getFullYear();return`${["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][t]}, ${["January","February","March","April","May","June","July","August","September","October","November","December"][n]} ${a}, ${o}`}async function A(e,t){if(e===t)return 1;const a=await d.get(`/items/${E}?filter[${F}]=${e}`,{params:{fields:[C]}});if(0===a.data.data.length||null===a.data.data[0][C]||void 0===a.data.data[0][C])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for source weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const n=await d.get(`/items/${E}?filter[${F}]=${t}`,{params:{fields:[C]}});if(0===n.data.data.length||null===n.data.data[0][C]||void 0===n.data.data[0][C])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for the target weight unit ${t}. Ensure that the symbol is correct and is a weight unit symbol`);const o=parseFloat(a.data.data[0][C]);if(isNaN(o))throw new Error(`[getWeightUnitConversionValue] source weight unit ${e} conversion value=${o} is not a number`);const i=parseFloat(n.data.data[0][C]);if(isNaN(i))throw new Error(`[getWeightUnitConversionValue] target weight unit ${t} conversion value=${i} is not a number`);return console.log(`[getWeightUnitConversionValue] source weight unit=${e}, target weight unit=${t}, source weight unit conversion=${o}, target weight unit conversion=${i}`),console.log("[getWeightUnitConversionValue] conversion factor="+o/i),o/i}}});const f={key:0},h={key:1};var _=[],w=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,n=!0===t.prepend?"prepend":"append",o=!0===t.singleTag,i="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(o){var r=_.indexOf(i);-1===r&&(r=_.push(i)-1,w[r]={}),a=w[r]&&w[r][n]?w[r][n]:w[r][n]=s()}else a=s();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function s(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),o=0;o<a.length;o++)e.setAttribute(a[o],t.attributes[a[o]]);var r="prepend"===n?"afterbegin":"beforeend";return i.insertAdjacentElement(r,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),y.render=function(e,t,a,n,o,g){const y=i("v-button"),_=i("v-notice");return r(),s(l,null,[c(' <input :value="value" @input="handleChange($event.target.value)" /> '),c(" create a button only interface for Directus"),e.value?(r(),s("div",h,[d(y,{onClick:t[1]||(t[1]=()=>e.viewPdf())},{default:u((()=>[p("View Penalty Elements Doc ")])),_:1})])):(r(),s("div",f,[d(y,{onClick:t[0]||(t[0]=()=>e.generatePdf()),loading:e.isGeneraingDoc},{default:u((()=>[p("Generate Penalty Elements Doc")])),_:1},8,["loading"]),e.failureReason?(r(),v(_,{key:0},{default:u((()=>[p(m(e.failureReason),1)])),_:1})):c("v-if",!0)])),d(y,{class:"margin-top-16px",onClick:t[2]||(t[2]=()=>e.copy()),loading:e.isCopying},{default:u((()=>[p("Copy")])),_:1},8,["loading"])],64)},y.__scopeId="data-v-64969d30",y.__file="src/interface.vue";var $=t({id:"navarch-penalty-elements-generator",name:"Penalty Elements Doc Generator",icon:"receipt_long",description:"This is a custom interface for Navarch's Penalty Elements Document Generator Button.",component:y,options:null,types:["json"],group:"standard"});export{$ as default};
