import{useApi as e,defineInterface as a}from"@directus/extensions-sdk";import{defineComponent as t,ref as o,inject as n,resolveComponent as i,openBlock as r,createElementBlock as l,Fragment as s,createCommentVNode as c,createVNode as d,withCtx as u,createTextVNode as f,createBlock as m,toDisplayString as p}from"vue";var y=(e=>(e.BRACKET="Bracket",e.MIN_DEDUCTION="Minimum Deduction",e.MAX_CAP="Maximum Cap",e))(y||{}),h=(e=>(e.PERCENTAGE="Percentage",e.FRACTIONAL="Fractional",e))(h||{}),v=(e=>(e.WET_WEIGHT="wet_weight",e.MOISTURE="moisture",e.DRY_WEIGHT="dry_weight",e))(v||{}),_=(e=>(e.METHOD="method",e.WET_WEIGHT_UOM="wet_weight_uom",e.MOISTURE_UOM="moisture_uom",e.DRY_WEIGHT_UOM="dry_weight_uom",e))(_||{}),g=t({props:{value:{type:Object,default:null}},emits:["input"],setup(a,{emit:t}){const i=o(""),r=o(!1),l=o(!1),s=e(),c=n("values",o({}));function d(e){if(console.log("[evaluateWeightData]"),0===e.length)return;const a=f(e,v.DRY_WEIGHT),t=f(e,v.WET_WEIGHT);return{method:u(e,_.METHOD),lots:e,dry_weight_uom:u(e,_.DRY_WEIGHT_UOM),wet_weight_uom:u(e,_.WET_WEIGHT_UOM),dry_weight:a,wet_weight:t,moisture:(t-a)/t*100}}function u(e,a){if(console.log("[getFirstValueAsSharedValue]"),0!==e.length)return console.log(`lots[0][${a.toString()}]=${e[0][a.toString()]}`),e[0][a.toString()]}function f(e,a){return console.log("[evaluateAggregateValue]"),e.reduce(((e,t)=>{var o;return e+parseFloat(null!=(o=t[a.toString()])?o:"0")}),0)}function m(e){return null==e}function p(e,a=2,t=!0){if(console.log("[formatNumber]"),isNaN(e)||null===e)return"-";const o=Math.round(e*Math.pow(10,a))/Math.pow(10,a),[n,i]=o.toString().split("."),r=n.replace(/\B(?=(\d{3})+(?!\d))/g,",");if(!i&&!t)return r;return`${r}.${(null!=i?i:"").padEnd(a,"0")}`}function g(e,a=2,t=!1){if(m(e)||isNaN(e))return null;const o=t&&e<0;return o&&(e*=-1),Math.round(e*Math.pow(10,a))/Math.pow(10,a)*(o?-1:1)}function $(e){if(console.log("[parseNumber]"),"number"==typeof e)return e;if(!e||"-"===e)return 0;const a=parseFloat(e.replace(/[^\d.-]/g,""));return console.log(`[parseNumber] number: ${e} to ${a}`),a}function w(e,a){return console.log("[findBracket]"),e.find((e=>{var t,o;const n=a>(null!=(t=e.lower_threshold)?t:0)&&(m(e.upper_threshold)||a<e.upper_threshold)||e.lower_threshold_inclusive&&a===(null!=(o=e.lower_threshold)?o:0)||e.upper_threshold_inclusive&&a===e.upper_threshold;return console.log(`[findBracket] value=${a} for bracket: ${JSON.stringify(e)}? match=${!!n}`),n}))}function D(e,a){var t,o,n,i,r,l,s,c,d,u,f;console.log("[evaluateFinalValueFromBrackets]");const m=(e-(null!=(t=a.initial_adjustment)?t:0)*(a.initial_adjustment_conversion_by_multiplication?null!=(o=a.initial_adjustment_conversion_factor)?o:1:1/(null!=(n=a.initial_adjustment_conversion_factor)?n:1)))*(null!=(i=a.rate)?i:0)*(a.rate_type===h.PERCENTAGE?.01:1)+(null!=(r=a.final_adjustment)?r:0)*(a.final_adjustment_conversion_factor?null!=(l=a.final_adjustment_conversion_factor)?l:1:1/(null!=(s=a.final_adjustment_conversion_factor)?s:1));switch(a.bracket_type){case y.MIN_DEDUCTION:if(null===a.comparator||void 0===a.comparator)throw new Error("Minimum deduction not found");const t=a.comparator*(a.comparator_conversion_by_multiplication?null!=(c=a.comparator_conversion_factor)?c:1:1/(null!=(d=a.comparator_conversion_factor)?d:1));return e-m<t?g(e-t,4):m;case y.MAX_CAP:if(null===a.comparator||void 0===a.comparator)throw new Error("Maximum cap not found");const o=a.comparator*(a.comparator_conversion_by_multiplication?null!=(u=a.comparator_conversion_factor)?u:1:1/(null!=(f=a.comparator_conversion_factor)?f:1));return g(m>o?o:m,4);case y.BRACKET:return g(m,4);default:throw new Error(`bracket type ${a.bracket_type} is not supported`)}}async function E(e,a,t,o){var n,i,r,l,s,c,d,u;if(console.log("[evaluatePayableAssay]"),!t||0===t.length)return{};const f=w(t,e);if(!f)throw new Error(`Unable to find the range for analytical assay value of ${e}, please ensure the payable assay rates for the commodity ${o} are defined in the contract cover all range of possible values`);let m,v,_=1,g=!0;if(f.initial_adjustment_uom&&void 0!==f.initial_adjustment_uom&&null!==f.initial_adjustment_uom&&f.initial_adjustment_uom!==a){const e=await B(f.initial_adjustment_uom,a);_=e.value,m=k(f.initial_adjustment_uom,a,e.isConvertByMultiplication),g=e.isConvertByMultiplication}let $,E=1,b=!0;if(f.bracket_type===y.MAX_CAP){if(v=null!=(n=f.maximum_cap)?n:0,void 0!==f.maximum_cap_uom&&null!==f.maximum_cap_uom&&f.maximum_cap_uom!==a){const e=await B(f.maximum_cap_uom,a);E=e.value,$=k(f.maximum_cap_uom,a,e.isConvertByMultiplication),b=e.isConvertByMultiplication}}else if(f.bracket_type===y.MIN_DEDUCTION&&(v=null!=(i=f.minimum_deduction)?i:0,void 0!==f.minimum_deduction_uom&&null!==f.minimum_deduction_uom&&f.minimum_deduction_uom!==a)){const e=await B(f.minimum_deduction_uom,a);E=e.value,$=k(f.minimum_deduction_uom,a,e.isConvertByMultiplication),b=e.isConvertByMultiplication}const P={bracket_type:f.bracket_type,rate:null!=(r=f.rate)?r:1,rate_type:null!=(l=f.rate_type)?l:h.FRACTIONAL,initial_adjustment:null!=(s=f.initial_adjustment)?s:0,initial_adjustment_conversion_factor:_,initial_adjustment_conversion_by_multiplication:g,comparator:v,comparator_conversion_factor:E,comparator_conversion_by_multiplication:b};console.log(`[evaluatePayableAssay] bracketForEvaluation: ${JSON.stringify(P)}`);const C=D(e,P);let S="";const A=void 0!==f.initial_adjustment&&null!==f.initial_adjustment;if(f.bracket_type===y.BRACKET)S=`${A?"(":""}${p(e,4)}${null!=a?a:""}${A?` - ${p(f.initial_adjustment,4)}${null!=(c=f.initial_adjustment_uom)?c:`${null!=a?a:""}`}`:""}${A&&1!==_?` ${g?"*":"/"} ${p(_,4)}${m}`:""}${A?")":""} * ${p(f.rate,4)}${f.rate_type===h.PERCENTAGE?"/100":`/${p(1,4)}`}`;else if(f.bracket_type===y.MIN_DEDUCTION){S=C===e-v*E?`${p(e,4)}${null!=a?a:""} - ${p(v,4)}${null!=a?a:""}${1!==E?` ${b?"*":"/"} ${p(E,4)}${$}`:""}`:`${A?"(":""}${p(e,4)}${null!=a?a:""}${A?` - ${p(f.initial_adjustment,4)}${null!=(d=f.initial_adjustment_uom)?d:`${null!=a?a:""}`}`:""}${A&&1!==_?` ${g?"*":"/"} ${p(_,4)}${m}`:""}${A?")":""} * ${p(f.rate,4)}${f.rate_type===h.PERCENTAGE?"/100":`/${p(1,4)}`}`}else{if(f.bracket_type!==y.MAX_CAP)throw new Error(`[buildPayableAssayExpression] unknown bracket method: ${f.bracket_type}`);S=C===v*E?`${p(v,4)}${null!=a?a:""}${1!==E?` ${b?"*":"/"} ${p(E,4)}${$}`:""}`:`${A?"(":""}${p(e,4)}${null!=a?a:""}${A?` - ${p(f.initial_adjustment,4)}${null!=(u=f.initial_adjustment_uom)?u:`${null!=a?a:""}`}`:""}${A&&1!==_?` ${g?"*":"/"} ${p(_,4)}${m}`:""}${A?")":""} * ${p(f.rate,4)}${f.rate_type===h.PERCENTAGE?"/100":`/${p(1,4)}`}`}return{payableAssay:C,expression:S}}console.log("[main] formValues=",c);const b="above the lower threshold, plus",P="below the upper threshold, minus";function C(e,a,t,o,n){var i,r,l,s,c,d,u;if(console.log("[evaluateCharge]"),!t||!t.length)return;const f=w(t,e);if(!f)throw new Error(`Unable to find the range for the price rate value of ${e}, please ensure the ${n} rates for commodity ${o} are defined in the contract cover all range of possible values`);let m=0,p=1;if(f.use_btc)p=0,m=0;else{const e=null!=(i=f.escalator_reference)?i:1;if(p=(null!=(r=f.rate)?r:1)/e,f.for_every_unit===b)m=null!=(l=f.lower_threshold)?l:0;else{if(f.for_every_unit!==P)throw new Error(`[evaluateCharge] unknown for_every_unit: ${f.for_every_unit}`);m=null!=(s=f.upper_threshold)?s:0}}const v={bracket_type:y.BRACKET,rate:p,rate_type:h.FRACTIONAL,initial_adjustment:m,final_adjustment:(null!=(c=f.base_treatment_charge)?c:0)+(null!=(d=f.base_charge_adjustment)?d:0)};return console.log(`[evaluateCharge] bracketForEvaluation: ${JSON.stringify(v)}`),{finalValue:D(e,v),baseTreatmentCharge:f.base_treatment_charge+(null!=(u=f.base_charge_adjustment)?u:0)}}function S(e,a,t,o,n){var i,r,l,s;if(console.log("[evaluatePenalty]"),!a||!a.length)return{};const c=w(a,e);if(!c)throw new Error(`Unable to find the range for the analytical assay value of ${e}, please ensure the penalty rates for commodity ${n} are defined in the contract cover all range of possible values`);let d=0,u=1;if(c.no_penalty)u=0,d=0;else{const e=null!=(i=c.escalator_reference)?i:1;if(u=(null!=(r=c.rate)?r:1)/e,c.for_every_unit===b)d=null!=(l=c.lower_threshold)?l:0;else{if(c.for_every_unit!==P)throw new Error(`[evaluatePenalty] unknown for_every_unit: ${c.for_every_unit}`);d=null!=(s=c.upper_threshold)?s:0}}const f={bracket_type:y.BRACKET,rate:u,rate_type:h.FRACTIONAL,initial_adjustment:d,final_adjustment:0};console.log(`[evaluatePenalty] bracketForEvaluation: ${JSON.stringify(f)}`);const m=D(e,f),v=null!=f.initial_adjustment;let _="";return _=c.rate&&0!==c.rate?`${v?"(":""}${p(e,4)}${v?` - ${p(d,4)})`:""} / ${p(1,4)} * ${null!=t?t:""} ${p(u,4)}/${null!=o?o:""}`:"No penalty",{penalty:m,expression:_,bracket:c}}function A(e){const a=e.getDate(),t=e.getMonth(),o=e.getFullYear();return`${a} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t]} ${o}`}function N(e,a=!0){const t=e.getMonth()+1,o=e.getDate();return`${e.getFullYear()}${a?"-":" "}${t<10?"0":""}${t}${a?"-":" "}${o<10?"0":""}${o}`}function M(e){return 0===e.getDay()||6===e.getDay()}function O(e,a,t=!1){const o=new Date(e.valueOf());let n=a-(t?1:0),i=!0;for(;M(o);)o.setDate(o.getDate()+1),i&&(n-=1,i=!1);for(;n>0;)o.setDate(o.getDate()+1),M(o)||(n-=1);for(o.getHours()>=12&&o.setDate(o.getDate()+1);M(o);)o.setDate(o.getDate()+1);return o}function T(e,a){const t=new Date(e.valueOf());return t.setMonth(t.getMonth()+a,1),t}function I(e,a){const t=new Date(e.valueOf());return t.setMonth(t.getMonth()+a+1,0),t}async function U(e,a){var t,o;if(e===a)return{value:1,isConvertByMultiplication:!0};const n=await s.get(`/items/${Ca}?filter[${Sa}]=${e}`,{params:{fields:[Ta]}});if(0===n.data.data.length||null===n.data.data[0][Ta]||void 0===n.data.data[0][Ta])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for source weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const i=await s.get(`/items/${Ca}?filter[${Sa}]=${a}`,{params:{fields:[Ta]}});if(0===i.data.data.length||null===i.data.data[0][Ta]||void 0===i.data.data[0][Ta])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for the target weight unit ${a}. Ensure that the symbol is correct and is a weight unit symbol`);const r=parseFloat(n.data.data[0][Ta]);if(isNaN(r))throw new Error(`[getWeightUnitConversionValue] source weight unit ${e} conversion value=${r} is not a number`);const l=parseFloat(i.data.data[0][Ta]);if(isNaN(l))throw new Error(`[getWeightUnitConversionValue] target weight unit ${a} conversion value=${l} is not a number`);return r<l?{value:null!=(t=g(l/r,4))?t:1,isConvertByMultiplication:!1}:{value:null!=(o=g(r/l,4))?o:1,isConvertByMultiplication:!0}}async function B(e,a){var t,o;if(null==e||null==a)return{value:1,isConvertByMultiplication:!0};if(e===a)return{value:1,isConvertByMultiplication:!0};const n=await s.get(`/items/${Ia}?filter[${Ua}]=${e}`,{params:{fields:[Ba]}});if(0===n.data.data.length||void 0===n.data.data[0][Ba]||null===n.data.data[0][Ba])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for source weight unit ${e}. Ensure that the symbol is correct and is a weight unit symbol`);const i=await s.get(`/items/${Ia}?filter[${Ua}]=${a}`,{params:{fields:[Ba]}});if(0===i.data.data.length||void 0===i.data.data[0][Ba]||null===i.data.data[0][Ba])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for the target weight unit ${a}. Ensure that the symbol is correct and is a weight unit symbol`);const r=parseFloat(n.data.data[0][Ba]);if(isNaN(r))throw new Error(`[getAssayUnitConversionValue] source weight unit ${e} conversion value=${r} is not a number`);console.log(`[getAssayUnitConversionValue] source unit conversion value=${r}`);const l=parseFloat(i.data.data[0][Ba]);if(isNaN(l))throw new Error(`[getAssayUnitConversionValue] target weight unit ${e} conversion value=${l} is not a number`);return console.log(`[getAssayUnitConversionValue] target unit conversion value=${l}`),console.log("[getAssayUnitConversionValue] returning "+r/l),r<l?{value:null!=(t=g(l/r,4))?t:1,isConvertByMultiplication:!1}:{value:null!=(o=g(r/l,4))?o:1,isConvertByMultiplication:!0}}function k(e,a,t){if(void 0===e||void 0===a||null===e||null===a)return;const o=e.split("/"),n=a.split("/");if(o.length>2||n.length>2)throw new Error(`[getConversionUnit] sourceUnit=${e} and targetUnit=${a} must be in the format of 'unit1/unit2', an extra '/' was found`);if(1===o.length&&1===n.length)return t?`${n[0]}/${o[0]}`:`${o[0]}/${n[0]}`;if(1===o.length){const e=n[0]===o[0]?"":`${n[1]}(${o[1]})`,a=n[1];return""===a?t?e:`/${e}`:t?`${e}/${a}`:`${a}/${e}`}if(1===n.length){const e=o[1],a=o[0]===n[0]?"":`${o[1]}(${n[0]})`;return""===a?t?e:`/${e}`:t?`${e}/${a}`:`${a}/${e}`}{const e=o[0]===n[0],a=o[1]===n[1],i=e||""===o[0],r=e||""===n[0],l=a||""===o[1],s=a||""===n[1],c=!l&&!r,d=!i&&!s,u=`${l?"":o[1]}${c?"(":""}${r?"":`${n[0]}`}${c?")":""}`,f=`${i?"":o[0]}${d?"(":""}${s?"":`${n[1]}`}${d?")":""}`;return""===f?t?u:`/${u}`:t?`${u}/${f}`:`${f}/${u}`}}async function j(e,a,t){const o=await s.get(`/items/${Ca}?filter[${Aa}]=${a}`,{params:{fields:[Sa]}});if(!o.data.data||!o.data.data[0]||!o.data.data[0][Sa])throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] Dry weight uom not found for symbol ${a}`);const n=o.data.data[0][Sa];if("%"===t){if(n===e)return{};const a=await U(n,e),t=k(n,e,a.isConvertByMultiplication);if(!t)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for dry weight unit ${n} and target weight unit ${e}`);return{finalConversion:{conversionFactor:a.value,conversionUom:t,isConvertByMultiplication:a.isConvertByMultiplication}}}let i=t.split("/");if(1==i.length){const e=await async function(e){const a=await s.get(`/items/${Ia}`,{params:{fields:[Ua,ka],filter:{[ka]:{_nnull:!0},[Ua]:{_eq:e}}}});if(200!==a.status||!a.data||0===a.data.data.length)throw new Error("[getAssayUnitComposition] no assay units found with composition");return a.data.data[0][ka]}(t);if(!e)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${t} does not have a composition`);i=e.split("/")}if(i.length>2||0===i.length)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${t} is not in the format of 'unit1/unit2'`);const r=i[0],l=i[1],c={};if(l!==n){const e=await U(n,l),a=k(n,l,e.isConvertByMultiplication);if(!a)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for dry weight unit ${n} and assay unit denominator unit ${l}`);c.initialConversion={conversionFactor:e.value,conversionUom:a,isConvertByMultiplication:e.isConvertByMultiplication}}if(r!==e){const a=await U(r,e),t=k(r,e,a.isConvertByMultiplication);if(!t)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] no conversion unit found for target weight unit ${e} and assay unit numerator unit ${r}`);c.finalConversion={conversionFactor:a.value,conversionUom:t,isConvertByMultiplication:a.isConvertByMultiplication}}return c}const F="id",V="foreign_key",R="lot_number",x="method",J="navarch_cashflow",q="navarch_parcel",W="contract",L="counterparty",G="assay_results",H="weight_result",Q="actual_arrival_date",K="estimate_arrival_date",Y="bl_date",X="invoice_due_date",z="estimated_shipment_date",Z="qp_selection",ee="vessel",ae="origin",te="destination",oe="shipment_code",ne="adjustments",ie="parcel_finalisation_date",re="navarch_assay_lot",le="commodity",se="dry_weight",ce="dry_weight_uom",de="buyer_assay",ue="seller_assay",fe="final_assay",me="assay_uom",pe="lot_number",ye="navarch_weight_lot",he="dry_weight",ve="wet_weight",_e="moisture",ge="wet_weight_uom",$e="dry_weight_uom",we="navarch_contract",De="contract_currency",Ee="name",be="navarch_contract_payment_information",Pe="related_contract",Ce="invoice_type",Se="pay_percent",Ae="pa_days",Ne="pa_day_type",Me="pa_ref_day",Oe="pp_days",Te="pp_day_type",Ie="pp_ref_day",Ue="navarch_commodity_in_contract",Be="contract",ke="commodity",je="primary_commodity",Fe="payable_commodity",Ve="price_method",Re="price_fix_to_use",xe="price_per_uom",Je="treatment_charge_per_uom",qe="refining_charge_rate_uom",We="quotational_periods",Le="payable_assay_rates",Ge="penalty_rates",He="penalty_per_uom",Qe="navarch_payable_assay_bracket",Ke="initial_adjustment",Ye="initial_adjustment_uom",Xe="minimum_deduction",ze="minimum_deduction_uom",Ze="maximum_cap",ea="maximum_cap_uom",aa="related_commodity_in_contract",ta="bracket_type",oa="lower_threshold",na="lower_threshold_inclusive",ia="upper_threshold",ra="upper_threshold_inclusive",la="rate",sa="rate_type",ca="navarch_treatment_charge_bracket",da="base_treatment_charge",ua="base_charge_adjustment",fa="use_btc",ma="escalator_reference",pa="for_every_unit",ya="related_contract_commodity_tc",ha="related_contract_commodity_rc",va="navarch_penalty_bracket",_a="no_penalty",ga="escalator_reference",$a="for_every_unit",wa="navarch_commodity",Da="name",Ea="code",ba="navarch_currency",Pa="code",Ca="navarch_unit",Sa="symbol",Aa="dry_symbol",Na="wet_symbol",Ma="dry_unit",Oa="wet_unit",Ta="conversionToGram",Ia="navarch_assay_unit",Ua="unit",Ba="conversion_to_ppb",ka="composition",ja="navarch_counterparty",Fa="codename",Va="name",Ra="navarch_vessel",xa="name",Ja="price_am",qa="price_pm",Wa="average_price",La="date",Ga="navarch_invoices",Ha="parcel",Qa="invoice",Ka="invoice_date",Ya="amount_paid",Xa="invoice_type",za="navarch_forecast_price",Za="commodity",et="price",at="start_date",tt="end_date",ot={Advance:0,"Second Advance":1,"Third Advance":2,"Fourth Advance":3,Provisional:4,"Second Provisional":5,"Third Provisional":6,"Fourth Provisional":7,Final:8};function nt(e){const a=[...new Set(e.flatMap((e=>Object.keys(e))))],t=e.map((e=>a.map((a=>{const t=e[a]||"";return"string"==typeof t&&t.includes(",")?`"${t}"`:t})).join(",")));return[a.join(","),...t].join("\n")}function it(e){const a=new Blob([e],{type:"text/csv"}),t=URL.createObjectURL(a),o=document.createElement("a");o.href=t,o.download=`Cashflow-[${function(){const e=new Date,a=60*e.getTimezoneOffset()*1e3,t=e.getTime()-a,o=new Date(t),n=o.toISOString().slice(0,19),i=e.getTimezoneOffset()/60*-1;return`${n}GMT${i>0?"+":""}${i}`.replace(/:/g,"")}()}]-Valuation_Period-(${N(new Date(c.value.start_date),!1)}~${N(new Date(c.value.end_date),!1)}).csv`,document.body.appendChild(o),o.click(),document.body.removeChild(o)}class rt extends Error{constructor(e){super(e),this.name="NonFatalError",Object.setPrototypeOf(this,rt.prototype)}}return{isGeneraingDoc:r,invoiceUrl:c.value,generateCashflow:async function(){i.value="";try{r.value=!0;const e=await async function(){const e=new Date(c.value.start_date);if("Invalid Date"===e.toString())throw i.value="Start date is invalid",new Error("Start date is invalid");const a=new Date(c.value.end_date);if("Invalid Date"===a.toString())throw i.value="End date is invalid",new Error("End date is invalid");const t=await s.get(`/items/${we}`,{params:{fields:[Ee,F,"invoice_type"]}}),o={};await Promise.all(t.data.data.map((async t=>{var n,i,r,l,c;const d=await s.get(`/items/${be}`,{params:{filter:{[Pe]:{_eq:t[F]}},fields:[Ce,Ae,Ne,Me]}}),u=await s.get(`/items/${q}`,{params:{filter:{[W]:{_eq:t[F]}},fields:[F,oe,Q,K,Y,z,ie,X]}});for(const f of d.data.data){const d={days:f[Ae],day_type:f[Ne],ref_day:"Final"===f[Xa]?"QP Month + n days":f[Me]};if(!d)throw new Error(`Contract ${t[Ee]} does not have a payment advice for invoice type ${f[Xa]}`);let p,y="";for(const h of u.data.data){switch(d.ref_day){case"Arrival Date":y="Actual Arrival Date from the Parcel form",p=null!=(n=h[Q])?n:h[K];break;case"B/L Date":y="B/L Date (or Estimated Shipment Date) from the Parcel form",p=null!=(i=h[Y])?i:h[z];break;case"Invoice Date":y="Invoice Date (using the B/L Date or Estimated Shipment Date from the Parcel form)",p=null!=(r=h[Y])?r:h[z];break;case"Estimated Shipment Date":y="Estimated Shipment Date from the Parcel form",p=h[z];break;case"QP Month + n days":const e=await s.get(`items/${Ue}`,{params:{filter:{[Be]:{_eq:t[F]},[Fe]:{_eq:!0}},fields:[We]}});if(!Array.isArray(e.data.data)||0===e.data.data.length)throw new Error(`Contract ${t[Ee]} does not have any payable commodities`);const a=e.data.data.map((e=>e[We].find((e=>!!e.default)))),o=a.reduce(((e,a)=>a.qp_period>e.qp_period?a:e),a[0]);let u;switch(o.qp_code){case"MAMA":y="Actual Arrival Date (or Estimated Arrival Date) from the Parcel form",u=null!=(l=h[Q])?l:h[K];break;case"MOSS":case"MOS":case"MOAS":y="B/L Date (or Estimated Shipment Date) from the Parcel form",u=null!=(c=h[Y])?c:h[z];break;default:throw new Error(`Unsupported QP code ${o.qp_code}, currently only supports MAMA, MOS, MOSS, and MOAS`)}if(m(u))throw new Error(`Invalid reference date, please ensure the ${y} field(s) in parcel ${h[oe]} are filled in`);p=I(new Date(u),o.qp_period).toISOString();break;default:throw new Error(`Invalid reference day for payment advice: ${d.ref_day}; please contact Navarch for support`)}if(null==p)throw new Error(`Reference day for payment advice ${y} is empty in parcel ${h[oe]}`);const u=new Date(p),v=parseInt(d.days);let _;switch(d.day_type){case"Business Day(s)":_=O(u,v);break;case"Calendar Day(s)":_=new Date(u.valueOf()),_.getHours()>=12?_.setDate(_.getDate()+v+1):_.setDate(_.getDate()+v);break;default:throw new Error(`Please provide a valid Day Type (Cashflow) for ${t[Ee]}:Final Invoice Type`)}if(_>=e&&_<=a&&(o[h[F]]||(o[h[F]]=[]),o[h[F]].push({invoiceType:f[Ce],dueDate:_,parcelId:h[F],contractName:t[Ee]})),!h[X])continue;const g=h[X];Object.values(g).forEach((n=>{if(n.due_date){const i=n.inv_type,r=new Date(n.due_date);if("Invalid Date"===r.toString())throw new Error(`Invoice Due Date field in the parcel ${h[oe]} has an invalid due date for invoice type ${i}`);if(r>=e&&r<=a){o[h[F]]||(o[h[F]]=[]);const e={invoiceType:i,dueDate:r,parcelId:h[F],contractName:t[Ee]},a=o[h[F]].findIndex((e=>e.invoiceType===i));-1!==a?o[h[F]][a]=e:o[h[F]].push(e)}else{const e=o[h[F]].findIndex((e=>e.invoiceType===i));-1!==e&&o[h[F]].splice(e,1)}}}))}}})));const n=Object.keys(o);let r;for(let e=0;e<n.length;e+=15){const a=n.slice(e,e+15),t=await s.get(`/items/${q}`,{params:{filter:{[F]:{_in:a}},fields:[F,W,L,G,H,Q,K,Y,z,Z,ee,ae,te,oe,ne,"parcel_finalised",ie,G]}});r?r.data.data=r.data.data.concat(t.data.data):r=t}if(!r.data.data||r.data.data.length!==n.length)throw new Error("Experiencing some network issues, please try again. If the issue persists, contact Navarch for support");const l={parcelData:r.data.data.reduce(((e,a)=>(e[a[F]]=a,e)),{}),contractNameByParcelId:n.reduce(((e,a)=>(e[a]=o[a][0].contractName,e)),{}),invoiceTypeParcel:n.flatMap((e=>o[e])),parcelIds:n};return console.log(`[getApplicableParcels] returnObject=${JSON.stringify(l)}`),l}(),a=await async function(e){const a=[];let t;for(let a=0;a<e.parcelIds.length;a+=15){const o=e.parcelIds.slice(a,a+15),n=await s.get(`/items/${Ga}`,{params:{filter:{[Ha]:{_in:o},[Qa]:{_nnull:!0}},fields:[Ha,Xa,Qa,Ka,Ya]}});t?t.data.data=t.data.data.concat(n.data.data):t=n}t.data.data.sort(((e,a)=>{const t=ot[e[Xa]]-ot[a[Xa]];return 0===t?new Date(a[Ka]).valueOf()-new Date(e[Ka]).valueOf():t}));for(const o of e.invoiceTypeParcel){const n=t.data.data.find((e=>e[Ha]===o.parcelId&&e[Xa]===o.invoiceType));n?a.push({parcelId:o.parcelId,invoiceType:o.invoiceType,contractName:e.contractNameByParcelId[o.parcelId],dueDate:o.dueDate,invoiceData:{...n[Qa],amount_paid:n[Ya]}}):a.push({parcelId:o.parcelId,invoiceType:o.invoiceType,contractName:e.contractNameByParcelId[o.parcelId],dueDate:o.dueDate,parcelData:e.parcelData[o.parcelId]})}return console.log(`[generateInvoiceParamForParcel] invoiceParams=${JSON.stringify(a)}`),a}(e);console.log(`[generateCashflow] form values=${JSON.stringify(c.value)}`);const o=await Promise.all(a.map((async e=>(console.log(`[generateCashflow] invoiceParam=${JSON.stringify(e)}`),await async function(e){var a,t,o,n,l,c,u,f,m,y,h,v,_,w,D,b,P,N,M,O,T,I,U,B,k,J,X,Z,ie,Ee,Ta,Ia,Ua,Ba,ka,Ja,qa,Wa;i.value="",r.value=!0;try{if(e.invoiceData){console.log(`[generateInvoice][invoice=${JSON.stringify(e.invoiceData.invoice_number)}::parcel=${e.invoiceData.parcel}] using existing invoice=${JSON.stringify(e.invoiceData)}`);const a=e.invoiceData,t=await s.get(`/items/${ja}`,{params:{filter:{[Va]:{_eq:a.buyer}},fields:[Fa]}});vt(t.data.data[0]);const o=await s.get(`/items/${q}`,{params:{filter:{[F]:{_eq:e.parcelId}},fields:[Y,Q,K]}});console.log(`[generateInvoice][invoice=${JSON.stringify(e.invoiceData.invoice_number)}::parcel=${e.invoiceData.parcel}] parcel date data=${JSON.stringify(o.data.data)}`);const n=o.data.data[0];return{Parcel:a.parcel,Counterparty:t.data.data[0][Fa],Vessel:"N/A"===a.vessel?"Vessel TBA":a.vessel,"Shipment Date":a.bl_date,"Arrival Date":n[Q]?A(new Date(n[Q])):n[K]?A(new Date(n[K])):"N/A",Status:o[Y]?"Unfinalised":"Planned",Revision:"Original",Invoice:`${a.invoice_type}:Original`,"Invoice Due Date":A(e.dueDate),"Dry Weight":`${p(a.dry_weight,2)}`,...await dt(a.commodities,{dryWeight:a.dry_weight,dryWeightUom:a.dry_weight_uom}),"Total Revenues USD":p(a.total_revenue),"Total Penalties USD":p(a.total_deductions),"Total Adjustments USD":a.adjustments?p(a.adjustments.total_adjustments):"0.00","Parcel Value USD":p(a.invoice_value),"Parcel Payable Value USD":p(a.payable_amount),"Payments USD":a.amount_paid,"Due Total":p(a.balance_in_sellers_favor),metadata:{invoiceTypeRanking:ot[a.invoice_type]}}}if(void 0===e.parcelData)throw new rt(`Something went wrong, no parcel or invoice data for Invoice of parcel id ${e.parcelId.substring(0,5)} and invoice type ${e.invoiceType}`);const r=e.parcelId;if(!r)return void console.error(`[generateInvoice] A parcel id is not defined for invoice type ${e.invoiceType}`);const La=e.invoiceType,Ka=e.parcelData,Ya=e.contractName;console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] parcel data=${JSON.stringify(Ka)}`),function(e){if(!e)throw new Error("Parcel data not found, please ensure the selected parcel still exists");if(!e[oe])throw new Error("One of the parcels does not have a shipment code, please ensure that all parcels have a shipment code");if(!e[W])throw new Error(`The parcel ${e[oe]} does not have a contract, please ensure that the contract field for the parcel is not empty`);if(!e[L])throw new Error(`The parcel ${e[oe]} does not havea counterparty, please ensure that the counterparty field for the parcel is not empty`);if(!e[G])throw new rt(`The parcel ${e[oe]} does not have assay results`);if(!e[H])throw new rt(`The parcel ${e[oe]} does not have weight results`);if(!e[ae])throw new Error(`The parcel ${e[oe]} does not havean origin port`);if(!e[te])throw new Error(`The parcel ${e[oe]} does not havea destination port`)}(Ka);const Xa=Ka[G],za=Ka[H],Za=Ka[W];if(!Za)throw new Error(`Contract not found for parcel ${Ka[oe]}`);const et=await s.get(`/items/${be}`,{params:{filter:{[Pe]:{_eq:Za},[Ce]:{_eq:La}},fields:[Ce,Se,Ae,Ne,Me,Oe,Te,Ie]}});if(et.data.data&&0===et.data.data.length)throw new Error(`No invoice type found for the contract ${Ya}`);const at=et.data.data.find((e=>e[Ce]===La));if(!at)throw new Error(`Cannot find payment information for ${La} in the contract ${Ya}, please ensure that data for it has been entered and saved`);const tt=await s.get(`/items/${ye}?filter[${V}]=${za}&sort[]=${R}`,{params:{fields:[F,he,ve,x,_e,ge,$e]}});console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] weight lots data=${JSON.stringify(tt.data.data)}`),function(e){if(!e||0===e.length)throw new rt("No weight lots found for the selected parcel")}(tt.data.data);const nt=function(e){console.log("[evaluateWeights]");const a={};for(const t of e)a[t.method]||(console.log(`adding method ${t.method} to weightData object`),a[t.method]=[]),console.log(`adding lot ${t.id} to weightData.${t.method} array`),a[t.method.toString()].push(t);const t=[];for(const e of Object.keys(a)){if(!a[e]){console.log(`method=${e} does not exist in weightData object`);continue}console.log(`adding lots and other values to weights for method=${e}`);const o=d(a[e]);o&&t.push(o)}return t}(tt.data.data);let it;if(it||(it=nt.find((e=>"Outturn"===e.method))),it||(it=nt.find((e=>"Inturn Final"===e.method))),it||(it=nt.find((e=>"Inturn"===e.method))),it||(it=nt.find((e=>"Estimated"===e.method))),it||(it=nt.find((e=>"Planned"===e.method))),!it)throw new Error(`No weight lots with valid method found for parcel ${Ka[oe]}`);if(void 0===it.dry_weight||null===it.dry_weight||void 0===it.wet_weight||null===it.wet_weight||void 0===it.moisture||null===it.moisture||void 0===it.dry_weight_uom||null===it.dry_weight_uom||void 0===it.wet_weight_uom||null===it.wet_weight_uom||void 0===it.method||null===it.method)throw new Error(`One of the fields for the latest weight lots data is undefined for parcel ${Ka[oe]}`);const lt=await s.get(`/items/${Ca}?filter[${Aa}]=${it.dry_weight_uom}`,{params:{fields:[Ma]}}),ut=await s.get(`/items/${Ca}?filter[${Na}]=${it.wet_weight_uom}`,{params:{fields:[Oa]}});if(!lt.data.data||!lt.data.data[0]||!lt.data.data[0][Ma])throw new Error(`Dry weight uom not found for symbol ${it.dry_weight_uom} for parcel ${Ka[oe]}`);if(!ut.data.data||!ut.data.data[0]||!ut.data.data[0][Oa])throw new Error(`Wet weight uom not found for symbol ${it.wet_weight_uom} for parcel ${Ka[oe]}`);const _t=await s.get(`/items/${re}?filter[${V}]=${Xa}&sort[]=${R}`,{params:{fields:[F,le,x,se,ce,de,ue,fe,pe,me]}});console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] assay lots data=${JSON.stringify(_t.data.data)}`),function(e){if(!e||0===e.length)throw new rt("No assay lots found for the selected parcel")}(_t.data.data);const gt=function(e){var a;console.log("[evaluateAnalyticalAssay]");const t={};for(const a of e)t[a.method]||(t[a.method]={}),t[a.method][a.commodity]||(t[a.method][a.commodity]=[]),null!==a.lot_number?(1===t[a.method][a.commodity].length&&null===t[a.method][a.commodity][0].lot_number&&(t[a.method][a.commodity]=[]),t[a.method][a.commodity].push(a)):null===a.lot_number&&0===t[a.method][a.commodity].length&&t[a.method][a.commodity].push(a);console.log(`[evaluateAnalyticalAssay] group: ${JSON.stringify(t)}}`);const o={};for(const e in t){console.log(`[evaluateAnalyticalAssay] methodKey: ${e}, group[methodKey]: ${JSON.stringify(t[e])}`);for(const n in t[e]){console.log(`[evaluateAnalyticalAssay] commodityKey: ${n}, group[methodKey][commodityKey]: ${JSON.stringify(t[e][n])}`),o[e]=null!=(a=o[e])?a:{},o[e][n]={};const r=t[e][n].reduce(((e,a)=>e+parseFloat(a.dry_weight)),0);if(console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${r} from ${JSON.stringify(t[e][n])}`),0===r||isNaN(r))throw i.value=`Please provide dry weight for ${n} commodity in ${e} method, total dry weight cannot be ${r}`,new Error("[evaluateAnalyticalAssay] totalDryWeight is 0");console.log(`[evaluateAnalyticalAssay] totalDryWeight: ${r}`),o[e][n].analytical_assay=t[e][n].reduce(((a,t)=>{var o,r,l;const s=parseFloat(null!=(r=t.final_assay)?r:null!=(o=t.seller_assay)?o:t.buyer_assay);if(null==s)throw i.value=`Please provide Final, Seller or Buyer assay value for ${n} commodity in ${e} method`,new Error("[evaluateAnalyticalAssay] assay value is not defined for assay lot");const c=a+s*parseFloat(null!=(l=t.dry_weight)?l:"0");return console.log(`[evaluateAnalyticalAssay] evaluated analytical assay: ${c} for method=${e}, commodity=${n}; with values accumulator=${a}, assayValue=${s}, dryWeight=${t.dry_weight}`),c}),0)/r,console.log(`[evaluateAnalyticalAssay] analytical assay: ${o[e][n].analytical_assay}`),t[e][n].length>0&&(o[e][n][me]=t[e][n][0][me])}}return console.log(`[evaluateAnalyticalAssay] analyticalAssay: ${JSON.stringify(o)}`),o}(_t.data.data);let $t;if($t||($t=gt.Outturn),$t||($t=gt["Inturn Final"]),$t||($t=gt.Inturn),$t||($t=gt.Estimated),$t||($t=gt.Planned),!$t)throw new Error(`No assay lot data with a valid method found for parcel ${Ka[oe]}`);console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] weight lots for invoice evaluation=${JSON.stringify(it)}`),console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] assay lots for invoice evaluation=${JSON.stringify($t)}`);const wt=await s.get(`/items/${we}/${Za}`,{params:{fields:[De]}});!function(e){if(!e)throw new Error("Contract data not found, please ensure the selected contract still exists");if(!e[De])throw new Error("The selected contract does not have a set currency, please ensure that the currency field for the contract is not empty")}(wt.data.data);const Dt=await s.get(`/items/${ba}/${wt.data.data.contract_currency}`,{params:{fields:[Pa]}});!function(e){if(!e)throw new Error("Currency data not found, please ensure the selected currency still exists");if(!e[Pa])throw new Error("The selected currency in the contract is not valid")}(Dt.data.data);const Et=Dt.data.data.code,bt=await s.get(`/items/${Ue}?filter[${Be}]=${Za}`,{params:{fields:["id",ke,je,Fe,Ve,Re,We,Le,Ge,He,xe,Je,qe]}});!function(e){if(!e||0===e.length)throw new Error("No commodity data found in selected contract for parcel");if(!e.every((e=>e[ke])))throw new Error("The selected contract has an undefined commodity, please ensure that the 'Commodity' field for all commodites in the contract is not empty");if(!e.every((e=>!e[Fe]||e[xe])))throw new Error("The selected contract has an undefined base price Uom for commodity, please ensure that the 'Base Price Uom' field for all commodites in the contract is not empty")}(bt.data.data),console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] contract commodity data=${JSON.stringify(bt.data.data)}`);const Pt=[],Ct=[];let St="";for(const{id:e,commodity:i,primary_commodity:r,price_method:d,price_fix_to_use:$,quotational_periods:V,price_per_uom:R,penalty_per_uom:x,treatment_charge_per_uom:q,refining_charge_rate_uom:W}of bt.data.data){const L=await s.get(`/items/${wa}/${i}`,{params:{fields:[Da,Ea,F]}});if(mt(L.data.data,i),!$t[L.data.data.code]){console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}::comm=${L.data.data[Da]}] no analytical assay for commodity ${L.data.data.code} found, skipping...`);continue}if(r&&(St=L.data.data[Da]),null!==V){const i=V;console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}::comm=${L.data.data[Da]}] qp=${JSON.stringify(i)}`);const r=Array.isArray(i)?i.find((e=>e.default)):null;if(!r)throw new Error(`No default quotational period found for commodity ${L.data.data.code}`);const S=i.filter((e=>!e.default)).map((e=>`${e.qp_period} ${e.qp_code}`)),x=[`${r.qp_period} ${r.qp_code}`,...S].join(", ");console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}::comm=${L.data.data[Da]}] evaluate payable assay for ${L.data.data.code} with an analytical assay=${null==(a=$t[L.data.data.code])?void 0:a.analytical_assay}`);const G=await s.get(`/items/${Qe}?filter[${aa}]=${e}`,{params:{fields:[ta,oa,na,ia,ra,la,sa,Ke,Ye,Xe,ze,Ze,ea]}}),{payableAssay:H,expression:Q}=await E(null==(t=$t[L.data.data.code])?void 0:t.analytical_assay,null==(o=$t[L.data.data.code])?void 0:o.assay_uom,G.data.data,L.data.data[Da]);let K=null,Y=null,z=null;if("Final"!==La){const e=await st(L.data.data.code,L.data.data.name,Ka,d,(async()=>ct(r,Ka,Ya,L.data.data[Da])));if(null===e)throw new Error(`Pricing dates not found for commodity ${L.data.data.code} for parcel ${Ka[oe]}`);if(null===e.provisionalPricingStartDate||!(e.provisionalPricingStartDate instanceof Date))throw new Error(`Invalid provisional pricing start date for commodity ${L.data.data.code} of invoice type ${La} in parcel ${Ka[oe]}`);if(K=e.provisionalPricingStartDate,null===e.provisionalPricingEndDate||!(e.provisionalPricingEndDate instanceof Date))throw new Error(`Invalid provisional pricing end date for commodity ${L.data.data.code} of invoice type ${La} in parcel ${Ka[oe]}`);Y=e.provisionalPricingEndDate,z=e.expectedNoOfBusinessDays}else{const e=await st(L.data.data.code,L.data.data.name,Ka,d,(async()=>ct(r,Ka,Ya,L.data.data[Da])));if(null===e)throw new Error(`Pricing dates not found for commodity ${L.data.data.code} for parcel ${Ka[oe]}`);if(null===e.provisionalPricingStartDate||!(e.provisionalPricingStartDate instanceof Date))throw new Error(`Invalid provisional pricing start date for commodity ${L.data.data.code} of invoice type ${La} in parcel ${Ka[oe]}`);if(K=e.provisionalPricingStartDate,null===e.provisionalPricingEndDate||!(e.provisionalPricingEndDate instanceof Date))throw new Error(`Invalid provisional pricing end date for commodity ${L.data.data.code} of invoice type ${La} in parcel ${Ka[oe]}`);Y=e.provisionalPricingEndDate}console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}::comm=${L.data.data[Da]}] provisional pricing date range: ${K.toString()} - ${Y.toString()}`);const ee=await ft(L.data.data.code,L.data.data[F],d,K,Y,z,$),ae=ee.averagePrice;let te;K=ee.startDate,Y=ee.endDate,console.log(`[generateInvoice] average price within period: ${ae} with start date=${K} and end date=${Y}`);const ne=await s.get(`/items/${ca}?filter[${ya}]=${e}`,{params:{fields:[oa,na,ia,ra,da,ua,fa,ma,pa,la]}});let re,le;if(void 0!==ne.data.data&&null!==ne.data.data&&ne.data.data.length>0&&(te=await C(ae,null==(n=$t[L.data.data.code])||n.assay_uom,ne.data.data,L.data.data[Da],"treatment charge")),te){if(!q)throw new Error(`Treatment Charge Rate UOM is not defined for commodity ${L.data.data[Da]}`);const e=await s.get(`/items/${Ca}/${q}`,{params:{fields:[Sa]}});yt(e.data.data,L.data.data[Da]),re=e.data.data[Sa]}const se=await s.get(`/items/${ca}?filter[${ha}]=${e}`,{params:{fields:[oa,na,ia,ra,da,ua,fa,ma,pa,la]}});let ce;if(void 0!==se.data.data&&null!==se.data.data&&se.data.data.length>0&&(le=await C(ae,null==(l=$t[L.data.data.code])||l.assay_uom,se.data.data,L.data.data[Da],"refining charge")),le){if(!W)throw new Error(`Refining Charge Rate UOM is not defined for commodity ${L.data.data[Da]}`);const e=await s.get(`/items/${Ca}/${W}`,{params:{fields:[Sa]}});yt(e.data.data,L.data.data[Da]),ce=e.data.data[Sa]}const de=await s.get(`/items/${Ca}/${R}`,{params:{fields:[Sa]}});pt(de.data.data,L.data.data[Da]);const ue=de.data.data[Sa],fe=await j(ue,it.dry_weight_uom,null==(c=$t[L.data.data.code])?void 0:c.assay_uom);console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}::comm=${L.data.data[Da]}] payableMetalConversion for commodity ${L.data.data.name}: ${JSON.stringify(fe)}`),fe.initialConversion=1===(null==(u=fe.initialConversion)?void 0:u.conversionFactor)?void 0:fe.initialConversion,fe.finalConversion=1===(null==(f=fe.finalConversion)?void 0:f.conversionFactor)?void 0:fe.finalConversion;const me=(null==(m=fe.initialConversion)?void 0:m.isConvertByMultiplication)?null!=(h=null==(y=fe.initialConversion)?void 0:y.conversionFactor)?h:1:1/(null!=(_=null==(v=fe.initialConversion)?void 0:v.conversionFactor)?_:1),pe=(null==(w=fe.finalConversion)?void 0:w.isConvertByMultiplication)?null!=(b=null==(D=fe.finalConversion)?void 0:D.conversionFactor)?b:1:1/(null!=(N=null==(P=fe.finalConversion)?void 0:P.conversionFactor)?N:1),ye=null!=(O=g(it.dry_weight*me*(null!=H?H:1)*pe*("%"!==(null==(M=$t[L.data.data.code])?void 0:M.assay_uom)?1:.01),4))?O:1;console.log(`[generateInvoice] PAYABLE_METAL for commodity ${L.data.data.name}: ${ye}`);const he=ye*ae;Pt.push({commodity:L.data.data.name,analytical_assay:p(null==(T=$t[L.data.data.code])?void 0:T.analytical_assay,4),deduction_expression:Q,payable_assay:p(H,4),assay_uom:null==(I=$t[L.data.data.code])?void 0:I.assay_uom,payable_metal:p(ye,4),payable_metal_expression:`${p(it.dry_weight,4)}${it.dry_weight_uom}${fe.initialConversion?` ${fe.initialConversion.isConvertByMultiplication?"*":"/"} ${p(fe.initialConversion.conversionFactor,4)}${fe.initialConversion.conversionUom}`:""} * ${p(null!=H?H:1,4)}${"%"!==(null==(U=$t[L.data.data.code])?void 0:U.assay_uom)?`${null==(B=$t[L.data.data.code])?void 0:B.assay_uom}`:" / 100"}${fe.finalConversion?` ${fe.finalConversion.isConvertByMultiplication?"*":"/"} ${p(fe.finalConversion.conversionFactor,4)}${fe.finalConversion.conversionUom}`:""}`,payable_metal_uom:ue,qp:x,qp_start_date:A(K),qp_end_date:A(Y),price_method:d,price_rate:p(ae,4),price_per_uom:ue,price:p(he),treatment_charge:te?{rate:p(te.baseTreatmentCharge,4),discount:p((null!=(k=te.baseTreatmentCharge)?k:0)-(null!=(J=te.finalValue)?J:0),4),final_rate:p(te.finalValue,4),per_uom:re,final_amount:p(g(it.dry_weight*(null!=(X=te.finalValue)?X:1)*-1,2,!0))}:void 0,refining_charge:le?{rate:p(le.baseTreatmentCharge,4),discount:p((null!=(Z=le.baseTreatmentCharge)?Z:0)-(null!=(ie=le.finalValue)?ie:0),4),final_rate:p(le.finalValue,4),per_uom:ce,final_amount:p(g(ye*(null!=(Ee=le.finalValue)?Ee:1)*-1,2,!0))}:void 0,final_total:g(he-(te?1:0)*(null!=(Ia=g(it.dry_weight*(null!=(Ta=null==te?void 0:te.finalValue)?Ta:1),2))?Ia:1)-(le?1:0)*(null!=(Ba=g(it.dry_weight*(null!=(Ua=null==le?void 0:le.finalValue)?Ua:1),2))?Ba:1))})}const G=await s.get(`/items/${va}?filter[${aa}]=${e}`,{params:{fields:[oa,na,ia,ra,_a,ga,$a,la]}});if(G.data.data.length>0){if(null===x)throw new Error(`Please fill in the field for Penalty Per UOM in contract ${Ya} for commodity ${L.data.data[Da]}`);const e=await s.get(`/items/${Ca}/${x}`,{params:{fields:[Sa]}});ht(e.data.data,L.data.data[Da]);const a=e.data.data[Sa],{penalty:t,expression:o,bracket:n}=await S(null==(ka=$t[L.data.data.code])?void 0:ka.analytical_assay,G.data.data,Et,a,L.data.data[Da]);console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}::comm=${L.data.data[Da]}] evaluated penalty with an analytical assay=${null==(Ja=$t[L.data.data.code])?void 0:Ja.analytical_assay}, penaltyRate=${null==n?void 0:n.rate}, finalPenaltyRate=${t}, expression='${o}'`),Ct.push({commodity:L.data.data.name,analytical_assay:p(null==(qa=$t[L.data.data.code])?void 0:qa.analytical_assay,4),deduction_expression:o,assay_uom:null==(Wa=$t[L.data.data.code])?void 0:Wa.assay_uom,penalty_rate:p(null==n?void 0:n.rate,4),penalty_per_uom:a,final_penalty_rate:p(t,4),final_penalty:p((null!=t?t:1)*it.dry_weight)})}}console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] evaluated commodities=${JSON.stringify(Pt)}`),console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] evaluated penalties${JSON.stringify(Ct)}`);const At=Pt.reduce(((e,a)=>e+$(a.price)),0),Nt=Pt.reduce(((e,a)=>{var t;return e+$(null==(t=a.treatment_charge)?void 0:t.final_amount)}),0),Mt=Pt.reduce(((e,a)=>{var t;return e+$(null==(t=a.refining_charge)?void 0:t.final_amount)}),0),Ot=Ct.reduce(((e,a)=>e+$(a.final_penalty)),0);console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] TOTAL_REVENUE=${At}, TOTAL_TREATMENT_CHARGE=${Nt}, TOTAL_REFINING_CHARGE=${Mt}, TOTAL_PENALTIES=${Ot}`);let Tt,It=0;const Ut=!!Ka[ne];Ut&&(It=Ka[ne].reduce(((e,a)=>e+a.amount),0),Tt={adjustments:Ka[ne].map((e=>({description:e.description,amount:p(e.amount)}))),total_adjustments:p(It)});const Bt=at[Se],kt=At+Nt+Mt+Ot+It,jt=null!=Bt?kt*Bt/100:void 0,Ft=await s.get(`/items/${ja}/${Ka[L]}`,{params:{fields:[Fa]}});vt(Ft.data.data);const Vt=Ka[ee];let Rt;Vt&&(Rt=await s.get(`/items/${Ra}/${Vt}`,{params:{fields:[xa]}}),function(e){if(console.log("[validateVessel]"),!e)throw new Error("Vessel for parcel not found");if(!e[xa])throw new Error("No name defined for vessel of the selected parcel")}(Rt.data.data));let xt=(await s.get(`/items/${Ga}?filter[${Ha}]=${r}`,{params:{fields:["id",Qa]}})).data.data.reduce(((e,a)=>e+(a[Qa]?1:0)),0)+1,Jt=r;const qt=xt.toString().padStart(2,"0"),Wt=(Ka[oe],Jt.toString().padStart(2,"0")),Lt={Parcel:`${Ka[oe]} (#${Wt})`,Counterparty:Ft.data.data[Fa],Vessel:Rt?Rt.data.data[xa]:"Vessel TBA","Shipment Date":Ka[Y]?A(new Date(Ka[Y])):Ka[z]?A(new Date(Ka[z])):"N/A","Arrival Date":Ka[Q]?A(new Date(Ka[Q])):Ka[K]?A(new Date(Ka[K])):"N/A",Status:Ka[Y]?"Unfinalised":"Planned",Revision:"Valuation",Invoice:`${La}:Valuation`,"Invoice Due Date":A(e.dueDate),"Dry Weight":`${p(it.dry_weight,2)}`,...await dt(Pt,{dryWeight:it.dry_weight,dryWeightUom:it.dry_weight_uom}),"Total Revenues USD":p(At),"Total Penalties USD":p(Ot+Nt+Mt),"Total Adjustments USD":Ut?Tt.total_adjustments:"0.00","Parcel Value USD":p(kt),"Parcel Payable Value USD":p(jt),"Payments USD":"-","Due Total":"-",metadata:{invoiceTypeRanking:ot[La]}};return console.log(`[generateInvoice][parcel=${Ka[oe]}::invoice type=${La}] generated forecast invoice=${JSON.stringify(Lt)}`),Lt}catch(a){if(a instanceof rt)return void console.error(`[generateInvoice][parcel=${e.parcelId}::invoice type=${e.invoiceType}]Non-fatal error: ${a.message}`);throw new Error(a.message+` (parcel ${e.parcelId}, invoice type ${e.invoiceType})`)}}(e))))),n=function(e){const a=e.reduce(((e,a)=>(e[a.Parcel]||(e[a.Parcel]=[]),e[a.Parcel].push(a),e)),{});Object.keys(a).forEach((e=>{a[e].sort(((e,a)=>e.metadata.invoiceTypeRanking<a.metadata.invoiceTypeRanking?-1:e.metadata.invoiceTypeRanking>a.metadata.invoiceTypeRanking?1:0))})),console.log(`[evaluateDuePaymentsForCashflow] cashflowByParcel=${JSON.stringify(a)}`),Object.keys(a).forEach((e=>{a[e].forEach(((t,o)=>{if(!t["Parcel Payable Value(Below Line) USD"]||"-"===t["Parcel Payable Value(Below Line) USD"])throw new Error(`Parcel ${e} for invoice ${t.Invoice} does not have a Parcel Payable Value(Below Line) USD`);const n=$(t["Parcel Payable Value(Below Line) USD"]);if(isNaN(n))throw new Error(`Parcel ${e} for invoice ${t.Invoice} has an invalid Parcel Payable Value(Below Line) USD of ${t["Parcel Payable Value(Below Line) USD"]}`);if(0===o){t["Payments USD"]=t["Payments USD"]&&"-"!==t["Payments USD"]?t["Payments USD"]:"0.00";const e=$(t["Payments USD"]);t["Due Total"]=p(n-e)}else{if(!a[e][o-1]["Parcel Payable Value(Below Line) USD"]||"-"===a[e][o-1]["Parcel Payable Value(Below Line) USD"])throw new Error(`Parcel ${e} for invoice ${t.Invoice} does not have a Parcel Payable Value(Below Line) USD for the previous invoice`);const i=$(a[e][o-1]["Parcel Payable Value(Below Line) USD"]);if(isNaN(i))throw new Error(`Parcel ${e} for invoice ${t.Invoice} has an invalid Parcel Payable Value(Below Line) USD of ${a[e][o-1]["Parcel Payable Value(Below Line) USD"]} for the previous invoice`);t["Due Total"]=p(n-i),t["Payments USD"]&&"-"!==t["Payments USD"]||(t["Payments USD"]=a[e][o-1]["Payments USD"])}}))})),console.log(`[evaluateDuePaymentsForCashflow] cashflowByParcel=${JSON.stringify(a)}`);const t=Object.keys(a).flatMap((e=>a[e]));return console.log(`[evaluateDuePaymentsForCashflow] cashflowAsJsonWithDueTotal=${JSON.stringify(t)}`),t}(o.filter((e=>!!e))),l=n.map((e=>(delete e.metadata,e))),u=nt(l);t("input",l),console.log(`[generateCashflow] cashflow response: ${JSON.stringify(l)}`),console.log(`[generateCashflow] cashflow as csv: ${u}`),r.value=!1,lt(u)}catch(e){i.value=e.message}finally{r.value=!1}},downloadDoc:lt,copy:async function(){l.value=!0;const{id:e,user_created:a,date_created:t,user_updated:o,date_updated:n,cashflow:r,forecast_price:d,...u}=c.value,f=await s.get(`/items/${za}`,{params:{filter:{[F]:{_in:d}},fields:[Za,at,tt,et]}}),m=await s.post(`items/${za}`,f.data.data);if(200!==m.status)return console.log(`[cashflow::copy] duplicate forecast prices response status: ${m.status}`),void(i.value=`Failed to duplicate forecast prices with status ${m.status}`);const p=m.data.data.map((e=>e.id));console.log(`[cashflow::copy] duplicated forecast prices id=${JSON.stringify(p)}`),console.log(`[cashflow::copy] requestBody=${JSON.stringify(u)}`);const y=await s.post("/items/"+J,{forecast_price:p,...u});if(200!==y.status)return console.log(`[cashflow::copy] copy response status: ${y.status}`),void(i.value=`Failed to duplicate cashflow with status ${y.status}`);l.value=!1,window.open(`/admin/content/${J}/${y.data.data.id}`)},isCopying:l,failureReason:i};function lt(e){let a;a=m(e)?nt(c.value.cashflow):e,console.log(`[downloadDoc] csvData=${a}`),it(a)}async function st(e,a,t,o,n,i=!1){if(null===n&&(m(t[Z])||m(t[Z][e])))throw new Error(`QP Selection is not set for commodity ${a} in the parcel ${t[oe]}, please ensure all contract commodities have a QP selection`);if(m(t[Z])||m(t[Z][e]))return await n();const r=await async function(e,a,t,o){var n,i;if(o&&!e.declared)return null;const r=null==e?void 0:e.qp_selected;if(!r)return null;const l=r.split(" "),s={qp_period:parseInt(l[0]),qp_code:l[1]};let c,d,u,f;switch(s.qp_code){case"MAMA":c=null!=(n=a[Q])?n:a[K],d="Actual/Estimated Arrival Date";break;case"MOSS":c=a[z],d="Estimated Shipment Date";break;case"MOS":case"MOAS":c=null!=(i=a[Y])?i:a[z],d="B/L Date (or Estimated Shipment Date)";break;default:throw new Error(`Unsupported QP code ${s.qp_code} in the contract commodities, please ensure all commodity QP codes are MAMA, MOS, MOSS, or MOAS`)}if(m(c))throw new Error(`Please fill in a date for the field '${d}' for the Parcel form, for QP: ${r}`);const p=new Date(c);if(u=T(p,s.qp_period),u.valueOf()>Date.now())return null;return f=I(p,s.qp_period),{provisionalPricingStartDate:u,provisionalPricingEndDate:f,expectedNoOfBusinessDays:null}}(t[Z][e],t,0,i);return r||await n()}async function ct(e,a,t,o){var n,i;let r,l,s,c;switch(e.qp_code){case"MAMA":c=null!=(n=a[Q])?n:a[K],r="Actual/Estimated Arrival Date";break;case"MOSS":case"MOS":case"MOAS":c=null!=(i=a[Y])?i:a[z],r="B/L Date (Estimated Shipment Date)";break;default:throw new Error(`Unsupported QP code ${e.qp_code} in the contract ${t}, please ensure all commodity QP codes are MAMA, MOS, MOSS, or MOAS`)}if(m(c))throw new Error(`No reference day provided for ${r} from contract ${t} for commodity ${o}`);const d=new Date(c);return l=T(d,e.qp_period),s=I(d,e.qp_period),{provisionalPricingStartDate:l,provisionalPricingEndDate:s,expectedNoOfBusinessDays:null}}async function dt(e,a){console.log(`[mapOutCommoditiesForCashflow] commodities=${JSON.stringify(e)};;containedMetalParam=${JSON.stringify(a)}`);return(await Promise.all(e.map((async e=>{var t,o,n,i,r,l,s,c,d,u;const f=await j(e.payable_metal_uom,a.dryWeightUom,e.assay_uom);console.log(`[mapOutCommoditiesForCashflow] commodity=${e.commodity}, containedMetalUnitConversion=${JSON.stringify(f)}`);const m=((null==(t=f.initialConversion)?void 0:t.isConvertByMultiplication)?null!=(n=null==(o=f.initialConversion)?void 0:o.conversionFactor)?n:1:1/(null!=(r=null==(i=f.initialConversion)?void 0:i.conversionFactor)?r:1))*((null==(l=f.finalConversion)?void 0:l.isConvertByMultiplication)?null!=(c=null==(s=f.finalConversion)?void 0:s.conversionFactor)?c:1:1/(null!=(u=null==(d=f.finalConversion)?void 0:d.conversionFactor)?u:1)),y=("%"===e.assay_uom?.01:1)*e.analytical_assay;return{[`${e.commodity} Payable Metal (${e.payable_metal_uom})`]:e.payable_metal,[`${e.commodity} Contained Metal (${e.payable_metal_uom})`]:p(a.dryWeight*y*m),[`${e.commodity} Revenue (USD)`]:e.price,[`${e.commodity} QP Month`]:ut(new Date(e.qp_start_date)),[`${e.commodity} Price (USD/${e.price_per_uom})`]:e.price_rate,...!!e.treatment_charge&&{[`${e.commodity} TC (USD)`]:e.treatment_charge.final_amount,[`${e.commodity} TC (USD/${e.treatment_charge.per_uom})`]:e.treatment_charge.final_rate},...!!e.refining_charge&&{[`${e.commodity} RC (USD)`]:e.refining_charge.final_amount,[`${e.commodity} RC (USD/${e.refining_charge.per_uom})`]:e.refining_charge.final_rate}}})))).reduce(((e,a)=>({...e,...a})),{})}function ut(e){return`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e.getMonth()]} ${e.getFullYear()}`}async function ft(e,a,t,o,n,i,r=null,l=1){var d;if(console.log(`[getCommodityAvgPrice] commodity=${e}, commodityId=${a}, source=${t}, startDate=${o}, endDate=${n}, currency=${l}`),m(e))throw new Error(`Commodity ${e} is not defined for price calcualtion`);if(m(t))throw new Error(`Price method for commodity ${e} is not defined for price calcualtion`);if(m(o))throw new Error(`Start date is not defined for price calcualtion with Price Method #${t} has not been properly defined, please ensure that contract QP for commodity ${e} is properly defined`);if(m(n))throw new Error(`End date is not defined for price calcualtion with Price Method #${t} has not been properly defined, please ensure that contract QP for commodity ${e} is properly defined`);const u=new Date(o.valueOf());null===i||isNaN(i)||u.setDate(u.getDate()-10);const f=await s.get(`/items/navarch_commodity_price?filter[_and][0][price_method][_eq]=${t}&filter[_and][0][currency][_eq]=${l}&filter[_and][1][date][_between][0]=${N(u)}&filter[_and][1][date][_between][1]=${N(n)}&sort[]=-${La}`,{params:{fields:[Ja,qa,Wa,La,"price_method"]}});if((null==(d=f.data)?void 0:d.data)&&Array.isArray(f.data.data)&&f.data.data.length>0){const a=f.data.data[f.data.data.length-1],l=new Date(a[La]);if(console.log(`[getCommodityAvgPrice] commodity prices=${JSON.stringify(f.data.data)}`),l>=n){if(null!=i&&f.data.data.length<i)throw new Error(`Not enough commodity prices found for commodity ${e} between ${N(o)} and ${N(n)}, please contact Navarch for support`);const a=null===i||isNaN(i)?f.data.data:f.data.data.slice(0,i),l=a.reduce(((a,o)=>{if(!o[Wa]&&!o[qa]&&!o[Ja])throw new Error(`Commodity ${e} for Price Method #${t} on the date of ${o[La]} does not have a price, please contact Navarch for assistance`);let n;if("PM"===r){if(null===o[qa])throw new Error(`The price data for the commodity ${e} does not have a Closing Price (PM) for the date of ${o[La]}, please choose another price fix or provide a Price PM for this date`);n=Number(o[qa])}else if("AM"===r){if(null===o[Ja])throw new Error(`The price data for the commodity ${e} does not have an Opening Price (AM) for the date of ${o[La]}, please choose another price fix or provide a Price AM for this date`);n=Number(o[Ja])}else if("Average"===r){if(null===o[Wa])throw new Error(`The price data for the commodity ${e} does not have an Average Price for the date of ${o[La]}, please choose another price fix or provide an Average Price for this date`);n=Number(o[Wa])}else if(null!==o[Wa])n=Number(o[Wa]);else if(null!==o[qa])n=Number(o[qa]);else{if(null===o[Ja])throw new Error(`The commodity price for ${e} of Price Method #${t} for the date of ${o[La]} is not a valid number, please contact Navarch for assistance`);n=Number(o[Ja])}return a+n}),0)/a.length;return console.log(`[getCommodityAvgPrice] average price=${l} for commodity ${e} between ${N(o)} (with over-adjusted start date of ${N(u)}) and ${N(n)}`),{averagePrice:l,startDate:new Date(a[a.length-1][La]),endDate:new Date(a[0][La])}}console.log(`[getCommodityAvgPrice] latest comm price date=${l} is before end date=${n}, getting forecast price`)}if(!c.value[F])throw new Error("Please save the Cashflow form first before generating the cashflow doc");const p=await s.get(`/items/${za}`,{params:{filter:{[Za]:{_eq:a},cashflow_forecast_id:{_eq:c.value[F]}},fields:[et,Za,at,tt]}});!function(e,a){if(!e||!Array.isArray(e)||0===e.length)throw new Error(`No forecast price found for ${a}, please ensure prices have been provided`)}(p.data.data,e);const y=p.data.data.find((e=>{const a=new Date(e[at]),t=new Date(e[tt]);return a<=o&&t>=n}));if(!y)throw new Error(`No single forecast price found for commodity ${e} between ${N(o)} and ${N(n)}, please ensure there is only one price value for this range`);return console.log(`[getCommodityAvgPrice] forecast price=${y[et]} for commodity ${e} between ${N(o)} and ${N(n)}`),{averagePrice:y[et],startDate:o,endDate:n}}function mt(e,a){var t,o,n;if(console.log("[validateCommodityData]"),!e)throw new Error("commodity data response is null");if(!e[Da])throw new Error(`Commodity name for commodity ${null!=(t=e[Ea])?t:a} is undefined, please contact Navarch for assistance`);if(!e[Ea])throw new Error(`Commodity code for commodity ${null!=(o=e[Da])?o:a} is not defined, please contact Navarch for assistance`);if(!e[F])throw new Error(`Commodity ID for commodity ${null!=(n=e[Da])?n:a} is not defined, please contact Navarch for assistance`)}function pt(e,a){if(!e)throw new Error(`Price per UOM for commodity ${a} is not a valid`);if(!e[Sa])throw new Error(`Price per UOM for commodity ${a} does not have a valid unit symbol, please contact Navarch for assistance`)}function yt(e,a){if(!e)throw new Error(`Charge per UOM for commodity ${a} is not a valid`);if(!e[Sa])throw new Error(`Charge per UOM for commodity ${a} does not have a valid unit symbol, please contact Navarch for assistance`)}function ht(e,a){if(!e)throw new Error(`Penalty per UOM for commodity ${a} is not a valid`);if(!e[Sa])throw new Error(`Penalty per UOM for commodity ${a} does not have a valid unit symbol, please contact Navarch for assistance`)}function vt(e){if(console.log("[validateCounterparty]"),!e)throw new Error("Counterparty for parcel not found");if(!e[Fa])throw new Error("No codename defined for counterparty of the selected parcel")}}});const $={key:0},w={key:1};var D=[],E=[];!function(e,a){if(e&&"undefined"!=typeof document){var t,o=!0===a.prepend?"prepend":"append",n=!0===a.singleTag,i="string"==typeof a.container?document.querySelector(a.container):document.getElementsByTagName("head")[0];if(n){var r=D.indexOf(i);-1===r&&(r=D.push(i)-1,E[r]={}),t=E[r]&&E[r][o]?E[r][o]:E[r][o]=l()}else t=l();65279===e.charCodeAt(0)&&(e=e.substring(1)),t.styleSheet?t.styleSheet.cssText+=e:t.appendChild(document.createTextNode(e))}function l(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),a.attributes)for(var t=Object.keys(a.attributes),n=0;n<t.length;n++)e.setAttribute(t[n],a.attributes[t[n]]);var r="prepend"===o?"afterbegin":"beforeend";return i.insertAdjacentElement(r,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),g.render=function(e,a,t,o,n,y){const h=i("v-button"),v=i("v-notice");return r(),l(s,null,[c(' <input :value="value" @input="handleChange($event.target.value)" /> '),c(" create a button only interface for Directus"),e.value?(r(),l("div",w,[d(h,{onClick:a[1]||(a[1]=()=>e.downloadDoc())},{default:u((()=>[f("Download Cashflow ")])),_:1})])):(r(),l("div",$,[d(h,{onClick:a[0]||(a[0]=()=>e.generateCashflow()),loading:e.isGeneraingDoc},{default:u((()=>[f("Generate Cashflow")])),_:1},8,["loading"]),e.failureReason?(r(),m(v,{key:0},{default:u((()=>[f(p(e.failureReason),1)])),_:1})):c("v-if",!0)])),d(h,{class:"margin-top-16px",onClick:a[2]||(a[2]=()=>e.copy()),loading:e.isCopying},{default:u((()=>[f("Copy")])),_:1},8,["loading"])],64)},g.__scopeId="data-v-64969d30",g.__file="src/interface.vue";var b=a({id:"navarch-docgen-cashflow",name:"Navarch Cashflow Generator Button",icon:"receipt_long",description:"This is my custom interface for Navarch's Cashflow Doc!",component:g,options:null,types:["json"],group:"standard"});export{b as default};
