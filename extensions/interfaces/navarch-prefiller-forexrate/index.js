import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,ref as r,inject as n,resolveComponent as o,resolveDirective as l,openBlock as c,createElementBlock as i,Fragment as d,createElementVNode as s,createBlock as u,withCtx as f,withDirectives as h,createVNode as v,normalizeClass as p,createTextVNode as m,toDisplayString as g,createCommentVNode as x}from"vue";const y="contract",C="contract_currency",w="local_currency",_="navarch_currency",N="code";var b=a({props:{value:{type:String,default:null}},emits:["input"],setup(t,{emit:a}){const o=r(t.value?Number(t.value):null),l=r(!1),c=r(null),i=r(),d=r(new Date),s=r(!1),u="navarch_forex_rate",f="date",h="exchange_rate",v="currency_source",p="currency_target",m=e(),g=n("values",r({}));return{isCustomEditState:s,forexRate:o,isFetchingForexData:l,dateTimeMenu:i,selectedDate:d,failureReason:c,fetchForexRate:async function(e=null){console.log("[navarch-prefiller-forexrate] fetchForexRate started with newDate:",e),l.value=!0,c.value=null;const t=e||null;if(console.log("[navarch-prefiller-forexrate] new date:",t),!t)return console.log("[navarch-prefiller-forexrate] No date selected and none found in the Invoice Date field either, cannot fetch forex rate."),void(l.value=!1);d.value=new Date(t);const r=g.value.parcel;if(!r)return console.log("[navarch-prefiller-forexrate] No Parcel ID found in the Invoice Parcel field, cannot fetch forex rate."),l.value=!1,void(c.value="No Parcel ID found in the Invoice Parcel field.");const n=await m.get(`/items/navarch_parcel/${r}`,{params:{fields:[y]}});if(!(n&&n.data&&n.data.data&&n.data.data[y]))return console.log("[navarch-prefiller-forexrate] No contract found for the Parcel, cannot fetch forex rate."),l.value=!1,void(c.value="Selected parcel does not have an associated contract.");const i=n.data.data[y],s=await m.get(`/items/navarch_contract/${i}`,{params:{fields:[C,w]}});if(!s||!s.data||!s.data.data)return console.log("[navarch-prefiller-forexrate] No contract found for the Parcel, cannot fetch forex rate."),l.value=!1,void(c.value="No contract found for the Parcel.");const x=s.data.data[w];if(!x)return console.log("[navarch-prefiller-forexrate] No local currency found in the contract."),l.value=!1,void(c.value="Please set a Local Currency in the Tax section of the associated contract.");const b=s.data.data[C];if(!b)return console.log("[navarch-prefiller-forexrate] No currency found in the contract."),l.value=!1,void(c.value="Please set a Contract Currency in the Finance section of the associated contract.");const S=await async function(e,t=391,a=1){console.log("[navarch-prefiller-forexrate] fetchForexRateForDate called with date:",e,"currencySource:",t,"currencyTarget:",a);const r=await m.get("/items/"+u,{params:{filter:{[f]:{_eq:e},[v]:{_eq:t},[p]:{_eq:a}},fields:[h,v,p]}});if(!r||!r.data||!r.data.data||0===r.data.data.length)return console.log("[navarch-prefiller-forexrate] No forex rate found for the given date and currencies."),null;return console.log("[navarch-prefiller-forexrate] Forex rate fetched successfully:",JSON.stringify(r.data.data[0])),r.data.data[0]}(t,x,b);if(!S||!S[h]){const e=await m.get(`/items/${_}/${x}`,{params:{fields:[N]}}),a=await m.get(`/items/${_}/${b}`,{params:{fields:[N]}}),r=e.data.data[N]&&a.data.data[N]?`${e.data.data[N]} to ${a.data.data[N]}`:"the selected currencies in the contract";return void(c.value=`No currency rate found for the date of ${t} for ${r}.`)}o.value=Number(S[h]),console.log("[navarch-prefiller-forexrate] Forex rate value fetched:",o.value),a("input",o.value),l.value=!1},handleChange:async function(e){console.log("[navarch-prefiller-forexrate] handleChange called with event:",JSON.stringify(e)),c.value=null,isNaN(e)?(console.log("[navarch-prefiller-forexrate] handleChange emitting null value"),o.value=null):(console.log("[navarch-prefiller-forexrate] handleChange emitting value:",e),o.value=Number(e));a("input",o.value),console.log("[navarch-prefiller-forexrate] handleChange done")}}}});const S={class:"row"};var k=[],E=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,r=!0===t.prepend?"prepend":"append",n=!0===t.singleTag,o="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(n){var l=k.indexOf(o);-1===l&&(l=k.push(o)-1,E[l]={}),a=E[l]&&E[l][r]?E[l][r]:E[l][r]=c()}else a=c();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function c(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),n=0;n<a.length;n++)e.setAttribute(a[n],t.attributes[a[n]]);var l="prepend"===r?"afterbegin":"beforeend";return o.insertAdjacentElement(l,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}\n.row[data-v-64969d30] {\n  display: flex;\n  flex-direction: row;\n  justify-content: space-between;\n  align-items: center;\n  gap: 16px;\n}",{}),b.render=function(e,t,a,r,n,y){const C=o("v-icon"),w=o("v-input"),_=o("v-date-picker"),N=o("v-menu"),b=o("v-button"),k=o("v-notice"),E=l("tooltip");return c(),i(d,null,[s("div",S,[e.isCustomEditState?h((c(),u(w,{key:1,"model-value":e.forexRate,type:"number",label:"Forex Rate",placeholder:"Enter the forex rate manually","onUpdate:modelValue":e.handleChange},null,8,["model-value","onUpdate:modelValue"])),[[E,"Allows you to manually enter a forex rate.\n\nIf you want to fetch the rate for a specific date, please switch to the date picker mode."]]):(c(),u(N,{key:0,ref:"dateTimeMenu","close-on-content-click":!1,attached:"","full-height":"",seamless:""},{activator:f(({toggle:t,active:a})=>[h((c(),u(w,{active:a,clickable:!1,readonly:"","model-value":e.forexRate,placeholder:"Select a date to fill in the currency exchange rate of the day",onClick:t},{append:f(()=>[v(C,{name:"today",class:p({active:a})},null,8,["class"])]),_:2},1032,["active","model-value","onClick"])),[[E,"Autofills the currency exchange rate of the selected date (if it exists) from the Local Currency to the Contract Currency (both currencies are set in the contract).\n\nTo manually enter a forex rate, switch to the manual entry mode."]])]),default:f(()=>[v(_,{type:"date","include-seconds":!1,"use-24":!1,"model-value":e.selectedDate,"onUpdate:modelValue":t[0]||(t[0]=t=>e.fetchForexRate(t)),onClose:e.dateTimeMenu?.deactivate},null,8,["model-value","onClose"])]),_:1},512)),h((c(),u(b,{onClick:t[1]||(t[1]=t=>e.isCustomEditState=!e.isCustomEditState),icon:""},{default:f(()=>[e.isCustomEditState?(c(),u(C,{key:0,name:"today"})):(c(),u(C,{key:1,name:"edit"}))]),_:1})),[[E,e.isCustomEditState?"Switch to date picker mode to fetch forex rates for specific dates.":"Switch to manual entry mode to enter forex rates manually.",void 0,{left:!0}]])]),e.failureReason?(c(),u(k,{key:0,type:"danger",class:"margin-top-16px"},{default:f(()=>[m(g(e.failureReason),1)]),_:1})):x("v-if",!0)],64)},b.__scopeId="data-v-64969d30",b.__file="src/interface.vue";var F=t({id:"navarch-prefiller-forexrate",name:"Navarch Prefiller Foreign Exchange Rate Extension",icon:"currency_exchange",description:"Interface for pre-filling foreign exchange rates based on a selected currency and date.",component:b,types:["string"],options:null});export{F as default};
