import{useApi as e,defineInterface as a}from"@directus/extensions-sdk";import{defineComponent as t,ref as r,inject as n,resolveComponent as o,resolveDirective as c,openBlock as l,createElementBlock as i,Fragment as d,createVNode as u,withCtx as s,withDirectives as f,createBlock as v,normalizeClass as h,createTextVNode as p,toDisplayString as g,createCommentVNode as x}from"vue";const m="contract",y="contract_currency",_="local_currency",C="navarch_currency",N="code";var b=t({props:{value:{type:String,default:null}},emits:["input"],setup(a,{emit:t}){const o=r(a.value?Number(a.value):null),c=r(!1),l=r(null),i=r(),d=r(new Date),u="navarch_forex_rate",s="date",f="exchange_rate",v="currency_source",h="currency_target",p=e(),g=n("values",r({}));return{forexRate:o,isFetchingForexData:c,dateTimeMenu:i,selectedDate:d,failureReason:l,fetchForexRate:async function(e=null){console.log("[navarch-prefiller-forexrate] fetchForexRate started with newDate:",e),c.value=!0,l.value=null;const a=e||null;if(console.log("[navarch-prefiller-forexrate] new date:",a),!a)return console.log("[navarch-prefiller-forexrate] No date selected and none found in the Invoice Date field either, cannot fetch forex rate."),void(c.value=!1);d.value=new Date(a);const r=g.value.parcel;if(!r)return console.log("[navarch-prefiller-forexrate] No Parcel ID found in the Invoice Parcel field, cannot fetch forex rate."),c.value=!1,void(l.value="No Parcel ID found in the Invoice Parcel field.");const n=await p.get(`/items/navarch_parcel/${r}`,{params:{fields:[m]}});if(!(n&&n.data&&n.data.data&&n.data.data[m]))return console.log("[navarch-prefiller-forexrate] No contract found for the Parcel, cannot fetch forex rate."),c.value=!1,void(l.value="Selected parcel does not have an associated contract.");const i=n.data.data[m],x=await p.get(`/items/navarch_contract/${i}`,{params:{fields:[y,_]}});if(!x||!x.data||!x.data.data)return console.log("[navarch-prefiller-forexrate] No contract found for the Parcel, cannot fetch forex rate."),c.value=!1,void(l.value="No contract found for the Parcel.");const b=x.data.data[_];if(!b)return console.log("[navarch-prefiller-forexrate] No local currency found in the contract."),c.value=!1,void(l.value="Please set a Local Currency in the Tax section of the associated contract.");const w=x.data.data[y];if(!w)return console.log("[navarch-prefiller-forexrate] No currency found in the contract."),c.value=!1,void(l.value="Please set a Contract Currency in the Finance section of the associated contract.");const F=await async function(e,a=391,t=1){console.log("[navarch-prefiller-forexrate] fetchForexRateForDate called with date:",e,"currencySource:",a,"currencyTarget:",t);const r=await p.get("/items/"+u,{params:{filter:{[s]:{_eq:e},[v]:{_eq:a},[h]:{_eq:t}},fields:[f,v,h]}});if(!r||!r.data||!r.data.data||0===r.data.data.length)return console.log("[navarch-prefiller-forexrate] No forex rate found for the given date and currencies."),null;return console.log("[navarch-prefiller-forexrate] Forex rate fetched successfully:",JSON.stringify(r.data.data[0])),r.data.data[0]}(a,b,w);if(!F||!F[f]){const e=await p.get(`/items/${C}/${b}`,{params:{fields:[N]}}),t=await p.get(`/items/${C}/${w}`,{params:{fields:[N]}}),r=e.data.data[N]&&t.data.data[N]?`${e.data.data[N]} to ${t.data.data[N]}`:"the selected currencies in the contract";return void(l.value=`No currency rate found for the date of ${a} for ${r}.`)}o.value=Number(F[f]),console.log("[navarch-prefiller-forexrate] Forex rate value fetched:",o.value),t("input",o.value),c.value=!1},handleChange:async function(e){console.log("[navarch-prefiller-forexrate] handleChange called with event:",JSON.stringify(e)),l.value=null,e.target&&e.target.value?(console.log("[navarch-prefiller-forexrate] handleChange emitting value:",e.target.value),t("input",e.target.value)):(console.log("[navarch-prefiller-forexrate] handleChange emitting null value"),t("input",null));console.log("[navarch-prefiller-forexrate] handleChange done")}}}});var w=[],F=[];!function(e,a){if(e&&"undefined"!=typeof document){var t,r=!0===a.prepend?"prepend":"append",n=!0===a.singleTag,o="string"==typeof a.container?document.querySelector(a.container):document.getElementsByTagName("head")[0];if(n){var c=w.indexOf(o);-1===c&&(c=w.push(o)-1,F[c]={}),t=F[c]&&F[c][r]?F[c][r]:F[c][r]=l()}else t=l();65279===e.charCodeAt(0)&&(e=e.substring(1)),t.styleSheet?t.styleSheet.cssText+=e:t.appendChild(document.createTextNode(e))}function l(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),a.attributes)for(var t=Object.keys(a.attributes),n=0;n<t.length;n++)e.setAttribute(t[n],a.attributes[t[n]]);var c="prepend"===r?"afterbegin":"beforeend";return o.insertAdjacentElement(c,e),e}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),b.render=function(e,a,t,r,n,m){const y=o("v-icon"),_=o("v-input"),C=o("v-date-picker"),N=o("v-menu"),b=o("v-notice"),w=c("tooltip");return l(),i(d,null,[u(N,{ref:"dateTimeMenu","close-on-content-click":!1,attached:"","full-height":"",seamless:""},{activator:s(({toggle:a,active:t})=>[f((l(),v(_,{active:t,clickable:!1,readonly:"","model-value":e.forexRate,placeholder:"Select a date to fill in the currency exchange rate of the day",onClick:a},{append:s(()=>[u(y,{name:"today",class:h({active:t})},null,8,["class"])]),_:2},1032,["active","model-value","onClick"])),[[w,"Autofills the currency exchange rate of the selected date (if it exists) from the Local Currency to the Contract Currency (both currencies are set in the contract)."]])]),default:s(()=>[u(C,{type:"date","include-seconds":!1,"use-24":!1,"model-value":e.selectedDate,"onUpdate:modelValue":a[0]||(a[0]=a=>e.fetchForexRate(a)),onClose:e.dateTimeMenu?.deactivate},null,8,["model-value","onClose"])]),_:1},512),e.failureReason?(l(),v(b,{key:0,type:"danger",class:"margin-top-16px"},{default:s(()=>[p(g(e.failureReason),1)]),_:1})):x("v-if",!0)],64)},b.__scopeId="data-v-64969d30",b.__file="src/interface.vue";var D=a({id:"navarch-prefiller-forexrate",name:"Navarch Prefiller Foreign Exchange Rate Extension",icon:"currency_exchange",description:"Interface for pre-filling foreign exchange rates based on a selected currency and date.",component:b,types:["string"],options:null});export{D as default};
