import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,ref as l,inject as o,watch as d,resolveComponent as i,resolveDirective as n,openBlock as c,createBlock as s,withCtx as r,createCommentVNode as u,createElementBlock as m,createVNode as p,Fragment as v,renderList as _,createElementVNode as f,toDisplayString as y,withDirectives as q}from"vue";var h=a({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:a}){var i;const n=e(),c=l(!1),s=l(null!=(i="string"==typeof t.value?JSON.parse(t.value):t.value)?i:{}),r=l({}),u=l({}),m=l([]),p="contract",v="actual_arrival_date",_="estimate_arrival_date",f="bl_date",y="estimated_shipment_date",q="id",h="navarch_commodity_in_contract",b="contract",g="commodity",S="primary_commodity",$="payable_commodity",O="quotational_periods",M="navarch_commodity",A="name",x="code",C=o("values",l({}));return c.value=!!C.value[p],d((()=>C.value[p]),(async e=>{e?async function(e){c.value=!0;const t=await n.get(`/items/${h}`,{params:{filter:{_and:[{[b]:{_eq:e}},{_or:[{[S]:{_eq:!0}},{[$]:{_eq:!0}}]}]},fields:[g,O]}});console.log(`[loadQpSelectionField] fetched commodity in contract data=${JSON.stringify(t.data.data)}`);const a=t.data.data.map((e=>e[g])),l=await n.get(`/items/${M}`,{params:{filter:{[q]:{_in:a}},fields:[q,A,x]}});console.log(`[loadQpSelectionField] fetched commodity data=${JSON.stringify(l.data.data)}`),m.value=l.data.data.map((e=>e[x]));const o=l.data.data.reduce(((e,t)=>(e[t[q]]={name:t[A],code:t[x]},e)),{});0===Object.keys(s.value).length?s.value=t.data.data.reduce(((e,t)=>{const a=t[g],l=o[a],d=t[O],i=d.find((e=>!!e.default));return e[l.code]={commodity_name:l.name,commodity_code:l.code,commodity_id:a,declared:!1,qp_selected:i?`${i.qp_period} ${i.qp_code}`:null},r.value[l.code]=d.map((e=>({text:`${e.qp_period} ${e.qp_code}${e.default?" (default)":""}`,value:`${e.qp_period} ${e.qp_code}`}))),e}),{}):r.value=t.data.data.reduce(((e,t)=>{const a=t[g],l=o[a];if(e[l.code]=t[O].map((e=>({text:`${e.qp_period} ${e.qp_code}${e.default?" (default)":""}`,value:`${e.qp_period} ${e.qp_code}`}))),console.debug(`[loadQpSelectionField] checking if commodity code ${l.code} exists in qpCommodities=${!!s.value[l.code]}`),!s.value[l.code]){const e=t[O].find((e=>!!e.default));s.value[l.code]={commodity_name:l.name,commodity_code:l.code,commodity_id:a,declared:!1,qp_selected:e?`${e.qp_period} ${e.qp_code}`:null}}return e}),{});console.log(`[loadQpSelectionField] qpCommodities=${JSON.stringify(s.value)}, and qpSelection=${JSON.stringify(r.value)}`)}(e):(c.value=!1,a("input",null))}),{immediate:!0}),d(s,(e=>{console.log("[watch] changes detected for the QP settings for the commodities"),Object.values(e).forEach((e=>{var t,a;if(null===e.qp_selected)return;let l;const[o,d]=e.qp_selected.split(" ");switch(d){case"MOS":case"MOAS":l=null!=(t=C.value[f])?t:C.value[y];break;case"MAMA":l=null!=(a=C.value[v])?a:C.value[_];break;case"MOSS":l=C.value[y]}console.log(`[watch] date=${l}`),N(e.commodity_code,parseInt(o),l)})),a("input",JSON.stringify(e))}),{deep:!0}),d((()=>C.value[y]),(e=>{Object.values(s.value).forEach((t=>{if(t.qp_selected){const[a,l]=t.qp_selected.split(" ");(null!==C.value[f]||"MOAS"!==l&&"MOS"!==l)&&"MOSS"!==l||N(t.commodity_code,parseInt(a),e)}}))}),{immediate:!0}),d((()=>C.value[_]),(e=>{Object.values(s.value).forEach((t=>{if(t.qp_selected){const[a,l]=t.qp_selected.split(" ");null===C.value[v]&&"MAMA"===l&&N(t.commodity_code,parseInt(a),e)}}))}),{immediate:!0}),d((()=>C.value[v]),(e=>{Object.values(s.value).forEach((t=>{if(t.qp_selected){const[a,l]=t.qp_selected.split(" ");null!==C.value[v]&&"MAMA"===l?N(t.commodity_code,parseInt(a),e):null===C.value[v]&&"MAMA"===l&&N(t.commodity_code,parseInt(a),C.value[_])}}))}),{immediate:!0}),d((()=>C.value[f]),(e=>{Object.values(s.value).forEach((t=>{if(t.qp_selected){const[a,l]=t.qp_selected.split(" ");null===C.value[f]||"MOAS"!==l&&"MOS"!==l?null!==C.value[f]||"MOAS"!==l&&"MOS"!==l||N(t.commodity_code,parseInt(a),C.value[y]):N(t.commodity_code,parseInt(a),e)}}))}),{immediate:!0}),{isContractSelected:c,qpCommodities:s,qpSelection:r,DEFAULT_NA_SELECTION:[{text:"N/A",value:null}],commodityCodeList:m,qpMonthsDisplay:u};function N(e,t,a){if(!t||!a)return void console.log(`[evaluateQpMonth] invalid qpPeriod=${t} or date=${a}`);console.log(`[evaluateQpMonth] commodityCode=${e}, qpPeriod=${t}, date=${a}`);const l=new Date(a),o=l.getMonth(),d=(o+t)%12,i=o<=d?l.getFullYear():l.getFullYear()+1,n={[e]:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d]} ${i}`};u.value={...u.value,...n}}}});const b={key:0},g={key:1},S={class:"list-item-component left"};var $=[],O=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,l=!0===t.prepend?"prepend":"append",o=!0===t.singleTag,d="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(o){var i=$.indexOf(d);-1===i&&(i=$.push(d)-1,O[i]={}),a=O[i]&&O[i][l]?O[i][l]:O[i][l]=n()}else a=n();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function n(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),o=0;o<a.length;o++)e.setAttribute(a[o],t.attributes[a[o]]);var i="prepend"===l?"afterbegin":"beforeend";return d.insertAdjacentElement(i,e),e}}('.list-item[data-v-64969d30] {\n  margin-bottom: 10px;\n}\n.list-item-component[data-v-64969d30] {\n  float: left;\n}\n.left[data-v-64969d30] {\n  width: 30%;\n}\n.middle[data-v-64969d30] {\n  width: 40%;\n}\n.right[data-v-64969d30] {\n  width: 30%;\n  padding-left: 20px;\n}\n\n/* Clear floats after the columns */\n.list-item[data-v-64969d30]:after {\n  content: "";\n  display: table;\n  clear: both;\n}',{}),h.render=function(e,t,a,l,o,d){const h=i("v-select"),$=i("v-checkbox"),O=i("v-list-item"),M=i("v-list"),A=i("v-sheet"),x=n("tooltip");return c(),s(A,null,{default:r((()=>[u(" <div>{{ qpMonthsDisplay }}</div>\r\n\t\t<div>{{ qpCommodities }}</div> "),e.isContractSelected?(c(),m("div",g,[p(M,null,{default:r((()=>[(c(!0),m(v,null,_(e.qpCommodities,(t=>(c(),s(O,{class:"list-item",key:t.commodity_id},{default:r((()=>[f("div",S,y(`${t.commodity_name} (${e.qpMonthsDisplay[t.commodity_code]??"--"}): `),1),q(p(h,{class:"list-item-component middle",modelValue:t.qp_selected,"onUpdate:modelValue":e=>t.qp_selected=e,items:e.qpSelection[t.commodity_code]??e.DEFAULT_NA_SELECTION,disabled:t.declared},null,8,["modelValue","onUpdate:modelValue","items","disabled"]),[[x,t.declared?"Cannot change Quotational Period if Declared.":null,void 0,{bottom:!0}]]),q(p($,{class:"list-item-component right",modelValue:t.declared,"onUpdate:modelValue":e=>t.declared=e,"icon-on":"check_box","icon-off":"check_box_outline_blank",label:"Declared",disabled:null===t.qp_selected},null,8,["modelValue","onUpdate:modelValue","disabled"]),[[x,t.qp_selected?null:"Please select a Quotational Period first.",void 0,{bottom:!0}]])])),_:2},1024)))),128))])),_:1})])):(c(),m("div",b,"Please select a contract first."))])),_:1})},h.__scopeId="data-v-64969d30",h.__file="src/interface.vue";var M=t({id:"navarch-qp-select",name:"Navarch QP Select",icon:"format_list_numbered_rtl",description:"For QP selection in the Parcel form",component:h,options:null,types:["json"]});export{M as default};
