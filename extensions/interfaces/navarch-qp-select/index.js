import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as o,ref as a,inject as l,watch as d,resolveComponent as i,resolveDirective as n,openBlock as c,createBlock as u,withCtx as m,createCommentVNode as s,createElementBlock as r,createVNode as p,Fragment as v,renderList as _,createElementVNode as f,toDisplayString as y,withDirectives as q,createSlots as h,mergeProps as g,toHandlers as b}from"vue";var S=o({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:o}){var i;const n=e(),c=a(!1),u=a(null!=(i="string"==typeof t.value?JSON.parse(t.value):t.value)?i:{}),m=a({}),s=a({}),r=a([]),p=a("MONTH"),v=a(),_=a(null),f=a({}),y="contract",q="actual_arrival_date",h="estimate_arrival_date",g="bl_date",b="estimated_shipment_date",S="id",$="navarch_commodity_in_contract",O="contract",k="commodity",C="primary_commodity",M="payable_commodity",D="quotational_periods",A="navarch_commodity",N="name",x="code",V=l("values",a({}));c.value=!!V.value[y],d((()=>V.value[y]),(async e=>{e?async function(e){c.value=!0;const t=await n.get(`/items/${$}`,{params:{filter:{_and:[{[O]:{_eq:e}},{_or:[{[C]:{_eq:!0}},{[M]:{_eq:!0}}]}]},fields:[k,D]}});console.log(`[loadQpSelectionField] fetched commodity in contract data=${JSON.stringify(t.data.data)}`);const o=t.data.data.map((e=>e[k])),a=await n.get(`/items/${A}`,{params:{filter:{[S]:{_in:o}},fields:[S,N,x]}});console.log(`[loadQpSelectionField] fetched commodity data=${JSON.stringify(a.data.data)}`),r.value=a.data.data.map((e=>e[x]));const l=a.data.data.reduce(((e,t)=>(e[t[S]]={name:t[N],code:t[x]},e)),{});0===Object.keys(u.value).length?u.value=t.data.data.reduce(((e,t)=>{const o=t[k],a=l[o],d=t[D],i=d.find((e=>!!e.default));return e[a.code]={commodity_name:a.name,commodity_code:a.code,commodity_id:o,declared:!1,qp_selected:i?`${i.qp_period} ${i.qp_code}`:null,qp_month:null},m.value[a.code]=d.map((e=>({text:`${e.qp_period} ${e.qp_code}${e.default?" (default)":""}`,value:`${e.qp_period} ${e.qp_code}`}))),e}),{}):m.value=t.data.data.reduce(((e,t)=>{const o=t[k],a=l[o];if(e[a.code]=t[D].map((e=>({text:`${e.qp_period} ${e.qp_code}${e.default?" (default)":""}`,value:`${e.qp_period} ${e.qp_code}`}))),console.debug(`[loadQpSelectionField] checking if commodity code ${a.code} exists in qpCommodities=${!!u.value[a.code]}`),!u.value[a.code]){const e=t[D].find((e=>!!e.default));u.value[a.code]={commodity_name:a.name,commodity_code:a.code,commodity_id:o,declared:!1,qp_selected:e?`${e.qp_period} ${e.qp_code}`:null,qp_month:null}}return e}),{});console.log(`[loadQpSelectionField] qpCommodities=${JSON.stringify(u.value)}, and qpSelection=${JSON.stringify(m.value)}`)}(e):(c.value=!1,o("input",null))}),{immediate:!0});let E=JSON.parse(JSON.stringify(u.value));return d(u,(e=>{console.log("[watch] changes detected for the QP settings for the commodities: "+JSON.stringify(e)+" vs old: "+JSON.stringify(E)),Object.values(e).forEach((e=>{var t,o,l;if(e.qp_selected!==(null==(t=E[e.commodity_code])?void 0:t.qp_selected)){if(null===e.qp_selected)return;let t;const[d,i]=e.qp_selected.split(" ");switch(i){case"MOS":case"MOAS":t=null!=(o=V.value[g])?o:V.value[b];break;case"MAMA":t=null!=(l=V.value[q])?l:V.value[h];break;case"MOSS":t=V.value[b]}console.log(`[watch] date=${t}`),T(e.commodity_code,parseInt(null!=d?d:"0"),t),void 0===f.value[e.commodity_code]&&(f.value[e.commodity_code]=a())}})),E=JSON.parse(JSON.stringify(e)),o("input",JSON.stringify(e))}),{deep:!0}),d((()=>V.value[b]),(e=>{Object.values(u.value).forEach((t=>{if(!t.declared&&t.qp_selected){const[o,a]=t.qp_selected.split(" ");(null!==V.value[g]||"MOAS"!==a&&"MOS"!==a)&&"MOSS"!==a||T(t.commodity_code,parseInt(null!=o?o:"0"),e)}}))}),{immediate:!0}),d((()=>V.value[h]),(e=>{Object.values(u.value).forEach((t=>{if(!t.declared&&t.qp_selected){const[o,a]=t.qp_selected.split(" ");null===V.value[q]&&"MAMA"===a&&T(t.commodity_code,parseInt(null!=o?o:"0"),e)}}))}),{immediate:!0}),d((()=>V.value[q]),(e=>{Object.values(u.value).forEach((t=>{if(!t.declared&&t.qp_selected){const[o,a]=t.qp_selected.split(" ");null!==V.value[q]&&"MAMA"===a?T(t.commodity_code,parseInt(null!=o?o:"0"),e):null===V.value[q]&&"MAMA"===a&&T(t.commodity_code,parseInt(null!=o?o:"0"),V.value[h])}}))}),{immediate:!0}),d((()=>V.value[g]),(e=>{Object.values(u.value).forEach((t=>{if(!t.declared&&t.qp_selected){const[o,a]=t.qp_selected.split(" ");null===V.value[g]||"MOAS"!==a&&"MOS"!==a?null!==V.value[g]||"MOAS"!==a&&"MOS"!==a||T(t.commodity_code,parseInt(null!=o?o:"0"),V.value[b]):T(t.commodity_code,parseInt(null!=o?o:"0"),e)}}))}),{immediate:!0}),{isContractSelected:c,qpCommodities:u,qpSelection:m,DEFAULT_NA_SELECTION:[{text:"N/A",value:null}],commodityCodeList:r,qpMonthsDisplay:s,dateTimeRef:v,dateTime:_,dateTimeRefByCommodity:f,unsetValue:function(e){if(console.log(`[unsetValue] comm code: ${e}`),!u.value[e])return void console.warn(`[unsetValue] due date for ${e} is already unset`);u.value[e].qp_month=null,console.log("[unsetValue] done")},updateDueDate:function(e,t){var o,a;if(console.log(`[updateDueDate] comm code: ${e}, newDueDate: ${t}`),!t&&!(null==(o=u.value[e])?void 0:o.qp_month))return void console.log(`[updateDueDate] newDueDate is null, doing nothing value for ${e}`);u.value[e].qp_month=t,null==(a=v.value)||a.deactivate(),console.log("[updateDueDate] done")},activePicker:p};function T(e,t,o){if(!t||!o)return void console.log(`[evaluateQpMonth] invalid qpPeriod=${t} or date=${o}`);console.log(`[evaluateQpMonth] commodityCode=${e}, qpPeriod=${t}, date=${o}`);const a=new Date(o),l=a.getMonth(),d=(l+t)%12,i=l<=d?a.getFullYear():a.getFullYear()+1;u.value[e]&&(u.value[e].qp_month=`${i}-${(d+1).toString().padStart(2,"0")}-01`)}}});const $={key:0},O={key:1};var k=[],C=[];!function(e,t){if(e&&"undefined"!=typeof document){var o,a=!0===t.prepend?"prepend":"append",l=!0===t.singleTag,d="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(l){var i=k.indexOf(d);-1===i&&(i=k.push(d)-1,C[i]={}),o=C[i]&&C[i][a]?C[i][a]:C[i][a]=n()}else o=n();65279===e.charCodeAt(0)&&(e=e.substring(1)),o.styleSheet?o.styleSheet.cssText+=e:o.appendChild(document.createTextNode(e))}function n(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var o=Object.keys(t.attributes),l=0;l<o.length;l++)e.setAttribute(o[l],t.attributes[o[l]]);var i="prepend"===a?"afterbegin":"beforeend";return d.insertAdjacentElement(i,e),e}}('.list-item-qp-selection[data-v-64969d30] {\n  width: 100%;\n  display: grid;\n  grid-template-columns: 150px 1fr 1fr 100px;\n  column-gap: 20px;\n  margin-bottom: 10px;\n}\n\n/* Clear floats after the columns */\n.list-item[data-v-64969d30]:after {\n  content: "";\n  display: table;\n  clear: both;\n}',{}),S.render=function(e,t,o,a,l,d){const S=i("v-select"),k=i("v-icon"),C=i("v-input"),M=i("v-date-picker"),D=i("v-menu"),A=i("v-checkbox"),N=i("v-list-item"),x=i("v-list"),V=i("v-sheet"),E=n("tooltip");return c(),u(V,null,{default:m((()=>[s(" <div>{{ qpMonthsDisplay }}</div>\r\n\t\t<div>{{ qpCommodities }}</div> "),e.isContractSelected?(c(),r("div",O,[p(x,null,{default:m((()=>[(c(!0),r(v,null,_(e.qpCommodities,(t=>(c(),u(N,{class:"list-item-qp-selection",key:t.commodity_id},{default:m((()=>[f("div",null,y(t.commodity_name),1),q(p(S,{modelValue:t.qp_selected,"onUpdate:modelValue":e=>t.qp_selected=e,items:e.qpSelection[t.commodity_code]??e.DEFAULT_NA_SELECTION,disabled:t.declared},null,8,["modelValue","onUpdate:modelValue","items","disabled"]),[[E,t.declared?"Cannot change Quotational Period if Declared.":null,void 0,{bottom:!0}]]),s(' <v-date-picker\r\n\t\t\t\t\t\tv-model="picker"\r\n\t\t\t\t\t\ttype="month"\r\n\t\t\t\t\t\tlabel="Select Month and Year"\r\n\t\t\t\t\t></v-date-picker> '),s(' <v-date-picker view-mode="month"></v-date-picker> '),s(' <v-date-picker type="month" :active-picker.sync="activePicker"></v-date-picker> '),s(' <v-date-picker view-mode="months"></v-date-picker> '),p(D,{ref_for:!0,ref:e.dateTimeRef,"close-on-content-click":!1,attached:"",disabled:t.declared,"full-height":"",seamless:""},{activator:m((({toggle:o,active:a})=>[p(C,{active:a,clickable:"",readonly:"","model-value":e.qpCommodities[t.commodity_code]?.qp_month??null,disabled:t.declared,onClick:o},h({_:2},[t.declared?void 0:{name:"append",fn:m((()=>[p(k,g({name:e.qpCommodities[t.commodity_code]?.qp_month?"clear":"today",class:{active:a,"clear-icon":!!e.qpCommodities[t.commodity_code]?.qp_month,"today-icon":!e.qpCommodities[t.commodity_code]?.qp_month}},b({click:e.qpCommodities[t.commodity_code]?.qp_month?()=>e.unsetValue(t.commodity_code):null})),null,16,["name","class"])])),key:"0"}]),1032,["active","model-value","disabled","onClick"])])),default:m((()=>[p(M,{type:"date",disabled:t.declared,"include-seconds":!1,"use-24":!1,"model-value":e.qpCommodities[t.commodity_code]?.qp_month??null,"onUpdate:modelValue":o=>e.updateDueDate(t.commodity_code,o),onClose:e.dateTimeRef?.deactivate},null,8,["disabled","model-value","onUpdate:modelValue","onClose"])])),_:2},1032,["disabled"]),s(' <v-input \r\n\t\t\t\t\t\ttype="date"\r\n\t\t\t\t\t\t:value="qpCommodities[commodity.commodity_code]?.qp_month ?? null"\r\n\t\t\t\t\t\t@update:value="updateDueDate(commodity.commodity_code, $event)"\r\n\t\t\t\t\t></v-input> '),q(p(A,{modelValue:t.declared,"onUpdate:modelValue":e=>t.declared=e,"icon-on":"check_box","icon-off":"check_box_outline_blank",label:"Declared",disabled:null===t.qp_selected},null,8,["modelValue","onUpdate:modelValue","disabled"]),[[E,t.qp_selected?null:"Please select a Quotational Period first.",void 0,{bottom:!0}]])])),_:2},1024)))),128))])),_:1})])):(c(),r("div",$,"Please select a contract first."))])),_:1})},S.__scopeId="data-v-64969d30",S.__file="src/interface.vue";var M=t({id:"navarch-qp-select",name:"Navarch QP Select",icon:"format_list_numbered_rtl",description:"For QP selection in the Parcel form",component:S,options:null,types:["json"]});export{M as default};
