import{useApi as e,defineInterface as t}from"@directus/extensions-sdk";import{defineComponent as a,ref as l,inject as o,watch as d,resolveComponent as n,resolveDirective as i,openBlock as c,createBlock as s,withCtx as r,createCommentVNode as m,createElementBlock as u,createVNode as p,Fragment as v,renderList as _,createElementVNode as f,toDisplayString as y,withDirectives as h}from"vue";var b=a({props:{value:{type:Object,default:null}},emits:["input"],setup(t,{emit:a}){var n;const i=e(),c=l(!1),s=l(null!=(n=t.value)?n:{}),r=l({}),m=l([]),u="contract",p="actual_arrival_date",v="estimate_arrival_date",_="bl_date",f="estimated_shipment_date",y="id",h="navarch_commodity_in_contract",b="contract",q="commodity",g="primary_commodity",M="payable_commodity",S="quotational_periods",O="navarch_commodity",$="name",A="code",k=o("values",l({}));return c.value=!!k.value[u],d((()=>k.value[u]),(async e=>{e?async function(e){c.value=!0;const t=await i.get(`/items/${h}`,{params:{filter:{_and:[{[b]:{_eq:e}},{_or:[{[g]:{_eq:!0}},{[M]:{_eq:!0}}]}]},fields:[q,S]}});console.log(`[loadQpSelectionField] fetched commodity in contract data=${JSON.stringify(t.data.data)}`);const a=t.data.data.map((e=>e[q])),l=await i.get(`/items/${O}`,{params:{filter:{[y]:{_in:a}},fields:[y,$,A]}});console.log(`[loadQpSelectionField] fetched commodity data=${JSON.stringify(l.data.data)}`),m.value=l.data.data.map((e=>e[A]));const o=l.data.data.reduce(((e,t)=>(e[t[y]]={name:t[$],code:t[A]},e)),{});0===Object.keys(s.value).length&&(s.value=t.data.data.reduce(((e,t)=>{const a=t[q],l=o[a],d=t[S];return e[l.code]={commodity_name:l.name,commodity_code:l.code,commodity_id:a,declared:!1,qp_selected:null,qp_selections:d.map((e=>({text:`${e.qp_period} ${e.qp_code}${e.default?" (default)":""}`,value:`${e.qp_period} ${e.qp_code}`})))},e}),{}));console.log(`[loadQpSelectionField] qpCommodities=${JSON.stringify(s.value)}`)}(e):(c.value=!1,a("input",null))}),{immediate:!0}),d(s,(e=>{console.log("[watch] changes detected for the QP settings for the commodities"),Object.values(e).forEach((e=>{var t,a;if(null===e.qp_selected)return;let l;const[o,d]=e.qp_selected.split(" ");switch(d){case"MOS":case"MOAS":l=null!=(t=k.value[_])?t:k.value[f];break;case"MAMA":l=null!=(a=k.value[p])?a:k.value[v];break;case"MOSS":l=k.value[f]}console.log(`[watch] date=${l}`),x(e.commodity_code,parseInt(o),l)})),a("input",JSON.stringify(e))}),{deep:!0}),d((()=>k.value[f]),(e=>{Object.values(s.value).forEach((t=>{if(t.qp_selected){const[a,l]=t.qp_selected.split(" ");(null!==k.value[_]||"MOAS"!==l&&"MOS"!==l)&&"MOSS"!==l||x(t.commodity_code,parseInt(a),e)}}))}),{immediate:!0}),d((()=>k.value[v]),(e=>{Object.values(s.value).forEach((t=>{if(t.qp_selected){const[a,l]=t.qp_selected.split(" ");null===k.value[p]&&"MAMA"===l&&x(t.commodity_code,parseInt(a),e)}}))}),{immediate:!0}),d((()=>k.value[p]),(e=>{Object.values(s.value).forEach((t=>{if(t.qp_selected){const[a,l]=t.qp_selected.split(" ");null!==k.value[p]&&"MAMA"===l?x(t.commodity_code,parseInt(a),e):null===k.value[p]&&"MAMA"===l&&x(t.commodity_code,parseInt(a),k.value[v])}}))}),{immediate:!0}),d((()=>k.value[_]),(e=>{Object.values(s.value).forEach((t=>{if(t.qp_selected){const[a,l]=t.qp_selected.split(" ");null===k.value[_]||"MOAS"!==l&&"MOS"!==l?null!==k.value[_]||"MOAS"!==l&&"MOS"!==l||x(t.commodity_code,parseInt(a),k.value[f]):x(t.commodity_code,parseInt(a),e)}}))}),{immediate:!0}),{isContractSelected:c,qpCommodities:s,commodityCodeList:m,qpMonthsDisplay:r};function x(e,t,a){if(!t||!a)return void console.log(`[evaluateQpMonth] invalid qpPeriod=${t} or date=${a}`);console.log(`[evaluateQpMonth] commodityCode=${e}, qpPeriod=${t}, date=${a}`);const l=new Date(a),o=new Date(l.setMonth(l.getMonth()+t)),d=o.getMonth(),n={[e]:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d]} ${o.getFullYear()}`};r.value={...r.value,...n}}}});const q={key:0},g={key:1},M={class:"list-item-component left"};var S=[],O=[];!function(e,t){if(e&&"undefined"!=typeof document){var a,l=!0===t.prepend?"prepend":"append",o=!0===t.singleTag,d="string"==typeof t.container?document.querySelector(t.container):document.getElementsByTagName("head")[0];if(o){var n=S.indexOf(d);-1===n&&(n=S.push(d)-1,O[n]={}),a=O[n]&&O[n][l]?O[n][l]:O[n][l]=i()}else a=i();65279===e.charCodeAt(0)&&(e=e.substring(1)),a.styleSheet?a.styleSheet.cssText+=e:a.appendChild(document.createTextNode(e))}function i(){var e=document.createElement("style");if(e.setAttribute("type","text/css"),t.attributes)for(var a=Object.keys(t.attributes),o=0;o<a.length;o++)e.setAttribute(a[o],t.attributes[a[o]]);var n="prepend"===l?"afterbegin":"beforeend";return d.insertAdjacentElement(n,e),e}}('.list-item[data-v-64969d30] {\n  margin-bottom: 10px;\n}\n.list-item-component[data-v-64969d30] {\n  float: left;\n}\n.left[data-v-64969d30] {\n  width: 30%;\n}\n.middle[data-v-64969d30] {\n  width: 40%;\n}\n.right[data-v-64969d30] {\n  width: 30%;\n  padding-left: 20px;\n}\n\n/* Clear floats after the columns */\n.list-item[data-v-64969d30]:after {\n  content: "";\n  display: table;\n  clear: both;\n}',{}),b.render=function(e,t,a,l,o,d){const b=n("v-select"),S=n("v-checkbox"),O=n("v-list-item"),$=n("v-list"),A=n("v-sheet"),k=i("tooltip");return c(),s(A,null,{default:r((()=>[m(" <div>{{ qpMonthsDisplay }}</div>\r\n\t\t<div>{{ qpCommodities }}</div> "),e.isContractSelected?(c(),u("div",g,[p($,null,{default:r((()=>[(c(!0),u(v,null,_(e.qpCommodities,(t=>(c(),s(O,{class:"list-item",key:t.commodity_id},{default:r((()=>[f("div",M,y(`${t.commodity_name} (${e.qpMonthsDisplay[t.commodity_code]??"--"}): `),1),h(p(b,{class:"list-item-component middle",modelValue:t.qp_selected,"onUpdate:modelValue":e=>t.qp_selected=e,items:t.qp_selections,disabled:t.declared},null,8,["modelValue","onUpdate:modelValue","items","disabled"]),[[k,t.declared?"Cannot change Quotational Period if Declared.":null,void 0,{bottom:!0}]]),h(p(S,{class:"list-item-component right",modelValue:t.declared,"onUpdate:modelValue":e=>t.declared=e,"icon-on":"check_box","icon-off":"check_box_outline_blank",label:"Declared",disabled:null===t.qp_selected},null,8,["modelValue","onUpdate:modelValue","disabled"]),[[k,t.qp_selected?null:"Please select a Quotational Period first.",void 0,{bottom:!0}]])])),_:2},1024)))),128))])),_:1})])):(c(),u("div",q,"Please select a contract first."))])),_:1})},b.__scopeId="data-v-64969d30",b.__file="src/interface.vue";var $=t({id:"navarch-qp-select",name:"Navarch QP Select",icon:"format_list_numbered_rtl",description:"For QP selection in the Parcel form",component:b,options:null,types:["json"]});export{$ as default};
