import{useApi as t,defineInterface as a}from"@directus/extensions-sdk";import{defineComponent as e,ref as n,inject as o,resolveComponent as r,openBlock as i,createElementBlock as s,Fragment as l,createCommentVNode as u,createVNode as d,withCtx as c,createTextVNode as m,createBlock as v,toDisplayString as g}from"vue";var f=e({props:{value:{type:Object,default:null}},emits:["input"],setup(a,{emit:e}){const r=n(""),i=n(!1),s=n(!1),l=n(""),u=t(),d=o("values",n({})),c="id",m="name",v="code",g="contract",f="bl_date",p="vessel",_="destination",h="assay_results",y="name",w="port_name",$="commodity",b="dry_weight_uom",C="assay_uom",D="price_per_uom",E="navarch_assay_unit",N="unit",A="conversion_to_ppb",U="composition",V="navarch_unit",F="symbol",O="dry_symbol",M="unit",P="conversionToGram";return{isGeneraingDoc:i,failureReason:r,generatePdf:async function(){var t,a;r.value="",i.value=!0;try{i.value=!0;const n=d.value.metal,o=d.value.start_date,s=d.value.end_date;if(!n)return r.value="Metal not selected",void(i.value=!1);if(!o)return r.value="Start date not selected",void(i.value=!1);if(!s)return r.value="End date not selected",void(i.value=!1);const y=await u.get(`/items/navarch_commodity/${n}`,{params:{fields:[v,m]}}),w=await u.get(`/items/navarch_parcel?filter[_and][0][_and][0][${f}][_between][0]=${o}&filter[_and][0][_and][0][${f}][_between][1]=${s}`,{params:{fields:[c,"shipment_code",p,_,f,h,"weight_result",g]}});if(0===w.data.data.length)return r.value=`No parcels found for actual shipment date within the date range ${o} to ${s}`,void(i.value=!1);const $=w.data.data[0][g],b=await u.get(`/items/navarch_contract/${$}`,{params:{fields:["weight_uom"]}});console.log(`[generateLoadportDisportComparisonDoc] contract=${JSON.stringify(b.data.data)} for contract Id=${$} and parcel id=${w.data.data[0][c]}`);const C=await u.get(`/items/${V}/${b.data.data.weight_uom}`,{params:{fields:[O,M]}}),E=null!=(t=C.data.data[O])?t:"",N=(null==(a=C.data.data[M])?void 0:a.split(" ").map((t=>t[0].toUpperCase())).join(""))+"s",A=await u.get(`/items/navarch_commodity_in_contract?filter[contract]=${$}&filter[commodity]=${n}`,{params:{fields:[D]}});if(0===A.data.data.length||!A.data.data[0][D])return r.value=`Commodity ${n} not found in contract ${$} or does not have a Base Price Per UOM set`,void(i.value=!1);console.log(`[generateLoadportDisportComparisonDoc] commodity in contract response=${JSON.stringify(A.data.data)} for contract Id=${$} and parcel id=${w.data.data[0][c]}`);const U=(await u.get(`/items/${V}/${A.data.data[0][D]}`,{params:{fields:[F]}})).data.data[F],P=[];for(const t of w.data.data){const a=await k(t,y.data.data[v],U,E);P.push(a)}const x={start_date:j(new Date(o)),end_date:j(new Date(s)),metal:y.data.data[m],assay_uom:l.value,dry_weight_uom:E.toUpperCase(),dry_weight_uom_name:N,parcels:P},I=await u.post("/generate/loadport-disport-compare",x);if(200!==I.status)return console.log(`[generateLoadportDisportComparisonDoc] response status: ${I.status}`),r.value=I.data,void(i.value=!1);const J=I.data;e("input",{...x,doc_name:J}),i.value=!1,S(J)}catch(t){console.error("[generateProvWeightAndAssay] error=",t),r.value=t,i.value=!1}},isCopying:s,copy:async function(){s.value=!0;const{id:t,user_created:a,date_created:e,user_updated:n,date_updated:o,loadport_disport_doc:i,...l}=d.value;console.log(`[loadport disport::copy] requestBody=${JSON.stringify(l)}`);const c=await u.post("/items/navarch_loadport_disport",l);if(200!==c.status)return console.log(`[loadport disport::copy] copy response status: ${c.status}`),void(r.value=`Failed to duplicate loadport disport with status ${c.status}`);s.value=!1,window.open(`/admin/content/navarch_loadport_disport/${c.data.data.id}`)},viewPdf:S};function S(t){const e=null!=t?t:a.value.doc_name;console.log(`[viewPdf] doc name: ${e}`);const n=`/display-doc?docname=${encodeURIComponent(`${e}.pdf`)}`;window.open(n)}async function k(t,a,e,n){var o,r,i,s,d,c,m,v,g,f,D,M,P,S,k,J,T,j,B,R,z;const Y=t[h],H=await u.get(`/items/navarch_assay_lot?filter[${$}]=${a}&filter[foreign_key]=${Y}&filter[_and][0][_or][0][method][_eq]=Inturn&filter[_and][0][_or][1][_and][0][lot_number][_nnull]=true&filter[_and][0][_or][1][_and][1][method][_eq]=Outturn`,{params:{fields:[$,"method","final_assay","lot_number",C,"dry_weight",b]}});""===l.value&&(l.value=H.data.data[0][C]);const K=function(t){const a={outturn:null,inturn:null};if(!t)return a;const e=function(t){const a={Inturn:{},Outturn:{}};return t.forEach((t=>{var e;a[t.method]&&(a[t.method][t.commodity]?null==(e=a[t.method][t.commodity])||e.push(t):a[t.method][t.commodity]=[t])})),[...Object.values(a.Inturn),...Object.values(a.Outturn)]}(t);let n=null;for(const t of e)n=1!==t.length||W(t[0])?L(t):I(t[0]),null!=n&&("Inturn"===n.method?a.inturn=n:"Outturn"===n.method&&(a.outturn=n));return a}(H.data.data),Q=t[p];let X;Q&&(X=await u.get(`/items/navarch_vessel/${Q}`,{params:{fields:[y]}}));const Z=await u.get(`/items/navarch_world_port/${t[_]}`,{params:{fields:[w,"country"]}}),tt=x(null==(o=K.inturn)?void 0:o.total_dry_weight,null==(r=K.outturn)?void 0:r.total_dry_weight),at=x(null==(i=K.inturn)?void 0:i.final_assay,null==(s=K.outturn)?void 0:s.final_assay),et=x(null==(d=K.inturn)?void 0:d.total_metal,null==(c=K.outturn)?void 0:c.total_metal),nt=await q(H.data.data[0][b],n),ot=await async function(t,a){if(null==t||null==a)return 1;if(t===a)return 1;const e=await u.get(`/items/${E}?filter[${N}]=${t}`,{params:{fields:[A]}});if(0===e.data.data.length||void 0===e.data.data[0][A]||null===e.data.data[0][A])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for source weight unit ${t}. Ensure that the symbol is correct and is a weight unit symbol`);const n=await u.get(`/items/${E}?filter[${N}]=${a}`,{params:{fields:[A]}});if(0===n.data.data.length||void 0===n.data.data[0][A]||null===n.data.data[0][A])throw new Error(`[getAssayUnitConversionValue] failed to get conversion value for the target weight unit ${a}. Ensure that the symbol is correct and is a weight unit symbol`);const o=parseFloat(e.data.data[0][A]);if(isNaN(o))throw new Error(`[getAssayUnitConversionValue] source weight unit ${t} conversion value=${o} is not a number`);console.log(`[getAssayUnitConversionValue] source unit conversion value=${o}`);const r=parseFloat(n.data.data[0][A]);if(isNaN(r))throw new Error(`[getAssayUnitConversionValue] target weight unit ${t} conversion value=${r} is not a number`);return console.log(`[getAssayUnitConversionValue] target unit conversion value=${r}`),console.log("[getAssayUnitConversionValue] returning "+o/r),o/r}(H.data.data[0][C],l.value),rt=await async function(t,a,e){const n=await u.get(`/items/${V}?filter[${O}]=${a}`,{params:{fields:[F]}});if(!n.data.data||!n.data.data[0]||!n.data.data[0][F])throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] Dry weight uom not found for symbol ${a}`);const o=n.data.data[0][F];if("%"===e)return o===t?.01:await q(o,t);let r=e.split("/");if(1==r.length){const t=await async function(t){const a=await u.get(`/items/${E}`,{params:{fields:[N,U],filter:{[U]:{_nnull:!0},[N]:{_eq:t}}}});if(200!==a.status||!a.data||0===a.data.data.length)throw new Error("[getAssayUnitComposition] no assay units found with composition");return a.data.data[0][U]}(e);if(!t)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${e} does not have a composition`);r=t.split("/")}if(r.length>2||0===r.length)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] assay unit ${e} is not in the format of 'unit1/unit2'`);const i=r[0],s=r[1];let l=1;if(s!==o){const t=await q(o,s);if(isNaN(t)||0===t)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] conversion value=${t} for original weight unit ${o} and assay unit denominator ${s} is not a number or is zero`);l*=t}if(i!==t){const a=await q(i,t);if(isNaN(a)||0===a)throw new Error(`[getConversionValuesAndUnitsForPayableMetalCalculation] conversion value=${a} for evaluated contained metal uom ${i} and target weight unit ${t} is not a number or is zero`);l*=a}return console.log(`[getConversionValuesAndUnitsForPayableMetalCalculation] returning conversion value=${l}`),l}(e,H.data.data[0][b],H.data.data[0][C]);return{id:t.id,name:t.shipment_code,vessel:`${null!=(v=null==(m=null==X?void 0:X.data)?void 0:m.data[y])?v:"No vessel name found"}`,port:`${null!=(g=Z.data.data[w])?g:"No port found"}`,shipment_date:G(new Date(t.actual_shipment_date)),dry_weight:{loadport:(null!=(D=null==(f=K.inturn)?void 0:f.total_dry_weight)?D:0)*nt,disport:(null!=(P=null==(M=K.outturn)?void 0:M.total_dry_weight)?P:0)*nt,variance:tt.variance,variance_percent:tt.variance_percent},grade:{loadport:(null!=(k=null==(S=K.inturn)?void 0:S.final_assay)?k:0)*ot,disport:(null!=(T=null==(J=K.outturn)?void 0:J.final_assay)?T:0)*ot,variance:at.variance,variance_percent:at.variance_percent},metal:{loadport:(null!=(B=null==(j=K.inturn)?void 0:j.total_metal)?B:0)*rt,disport:(null!=(z=null==(R=K.outturn)?void 0:R.total_metal)?z:0)*rt,variance:et.variance,variance_percent:et.variance_percent},metal_uom:e,gain_loss:et.variance_percent>0?"Gain":"Loss"}}function x(t,a){if(null==t)throw new Error("Loadport (Inturn) assays must be defined as composite assays");if(null==a)throw new Error("Disport (Outturn) assays must be defined as assay lots");const e=a-t;return{variance:e,variance_percent:e/t*100}}function I(t){if(!t)return null;return{method:t.method,commodity:t.commodity,assay_uom:t.assay_uom,total_metal:t.dry_weight*t.final_assay,final_assay:t.final_assay,total_dry_weight:t.dry_weight}}function J(t){return!!t}function L(t){if(!t)return null;const a=t.filter(W).filter(J);if(0===a.length)return null;const e=a[0];let n={method:e.method,commodity:e.commodity,assay_uom:e.assay_uom,final_assay:0,total_metal:0,total_dry_weight:0};return a.forEach((t=>{n.total_metal=T(n.total_metal)+T(t.final_assay)*T(t.dry_weight),n.total_dry_weight=T(n.total_dry_weight)+T(t.dry_weight)})),n.final_assay=T(n.total_metal)/n.total_dry_weight,n}function T(t,a){return!t||Number.isNaN(t)?null!=a?a:0:t}function W(t){return!!t&&!(!("lot_number"in t)||!t.lot_number)}function j(t){const a=t.getDay(),e=t.getDate(),n=t.getMonth(),o=t.getFullYear();return`${["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][a]}, ${["January","February","March","April","May","June","July","August","September","October","November","December"][n]} ${e}, ${o}`}function G(t){const a=t.getDate(),e=t.getMonth(),n=t.getFullYear();return`${a} ${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][e]} ${n}`}async function q(t,a){if(t===a)return 1;const e=await u.get(`/items/${V}?filter[${F}]=${t}`,{params:{fields:[P]}});if(0===e.data.data.length||null===e.data.data[0][P]||void 0===e.data.data[0][P])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for source weight unit ${t}. Ensure that the symbol is correct and is a weight unit symbol`);const n=await u.get(`/items/${V}?filter[${F}]=${a}`,{params:{fields:[P]}});if(0===n.data.data.length||null===n.data.data[0][P]||void 0===n.data.data[0][P])throw new Error(`[getWeightUnitConversionValue] failed to get conversion value for the target weight unit ${a}. Ensure that the symbol is correct and is a weight unit symbol`);const o=parseFloat(e.data.data[0][P]);if(isNaN(o))throw new Error(`[getWeightUnitConversionValue] source weight unit ${t} conversion value=${o} is not a number`);const r=parseFloat(n.data.data[0][P]);if(isNaN(r))throw new Error(`[getWeightUnitConversionValue] target weight unit ${a} conversion value=${r} is not a number`);return console.log(`[getWeightUnitConversionValue] source weight unit=${t}, target weight unit=${a}, source weight unit conversion=${o}, target weight unit conversion=${r}`),console.log("[getWeightUnitConversionValue] conversion factor="+o/r),o/r}}});const p={key:0},_={key:1};var h=[],y=[];!function(t,a){if(t&&"undefined"!=typeof document){var e,n=!0===a.prepend?"prepend":"append",o=!0===a.singleTag,r="string"==typeof a.container?document.querySelector(a.container):document.getElementsByTagName("head")[0];if(o){var i=h.indexOf(r);-1===i&&(i=h.push(r)-1,y[i]={}),e=y[i]&&y[i][n]?y[i][n]:y[i][n]=s()}else e=s();65279===t.charCodeAt(0)&&(t=t.substring(1)),e.styleSheet?e.styleSheet.cssText+=t:e.appendChild(document.createTextNode(t))}function s(){var t=document.createElement("style");if(t.setAttribute("type","text/css"),a.attributes)for(var e=Object.keys(a.attributes),o=0;o<e.length;o++)t.setAttribute(e[o],a.attributes[e[o]]);var i="prepend"===n?"afterbegin":"beforeend";return r.insertAdjacentElement(i,t),t}}(".margin-top-16px[data-v-64969d30] {\n  margin-top: 16px;\n}",{}),f.render=function(t,a,e,n,o,f){const h=r("v-button"),y=r("v-notice");return i(),s(l,null,[u(' <input :value="value" @input="handleChange($event.target.value)" /> '),u(" create a button only interface for Directus"),t.value?(i(),s("div",_,[d(h,{onClick:a[1]||(a[1]=()=>t.viewPdf())},{default:c((()=>[m("View Loadport-Disport Doc ")])),_:1})])):(i(),s("div",p,[d(h,{onClick:a[0]||(a[0]=()=>t.generatePdf()),loading:t.isGeneraingDoc},{default:c((()=>[m("Generate Loadport-Disport Doc")])),_:1},8,["loading"]),t.failureReason?(i(),v(y,{key:0},{default:c((()=>[m(g(t.failureReason),1)])),_:1})):u("v-if",!0)])),d(h,{class:"margin-top-16px",onClick:a[2]||(a[2]=()=>t.copy()),loading:t.isCopying},{default:c((()=>[m("Copy")])),_:1},8,["loading"])],64)},f.__scopeId="data-v-64969d30",f.__file="src/interface.vue";var w=a({id:"navarch-loadport-disport-generator",name:"Loadport-Disport Comparison Doc Generator",icon:"receipt_long",description:"This is a custom interface for Navarch's Loadport-Disport Comparison Document Generator Button.",component:f,options:null,types:["json"],group:"standard"});export{w as default};
