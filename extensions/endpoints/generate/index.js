"use strict";var t=new(require("pdfmake"))({Roboto:{normal:"fonts/Roboto-Regular.ttf",bold:"fonts/Roboto-Medium.ttf",italics:"fonts/Roboto-Italic.ttf",bolditalics:"fonts/Roboto-MediumItalic.ttf"}}),e=require("fs");const n={footer:{fontSize:10,bold:!0,color:"lightgrey"},bigfont:{fontSize:15},midfont:{fontSize:13},smlfont:{fontSize:10},xsmlfont:{fontSize:8},tableExample:{margin:[0,5,0,15],fontSize:8},tableExample2:{margin:[0,5,0,0],fontSize:8},tableHeader:{bold:!0,fontSize:10,color:"black"},sectionHeader:{bold:!0,fontSize:10,color:"black",decoration:"underline"},bigSectionHeader:{margin:[0,12,0,12],bold:!0,fontSize:15,color:"black",decoration:"underline"},bigDocTitleInHeaderWithTop27Padding:{margin:[10,27,0,10],bold:!0,fontSize:15,color:"black",decoration:"underline"},bigDocTitleInHeader:{margin:[10,0,0,10],bold:!0,fontSize:15,color:"black",decoration:"underline"}};function a(n,a){var o=t.createPdfKitDocument(n);const r=process.env.STORAGE_LOCAL_ROOT||"uploads";return console.log(`[generatePdf] generated doc will be stored to location: ${r}`),o.pipe(e.createWriteStream(`${r}/${a}.pdf`)),o.end(),`${r}/${a}.pdf`}function o(t){return"number"==typeof t&&(t=t.toString()),t?t.replace(/\s/g,"_"):"undefined"}function r(t,e=4,n=!0){if(console.log("[formatNumber]"),isNaN(t)||null===t)return"-";const a=Math.round(t*Math.pow(10,e))/Math.pow(10,e),[o,r]=a.toString().split("."),i=(null!=o?o:"0").replace(/\B(?=(\d{3})+(?!\d))/g,",");if(!r&&!n)return i;return`${i}.${(null!=r?r:"").padEnd(e,"0")}`}function i(t){return[{canvas:[{type:"line",x1:0,y1:80,x2:100,y2:80,lineWidth:1}]},`${t.signatoryName}\n${t.signatoryTitle}\n${t.company}`]}function l(t,e){var n,a,o,r,i,l,s,c;if(t.length!==e.length)throw new Error(`[Assay Exchange Doc Builder] number of assays=${t.length} does not match the number of weights=${e.length}`);const d=t.length;let m=0,g=0;for(let y=0;y<d;y++)void 0!==t[y]&&void 0!==(null==(n=t[y])?void 0:n.analyticalAssay)&&void 0!==e[y]&&void 0!==(null==(a=e[y])?void 0:a.dryWeight)?(m+=(null!=(r=null==(o=t[y])?void 0:o.analyticalAssay)?r:0)*(null!=(l=null==(i=e[y])?void 0:i.dryWeight)?l:0),g+=null!=(c=null==(s=e[y])?void 0:s.dryWeight)?c:0):console.error(`[Assay Exchange Doc Builder] assay (${JSON.stringify(t[y])}) or weight (${JSON.stringify(e[y])}) no.${y} is undefined or one of their value is undefined`);return m/g}function s(t,e){var n,a,o,i,s,c,d,m,g;e.sort(((t,e)=>t.lotNumber-e.lotNumber));const y=function(t){const e=t.reduce(((t,e)=>t+e.wetWeight),0),n=t.reduce(((t,e)=>t+e.dryWeight),0);return{totalWetWeight:e,totalDryWeight:n,avgMoisture:(e-n)/e*100}}(e),h=function(t){const e={};for(const n of t)void 0===e[n.commodityCode]&&(e[n.commodityCode]=[]),e[n.commodityCode].push(n);const n=Object.values(e);return n.forEach((t=>t.sort(((t,e)=>t.lotNumber-e.lotNumber)))),n}(t);if(h.length!==e.length)return console.error(`[Assay Exchange Doc Builder] number of assay lots=${h.length} does not match the number of weight lots=${e.length}`),[];const u=function(t,e){const n=[];for(let a=0;a<e.length;a+=t)n.push(e.slice(a,a+t));return n}(2,h),p=[];for(const t of u)if(2===t.length){const d=t[0].sort(((t,e)=>t.lotNumber-e.lotNumber)),m=l(d,e),g=t[1].sort(((t,e)=>t.lotNumber-e.lotNumber)),h=l(g,e);p.push({style:"tableExample",table:{headerRows:1,widths:[50,60,30,60,30,60,30,60,60],body:[[{text:"Lot",alignment:"center"},{text:"WMT",alignment:"right"},{text:"UoM",alignment:"left"},{text:"Moisture",alignment:"right"},{text:"UoM",alignment:"left"},{text:"DMT",alignment:"right"},{text:"UoM",alignment:"left"},{text:`${null==(n=d[0])?void 0:n.commodityName} (${null==(a=d[0])?void 0:a.commodityCode} - ${null==(o=d[0])?void 0:o.assayUom})`,alignment:"center"},{text:`${null==(i=g[0])?void 0:i.commodityName} (${null==(s=g[0])?void 0:s.commodityCode} - ${null==(c=g[0])?void 0:c.assayUom})`,alignment:"center"}],...e.map(((t,e)=>{var n,a;return[{text:t.lotNumber,alignment:"center"},{text:r(t.wetWeight),alignment:"right"},t.wetWeightUom,{text:r(t.moisture),alignment:"right"},t.moistureUom,{text:r(t.dryWeight),alignment:"right"},t.dryWeightUom,{text:r(null==(n=d[e])?void 0:n.analyticalAssay),alignment:"center"},{text:r(null==(a=g[e])?void 0:a.analyticalAssay),alignment:"center"}]}))]}}),p.push({style:"tableExample",table:{headerRows:0,widths:[50,60,30,60,30,60,30,60,60],body:[[{text:"Total / Average",alignment:"center"},{text:r(y.totalWetWeight),alignment:"right"},"",{text:r(y.avgMoisture),alignment:"right"},"",{text:r(y.totalDryWeight),alignment:"right"},"",{text:r(m),alignment:"center"},{text:r(h),alignment:"center"}]]},pageBreak:"after"})}else if(1===t.length){const n=t[0].sort(((t,e)=>t.lotNumber-e.lotNumber)),a=l(n,e);p.push({style:"tableExample",table:{headerRows:1,widths:[50,60,30,60,30,60,30,120],body:[[{text:"Lot",alignment:"center"},{text:"WMT",alignment:"right"},{text:"UoM",alignment:"left"},{text:"Moisture",alignment:"right"},{text:"UoM",alignment:"left"},{text:"DMT",alignment:"right"},{text:"UoM",alignment:"left"},{text:`${null==(d=n[0])?void 0:d.commodityName} (${null==(m=n[0])?void 0:m.commodityCode} - ${null==(g=n[0])?void 0:g.assayUom})`,alignment:"center"}],...e.map(((t,e)=>{var a;return[{text:t.lotNumber,alignment:"center"},{text:r(t.wetWeight),alignment:"right"},t.wetWeightUom,{text:r(t.moisture),alignment:"right"},t.moistureUom,{text:r(t.dryWeight),alignment:"right"},t.dryWeightUom,{text:r(null==(a=n[e])?void 0:a.analyticalAssay),alignment:"center"}]}))]}}),p.push({style:"tableExample",table:{headerRows:0,widths:[50,60,30,60,30,60,30,120],body:[[{text:"Total / Average",alignment:"center"},{text:r(y.totalWetWeight),alignment:"right"},"",{text:r(y.avgMoisture),alignment:"right"},"",{text:r(y.totalDryWeight),alignment:"right"},"",{text:r(a),alignment:"center"}]]},pageBreak:"after"})}return p}function c(t){const e=[{text:"Composites",style:"sectionHeader"}];return e.push({style:"tableExample",table:{headerRows:1,widths:[100,60,100],body:[...t.map((t=>[{text:`${t.commodityName} (${t.commodityCode})`},{text:t.assayUom},{text:r(t.analyticalAssay)}]))]}}),e}function d(t){return[{text:"Assays:",style:"sectionHeader"},{style:"tableExample",table:{headerRows:0,widths:[100,10,"*"],body:[...t.map((t=>[t.commodity_name,":",`${r(t.analytical_assay)} ${t.assay_uom}`]))]},layout:"noBorders"}]}function m(t,e,n,a){return[{style:"tableExample",table:{headerRows:1,widths:[52,150,45,45,45,45,45,45,45,45,45,45],body:[["Parcel ID","Parcel Name","Mine","Commodity","Counterparty","Vessel","Invoice",e,"Assay","Element",`Rate (${n})`,`Value (${a})`],...g(t)]}},y(t)]}function g(t){const e=[];return t.forEach((t=>{e.push(...function(t){return t.penalties.map((e=>[t.id,t.name,e.mine,e.commodity_code,e.counterparty,t.vessel,t.invoice_type,r(t.dry_weight,2),r(e.assay),`${e.commodity_code} ${e.assay_uom}`,"0.00"===r(e.penalty_rate,2)?r(e.penalty_rate,6):r(e.penalty_rate,2),r(e.penalty_amount,2)]))}(t))})),e}function y(t){return{style:"tableExample",table:{headerRows:0,widths:["*",45],body:[[{text:"Grand Total",bold:!0},r(t.reduce(((t,e)=>t+e.penalties.reduce(((t,e)=>t+e.penalty_amount),0)),0),2)]]}}}function h(t){const{start_date:e,end_date:i,filter_date:l,parcels:s,wet_weight_uom:c,dry_weight_uom:d}=t.body,m=function(t,e,n,a){const o=function(t){const e=[];t.forEach((t=>{t.assays.forEach((t=>{e.push(t)}))}));const n=e.filter(((t,e,n)=>e===n.findIndex((e=>e.code===t.code)))),a=[];for(let t=0;t<n.length;t+=2)a.push(n.slice(t,t+2));return a}(t),i=function(t){const e=[];t.forEach((t=>{const n={};t.assays.forEach((t=>{n[t.code]=t})),e.push({name:t.name,counterparty:t.counterparty,port:t.port,vessel:t.vessel,phy_status:t.phy_status,fin_status:t.fin_status,shipment_date:t.shipment_date,weight_source:t.weight_source,wet_weight:t.wet_weight,dry_weight:t.dry_weight,moisture:t.moisture,assay_source:t.assay_source,assays:n})}));const n=[];return e.forEach((t=>{if(n.includes(t.name)){let e=1;for(;n.includes(`${t.name} (${e})`);)e++;n.push(`${t.name} (${e})`),t.name=`${t.name} (${e})`}else n.push(t.name)})),e}(t),l=function(t){const e=t.reduce(((t,e)=>t+e.wet_weight),0),n=t.reduce(((t,e)=>t+e.dry_weight),0);return{totalWetWeight:e,totalMoisture:(e-n)/e*100,totalDryWeight:n}}(t),s=function(t){const e={};return t.forEach((t=>{t.assays.forEach((t=>{e[t.code]?e[t.code]+=t.contained_metal:e[t.code]=t.contained_metal}))})),e}(t),c=[],d=o.length;return o.forEach(((t,o)=>{var m,g,y,h,p,$,b,f,_,w,v,S,E,W,A;2===t.length?(c.push({style:"tableExample",table:{headerRows:0,widths:[100,10,"*"],body:[["Filter Date",":",e]]},layout:"noBorders"}),c.push({style:"tableExample",table:{headerRows:2,widths:[43,46,46,46,37,37,37,37,37,37,37,37,37,37,37,37],body:[[{text:"Parcel",rowSpan:2,alignment:"center"},{text:"Counterparty",rowSpan:2,alignment:"center"},{text:"Port",rowSpan:2,alignment:"center"},{text:"Vessel",rowSpan:2,alignment:"center"},{text:"Status",colSpan:2,alignment:"center"},"",{text:"Shipment Date",rowSpan:2,alignment:"center"},{text:"Weight Source",rowSpan:2,alignment:"center"},{text:n,rowSpan:2,alignment:"center"},{text:"Moist",rowSpan:2,alignment:"center"},{text:a,rowSpan:2,alignment:"center"},{text:"Assay Source",rowSpan:2,alignment:"center"},{text:`${null==(m=t[0])?void 0:m.commodity} (${null==(g=t[0])?void 0:g.code})`,colSpan:2,alignment:"center"},"",{text:`${null==(y=t[1])?void 0:y.commodity} (${null==(h=t[1])?void 0:h.code})`,colSpan:2,alignment:"center"},""],["","","","","Physical","Financial","","","","","","",`Assay (${null==(p=t[0])?void 0:p.assay_uom})`,`Assay (${null==($=t[0])?void 0:$.contained_metal_uom})`,`Assay (${null==(b=t[1])?void 0:b.assay_uom})`,`Assay (${null==(f=t[1])?void 0:f.contained_metal_uom})`],...u(i,t)]}}),c.push({style:"tableExample",table:{headerRows:0,widths:["*",37,37,37,37,37,37,37,37],body:[[{text:"Grand Total",bold:!0},r(l.totalWetWeight,3),r(l.totalMoisture,3),r(l.totalDryWeight,3),"","",{text:r(x(s,null==(_=t[0])?void 0:_.code)),bold:!0,alignment:"right"},"",{text:r(x(s,null==(w=t[1])?void 0:w.code)),bold:!0,alignment:"right"}]]},pageBreak:d===o+1?void 0:"after"})):1===t.length&&(c.push({style:"tableExample",table:{headerRows:0,widths:[100,10,"*"],body:[["Filter Date",":",e]]},layout:"noBorders"}),c.push({style:"tableExample",table:{headerRows:2,widths:[43,46,46,46,37,37,37,37,37,37,37,37,37,37,37,37],body:[[{text:"Parcel",rowSpan:2,alignment:"center"},{text:"Counterparty",rowSpan:2,alignment:"center"},{text:"Port",rowSpan:2,alignment:"center"},{text:"Vessel",rowSpan:2,alignment:"center"},{text:"Status",colSpan:2,alignment:"center"},"",{text:"Shipment Date",rowSpan:2,alignment:"center"},{text:"Weight Source",rowSpan:2,alignment:"center"},{text:n,rowSpan:2,alignment:"center"},{text:"Moist",rowSpan:2,alignment:"center"},{text:a,rowSpan:2,alignment:"center"},{text:"Assay Source",rowSpan:2,alignment:"center"},{text:`${null==(v=t[0])?void 0:v.commodity} (${null==(S=t[0])?void 0:S.code})`,colSpan:4,alignment:"center"},"","",""],["","","","","Physical","Financial","","","","","","",{text:`Assay (${null==(E=t[0])?void 0:E.assay_uom})`,colSpan:2,alignment:"center"},"",{text:`Assay (${null==(W=t[0])?void 0:W.contained_metal_uom})`,colSpan:2,alignment:"center"},""],...u(i,t)]}}),c.push({style:"tableExample",table:{headerRows:0,widths:["*",37,37,37,37,37,37,37,37],body:[[{text:"Grand Total",bold:!0},r(l.totalWetWeight,3),r(l.totalMoisture,3),r(l.totalDryWeight,3),"",{text:"",colSpan:2},"",{text:r(x(s,null==(A=t[0])?void 0:A.code)),colSpan:2,bold:!0,alignment:"right"},""]]},pageBreak:d===o+1?void 0:"after"}))})),c}(s,l,c,d);var g={pageSize:"A4",pageOrientation:"landscape",pageMargins:[40,120,40,60],info:{title:"Shipment Latest",author:"Navarch Technologies",subject:"Shipment Latest",keywords:`shipment-latest-${o(e)}-${o(i)}`},header:function(t,n,a){return{margin:[40,60,40,0],stack:[{text:"Shipment Latest",style:"bigDocTitleInHeader",alignment:"center",bold:!0},{text:`From ${e} to ${i}`,alignment:"center",italics:!0}]}},footer:function(t,n,a){return{margin:[40,0,40,0],columns:[{text:`Shipment Latest - with Metals\nFrom ${e} to ${i}`,style:"xsmlfont",alignment:"left"},{text:"Page "+t.toString()+" of "+n.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}},content:[...m],styles:n};const y=`shipment-latest-${o(e)}-${o(i)}`;return a(g,y),y}function u(t,e){return t.map((t=>{var n,a,o,i,l,s;return 2===e.length?[t.name,t.counterparty,t.port,t.vessel,t.phy_status,t.fin_status,t.shipment_date,t.weight_source,r(t.wet_weight,3),r(t.moisture,2),r(t.dry_weight,3),t.assay_source,r(p(t,null==(n=e[0])?void 0:n.code,"assay")),r(p(t,null==(a=e[0])?void 0:a.code,"contained_metal")),r(p(t,null==(o=e[1])?void 0:o.code,"assay")),r(p(t,null==(i=e[1])?void 0:i.code,"contained_metal"))]:1===e.length?[t.name,t.counterparty,t.port,t.vessel,t.phy_status,t.fin_status,t.shipment_date,t.weight_source,r(t.wet_weight,3),r(t.moisture,2),r(t.dry_weight,3),t.assay_source,{text:r(p(t,null==(l=e[0])?void 0:l.code,"assay")),colSpan:2},"",{text:r(p(t,null==(s=e[0])?void 0:s.code,"contained_metal")),colSpan:2},""]:[]}))}function p(t,e,n){if(e){const a=t.assays[e];if(a)return a[n]}return"-"}function x(t,e){if(!e)return"";const n=t[e];return n||""}function $(t){const{start_date:e,end_date:r,metal:i,assay_uom:l,parcels:s,dry_weight_uom:c,dry_weight_uom_name:d}=t.body,m=function(t,e,n,a,o){const r=b(t.map((t=>t.dry_weight))),i=b(t.map((t=>t.grade))),l=b(t.map((t=>t.metal)),1);return[{style:"tableExample",table:{headerRows:0,widths:[100,10,"*"],body:[["Metal",":",`${e} (${n})`]]},layout:"noBorders"},{style:"tableExample",table:{headerRows:2,widths:[25,40,40,40,33,30,30,30,30,30,30,30,30,30,30,30,30,25,25],body:[[{text:"Parcel ID",rowSpan:2,alignment:"center"},{text:"Parcel",rowSpan:2,alignment:"center"},{text:"Vessel",rowSpan:2,alignment:"center"},{text:"Port",rowSpan:2,alignment:"center"},{text:"Shipment",rowSpan:2,alignment:"center"},{text:`${o} (${a})`,colSpan:4,alignment:"center"},"","","",{text:"Grade",colSpan:4,alignment:"center"},"","","",{text:"Metal",colSpan:6,alignment:"center"},"","","","",""],["","","","","","Loadport","Disport","Variance","Variance %","Loadport","Disport","Variance","Variance %","Loadport","Disport","Variance","Variance %","Unit","Gain/Loss"],...f(t)]}},{style:"tableExample",table:{headerRows:0,widths:["*",30,30,30,30,30,30,30,30,30,30,30,30,50],body:[[{text:"Grand Total",bold:!0},r.loadport,r.disport,r.variance,r.variance_percent,i.loadport,i.disport,i.variance,i.variance_percent,l.loadport,l.disport,l.variance,l.variance_percent,""]]}}]}(s,i,l,c,d);var g={pageSize:"A4",pageOrientation:"landscape",pageMargins:[40,120,40,60],info:{title:"Loadport - Disport Comparison - Grouped",author:"Navarch Technologies",subject:"Loadport - Disport Comparison - Grouped",keywords:`Loadport-Disport-Comparison-Grouped-${o(e)}-${o(r)}`},header:function(t,n,a){return{margin:[40,60,40,0],stack:[{text:"Loadport - Disport Comparison - Grouped",style:"bigDocTitleInHeader",alignment:"center",bold:!0},{text:`From ${e} to ${r}`,alignment:"center",italics:!0}]}},footer:function(t,n,a){return{margin:[40,0,40,0],columns:[{text:`Loadport - Disport Comparison - Grouped\nFrom ${e} to ${r}`,style:"xsmlfont",alignment:"left"},{text:"Page "+t.toString()+" of "+n.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}},content:[...m],styles:n};const y=`loadport-disport-compare-${o(e)}-${o(r)}`;return a(g,y),y}function b(t,e=2){const n=t.reduce(((t,e)=>t+e.loadport),0),a=t.reduce(((t,e)=>t+e.disport),0),o=a-n,i=o/n*100;return{loadport:r(n,e),disport:r(a,e),variance:r(o,e),variance_percent:r(i,e)}}function f(t){return t.map((t=>[t.id,t.name,t.vessel,t.port,t.shipment_date,r(t.dry_weight.loadport,2),r(t.dry_weight.disport,2),r(t.dry_weight.variance,2),r(t.dry_weight.variance_percent,2),r(t.grade.loadport,2),r(t.grade.disport,2),r(t.grade.variance,2),r(t.grade.variance_percent,2),r(t.metal.loadport,2),r(t.metal.disport,2),r(t.metal.variance,2),r(t.metal.variance_percent,2),t.metal_uom,t.gain_loss]))}require("dotenv").config();var _=t=>{t.post("/assay-exchange",((t,e)=>{try{const r=function(t){const{seller:e,seller_address:r,seller_phone_number:l,buyer:d,parcel_ref:m,contract_ref:g,vessel:y,bl_date:h,port_of_loading:u,port_of_discharge:p,assays:x,composite_assays:$,weights:b,signatory:f}=t.body;var _={pageSize:"A4",pageMargins:[40,260,40,60],info:{title:`${e}`,author:"Navarch Technologies",subject:`Assay Exchange Certificate (${m})`,keywords:`${o(m)}-assay-exchange-cert`},header:function(t,n,a){return{margin:[40,60,40,0],stack:[{columns:[{width:"25%",stack:[{text:`${e}\n`,style:e&&e.length<=20?"midfont":"smlfont",bold:!0},{text:`${r}\n\n`,style:"xsmlfont"},{text:`${l}\n\n\n`,style:"xsmlfont"}]},{width:"50%",text:"Assay Exchange Certificate",style:"bigDocTitleInHeaderWithTop27Padding",alignment:"center"},{width:"25%",text:""}]},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]},{style:"tableExample",table:{widths:[90,220,"*",100],body:[[{text:"Buyer Information",style:"tableHeader",decoration:"underline",colSpan:3},"","",{text:"Shipment Information",style:"tableHeader",decoration:"underline",alignment:"right"}],["Buyer:",{text:`${d}`,bold:!0},"Vessel:",{text:`${y}`,alignment:"right"}],["Seller Contract:",`${g}`,"Port of Loading:",{text:`${u}`,alignment:"right"}],["Parcel:",`${m}`,"B/L Date:",{text:`${h}`,alignment:"right"}],["","","Port of Discharge:",{text:`${p}`,alignment:"right"}]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]}]}},footer:function(t,e,n){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:1}]}," ",{columns:[" ",{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[...s(x,b),...c($),...i(f)],styles:n};const w=`${o(m)}-assay-exchange-cert`;return a(_,w),w}(t);e.send(r)}catch(t){console.error(t),e.status(400).send(`An error occurred while generating the Assay Exchange Certificate document. Error=${t}`)}})),t.post("/cert-of-origin",((t,e)=>{try{const l=function(t){const{parcel_id:e,seller:l,seller_address:s,seller_phone_number:c,buyer:d,contract_ref:m,vessel:g,bl_date:y,port_of_loading:h,port_of_discharge:u,wet_weight:p,wet_weight_uom:x,country_of_origin:$,commodity_name:b,other_comments:f,signatory:_}=t.body;var w={pageSize:"A4",pageMargins:[40,260,40,60],info:{title:`${l}`,author:"Navarch Technologies",subject:`Certificate of Origin for Parcel ${e}`,keywords:`cert-of-origin-${o(b)}`},header:function(t,e,n){return{margin:[40,60,40,0],stack:[{text:`${l}\n`,style:l&&l.length<=20?"midfont":"smlfont",bold:!0},{text:`${s}\n\n`,style:"xsmlfont"},{text:`${c}\n\n\n`,style:"xsmlfont"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]},{style:"tableExample",table:{widths:[90,220,"*",100],body:[[{text:"Buyer Information",style:"tableHeader",decoration:"underline",colSpan:3},"","",{text:"Shipment Information",style:"tableHeader",decoration:"underline",alignment:"right"}],["Buyer:",{text:`${d}`,bold:!0},"Vessel:",{text:`${g}`,alignment:"right"}],["Contract Reference:",`${m}`,"Port of Loading:",{text:`${h}`,alignment:"right"}],["Commodity:",""===b?"No primary commodity":`${b} Concentrates`,"B/L Date:",{text:`${y}`,alignment:"right"}],["","","Port of Discharge:",{text:`${u}`,alignment:"right"}]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]}]}},footer:function(t,e,n){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:1}]}," ",{columns:[" ",{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[{text:"Certificate of Origin",style:"bigSectionHeader",alignment:"center"},{style:"tableExample",table:{headerRows:0,widths:[100,10,"*"],body:[[{text:"Material"},":",{text:`${r(p)} ${x}`+(""===b?"":` of ${b} Concentrates`)}],[{text:"Country of Origin"},":",$],[{text:"Other Comments"},":",f]]},layout:"noBorders"},...i(_)],styles:n};const v=`cert-of-origin-parcel#${o(e)}-contract#${o(m)}`;return a(w,v),v}(t);e.send(l)}catch(t){console.error(t),e.status(400).send(`An error occurred while generating the Certificate of Origin document. Error=${t}`)}})),t.post("/loadport-disport-compare",((t,e)=>{try{const n=$(t);e.send(n)}catch(t){console.error(t),e.status(400).send(`An error occurred while generating the Loadport - Disport Comparison document. Error=${t}`)}})),t.post("/shipment-latest",((t,e)=>{try{const n=h(t);e.send(n)}catch(t){console.error(t),e.status(400).send(`An error occurred while generating the Shipment Latest document. Error=${t}`)}})),t.post("/penalty-elements",((t,e)=>{try{const r=function(t){const{start_date:e,end_date:r,filter_date:i,invoice_type:l,parcels:s,dry_weight_uom:c,penalty_rate_uom:d,currency:g}=t.body;var y={pageSize:"A4",pageOrientation:"landscape",pageMargins:[40,120,40,60],info:{title:"Penalty Elements",author:"Navarch Technologies",subject:"Penalty Elements",keywords:`penalty-elments-${o(e)}-${o(r)}`},header:function(t,n,a){return{margin:[40,50,40,0],stack:[{text:"Penalty Elements",style:"bigDocTitleInHeader",alignment:"center",bold:!0},{text:`From ${e} to ${r}`,alignment:"center",italics:!0}]}},footer:function(t,n,a){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:762,y2:0,lineWidth:1}]}," ",{columns:[{text:`Penalty Elements\nFrom ${e} to ${r}`,style:"xsmlfont",alignment:"left"},{text:"Page "+t.toString()+" of "+n.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[{style:"tableExample",table:{headerRows:0,widths:[100,10,"*"],body:[["Filter Date",":",i],["Invoice Type",":",l]]},layout:"noBorders"},...m(s,c,d,g)],styles:n};const h=`penalty-elments-${o(e)}-${o(r)}`;return a(y,h),h}(t);e.send(r)}catch(t){console.error(t),e.status(400).send(`An error occurred while generating the Penalty Element document. Error=${t}`)}})),t.post("/weight-and-assay-cert",((t,e)=>{try{const l=function(t){const{invoice_type:e,seller:l,seller_address:s,seller_phone_number:c,buyer:m,contract_ref:g,vessel:y,bl_date:h,commodity_name:u,port_of_loading:p,port_of_discharge:x,wet_weight:$,wet_weight_uom:b,dry_weight:f,dry_weight_uom:_,moisture:w,moisture_uom:v,assays:S,signatory:E}=t.body;var W={pageSize:"A4",pageMargins:[40,260,40,60],info:{title:`${l}`,author:"Navarch Technologies",subject:`${e} Weight and Assay Certificate`,keywords:`${e}-weight-and-assay-cert-${o(g)}`},header:function(t,n,a){return{margin:[40,60,40,0],stack:[{columns:[{width:"25%",stack:[{text:`${l}\n`,style:l&&l.length<=20?"midfont":"smlfont",bold:!0},{text:`${s}\n\n`,style:"xsmlfont"},{text:`${c}\n\n\n`,style:"xsmlfont"}]},{width:"50%",text:`${e} Weight & Assay Certificate`,style:"bigDocTitleInHeaderWithTop27Padding",alignment:"center"},{width:"25%",text:""}]},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]},{style:"tableExample",table:{widths:[90,220,"*",100],body:[[{text:"Buyer Information",style:"tableHeader",decoration:"underline",colSpan:3},"","",{text:"Shipment Information",style:"tableHeader",decoration:"underline",alignment:"right"}],["Buyer:",{text:`${m}`,bold:!0},"Vessel:",{text:`${y}`,alignment:"right"}],["Contract Reference:",`${g}`,"Port of Loading:",{text:`${p}`,alignment:"right"}],["Commodity:",`${u} Concentrates`,"B/L Date:",{text:`${h}`,alignment:"right"}],["","","Port of Discharge:",{text:`${x}`,alignment:"right"}]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]}]}},footer:function(t,e,n){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:1}]}," ",{columns:[" ",{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[{text:"We hereby certify the following provisional weights and assays for the above mentioned shipment.",alignment:"center",margin:[0,12,0,12]},{text:"Weights:",style:"sectionHeader"},{style:"tableExample",table:{headerRows:0,widths:[100,10,"*"],body:[[{text:"Wet Weight"},":",`${r($)} ${b}`],[{text:"Moisture"},":",`${r(w)} ${v}`],[{text:"Dry Weight"},":",`${r(f)} ${_}`]]},layout:"noBorders"},...d(S),...i(E)],styles:n};const A=`${e}-weight-and-assay-cert-${o(g)}`;return a(W,A),A}(t);e.send(l)}catch(t){console.error(t),e.status(400).send(`An error occurred while generating the Provisional/Final Weight And Assay Certificate document. Error=${t}`)}})),t.post("/invoice",((t,e)=>{try{const r=function(t){const{seller:e,seller_address:r,seller_phone_number:l,buyer:s,buyer_address:c,shipment_code:d,vessel:m,bl_date:g,invoice_type:y,invoice_date:h,revision:u,invoice_number:p,parcel:x,port_of_loading:$,port_of_discharge:b,primary_commodity:f,due_date:_,wet_weight:w,wet_weight_uom:v,wet_weight_uom_name:S,moisture:E,moisture_uom:W,dry_weight:A,dry_weight_uom:P,dry_weight_uom_name:D,total_revenue:T,total_deductions:B,currency:C,commodities:N,penalties:M,adjustments:R,invoice_value:I,payable_percentage:L,payable_amount:k,payment_received_source:H,payment_received:V,balance_in_sellers_favor:U,signatory:z,remittance:O}=t.body,j=function(t,e,n,a="USD"){var o=[];for(const r of t)o.push({style:"tableExample2",table:{widths:[70,120,"*",70],body:[[{text:`${r.commodity}:`,style:"tableHeader"},"","",""],[{text:`${r.analytical_assay}${r.assay_uom}`,alignment:"right"},`${r.commodity} Analytical Assay`,"",""],[{text:`${r.payable_assay}${r.assay_uom}`,alignment:"right"},`${r.commodity} Payable Assay`,`${r.deduction_expression}`,""],[{text:`${r.payable_metal} ${r.payable_metal_uom}`,alignment:"right"},`${r.commodity} Payable Metal`,`${r.payable_metal_expression}`,""],[{text:`${r.qp}`,alignment:"right"},`${r.commodity} QP Month`,"",""],[{text:`${a} ${r.price_rate}/${r.price_per_uom}`,alignment:"right"},{text:`${r.commodity} Price: ${r.qp_date_range} - ${r.price_method}`,colSpan:2},"",""],["",`${r.commodity} Payable Value`,`${r.payable_metal} ${r.payable_metal_uom} * ${a} ${r.price_rate}/${r.price_per_uom}`,{text:`${a} ${r.price}`,alignment:"right",bold:!0}],...r.treatment_charge?r.treatment_charge.rate===r.treatment_charge.final_rate?[["","Treatment Charge",`${e} ${n} * ${a} ${r.treatment_charge.final_rate}/${r.treatment_charge.per_uom}`,{text:`${a} (${r.treatment_charge.final_amount})`,alignment:"right",bold:!0}]]:[[{text:`${a} ${r.treatment_charge.discount}/${r.treatment_charge.per_uom}`,alignment:"right"},"Treatment Charge Discount","",""],[{text:`${a} ${r.treatment_charge.final_rate}/${r.treatment_charge.per_uom}`,alignment:"right"},`${r.commodity} Treatment Charge Rate`,`${a} ${r.treatment_charge.rate}/${r.treatment_charge.per_uom}${void 0===r.treatment_charge.discount||0===r.treatment_charge.discount?"":` - ${a} ${r.treatment_charge.discount}/${r.treatment_charge.per_uom}`}`,""],["","Treatment Charge",`${e} ${n} * ${a} ${r.treatment_charge.final_rate}/${r.treatment_charge.per_uom}`,{text:`${a} (${r.treatment_charge.final_amount})`,alignment:"right",bold:!0}]]:[]]},layout:"noBorders"}),o.push({canvas:[{type:"line",x1:442,y1:5,x2:522,y2:5,lineWidth:1}]}),o.push({style:"tableExample2",table:{widths:[70,120,"*",70],body:[["","",{text:`Total ${r.commodity}:`,alignment:"right",bold:!0},{text:`${a} ${r.final_total}`,alignment:"right",bold:!0}]]},layout:"noBorders"}),o.push({canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:1}]});return o}(N,A,P,C),F=function(t,e,n,a="USD"){const o=[];if(0===t.penalties.length)return[];const r=[];return o.push({style:"tableExample2",table:{widths:[70,120,"*",70],body:[[{text:"Penalties:",style:"tableHeader"},"","",""],...r.concat(...t.penalties.map((t=>"No penalty"===t.deduction_expression?[[{text:`${t.analytical_assay}${t.assay_uom}`,alignment:"right"},`${t.commodity} Analytical Assay`,"",""]]:[[{text:`${t.analytical_assay}${t.assay_uom}`,alignment:"right"},`${t.commodity} Analytical Assay`,"",""],[{text:`${a} ${t.final_penalty_rate}/${t.penalty_per_uom}`,alignment:"right"},`${t.commodity} Penalty`,`${t.deduction_expression}`,""],["",`${t.commodity} Penalty`,`${e} ${n} * ${a} ${t.final_penalty_rate}/${t.penalty_per_uom}`,{text:`${a} (${t.final_penalty})`,alignment:"right",bold:!0}]])))]},layout:"noBorders"}),o.push({canvas:[{type:"line",x1:442,y1:5,x2:522,y2:5,lineWidth:1}]}),o.push({style:"tableExample2",table:{widths:[70,160,"*",70],body:[["","",{text:"Total Penalties:",alignment:"right",bold:!0},{text:`${a} (${t.total_penalties})`,alignment:"right",bold:!0}]]},layout:"noBorders"}),o.push({canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:1}]}),o}(M,A,P,C),G=function(t,e="USD"){if(!t||0===t.adjustments.length)return[];const n=[];return n.push({style:"tableExample2",table:{widths:[70,120,"*",70],body:[[{text:"Adjustments:",style:"tableHeader"},"","",""],...t.adjustments.map((t=>["",`${t.description} :`,"",{text:`${e} ${t.amount}`,alignment:"right",bold:!0}]))]},layout:"noBorders"}),n.push({canvas:[{type:"line",x1:442,y1:5,x2:522,y2:5,lineWidth:1}]}),n.push({style:"tableExample2",table:{widths:[70,160,"*",70],body:[["","",{text:"Total Adjustments:",alignment:"right",bold:!0},{text:`${e} ${t.total_adjustments}`,alignment:"right",bold:!0}]]},layout:"noBorders"}),n.push({canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:1}]}),n}(R,C),q=function(t,e="USD"){const n=[];for(const e of t)n.push(["",`${e.commodity} Analytical Assay`,"",{text:`${e.analytical_assay}${e.assay_uom}`,alignment:"right"}]);for(const a of t)n.push(["",{text:`${a.commodity} Price: ${a.qp_date_range} - ${a.price_method}`,colSpan:2},"",{text:`${e} ${a.price_rate}/${a.price_per_uom}`,alignment:"right"}]);for(const e of t)n.push(["",`${e.commodity} QP Month : (To Be Declared)`,"",{text:`${e.qp}`,alignment:"right"}]);return n}(N,C);var J={pageSize:"A4",pageMargins:[40,380,40,60],info:{title:`${e}`,author:"Navarch Technologies",subject:`Invoice ${p}`,keywords:`${o(p)}`},header:function(t,n,a){return{margin:[40,60,40,0],stack:[{text:`${e}\n`,style:e&&e.length<=20?"midfont":"smlfont",bold:!0},{text:`${r}\n\n`,style:"xsmlfont"},{text:`${l}\n\n\n`,style:"xsmlfont"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]},{style:"tableExample",table:{widths:[90,220,"*",100],body:[[{text:"Buyer Information",style:"tableHeader",decoration:"underline",colSpan:3},"","",{text:"Shipment Information",style:"tableHeader",decoration:"underline",alignment:"right"}],[{text:`${s}`,bold:!0,colSpan:2},"","Shipment:",{text:`${d}`,alignment:"right"}],[{text:`${c}`,rowSpan:2},"","Vessel:",{text:`${m}`,alignment:"right"}],["","","B/L Date:",{text:`${g}`,alignment:"right"}]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:1}]},{style:"tableExample",table:{widths:[90,220,"*",100],body:[[{text:"Invoice",style:"tableHeader"},{text:`${y}`,style:"tableHeader"},"Port of Loading:",{text:`${$}`,alignment:"right"}],["Invoice Date:",`${h}`,"Port of Discharge:",{text:`${b}`,alignment:"right"}],["Revision:",`${null!=u?u:"-"}`,"Commodity:",{text:`${f}`,alignment:"right"}],["Invoice Number:",`${p}`,"",""],["Parcel:",`${x}`,"",""]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]}]}},footer:function(t,e,n){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:1}]}," ",{columns:[" ",{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[{style:"tableExample",table:{widths:[90,220,"*",100],body:[[{text:"Summary:",style:"tableHeader"},"","",""],["",`${S} `,"",{text:`${w} ${v}`,alignment:"right"}],["","Moisture","",{text:`${E}${W}`,alignment:"right"}],["",`${D} `,"",{text:`${A} ${P}`,alignment:"right"}],...q,["","Total Revenue","",{text:`${C} ${T}`,alignment:"right"}],["","Total Deductions","",{text:`${C} ${B}`,alignment:"right"}]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:1}]},{style:"tableExample2",table:{widths:[90,220,"*",100],body:[[{text:"Totals:",style:"tableHeader"},"","",""],["","Invoice Value","",{text:`${C} ${I}`,alignment:"right"}],["",`Payable Value @ ${L}% of Invoice Value`,"",{text:`${C} ${k}`,alignment:"right"}],...H&&V?[["",`Payment received: ${H}`,"",{text:`${C} (${V})`,alignment:"right"}]]:[]]},layout:"noBorders"},{canvas:[{type:"line",x1:442,y1:5,x2:522,y2:5,lineWidth:1}]},{style:"tableExample2",table:{widths:[90,220,"*",100],body:[["",{text:"BALANCE IN SELLERS FAVOUR",bold:!0,colSpan:2,alignment:"right"},"",{text:`${C} ${U}`,bold:!0,alignment:"right"}]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:1}]},{style:"tableExample",table:{widths:[90,220,"*",100],body:[[{text:"Payment Advice:",style:"tableHeader"},`Due ${_}`,"",""],["",`When remitting please quote: ${p}`,"",""]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]},{style:"tableExample",table:{widths:[90,220,"*",100],body:[["",{text:"Please remit to",decoration:"underline"},"",""],["",O,"",""]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:2}]},...i(z),{text:"",pageBreak:"after"},{style:"tableExample2",table:{widths:[70,220,"*",100],body:[[{text:"Weights:",style:"tableHeader"},"","",""],[{text:`${w} ${v}`,alignment:"right"},`${S} `,"",""],[{text:`${E}${W}`,alignment:"right"},"Moisture","",""],[{text:`${A} ${P}`,alignment:"right"},`${D} `,"",""]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:1}]},...j,...F,...G,{style:"tableExample2",table:{widths:[70,160,"*",70],body:[[{text:"Totals:",style:"tableHeader"},"","",""],["","Invoice Value","",{text:`${C} ${I}`,alignment:"right",bold:!0}],["",`Payable Value @ ${L}% of Invoice Value`,"",{text:`${C} ${k}`,alignment:"right",bold:!0}],...H&&V?[["",{text:`Payment received: ${H}`,colSpan:2},"",{text:`${C} (${V})`,alignment:"right",bold:!0}]]:[]]},layout:"noBorders"},{canvas:[{type:"line",x1:442,y1:5,x2:522,y2:5,lineWidth:1}]},{style:"tableExample2",table:{widths:[70,160,"*",70],body:[["",{text:"BALANCE IN SELLERS FAVOUR",bold:!0,colSpan:2,alignment:"right"},"",{text:`${C} ${U}`,bold:!0,alignment:"right"}]]},layout:"noBorders"},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:1}]}],styles:n};const Q=o(`${p}-${y}`);return a(J,Q),Q}(t);e.send(r)}catch(t){console.error(t),e.status(400).send(`An error occurred while generating the Invoice document. Error=${t}`)}}))};module.exports=_;
