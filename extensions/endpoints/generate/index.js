"use strict";var t=require("crypto");var e=new(require("pdfmake"))({Roboto:{normal:"fonts/Roboto-Regular.ttf",bold:"fonts/Roboto-Medium.ttf",italics:"fonts/Roboto-Italic.ttf",bolditalics:"fonts/Roboto-MediumItalic.ttf"}}),n=require("fs");const a={footer:{fontSize:9,bold:!0,color:"lightgrey"},bigfont:{fontSize:15},midfont:{fontSize:13},smlfont:{fontSize:9},xsmlfont:{fontSize:6},marginBottom5:{margin:[0,0,0,5]},tableSmlTopMarginLrgBottomMargin:{margin:[0,5,0,15],fontSize:6},tableSmlTopMargin:{margin:[0,5,0,0],fontSize:6},tableSmlBottomMargin:{margin:[0,0,0,5],fontSize:6},tableSmlBottomMarginSmlTopMargin:{margin:[0,5,0,5],fontSize:6},tableHeader:{bold:!0,fontSize:9,color:"black"},tableHeaderCell:{bold:!0,color:"black"},sectionHeader:{bold:!0,fontSize:9,color:"black",decoration:"underline"},bigSectionHeader:{margin:[0,12,0,12],bold:!0,fontSize:15,color:"black"},bigDocTitleInHeaderWithTop10Padding:{margin:[10,10,0,10],bold:!0,fontSize:15,color:"black"},bigDocTitleInHeaderWithTop27Padding:{margin:[10,27,0,10],bold:!0,fontSize:15,color:"black"},bigDocUnderlinedTitleInHeaderWithTop27Padding:{margin:[10,27,0,10],bold:!0,fontSize:15,color:"black",decoration:"underline"},bigUnderlinedTitleForHeader:{margin:[10,0,0,10],bold:!0,fontSize:15,color:"black",decoration:"underline"},bigTitleForHeader:{margin:[10,0,0,10],bold:!0,fontSize:15,color:"black"}};function r(a,r,l=null,o=null){var i=e.createPdfKitDocument(a);const s=t.randomUUID(),c=process.env.STORAGE_LOCATIONS||"local";return console.log(`[generatePdf] generated doc ${s} will be stored to ${c}`),"local"===c?(i.pipe(n.createWriteStream(`uploads/formatting/${r}.pdf`)),i.end(),Promise.resolve(void 0)):new Promise(((t,e)=>{const n=[];i.on("data",(t=>n.push(t))),i.on("end",(()=>{const e=Buffer.concat(n).toString("base64");console.log(`folder=${o}`);const a={id:s,file:e,filename_disk:`${s}.pdf`,filename_download:`${r}.pdf`,title:null!=l?l:r,type:"application/pdf",storage:"gcs",folder:o,charset:null,filesize:e.length,width:null,height:null,duration:null,embed:null,description:null,location:null,tags:null,metadata:null};t(a)})),i.on("error",e),i.end()}))}function l(t){return"number"==typeof t&&(t=t.toString()),t?t.replace(/\s/g,"_"):"undefined"}function o(t,e=4,n=!0){if(isNaN(t)||null===t)return"-";const a=Math.round(t*Math.pow(10,e))/Math.pow(10,e),[r,l]=a.toString().split("."),o=(null!=r?r:"0").replace(/\B(?=(\d{3})+(?!\d))/g,",");if(!l&&!n)return o;return`${o}.${(null!=l?l:"").padEnd(e,"0")}`}function i(t,e=2){let n;return n="number"==typeof t?o(t,e):t,n&&"-"!==n?n.startsWith("-")?`(${n.slice(1)})`:n:"-"}function s(t){return t?`data:${t.imageType};base64,${t.imageData}`:null}function c(){const t=new Date,e=60*t.getTimezoneOffset()*1e3,n=t.getTime()-e,a=new Date(n).toISOString().slice(0,19),r=t.getTimezoneOffset()/60*-1;return`${a}GMT${r>0?"+":""}${r}`.replace(/:/g,"")}function d(t){const e=new Date(t),n=60*e.getTimezoneOffset()*1e3,a=e.getTime()-n;return new Date(a).toISOString().slice(0,10)}function g(t){return Array(t).fill({text:"",border:[!1,!1,!1,!0]})}function m(t){return Array(t-1).fill("").concat({text:"",border:[!1,!1,!1,!0]})}function u(t){const e=t.signature?0:80;return[t.signature?{image:s(t.signature),fit:[90,80]}:null,{canvas:[{type:"line",x1:0,y1:e,x2:100,y2:e,lineWidth:1}]},`${t.signatoryName}\n${t.signatoryTitle}\n${t.company}`]}function h(t,e){var n,a,r,l,o,i,s,c;if(t.length!==e.length)throw new Error(`[Assay Exchange Doc Builder] number of assays=${t.length} does not match the number of weights=${e.length}`);const d=t.length;let g=0,m=0;for(let u=0;u<d;u++)void 0!==t[u]&&void 0!==(null==(n=t[u])?void 0:n.analyticalAssay)&&void 0!==e[u]&&void 0!==(null==(a=e[u])?void 0:a.dryWeight)?(g+=(null!=(l=null==(r=t[u])?void 0:r.analyticalAssay)?l:0)*(null!=(i=null==(o=e[u])?void 0:o.dryWeight)?i:0),m+=null!=(c=null==(s=e[u])?void 0:s.dryWeight)?c:0):console.error(`[Assay Exchange Doc Builder] assay (${JSON.stringify(t[u])}) or weight (${JSON.stringify(e[u])}) no.${u} is undefined or one of their value is undefined`);return g/m}function y(t,e){var n,a,r,l,i,s,c,d,g;e.sort(((t,e)=>t.lotNumber-e.lotNumber));const m=function(t){const e=t.reduce(((t,e)=>t+e.wetWeight),0),n=t.reduce(((t,e)=>t+e.dryWeight),0);return{totalWetWeight:e,totalDryWeight:n,avgMoisture:(e-n)/e*100}}(e),u=function(t){const e={};for(const n of t)void 0===e[n.commodityCode]&&(e[n.commodityCode]=[]),e[n.commodityCode].push(n);const n=Object.values(e);return n.forEach((t=>t.sort(((t,e)=>t.lotNumber-e.lotNumber)))),n}(t),y=function(t,e){const n=[];for(let a=0;a<e.length;a+=t)n.push(e.slice(a,a+t));return n}(2,u),p=[];for(const t of y)if(2===t.length){const c=t[0].sort(((t,e)=>t.lotNumber-e.lotNumber)),d=h(c,e),g=t[1].sort(((t,e)=>t.lotNumber-e.lotNumber)),u=h(g,e);p.push({style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:1,widths:[50,60,30,60,30,60,30,60,60],body:[[{text:"Lot",alignment:"center",style:"tableHeaderCell"},{text:"Wet Weight",alignment:"right",style:"tableHeaderCell"},{text:"Unit",alignment:"left",style:"tableHeaderCell"},{text:"Moisture",alignment:"right",style:"tableHeaderCell"},{text:"Unit",alignment:"left",style:"tableHeaderCell"},{text:"Dry Weight",alignment:"right",style:"tableHeaderCell"},{text:"Unit",alignment:"left",style:"tableHeaderCell"},{text:`${null==(n=c[0])?void 0:n.commodityName} (${null==(a=c[0])?void 0:a.commodityCode} - ${null==(r=c[0])?void 0:r.assayUom})`,alignment:"center",style:"tableHeaderCell"},{text:`${null==(l=g[0])?void 0:l.commodityName} (${null==(i=g[0])?void 0:i.commodityCode} - ${null==(s=g[0])?void 0:s.assayUom})`,alignment:"center",style:"tableHeaderCell"}],...e.map(((t,e)=>{var n,a;return[{text:t.lotNumber,alignment:"center"},{text:o(t.wetWeight),alignment:"right"},t.wetWeightUom,{text:o(t.moisture),alignment:"right"},t.moistureUom,{text:o(t.dryWeight),alignment:"right"},t.dryWeightUom,{text:o(null==(n=c[e])?void 0:n.analyticalAssay),alignment:"center"},{text:o(null==(a=g[e])?void 0:a.analyticalAssay),alignment:"center"}]}))]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5,fillColor:function(t,e,n){return t<1?"#BFBFBF":t%2==1?"#F2F2F2":null}}}),p.push({style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:[50,60,30,60,30,60,30,60,60],body:[[{text:"Total / Average",alignment:"center"},{text:o(m.totalWetWeight),alignment:"right"},"",{text:o(m.avgMoisture),alignment:"right"},"",{text:o(m.totalDryWeight),alignment:"right"},"",{text:o(d),alignment:"center"},{text:o(u),alignment:"center"}]]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5},pageBreak:"after"})}else if(1===t.length){const n=t[0].sort(((t,e)=>t.lotNumber-e.lotNumber)),a=h(n,e);p.push({style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:1,widths:[50,60,30,60,30,60,30,120],body:[[{text:"Lot",alignment:"center",style:"tableHeaderCell"},{text:"Wet Weight",alignment:"right",style:"tableHeaderCell"},{text:"Unit",alignment:"left",style:"tableHeaderCell"},{text:"Moisture",alignment:"right",style:"tableHeaderCell"},{text:"Unit",alignment:"left",style:"tableHeaderCell"},{text:"Dry Weight",alignment:"right",style:"tableHeaderCell"},{text:"Unit",alignment:"left",style:"tableHeaderCell"},{text:`${null==(c=n[0])?void 0:c.commodityName} (${null==(d=n[0])?void 0:d.commodityCode} - ${null==(g=n[0])?void 0:g.assayUom})`,alignment:"center",style:"tableHeaderCell"}],...e.map(((t,e)=>{var a;return[{text:t.lotNumber,alignment:"center"},{text:o(t.wetWeight),alignment:"right"},t.wetWeightUom,{text:o(t.moisture),alignment:"right"},t.moistureUom,{text:o(t.dryWeight),alignment:"right"},t.dryWeightUom,{text:o(null==(a=n[e])?void 0:a.analyticalAssay),alignment:"center"}]}))]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5,fillColor:function(t,e,n){return t<1?"#BFBFBF":t%2==1?"#F2F2F2":null}}}),p.push({style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:[50,60,30,60,30,60,30,120],body:[[{text:"Total / Average",alignment:"center"},{text:o(m.totalWetWeight),alignment:"right"},"",{text:o(m.avgMoisture),alignment:"right"},"",{text:o(m.totalDryWeight),alignment:"right"},"",{text:o(a),alignment:"center"}]]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5},pageBreak:"after"})}return p}function p(t){const e=[{text:"Composite Assays",style:"sectionHeader"}];return 0===t.length||e.push({style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:1,widths:[100,100],body:[[{text:"Commodity",style:"tableHeaderCell"},{text:"Assay",style:"tableHeaderCell"}],...t.map((t=>[{text:`${t.commodityName} (${t.commodityCode})`},{text:`${o(t.analyticalAssay)} ${t.assayUom}`}]))]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5,fillColor:function(t,e,n){return t<1?"#BFBFBF":t%2==1?"#F2F2F2":null}}}),e}require("dotenv").config(),require("dotenv").config();const b="GST Data Missing";async function f(t){const{folder_id:e,seller:n,seller_address:d,seller_business_number:h,seller_phone_number:y,company_logo:p,buyer:f,buyer_address:_,buyer_business_number:x,shipment_code:w,vessel:S,bl_date:v,invoice_type:C,invoice_date:W,revision:B,invoice_number:L,parcel:M,port_of_loading:T,port_of_discharge:H,primary_commodity:P,due_date:A,wet_weight:D,wet_weight_uom:F,wet_weight_uom_name:N,moisture:k,moisture_uom:E,dry_weight:R,dry_weight_uom:I,dry_weight_uom_name:U,total_revenue:z,total_deductions:O,currency:V,commodities:G,penalties:q,adjustments:j,invoice_value:J,payable_percentage:Q,payable_amount:K,payments_received:X,gst:Y,balance_of_gst_payable:Z,balance_in_sellers_favor:tt,signatory:et,remittance:nt}=t.body,at=function(t,e,n,a="USD"){var r=[];for(const l of t)r.push({style:"tableSmlBottomMargin",table:{widths:[70,120,"*",70],body:[[{text:`${l.commodity}:`,style:"tableHeader"},"","",""],[{text:`${o(l.analytical_assay)}${l.assay_uom}`,alignment:"right"},`${l.commodity} Analytical Assay`,"",""],[{text:`${o(l.payable_assay)}${l.assay_uom}`,alignment:"right"},`${l.commodity} Payable Assay`,`${l.deduction_expression}`,""],[{text:`${o(l.payable_metal)} ${l.payable_metal_uom}`,alignment:"right"},`${l.commodity} Payable Metal`,`${l.payable_metal_expression}`,""],[{text:`${l.qp}`,alignment:"right"},`${l.commodity} QP Month`,"",""],[{text:`${a} ${o(l.price_rate)}/${l.price_per_uom}`,alignment:"right"},{text:`${l.commodity} Price: ${l.qp_start_date} - ${l.qp_end_date} - ${l.price_method}`,colSpan:2},"",""],["",`${l.commodity} Payable Value`,`${o(l.payable_metal)} ${l.payable_metal_uom} * ${a} ${o(l.price_rate)}/${l.price_per_uom}`,{text:`${a} ${i(l.price)}`,alignment:"right",bold:!0}],...l.treatment_charge?l.treatment_charge.rate===l.treatment_charge.final_rate?[["","Treatment Charge",`${o(e)} ${n} * ${a} ${o(l.treatment_charge.final_rate)}/${l.treatment_charge.per_uom}`,{text:`${a} ${i(l.treatment_charge.final_amount)}`,alignment:"right",bold:!0}]]:[[{text:`${a} ${o(l.treatment_charge.discount)}/${l.treatment_charge.per_uom}`,alignment:"right"},"Treatment Charge Discount","",""],[{text:`${a} ${o(l.treatment_charge.final_rate)}/${l.treatment_charge.per_uom}`,alignment:"right"},`${l.commodity} Treatment Charge Rate`,`${a} ${o(l.treatment_charge.rate)}/${l.treatment_charge.per_uom}${null===l.treatment_charge.discount||0===l.treatment_charge.discount?"":` - ${a} ${o(l.treatment_charge.discount)}/${l.treatment_charge.per_uom}`}`,""],["","Treatment Charge",`${o(l.payable_metal)} ${l.payable_metal_uom} * ${a} ${o(l.treatment_charge.final_rate)}/${l.treatment_charge.per_uom}`,{text:`${a} ${i(l.treatment_charge.final_amount)}`,alignment:"right",bold:!0}]]:[],...l.refining_charge?l.refining_charge.rate===l.refining_charge.final_rate?[["","Refining Charge",`${o(l.payable_metal)} ${l.payable_metal_uom} * ${a} ${o(l.refining_charge.final_rate)}/${l.refining_charge.per_uom}`,{text:`${a} ${i(l.refining_charge.final_amount)}`,alignment:"right",bold:!0}]]:[[{text:`${a} ${o(l.refining_charge.discount)}/${l.refining_charge.per_uom}`,alignment:"right"},"Refining Charge Discount","",""],[{text:`${a} ${o(l.refining_charge.final_rate)}/${l.refining_charge.per_uom}`,alignment:"right"},`${l.commodity} Refining Charge Rate`,`${a} ${o(l.refining_charge.rate)}/${l.refining_charge.per_uom}${null===l.refining_charge.discount||0===l.refining_charge.discount?"":` - ${a} ${o(l.refining_charge.discount)}/${l.refining_charge.per_uom}`}`,""],["","Refining Charge",`${o(l.payable_metal)} ${l.payable_metal_uom} * ${a} ${o(l.refining_charge.final_rate)}/${l.refining_charge.per_uom}`,{text:`${a} ${i(l.refining_charge.final_amount)}`,alignment:"right",bold:!0}]]:[],m(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}}),r.push({style:"tableSmlBottomMargin",table:{widths:[70,120,"*",70],body:[["","",{text:`Total ${l.commodity}:`,alignment:"right",bold:!0},{text:`${a} ${i(l.final_total)}`,alignment:"right",bold:!0}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}});return r}(G,R,I,V),rt=function(t,e,n,a="USD"){const r=[];if(0===t.penalties.length)return[];const l=[];return r.push({style:"tableSmlBottomMargin",table:{widths:[70,120,"*",70],body:[[{text:"Penalties:",style:"tableHeader"},"","",""],...l.concat(...t.penalties.map((t=>"No penalty"===t.deduction_expression?[[{text:`${o(t.analytical_assay)}${t.assay_uom}`,alignment:"right"},`${t.commodity} Analytical Assay`,"",""]]:[[{text:`${o(t.analytical_assay)}${t.assay_uom}`,alignment:"right"},`${t.commodity} Analytical Assay`,"",""],[{text:`${a} ${o(t.final_penalty_rate)}/${t.penalty_per_uom}`,alignment:"right"},`${t.commodity} Penalty`,`${t.deduction_expression}`,""],["",`${t.commodity} Penalty`,`${o(e)} ${n} * ${a} ${o(t.final_penalty_rate)}/${t.penalty_per_uom}`,{text:`${a} ${i(t.final_penalty)}`,alignment:"right",bold:!0}]]))),m(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}}),r.push({style:"tableSmlBottomMargin",table:{widths:[70,160,"*",70],body:[["","",{text:"Total Penalties:",alignment:"right",bold:!0},{text:`${a} ${i(t.total_penalties)}`,alignment:"right",bold:!0}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}}),r}(q,R,I,V),lt=function(t,e="USD"){if(!t||0===t.adjustments.length)return[];const n=[];return n.push({style:"tableSmlBottomMargin",table:{widths:[70,120,"*",70],body:[[{text:"Adjustments:",style:"tableHeader"},"","",""],...t.adjustments.map((t=>["",`${t.description} :`,"",{text:`${e} ${i(t.amount)}`,alignment:"right",bold:!0}])),m(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}}),n.push({style:"tableSmlBottomMargin",table:{widths:[70,160,"*",70],body:[["","",{text:"Total Adjustments:",alignment:"right",bold:!0},{text:`${e} ${i(t.total_adjustments)}`,alignment:"right",bold:!0}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}}),n}(j,V),ot=function(t,e="USD"){var n;const a=[];for(const e of t)a.push(["",`${e.commodity} Analytical Assay`,"",{text:`${o(e.analytical_assay)}${e.assay_uom}`,alignment:"right"}]);for(const n of t)a.push(["",{text:`${n.commodity} Price: ${n.qp_start_date} - ${n.qp_end_date} - ${n.price_method}`,colSpan:2},"",{text:`${e} ${o(n.price_rate)}/${n.price_per_uom}`,alignment:"right"}]);for(const e of t)a.push(["",`${e.commodity} QP Month : (${e.qp})`,"",{text:e.qp_declared?null!=(n=e.qp_month)?n:`${e.qp_start_date} - ${e.qp_end_date}`:"To Be Declared",alignment:"right"}]);return a}(G,V),it=s(p);var st={pageSize:"A4",pageMargins:[40,270,40,60],info:{title:`${n}`,author:"Navarch Technologies",subject:`Invoice ${L}`,keywords:`${l(L)}`},header:function(t,e,a){return{margin:[40,60,40,0],stack:[{columns:[{width:"25%",stack:[{text:`${n}\n`,style:n&&n.length<=20?"midfont":n&&n.length<=25?"smlfont":"xsmlfont",bold:!0},{text:`${d}${h?`\n\n${h}`:""}\n\n`,style:"xsmlfont"},{text:y?`${y}\n\n\n`:"\n",style:"xsmlfont"}]},,{width:"50%",text:"",alignment:"center"},it?{image:it,fit:[60,60],width:"25%",alignment:"right",style:"marginBottom5"}:null]},{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:1}]},{style:"tableSmlBottomMarginSmlTopMargin",table:{widths:[90,220,"*",100],body:[[{text:"Buyer Information",style:"tableHeader",colSpan:2},"",{text:"Shipment Information",style:"tableHeader",colSpan:2},""],[{text:`${f}`,bold:!0,colSpan:2},"","Shipment:",{text:`${w}`,alignment:"right"}],[{text:`${_}${x?`\n\n${x}`:""}`,rowSpan:2},"","Vessel:",{text:`${S}`,alignment:"right"}],["","","B/L Date:",{text:`${v}`,alignment:"right"}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}},{style:"tableSmlBottomMargin",table:{widths:[90,220,"*",100],body:[[{text:`${C} Invoice`,style:"tableHeader"},"","",""],["Invoice Date:",`${W}`,"Port of Loading:",{text:`${T}`,alignment:"right"}],["Revision:",`${null!=B?B:"-"}`,"Port of Discharge:",{text:`${H}`,alignment:"right"}],["Invoice Number:",`${L}`,"Commodity:",{text:`${P}`,alignment:"right"}],["Parcel:",`${M}`,"",""],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>1.2}}]}},footer:function(t,e,n){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:.5}]}," ",{columns:[" ",{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[{style:"tableSmlBottomMargin",table:{widths:[90,220,"*",100],body:[[{text:"Summary:",style:"tableHeader"},"","",""],["",`${N} `,"",{text:`${o(D)} ${F}`,alignment:"right"}],["","Moisture","",{text:`${o(k)}${E}`,alignment:"right"}],["",`${U} `,"",{text:`${o(R)} ${I}`,alignment:"right"}],...ot,["","Total Revenue","",{text:`${V} ${i(z)}`,alignment:"right"}],["","Total Deductions","",{text:`${V} ${i(O)}`,alignment:"right"}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}},{style:"tableSmlBottomMargin",table:{widths:[90,220,"*",100],body:[[{text:"Totals:",style:"tableHeader"},"","",""],["","Invoice Value","",{text:`${V} ${i(J)}`,alignment:"right"}],["",`Payable Value @ ${o(Q,2)}% of Invoice Value`,"",{text:`${V} ${i(K)}`,alignment:"right"}],...Y?[["",Y.current?`GST @ 100 % of Parcel Value (${Y.current.local_currency}/USD: ${o(Y.current.conversion_rate_to_usd)})`:b,{text:Y.current?`${Y.current.local_currency} ${i(Y.current.gst_in_local_currency)}`:"",alignment:"right"},{text:Y.current?`USD ${i(Y.current.gst_in_usd)}`:"",alignment:"right"}]]:[],...$(X,Y,V),...Z?[["","Balance of GST Payable",{text:`${Z.local_currency} ${i(Z.gst_in_local_currency)}`,alignment:"right"},{text:`USD ${i(Z.gst_in_usd)}`,alignment:"right"}]]:[],m(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}},{style:"tableSmlBottomMargin",table:{widths:[90,220,"*",100],body:[["",{text:"BALANCE IN SELLERS FAVOUR",bold:!0,colSpan:2,alignment:"right"},"",{text:`${V} ${i(tt)}`,bold:!0,alignment:"right"}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}},{style:"tableSmlBottomMargin",table:{widths:[90,220,"*",100],body:[[{text:"Payment Advice:",style:"tableHeader"},{text:`Due ${A}`,bold:!0},"",""],["",{text:`When remitting please quote: ${L}`,bold:!0},"",""],["",{text:"Remittance details:",bold:!0},"",""],["",nt,"",""],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}},...u(et),{text:"",pageBreak:"after"},{style:"tableSmlBottomMargin",table:{widths:[70,220,"*",100],body:[[{text:"Weights:",style:"tableHeader"},"","",""],[{text:`${o(D)} ${F}`,alignment:"right"},`${N} `,"",""],[{text:`${o(k)}${E}`,alignment:"right"},"Moisture","",""],[{text:`${o(R)} ${I}`,alignment:"right"},`${U} `,"",""],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}},...at,...rt,...lt,{style:"tableSmlBottomMargin",table:{widths:[70,160,"*",70],body:[[{text:"Totals:",style:"tableHeader"},"","",""],["","Invoice Value","",{text:`${V} ${i(J)}`,alignment:"right",bold:!0}],["",`Payable Value @ ${o(Q,2)}% of Invoice Value`,"",{text:`${V} ${i(K)}`,alignment:"right",bold:!0}],...Y?[["",Y.current?`GST @ 100 % of Parcel Value (${Y.current.local_currency}/USD: ${o(Y.current.conversion_rate_to_usd)})`:b,{text:Y.current?`${Y.current.local_currency} ${i(Y.current.gst_in_local_currency)}`:"",alignment:"right"},{text:Y.current?`USD ${i(Y.current.gst_in_usd)}`:"",alignment:"right"}]]:[],...$(X,Y,V),m(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}},{style:"tableSmlBottomMargin",table:{widths:[70,160,"*",70],body:[["",{text:"BALANCE IN SELLERS FAVOUR",bold:!0,colSpan:2,alignment:"right"},"",{text:`${V} ${i(tt)}`,bold:!0,alignment:"right"}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>.5}}],styles:a};const ct=l(`Invoice-[${c()}]-${L}-${C}`),dt=`${C} Invoice - ${L}`;return await r(st,ct,dt,null!=e?e:null)}function $(t,e,n="USD"){return t&&0!==t.length?t.flatMap((t=>[["",`Payment received: ${t.payment_received_source}`,"",{text:`${n} ${i(t.payment_received)}`,alignment:"right"}],...e?[["",e[t.payment_received_source]?`GST payment received from ${t.payment_received_source}`:b,{text:e[t.payment_received_source]?`${e[t.payment_received_source].local_currency} ${i(e[t.payment_received_source].gst_in_local_currency)}`:"",alignment:"right"},{text:e[t.payment_received_source]?`USD ${i(e[t.payment_received_source].gst_in_usd)}`:"",alignment:"right"}]]:[]])):[]}function _(t){return[{text:"Assays:",style:"sectionHeader"},{style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:[100,10,"*"],body:[...t.map((t=>[t.commodity_name,":",`${o(t.analytical_assay)} ${t.assay_uom}`]))]},layout:"noBorders"}]}function x(t,e,n,a){return[{style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:1,widths:[50,"*",50,50,"*","*",50,50,50,50,50],body:[[{text:"Parcel ID",style:"tableHeaderCell"},{text:"Parcel Name",style:"tableHeaderCell"},{text:"Mine",style:"tableHeaderCell"},{text:"Counterparty",style:"tableHeaderCell"},{text:"Vessel",style:"tableHeaderCell"},{text:"Invoice",style:"tableHeaderCell"},{text:`Weight (${e})`,style:"tableHeaderCell"},{text:"Assay",style:"tableHeaderCell"},{text:"Element",style:"tableHeaderCell"},{text:`Rate (${n})`,style:"tableHeaderCell"},{text:`Value (${a})`,style:"tableHeaderCell"}],...w(t)]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5,fillColor:function(t,e,n){return t<1?"#BFBFBF":t%2==1?"#F2F2F2":null}}},S(t)]}function w(t){const e=[];return t.forEach((t=>{e.push(...function(t){return t.penalties.map((e=>[t.id,t.name,e.mine,e.counterparty,t.vessel,t.invoice_type,o(t.dry_weight,2),`${o(e.assay)} ${e.assay_uom}`,e.commodity_code,"0.00"===o(e.penalty_rate,2)?o(e.penalty_rate,6):o(e.penalty_rate,2),o(e.penalty_amount,2)]))}(t))})),e}function S(t){return{style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:["*",50],body:[[{text:"Grand Total",bold:!0},o(t.reduce(((t,e)=>t+e.penalties.reduce(((t,e)=>t+e.penalty_amount),0)),0),2)]]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5}}}async function v(t){const{folder_id:e,start_date:n,end_date:i,filter_date:s,parcels:g,wet_weight_uom:m,dry_weight_uom:u}=t.body,h=function(t,e,n,a){const r=function(t){const e=[];t.forEach((t=>{t.assays.forEach((t=>{e.push(t)}))}));const n=e.filter(((t,e,n)=>e===n.findIndex((e=>e.code===t.code)))),a=[];for(let t=0;t<n.length;t+=2)a.push(n.slice(t,t+2));return a}(t),l=function(t){const e=[];t.forEach((t=>{const n={};t.assays.forEach((t=>{n[t.code]=t})),e.push({name:t.name,counterparty:t.counterparty,port:t.port,vessel:t.vessel,phy_status:t.phy_status,fin_status:t.fin_status,shipment_date:t.shipment_date,weight_source:t.weight_source,wet_weight:t.wet_weight,dry_weight:t.dry_weight,moisture:t.moisture,assay_source:t.assay_source,assays:n})}));const n=[];return e.forEach((t=>{if(n.includes(t.name)){let e=1;for(;n.includes(`${t.name} (${e})`);)e++;n.push(`${t.name} (${e})`),t.name=`${t.name} (${e})`}else n.push(t.name)})),e}(t),i=function(t){const e=t.reduce(((t,e)=>t+e.wet_weight),0),n=t.reduce(((t,e)=>t+e.dry_weight),0);return{totalWetWeight:e,totalMoisture:(e-n)/e*100,totalDryWeight:n}}(t),s=function(t){const e={};return t.forEach((t=>{t.assays.forEach((t=>{void 0!==e[t.code]?e[t.code]+=t.contained_metal:e[t.code]=t.contained_metal}))})),e}(t),c=[],d=r.length;return r.forEach(((t,e)=>{var r,g,m,u,h,y,p,b,f,$,_,x,w,S,v;2===t.length?(c.push({style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:2,widths:[43,46,46,46,37,37,37,37,37,37,37,37,37,37,37,37],body:[[{text:"Parcel",rowSpan:2,alignment:"center",bold:!0},{text:"Counterparty",rowSpan:2,alignment:"center",bold:!0},{text:"Port",rowSpan:2,alignment:"center",bold:!0},{text:"Vessel",rowSpan:2,alignment:"center",bold:!0},{text:"Status",colSpan:2,alignment:"center",bold:!0},"",{text:"Shipment Date",rowSpan:2,alignment:"center",bold:!0},{text:"Weight Source",rowSpan:2,alignment:"center",bold:!0},{text:n,rowSpan:2,alignment:"center",bold:!0},{text:"Moisture",rowSpan:2,alignment:"center",bold:!0},{text:a,rowSpan:2,alignment:"center",bold:!0},{text:"Assay Source",rowSpan:2,alignment:"center",bold:!0},{text:`${null==(r=t[0])?void 0:r.commodity} (${null==(g=t[0])?void 0:g.code})`,colSpan:2,alignment:"center",bold:!0},"",{text:`${null==(m=t[1])?void 0:m.commodity} (${null==(u=t[1])?void 0:u.code})`,colSpan:2,alignment:"center",bold:!0},""],["","","","",{text:"Physical",alignment:"center",bold:!0},{text:"Financial",alignment:"center",bold:!0},"","","","","","",{text:`Assay (${null==(h=t[0])?void 0:h.assay_uom})`,alignment:"center",bold:!0},{text:`Assay (${null==(y=t[0])?void 0:y.contained_metal_uom})`,alignment:"center",bold:!0},{text:`Assay (${null==(p=t[1])?void 0:p.assay_uom})`,alignment:"center",bold:!0},{text:`Assay (${null==(b=t[1])?void 0:b.contained_metal_uom})`,alignment:"center",bold:!0}],...C(l,t)]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5,fillColor:function(t,e,n){return t<2?"#BFBFBF":t%2==0?"#F2F2F2":null}}}),c.push({style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:["*",37,37,37,37,37,37,37,37],body:[[{text:"Grand Total",bold:!0},o(i.totalWetWeight,3),o(i.totalMoisture,3),o(i.totalDryWeight,3),"","",{text:o(B(s,null==(f=t[0])?void 0:f.code)),bold:!0},"",{text:o(B(s,null==($=t[1])?void 0:$.code)),bold:!0}]]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5},pageBreak:d===e+1?void 0:"after"})):1===t.length&&(c.push({style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:2,widths:[43,46,46,46,37,37,37,37,37,37,37,37,37,37,37,37],body:[[{text:"Parcel",rowSpan:2,alignment:"center",bold:!0},{text:"Counterparty",rowSpan:2,alignment:"center",bold:!0},{text:"Port",rowSpan:2,alignment:"center",bold:!0},{text:"Vessel",rowSpan:2,alignment:"center",bold:!0},{text:"Status",colSpan:2,alignment:"center",bold:!0},"",{text:"Shipment Date",rowSpan:2,alignment:"center",bold:!0},{text:"Weight Source",rowSpan:2,alignment:"center",bold:!0},{text:n,rowSpan:2,alignment:"center",bold:!0},{text:"Moisture",rowSpan:2,alignment:"center",bold:!0},{text:a,rowSpan:2,alignment:"center",bold:!0},{text:"Assay Source",rowSpan:2,alignment:"center",bold:!0},{text:`${null==(_=t[0])?void 0:_.commodity} (${null==(x=t[0])?void 0:x.code})`,colSpan:4,alignment:"center",bold:!0},"","",""],["","","","",{text:"Physical",alignment:"center",bold:!0},{text:"Financial",alignment:"center",bold:!0},"","","","","","",{text:`Assay (${null==(w=t[0])?void 0:w.assay_uom})`,colSpan:2,alignment:"center",bold:!0},"",{text:`Assay (${null==(S=t[0])?void 0:S.contained_metal_uom})`,colSpan:2,alignment:"center",bold:!0},""],...C(l,t)]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5,fillColor:function(t,e,n){return t<2?"#BFBFBF":t%2==0?"#F2F2F2":null}}}),c.push({style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:["*",37,37,37,37,37,37,37,37],body:[[{text:"Grand Total",bold:!0},o(i.totalWetWeight,3),o(i.totalMoisture,3),o(i.totalDryWeight,3),"",{text:"",colSpan:2},"",{text:o(B(s,null==(v=t[0])?void 0:v.code)),colSpan:2,bold:!0},""]]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5},pageBreak:d===e+1?void 0:"after"}))})),c}(g,0,m,u);var y={pageSize:"A4",pageOrientation:"landscape",pageMargins:[40,120,40,60],info:{title:"Shipment Latest",author:"Navarch Technologies",subject:"Shipment Latest",keywords:`shipment-latest-${l(n)}-${l(i)}`},header:function(t,e,a){return{margin:[40,60,40,0],stack:[{columns:[{text:"",width:"25%",alignment:"right"},{width:"50%",stack:[{text:"Shipment Latest",style:"bigTitleForHeader",alignment:"center",bold:!0},{text:`${s} from ${n} to ${i}`,alignment:"center",italics:!0}]},{text:"",width:"25%"}]}]}},footer:function(t,e,a){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:760,y2:0,lineWidth:.5}]}," ",{columns:[{text:`Shipment Latest - with Metals\n${s} from ${n} to ${i}`,style:"xsmlfont",alignment:"left"},{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[...h],styles:a};const p=d(n),b=d(n),f=`ShipmentLatest-[${c()}]-${p}-${b}`,$=`Shipment Latest - ${s} (${n} ~ ${i})`;return await r(y,f,$,null!=e?e:null)}function C(t,e){return t.map((t=>{var n,a,r,l,i,s;return 2===e.length?[t.name,t.counterparty,t.port,t.vessel,t.phy_status,t.fin_status,t.shipment_date,t.weight_source,o(t.wet_weight,3),o(t.moisture,2),o(t.dry_weight,3),t.assay_source,o(W(t,null==(n=e[0])?void 0:n.code,"assay")),o(W(t,null==(a=e[0])?void 0:a.code,"contained_metal")),o(W(t,null==(r=e[1])?void 0:r.code,"assay")),o(W(t,null==(l=e[1])?void 0:l.code,"contained_metal"))]:1===e.length?[t.name,t.counterparty,t.port,t.vessel,t.phy_status,t.fin_status,t.shipment_date,t.weight_source,o(t.wet_weight,3),o(t.moisture,2),o(t.dry_weight,3),t.assay_source,{text:o(W(t,null==(i=e[0])?void 0:i.code,"assay")),colSpan:2},"",{text:o(W(t,null==(s=e[0])?void 0:s.code,"contained_metal")),colSpan:2},""]:[]}))}function W(t,e,n){if(e){const a=t.assays[e];if(a)return a[n]}return"-"}function B(t,e){if(!e)return"";const n=t[e];return n||""}async function L(t){const{folder_id:e,start_date:n,end_date:o,metal:i,assay_uom:s,parcels:g,dry_weight_uom:m,dry_weight_uom_name:u}=t.body,h=function(t,e,n,a,r){const l=M(t.map((t=>t.dry_weight))),o=M(t.map((t=>t.grade))),i=M(t.map((t=>t.metal)));return[{style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:[100,10,"*"],body:[["Metal",":",`${e} (${n})`]]},layout:"noBorders"},{style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:2,widths:[25,"*","*","*",30,30,30,30,35,30,30,30,35,30,30,30,35,25,25],body:[[{text:"Parcel ID",rowSpan:2,alignment:"center",style:"tableHeaderCell"},{text:"Parcel",rowSpan:2,alignment:"center",style:"tableHeaderCell"},{text:"Vessel",rowSpan:2,alignment:"center",style:"tableHeaderCell"},{text:"Port",rowSpan:2,alignment:"center",style:"tableHeaderCell"},{text:"Shipment",rowSpan:2,alignment:"center",style:"tableHeaderCell"},{text:`${r} (${a})`,colSpan:4,alignment:"center",style:"tableHeaderCell"},"","","",{text:"Grade",colSpan:4,alignment:"center",style:"tableHeaderCell"},"","","",{text:"Metal",colSpan:6,alignment:"center",style:"tableHeaderCell"},"","","","",""],["","","","","",{text:"Loadport",alignment:"center",style:"tableHeaderCell"},{text:"Disport",alignment:"center",style:"tableHeaderCell"},{text:"Variance",alignment:"center",style:"tableHeaderCell"},{text:"Variance (%)",alignment:"center",style:"tableHeaderCell"},{text:"Loadport",alignment:"center",style:"tableHeaderCell"},{text:"Disport",alignment:"center",style:"tableHeaderCell"},{text:"Variance",alignment:"center",style:"tableHeaderCell"},{text:"Variance (%)",alignment:"center",style:"tableHeaderCell"},{text:"Loadport",alignment:"center",style:"tableHeaderCell"},{text:"Disport",alignment:"center",style:"tableHeaderCell"},{text:"Variance",alignment:"center",style:"tableHeaderCell"},{text:"Variance (%)",alignment:"center",style:"tableHeaderCell"},{text:"Unit",alignment:"center",style:"tableHeaderCell"},{text:"Outcome",alignment:"center",style:"tableHeaderCell"}],...T(t)]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5,fillColor:function(t,e,n){return t<2?"#BFBFBF":t%2==0?"#F2F2F2":null}}},{style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:["*",30,30,30,35,30,30,30,35,30,30,30,35,25,25],body:[[{text:"Grand Total",bold:!0},l.loadport,l.disport,l.variance,l.variance_percent,o.loadport,o.disport,o.variance,o.variance_percent,i.loadport,i.disport,i.variance,i.variance_percent,"",""]]},layout:{vLineWidth:()=>.5,hLineWidth:()=>.5,fillColor:function(t,e,n){return n>12?"#000000":null}}}]}(g,i,s,m,u);var y={pageSize:"A4",pageOrientation:"landscape",pageMargins:[40,120,40,60],info:{title:"Loadport - Disport Comparison - Grouped",author:"Navarch Technologies",subject:"Loadport - Disport Comparison - Grouped",keywords:`Loadport-Disport-Comparison-Grouped-${l(n)}-${l(o)}`},header:function(t,e,a){return{margin:[40,60,40,0],stack:[{columns:[{text:"",width:"25%",alignment:"right"},{width:"50%",stack:[{text:"Loadport - Disport Comparison - Grouped",style:"bigTitleForHeader",alignment:"center",bold:!0},{text:`From ${n} to ${o}`,alignment:"center",italics:!0}]},{text:"",width:"25%"}]}]}},footer:function(t,e,a){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:760,y2:0,lineWidth:.5}]}," ",{columns:[{text:`Loadport - Disport Comparison - Grouped\nFrom ${n} to ${o}`,style:"xsmlfont",alignment:"left"},{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[...h],styles:a};const p=d(n),b=d(n),f=`LoadportDisportCompare-[${c()}]-Comparison_Period-${p}~${b}`,$=`Loadport-Disport Comparison (${p} ~ ${b})`;return await r(y,f,$,null!=e?e:null)}function M(t,e=2){const n=t.reduce(((t,e)=>t+e.loadport),0),a=t.reduce(((t,e)=>t+e.disport),0),r=a-n,l=r/n*100;return{loadport:o(n,e),disport:o(a,e),variance:o(r,e),variance_percent:o(l,e)}}function T(t){return t.map((t=>[t.id,t.name,t.vessel,t.port,t.shipment_date,o(t.dry_weight.loadport,2),o(t.dry_weight.disport,2),o(t.dry_weight.variance,2),o(t.dry_weight.variance_percent,2),o(t.grade.loadport,2),o(t.grade.disport,2),o(t.grade.variance,2),o(t.grade.variance_percent,2),o(t.metal.loadport,2),o(t.metal.disport,2),o(t.metal.variance,2),o(t.metal.variance_percent,2),t.metal_uom,t.gain_loss]))}var H=t=>{t.post("/assay-exchange",((t,e)=>{(async function(t){const{folder_id:e,company_logo:n,seller:o,seller_address:i,seller_phone_number:d,buyer:m,parcel_ref:h,contract_ref:b,vessel:f,bl_date:$,port_of_loading:_,port_of_discharge:x,assays:w,composite_assays:S,weights:v,signatory:C}=t.body,W=s(n);var B={pageSize:"A4",pageMargins:[40,240,40,60],info:{title:`${o}`,author:"Navarch Technologies",subject:`Assay Exchange Certificate (${h})`,keywords:`${l(h)}-assay-exchange-cert`},header:function(t,e,n){return{margin:[40,60,40,0],stack:[{columns:[{width:"25%",stack:[{text:`${o}\n`,style:o&&o.length<=20?"midfont":"smlfont",bold:!0},{text:`${i}\n\n`,style:"xsmlfont"},{text:d?`${d}\n\n\n`:"\n",style:"xsmlfont"}]},{width:"50%",text:"Assay Exchange Certificate",style:"bigDocTitleInHeaderWithTop27Padding",alignment:"center"},W?{image:W,fit:[60,60],width:"25%",alignment:"right",style:"marginBottom5"}:null]},{canvas:[{type:"line",x1:0,y1:10,x2:522,y2:10,lineWidth:1}]},{style:"tableSmlTopMarginLrgBottomMargin",table:{widths:[90,220,"*",100],body:[[{text:"Parcel Information",style:"tableHeader",colSpan:2},"",{text:"Shipment Information",style:"tableHeader",colSpan:2},""],["Buyer:",{text:`${m}`,bold:!0},"Vessel:",{text:`${f}`,alignment:"right"}],["Contract:",`${null!=b?b:"-"}`,"Port of Loading:",{text:`${_}`,alignment:"right"}],["Parcel:",`${null!=h?h:"-"}`,"B/L Date:",{text:`${$}`,alignment:"right"}],["","","Port of Discharge:",{text:`${x}`,alignment:"right"}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>1}}]}},footer:function(t,e,n){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:.5}]}," ",{columns:[" ",{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[...y(w,v),...p(S),...u(C)],styles:a};const L=`AssayExchangeCertificate-[${c()}]-${l(h)}`,M=`Assay Exchange Certificate (Parcel #${h})`;return await r(B,L,M,null!=e?e:null)})(t).then((t=>{e.send(t)})).catch((t=>{console.error(t),e.status(400).send(`An error occurred while generating the Assay Exchange Certificate document. Error=${t}`)}))})),t.post("/cert-of-origin",((t,e)=>{(async function(t){const{folder_id:e,parcel_id:n,parcel_ref:i,company_logo:d,seller:m,seller_address:h,seller_phone_number:y,buyer:p,contract_ref:b,vessel:f,bl_date:$,port_of_loading:_,port_of_discharge:x,wet_weight:w,wet_weight_uom:S,country_of_origin:v,commodity_name:C,other_comments:W,signatory:B}=t.body,L=s(d);var M={pageSize:"A4",pageMargins:[40,210,40,60],info:{title:`${m}`,author:"Navarch Technologies",subject:`Certificate of Origin for Parcel ${n}`,keywords:`cert-of-origin-${l(C)}`},header:function(t,e,n){return{margin:[40,60,40,0],stack:[{columns:[{width:"25%",stack:[{text:`${m}\n`,style:m&&m.length<=20?"midfont":"smlfont",bold:!0},{text:`${h}\n\n`,style:"xsmlfont"},{text:y?`${y}\n\n\n`:"\n",style:"xsmlfont"}]},{width:"50%",text:"Certificate of Origin",style:"bigDocTitleInHeaderWithTop27Padding",alignment:"center"},L?{image:L,fit:[60,60],width:"25%",alignment:"right",style:"marginBottom5"}:null]},{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:1}]},{style:"tableSmlTopMarginLrgBottomMargin",table:{widths:[90,220,"*",100],body:[[{text:"Parcel Information",style:"tableHeader",colSpan:2},"",{text:"Shipment Information",style:"tableHeader",colSpan:2},""],["Buyer:",{text:`${p}`,bold:!0},"Vessel:",{text:`${f}`,alignment:"right"}],["Contract:",`${null!=b?b:"-"}`,"Port of Loading:",{text:`${_}`,alignment:"right"}],["Parcel:",`${null!=i?i:"-"}`,"B/L Date:",{text:`${$}`,alignment:"right"}],["Commodity:",""===C?"No primary commodity":`${C} Concentrates`,"Port of Discharge:",{text:`${x}`,alignment:"right"}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>1}}]}},footer:function(t,e,n){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:.5}]}," ",{columns:[" ",{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[{text:"Origin Details",style:"bigSectionHeader",alignment:"center"},{style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:[100,10,"*"],body:[[{text:"Material"},":",{text:`${o(w)} ${S}`+(""===C?"":` of ${C} Concentrates`)}],[{text:"Country of Origin"},":",v],[{text:"Other Comments"},":",null!=W?W:"-"]]},layout:"noBorders"},...u(B)],styles:a};const T=`CertificateOfOrigin-[${c()}]-Parcel#${l(n)}-Contract#${l(b)}`,H=`Certificate of Origin (Parcel #${n})`;return await r(M,T,H,null!=e?e:null)})(t).then((t=>{e.send(t)})).catch((t=>{console.error(t),e.status(400).send(`An error occurred while generating the Certificate of Origin document. Error=${t}`)}))})),t.post("/loadport-disport-compare",((t,e)=>{L(t).then((t=>{e.send(t)})).catch((t=>{console.error(t),e.status(400).send(`An error occurred while generating the Loadport - Disport Comparison document. Error=${t}`)}))})),t.post("/shipment-latest",((t,e)=>{v(t).then((t=>{e.send(t)})).catch((t=>{console.error(t),e.status(400).send(`An error occurred while generating the Shipment Latest document. Error=${t}`)}))})),t.post("/penalty-elements",((t,e)=>{(async function(t){const{folder_id:e,start_date:n,end_date:o,filter_date:i,invoice_type:s,parcels:d,dry_weight_uom:g,penalty_rate_uom:m,currency:u}=t.body;var h={pageSize:"A4",pageOrientation:"landscape",pageMargins:[40,120,40,60],info:{title:"Penalty Elements",author:"Navarch Technologies",subject:"Penalty Elements",keywords:`penalty-elments-${l(n)}-${l(o)}`},header:function(t,e,a){return{margin:[40,50,40,0],stack:[{columns:[{text:"",width:"25%",alignment:"right"},{width:"50%",stack:[{text:"Penalty Elements",style:"bigTitleForHeader",alignment:"center",bold:!0},{text:`From ${n} to ${o}`,alignment:"center",italics:!0}]}]}]}},footer:function(t,e,a){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:760,y2:0,lineWidth:.5}]}," ",{columns:[{text:`Penalty Elements\nFrom ${n} to ${o}`,style:"xsmlfont",alignment:"left"},{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[{style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:[100,10,"*"],body:[["Filter Date",":",i],["Invoice Type",":",s]]},layout:"noBorders"},...x(d,g,m,u)],styles:a};const y=`PenaltyElements-[${c()}]-${l(n)}-${l(o)}`,p=`Penalty Elements (${n} ~ ${o})`;return await r(h,y,p,null!=e?e:null)})(t).then((t=>{e.send(t)})).catch((t=>{console.error(t),e.status(400).send(`An error occurred while generating the Penalty Element document. Error=${t}`)}))})),t.post("/weight-and-assay-cert",((t,e)=>{(async function(t){const{folder_id:e,invoice_type:n,company_logo:i,seller:d,seller_address:m,seller_phone_number:h,buyer:y,contract_ref:p,parcel_ref:b,vessel:f,bl_date:$,commodity_name:x,port_of_loading:w,port_of_discharge:S,wet_weight:v,wet_weight_uom:C,dry_weight:W,dry_weight_uom:B,moisture:L,moisture_uom:M,assays:T,signatory:H}=t.body,P=s(i);var A={pageSize:"A4",pageMargins:[40,210,40,60],info:{title:`${d}`,author:"Navarch Technologies",subject:"Weight and Assay Certificate",keywords:`${n}-weight-and-assay-cert-${l(p)}`},header:function(t,e,n){return{margin:[40,60,40,0],stack:[{columns:[{width:"25%",stack:[{text:`${d}\n`,style:d&&d.length<=20?"midfont":"smlfont",bold:!0},{text:`${m}\n\n`,style:"xsmlfont"},{text:h?`${h}\n\n\n`:"\n",style:"xsmlfont"}]},{width:"50%",text:"Weight & Assay Certificate",style:"bigDocTitleInHeaderWithTop10Padding",alignment:"center"},P?{image:P,fit:[60,60],width:"25%",alignment:"right",style:"marginBottom5"}:null]},{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:1}]},{style:"tableSmlTopMarginLrgBottomMargin",table:{widths:[90,220,"*",100],body:[[{text:"Parcel Information",style:"tableHeader",colSpan:2},"",{text:"Shipment Information",style:"tableHeader",colSpan:2},""],["Buyer:",{text:`${y}`,bold:!0},"Vessel:",{text:`${f}`,alignment:"right"}],["Contract:",`${null!=p?p:"-"}`,"Port of Loading:",{text:`${w}`,alignment:"right"}],["Parcel:",`${null!=b?b:"-"}`,"B/L Date:",{text:`${$}`,alignment:"right"}],["Commodity:",""===x?"No primary commodity":`${x} Concentrates`,"Port of Discharge:",{text:`${S}`,alignment:"right"}],g(4)]},layout:{defaultBorder:!1,hLineWidth:()=>1}}]}},footer:function(t,e,n){return{margin:[40,0,40,0],stack:[{canvas:[{type:"line",x1:0,y1:0,x2:522,y2:0,lineWidth:.5}]}," ",{columns:[" ",{text:"Page "+t.toString()+" of "+e.toString(),alignment:"center"},{text:"by Navarch Technologies",alignment:"right",style:"footer"}]}]}},content:[{text:"We hereby certify the provisional weights and assays as stated below for the above mentioned shipment.",alignment:"center",margin:[0,12,0,12],styles:"midfont"},{text:"Weights:",style:"sectionHeader"},{style:"tableSmlTopMarginLrgBottomMargin",table:{headerRows:0,widths:[100,10,"*"],body:[[{text:"Wet Weight"},":",`${o(v)} ${C}`],[{text:"Moisture"},":",`${o(L)} ${M}`],[{text:"Dry Weight"},":",`${o(W)} ${B}`]]},layout:"noBorders"},..._(T),...u(H)],styles:a};const D=`WeightAndAssayCert-[${c()}]-${n}-${l(p)}`,F=`Weight & Assay Certificate - Contract ${p} - Parcel ${b}`;return await r(A,D,F,null!=e?e:null)})(t).then((t=>{e.send(t)})).catch((t=>{console.error(t),e.status(400).send(`An error occurred while generating the Provisional/Final Weight And Assay Certificate document. Error=${t}`)}))})),t.post("/invoice",((t,e)=>{f(t).then((t=>{e.send(t)})).catch((t=>{console.error(t),e.status(400).send(`An error occurred while generating the Invoice document. Error=${t}`)}))}))};module.exports=H;
