"use strict";var n=require("uuid");const e={navarch_contract:{string:{name:"_icontains","counterparty.codename":"_icontains"},number:{id:"_eq"}},navarch_parcel:{string:{shipment_code:"_icontains","contract.counterparty.name":"_icontains","contract.counterparty.codename":"_icontains",financial_status:"_icontains",physical_status:"_icontains","vessel.name":"_icontains","origin.port_name":"_icontains","destination.port_name":"_icontains"},number:{"contract.id":"_eq",id:"_eq"}},navarch_commodity_price:{string:{"price_method.name":"_icontains","currency.currency":"_icontains","currency.code":"_icontains",price_am:"_contains",price_pm:"_contains",average_price:"_contains",period:"_icontains"}}},i=new Set(["uuid","m2o","user-created","user-updated"]),t=new Set(["integer","float"]),s=new Set(["alias","boolean","json"]);module.exports=({filter:o},{logger:c})=>{o("items.query",(async(o,c,a)=>{var r,_;const{search:u}=o,{schema:l,accountability:f}=a;if(!u||!l||!f)return o;const{collection:d}=c,p=l.collections[d];if(!p)return o;const m={filter:{},...o};delete m.search;const h=m.filter;if(u){h._or=h._or||[];const c={};if(f.admin)Object.assign(c,p.fields);else{const n=null==(r=f.permissions)?void 0:r.find((n=>("read"===n.action&&n.collection)===d));if(!n)return o;if(null==(_=n.fields)?void 0:_.includes("*"))Object.assign(c,p.fields);else for(const e of n.fields||[])p.fields[e]&&(c[e]=p.fields[e])}if(n.validate(u)){for(const n in c)if("uuid"===c[n].type||"string"===c[n].type&&c[n].special.some((n=>i.has(n)))){const e={[n]:{_eq:u}};h._or.push(e)}}else if(isNaN(Number(u)))if(d in e&&e[d].string)for(const n in e[d].string){const i=n.split(".");if(!c[i[0]])continue;const t={};let s=t;for(const n of i)s[n]={},s=s[n];"lowercase"===e[d][n]?s._contains=u.toLowerCase():"uppercase"===e[d][n]?s._contains=u.toUpperCase():s._contains=u,h._or.push(t)}else for(const n in c){const{type:e}=c[n];if(!s.has(e))if("date"===e){if(!u.match(/^\d{4}-\d{2}-\d{2}$/))continue;if(10===u.length){const e={[n]:{_eq:u}};h._or.push(e)}}else if("time"===e){if(!u.match(/^\d{2}:\d{2}$/))continue;if(5===u.length){const e={[n]:{_eq:u}};h._or.push(e)}}else if("timestamp"===e){if(!u.match(/^\d{4}-\d{2}-\d{2}.\d{2}:\d{2}.*$/))continue;const e={[n]:{_contains:u}};h._or.push(e)}else if("uuid"===e){const e={[n]:{_eq:u}};h._or.push(e)}else if(!t.has(e)){const e={[n]:{_contains:u}};h._or.push(e)}}else{const n=d in e?e[d].number:void 0;for(const e in c){const{type:i}=c[e];if(!s.has(i))if(n&&n[e]){const i={[e]:{[n[e]]:u}};h._or.push(i)}else if("date"===i){if(4===u.length){const n={[`year(${e})`]:{_eq:Number(u)}};h._or.push(n)}}else if(t.has(i)){const n={[e]:{_eq:Number(u)}};h._or.push(n)}}}}return m}))};
