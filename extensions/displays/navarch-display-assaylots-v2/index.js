import{useApi as t,defineDisplay as a}from"@directus/extensions-sdk";import{defineComponent as e,ref as n,openBlock as r,createElementBlock as s,toDisplayString as o}from"vue";const l="id",i="related_parcel",u="lot_number",c="method",d="navarch_parcel",m="contract",f="navarch_assay_lot",y="commodity",p="assay_uom",h="final_assay",v="navarch_commodity",_="code",g="navarch_commodity_in_contract",w="commodity",O="primary_commodity",$="penalty_element",b="contract";var j=(t=>(t[t.Estimated=0]="Estimated",t[t.Planned=10]="Planned",t[t.Inturn=20]="Inturn",t[t["Inturn Final"]=30]="Inturn Final",t[t.Outturn=40]="Outturn",t))(j||{});function I(t,a){if(null==t)return"--";const e=function(t,a=2,e=!0){if(isNaN(t)||null==t)return"-";const n=Math.round(t*Math.pow(10,a))/Math.pow(10,a),[r,s]=n.toString().split("."),o=r?r.replace(/\B(?=(\d{3})+(?!\d))/g,","):0;if(!s&&!e)return o;const l=(null!=s?s:"").padEnd(a,"0");return`${o}.${l}`}(t,4,!0);return null==a?`${e}`:`${e}${a}`}var N=e({props:{value:{type:String,default:null}},setup(a){const e=t(),r=n(null),s=n(null);return a.value?(async function(){try{const t=await async function(){const t=[];for(let n=0;n<a.value.length;n+=15){const r=a.value.slice(n,n+15),s=await e.readCollectionItems(f,{filter:{[l]:{_in:r},[u]:{_null:!0}},fields:[c,h,p,y,i]});t.push(...s.data.data)}if(0===t.length||!t[0])return{COMMODITY:"No assays"};s.value=t[0][i];const n=t.map((t=>t.method)).sort(((t,a)=>j[a]-j[t]));if(0===n.length||!n[0])throw new Error("No latest method found for the assay lots");const r=n[0];return t.filter((t=>t.method===r)).reduce(((t,a)=>{const e=a[y];return t[e]||(t[e]=I(Number(a[h]),a[p])),t}),{})}(),n=await async function(t){if(!t)return[];if(!s.value)return Object.values(t);const a=await e.get(`/items/${d}/${s.value}`,{params:{fields:[m]}}),n=a.data.data.length>0?a.data.data[0][m]:null;if(!n)return Object.values(t).sort();const r=await e.get(`/items/${g}`,{params:{filter:{[b]:{_eq:n}},fields:[w,O,$]}});if(!r.data.data||r.data.data.length<1)return Object.values(t);const o=await e.get(`/items/${v}`,{params:{filter:{[l]:{_in:r.data.data.map((t=>t[w]))}},fields:[l,_]}});if(!o.data.data||o.data.data.length<1)return Object.values(t);const i=o.data.data.reduce(((t,a)=>(t[a[l]]=a[_],t)),{}),u=r.data.data.reduce(((t,a)=>{const e=i[a[w]];return a[O]&&e?t[e]=1:a[$]&&e?t[e]=3:t[e]=2,t}),{});return Object.entries(t).sort(((t,a)=>u[t[0]]-u[a[0]])).map((t=>t[1]))}(t);r.value=n.join(", ")}catch(t){console.error(t),r.value="Error occured"}}(),{finalAssaysByCommodity:r}):{finalAssaysByCommodity:n(null)}}});N.render=function(t,a,e,n,l,i){return r(),s("div",null,o(t.finalAssaysByCommodity??"--"),1)},N.__file="src/display.vue";var A=a({id:"navarch-display-assaylots-v2",name:"Navarch Display Assay Lots V2",icon:"box",description:"This is for displaying aggregate assay lot values in the Parcel home page with the Assay Results V2 interface.",component:N,options:null,types:["alias"],localTypes:["o2m"]});export{A as default};
